/*! For license information please see d5cb5aa499ab6129d944-37.js.LICENSE */
webpackJsonp([37],{1060:function(e,t,o){"use strict";o.d(t,"a",function(){return u});var n=o(341),s=o(136),i=(o.n(s),o(137)),a=(o.n(i),o(355)),r=(o.n(a),o(346));function c(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var u=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=arguments.length>1?arguments[1]:void 0;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.newMessageId=void 0,t.tids&&!t.tids.length&&delete t.tids;var n=t.mailboxUid||null;this.params=t,this.data=o,this.mSettings=n?ns.Model.get("mailbox-settings",{mailboxUid:n}):ns.Model.get("settings")}return function(e,t,o){t&&c(e.prototype,t),o&&c(e,o)}(e,[{key:"getParams",value:function(){return this.params}},{key:"getMessageType",value:function(){return Daria.UA.isMobile&&Daria.UA.isTouch?"html":Daria.UA.isMobile?"plain":this.mSettings.isSet("enable_richedit")||Daria.isReactiveCompose()?"html":this.mMessageBody?this.mMessageBody.getSubtype():"plain"}},{key:"getFromName",value:function(){return this.mSettings.getSetting(a.Settings.FROM_NAME)}},{key:"getFromEmail",value:function(){return this.mSettings.getSetting(a.Settings.LOCK_DEFAULT_EMAIL)?this.mSettings.getSetting(a.Settings.DEFAULT_EMAIL):this.mMessage&&this.mMessage.getToEmail()||this.mSettings.getSetting(a.Settings.DEFAULT_EMAIL)}},{key:"getAvailableFromEmails",value:function(){var e=this.mAccountInformation.getFromEmails();return this.mSettings.getSetting(a.Settings.LOCK_DEFAULT_EMAIL)?[this.mSettings.getSetting(a.Settings.DEFAULT_EMAIL)]:e}},{key:"_getForwardMarkIds",value:function(){return this.mMessage?this.mMessage.isThread()&&1===this.mMessage.get(".count")?[this.mMessage.get(".last_mid")]:this.mMessage.isThread()?[]:[this.mMessage.get(".mid")]:[]}},{key:"isForward",value:function(){return Boolean("forward"===this.params.oper)}},{key:"isTemplate",value:function(){return!(!this.mMessage||!this.mMessage.isTemplate())||!(!this.data||this.data.save_symbol!==i.WellKnownFolderSymbol.TEMPLATE)}},{key:"isDraft",value:function(){return!this.isTemplate()&&(!(!this.data||"no"!==this.data.ign_overwrite||!this.data.overwrite)||!!(this.mMessage&&this.mMessageBody&&this.mMessage.isDraftLike()))}},{key:"isReplyAll",value:function(){return Boolean(this.mMessageBody&&"reply-all"===this.params.oper)}},{key:"isReply",value:function(){return Boolean(this.mMessageBody&&"reply"===this.params.oper)}},{key:"isReplyAny",value:function(){return this.isReply()||this.isReplyAll()}},{key:"getForwardData",value:function(){var e=this.getMessageType(),t=this.getFromEmail(),o=this.mMessage?this.mMessage.getFolderId():null,n=this.mMessageBody?this.mMessageBody.getForwardBody(e,t):Daria.signs.appendToBody("",e,!0,t,null,this.mailboxUid),s=this.mMessageBody?this.mMessageBody.getMessageId():null;return{ttype:e,from_mailbox:t,from_name:this.getFromName(),cc:"",bcc:"",subj:"Fwd: "+this.messageSubject,send:n,inreplyto:s,current_folder:o,overwrite:this.params.ids,ign_overwrite:"yes",references:"",mark_ids:this._getForwardMarkIds(),mark_as:"forwarded",message_id:this.newMessageId}}},{key:"getDraftData",value:function(){var e=this.getMessageType(),t=this.mMessage.isTemplate()?i.WellKnownFolderSymbol.TEMPLATE:i.WellKnownFolderSymbol.DRAFT,o=_.clone(this.mMessage.get(".lid")),n=this.mMessage.getDelayedTime(),s=this.isTemplate()?this.newMessageId:this.mMessage.get(".message_id"),a=this.params.mailboxUid;if(!n){var r=ns.Model.get("labels",{mailboxUid:a}).getDelayedMessageLabel();r&&(o=_.pull(o,r.lid))}return{overwrite:this.params.ids,ign_overwrite:"no",save_symbol:t,to:this.mMessageBody.getAddressField("to"),cc:this.mMessageBody.getAddressField("cc"),bcc:this.mMessageBody.getAddressField("bcc"),phone:this.mMessageBody.getAddressField("phone"),lids:o,from_name:this.mMessage.getFromName(),from_mailbox:this.mMessage.getFromEmail(),subj:this.messageSubjectWithPrefix,send:this.mMessageBody.getDraftBody(e),ttype:e,inreplyto:this.mMessageBody.getInReplyTo(),references:this.mMessageBody.getReferences(),current_folder:this.mMessage.getFolderId(),send_time:n,message_id:s}}},{key:"getTemplateData",value:function(){if(this.mMessage&&this.mMessageBody)return this.draftMessageData;var e=this.defaultMessageData;return e.save_symbol=i.WellKnownFolderSymbol.TEMPLATE,e}},{key:"getReplyData",value:function(){var e=this.getMessageType(),t=this.mMessageBody.getRecipients(this.isReplyAll()),o=this.mMessageBody.getMessageId(),n=this.mMessageBody.getReferences(),s=this.mMessageBody.getInReplyTo(),i=this.mMessageBody.getInfo("delivered-to")[0],a=this.fromEmail,r=this.params.isQuickReply?"":this.sendMessageData;return{from:{receiver:i},from_mailbox:a,from_name:this.getFromName(),overwrite:this.params.ids,ign_overwrite:"yes",mark_as:"replied",mark_ids:[this.params.ids],to:t.to,cc:t.cc,bcc:"",subj:"Re: "+this.messageSubject,send:r,ttype:e,inreplyto:o,references:_.trim((n||s||"")+" "+o),message_id:this.newMessageId}}},{key:"getSendMessage",value:function(){return(this.data&&this.data.qrText||"")+this.getReplyBody()}},{key:"getReplyBody",value:function(){var e=this.getMessageType(),t=this.fromEmail;return this.mMessageBody.getReplyBody(e,t)}},{key:"getDefaultData",value:function(){var e=this.getFromEmail()||this.mAccountInformation.getFromDefaultEmail(),t=this.getFromName(),o=this.getMessageType(),n=this.data&&this.data.send||"";return Object(s.isEmpty)(n)||"html"!==this.getMessageType()||(n="<div>".concat(n,"</div>")),{from_mailbox:e,from_name:t,ttype:o,send:Daria.signs.appendToBody(n,o,!0,e,void 0,this.mailboxUid),message_id:this.newMessageId}}},{key:"getComposeMessageData",value:function(){return this.isDraft()?this.draftMessageData:this.isTemplate()?this.templateMessageData:this.isReplyAny()?this.replyMessageData:this.isForward()?this.forwardMessageData:this.defaultMessageData}},{key:"isPredefinedDataEmpty",value:function(){var e=Object(n.toJS)(this.data);return!e||0===Object.keys(e).length}},{key:"getRelatedThreadId",value:function(){return this.mMessage?this.mMessage.getThreadId():""}},{key:"isNewMessage",value:function(){return!this.isDraft()&&!this.isReplyAny()&&!this.isForward()}},{key:"isNewTemplate",value:function(){var e=this.data&&this.data.overwrite||this.mMessage&&this.mMessage.isDraftLike();return this.isTemplate()&&!e}},{key:"mailboxUid",get:function(){return this.params.mailboxUid}},{key:"hasMessage",get:function(){return this.params.ids&&!this.params.tids}},{key:"mMessage",get:function(){return this.hasMessage?ns.Model.getValid("message",{ids:this.params.ids,mailboxUid:this.mailboxUid}):null}},{key:"mThread",get:function(){return this.hasMessage?null:ns.Model.getValid("message",{ids:this.params.tids,mailboxUid:this.mailboxUid})}},{key:"mMessageBody",get:function(){if(!this.hasMessage)return null;var e=ns.Model.infoLite("message-body").calculateParamsForMessageBody(this.params);return ns.Model.getValid("message-body",e)}},{key:"mAccountInformation",get:function(){return Object(r.isSharedMailboxes)()&&this.mailboxUid?ns.Model.get("address-information"):ns.Model.get("account-information")}},{key:"fromName",get:function(){return this.getFromName()}},{key:"fromEmail",get:function(){return this.getFromEmail()}},{key:"fromEmails",get:function(){return this.getAvailableFromEmails()}},{key:"forwardMessageData",get:function(){return this.getForwardData()}},{key:"messageSubject",get:function(){var e=this.mMessage||this.mThread;return e?e.getSubject(!0):""}},{key:"messageSubjectWithPrefix",get:function(){var e=this.mMessage||this.mThread;return e?e.getSubject():""}},{key:"draftMessageData",get:function(){return this.getDraftData()}},{key:"templateMessageData",get:function(){return this.getTemplateData()}},{key:"replyMessageData",get:function(){return this.getReplyData()}},{key:"sendMessageData",get:function(){return this.getSendMessage()}},{key:"defaultMessageData",get:function(){return this.getDefaultData()}},{key:"messageData",get:function(){return this.getComposeMessageData()}},{key:"relatedThreadId",get:function(){return this.getRelatedThreadId()}}]),e}()},1061:function(e,t,o){"use strict";var n=o(357),s=o(705),i=o(3),a=(o.n(i),"do-attach-file-store");t.a=function(e,t){var o=t.onError,r=t.onSuccess,c={file:e.name,size:e.file&&e.file.size,checkLimit:!0};return ns.forcedRequest(a,c).then(function(t){return function(e,t,o){var i=o.onError,r=o.onSuccess,c=t&&t.upload_url,u=t&&t.oid;if(!c||!u)return i({info:{errorType:"upload.disk.no_url_or_oid"},additionalInfo:t&&JSON.stringify(t),status:n.c.FAILED}),void Object(s.a)(e.file,{handlerName:a,isOk:!1});e.narod={oid:u,url:c},Object(s.a)(e.file,{handlerName:a,isOk:!0}),e.file&&r()}(e,t[0].getData(),{onError:o,onSuccess:r})},function(t){var r=t&&t.invalid&&t.invalid[0]||{},c=r.error&&r.error.code,u=function(e){switch(e){case n.e.STATUS_DISK_FULL:return n.e.DISK_FULL;case n.e.DISK_TECHNICAL_WORK:return n.e.DISK_TECHNICAL_WORK;case n.e.DISK_TRAFFIC_LIMIT:return n.e.DISK_TRAFFIC_LIMIT;default:return n.e.UNKNOWN}}(c);Object(s.a)(e.file,{handlerName:a,isOk:!1,errorCode:c}),o({info:{type:i.ErrorType.Transport,source:i.ErrorSource.Network,block:i.ErrorBlock.Compose,sourceMethod:i.ErrorSourceMethod.ComposeAttach,message:"attach_disk_upload_failed",invalidModel:ns.Model.collectErrorData(r.invalid),rawErrorCode:c},status:n.c.FAILED,errorCode:u,additionalInfo:function(e,t){if(e===n.e.DISK_TRAFFIC_LIMIT&&t&&t.error&&t.error.limit)return{limit:t.error.limit}}(c,r)})})}},1062:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),o.d(t,"LOCAL",function(){return n}),o.d(t,"DISK",function(){return s});var n="local",s="disk"},1063:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),o.d(t,"MB_SIZE",function(){return n}),o.d(t,"GB_SIZE",function(){return s}),o.d(t,"HAS_DISK",function(){return i}),o.d(t,"MAX_TOTAL_ATTACHMENTS_SIZE",function(){return a}),o.d(t,"MAX_SIZE_FOR_SINGLE_FILE",function(){return r}),o.d(t,"IS_CORP",function(){return c});var n=1048576,s=1024*n,i=!Daria.IS_CORP&&-1!==Daria.SIDS.indexOf("59"),a=Daria.IS_CORP?40*n:24*n,r=i?2*s:a,c=Daria.IS_CORP},1064:function(e,t,o){"use strict";var n=o(357),s=o(705),i=o(706),a=o(3);o.n(a);t.a=function(e,t){var o=e.file,r=e.narod,c=t.onError,u=t.onUploadProgress,l=t.onUploadComplete,d=t.onCancelUpload,h=new FormData;h.append("file",o);var p=new XMLHttpRequest;return p.open("POST",r.url,!0),Object(i.a)(p,u),p.onreadystatechange=function(){4===this.readyState&&(0===this.status?d&&d(this):this.status>=200&&this.status<300?l(this):(c({info:{message:"attach_disk_upload_error",type:a.ErrorType.Transport,source:a.ErrorSource.Network,block:a.ErrorBlock.Compose,sourceMethod:a.ErrorSourceMethod.ComposeAttach,status:this.status,responseText:this.responseText},status:n.c.FAILED,errorCode:this.status===n.e.STATUS_DISK_FULL?n.e.DISK_FULL:n.e.UNKNOWN}),Object(s.a)(o,{handlerName:"diskUploadXhr",isOk:!1,errorCode:this.status})))},p.send(h),p}},1065:function(e,t,o){"use strict";var n=o(357),s=o(3);o.n(s);t.a=function(e,t){var o=t.onError,i=t.onUploadProgress,a=t.onUploadComplete;if(e&&e.narod)return ns.forcedRequest("do-attach-file-status",{oid:e.narod.oid}).then(function(t){return function(e,t,o){var i=o.onError,a=o.onUploadProgress,r=o.onUploadComplete,c=t[0].getData(),u=c.operation;if(!u)return void i({info:{errorType:"upload.disk.no_operation"},status:n.c.FAILED,errorCode:n.e.YADISK_ERROR});var l=u.status;switch(l){case"EXECUTING":case"WAITING":a(function(e){var t=(e&&e.stages&&e.stages.stage||[]).filter(function(e){return e&&"kladun_upload"===e.name})[0],o=t&&t.progress;return void 0===o||100===Number(o)?100:o}(u));break;case"FAILED":i(function(e){var t=Number(e&&e.error&&e.error.code);return t===n.e.VIRUS?{info:{errorType:"upload.disk.virus"},status:n.c.VIRUS,errorCode:n.e.VIRUS}:t===n.e.DISK_FULL?{info:{errorType:"upload.disk.quota_limit"},status:n.c.FAILED,errorCode:n.e.DISK_FULL}:{info:{type:s.ErrorType.Transport,source:s.ErrorSource.Request,block:s.ErrorBlock.Compose,sourceMethod:s.ErrorSourceMethod.ComposeAttach,message:"attach_disk_response_unknown"},status:n.c.FAILED,errorCode:n.e.YADISK_ERROR}}(u));break;case"DONE":return function(e,t,o){var i=o.onError,a=o.onUploadComplete,r=t.file;if(r)return function(e,t,o){var i=o.onError,a=o.onUploadComplete;return e.narodUrl=t.meta&&t.meta.short_url,e.size=t.size,e.hash=t.meta&&t.meta.public_hash,function(e){var t=e&&e.meta||{},o=t.preview,n=t.public_hash;return o&&n?ns.Model.get("disk-resources").getPreview(n).always(function(e){return e}):Promise.resolve(o)}(t).then(function(t){e.narodPreview=t,function(e,t){var o=t.onError,i=t.onUploadComplete;delete e.narod,e.narodUrl&&e.size?i():o({info:{type:s.ErrorType.Transport,source:s.ErrorSource.Request,block:s.ErrorBlock.Compose,sourceMethod:s.ErrorSourceMethod.ComposeAttach,message:"attach_disk_no_size_or_no_url",disk_url:e.narodUrl,disk_size:e.size},status:n.c.FAILED,errorCode:n.e.YADISK_ERROR})}(e,{onError:i,onUploadComplete:a})})}(e,r,{onError:i,onUploadComplete:a});i({info:{type:s.ErrorType.Transport,source:s.ErrorSource.Request,block:s.ErrorBlock.Compose,sourceMethod:s.ErrorSourceMethod.ComposeAttach,message:"attach_disk_no_fileinfo"},status:n.c.FAILED,errorCode:n.e.YADISK_ERROR})}(e,u,{onError:i,onUploadComplete:r});default:i({info:{errorType:"unknown_disk_status",status:l},additionalInfo:JSON.stringify(c)})}}(e,t,{onError:o,onUploadProgress:i,onUploadComplete:a})},function(){return o({info:{type:s.ErrorType.Transport,source:s.ErrorSource.Network,block:s.ErrorBlock.Compose,sourceMethod:s.ErrorSourceMethod.ComposeAttach,message:"attach_disk_file_status_failed"},status:n.c.FAILED})})}},1066:function(e,t,o){"use strict";function n(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};clearInterval(e.getProgressTimer)}t.a=function(e,t){n(e),e.getProgressTimer=setInterval(t,1500)},t.b=n},1067:function(e,t,o){"use strict";var n=o(706);t.a=function(e,t){var o=e.name,s=e.file,i=t.uploadUrl,a=t.onUploadProgress,r=t.onUploadComplete,c=new FormData;c.append("Filename",o);var u=new XMLHttpRequest;return u.open("POST",i,!0),Object(n.a)(u,a),u.onreadystatechange=function(){4===this.readyState&&r(this)},c.append("attachment",s,o),a(0),u.send(c),u}},1068:function(e,t,o){"use strict";var n=o(357),s=o(3);o.n(s);t.a=function(e,t){var o=e.info,i=e.previewSupported,a=e.xhr,r=t.onError,c=t.onSuccess,u=t.onAuthFail,l=a.responseText,d={};if(l)try{d=JSON.parse(l)}catch(e){return void r({info:{xhr_status:a.status,xhr_readystate:a.readyState,xhr_length:l?l.length:0,message:"attach_json_parse_error",type:s.ErrorType.Transport,source:s.ErrorSource.Logic,block:s.ErrorBlock.Compose,sourceMethod:s.ErrorSourceMethod.ComposeAttach,responseText:l},status:n.c.FAILED,errorCode:n.e.UNKNOWN})}var h=d.write_attachment;h||!d.error||"AUTH_NO_AUTH"!==d.error.code&&"AUTH_WRONG_GUARD"!==d.error.code||u();var p=h&&h.id,f=h&&h.downloadUrl;if(p&&f){o.att_id=p,o.url=f.replace("http://","//");var m=h&&h.previewUrl;i&&m&&(o.previewHref=o.url+"&no_disposition=y",o.previewSrc=m.replace("http://","//")+"&no_disposition=y"),c()}else r({info:{type:s.ErrorType.Transport,source:s.ErrorSource.Network,block:s.ErrorBlock.Compose,sourceMethod:s.ErrorSourceMethod.ComposeAttach,message:"attach_id_or_url_undefined",xhr_status:a.status,xhr_readystate:a.readyState,xhr_length:l?l.length:0,responseText:l,attId:!!p,downloadUrl:!!f},status:n.c.FAILED,errorCode:n.e.UNKNOWN})}},1069:function(e,t,o){"use strict";var n=o(357);t.a=function(e,t){switch(e.type){case n.d.FILE:return{att_id:e.att_id,hid:e.hid,from_template:e.from_template,template_hid:e.template_hid,template_mid:e.template_mid};case n.d.YADISK:return{disk:t===n.c.COMPLETED?function(e){return Daria.utils.getDiskParams(e)}(e):""}}}},1070:function(e,t,o){"use strict";var n=o(781);t.a=function(e,t){var o=t.onFail,s=t.onSuccess,i=function(e){var t=Object(n.a)(100),o=0;return setInterval(function(){return e(t(o++))},100)}(t.onUploadProgress);return ns.Model.get("disk-resources").attach(e.diskSrcPath,e.name).then(function(t){return function(e,t){return e.narodUrl=t.url,e.hash=t.hash,e.narodPreview?ns.Model.get("disk-resources").getPreview(t.hash).always(function(t){return e.narodPreview=t}):Promise.resolve()}(e,t)}).then(function(){return s()}).fail(function(){return o()}).always(function(){return function(e){clearInterval(e)}(i)})}},1072:function(e,t,o){"use strict";var n=o(136),s=(o.n(n),o(357));t.a=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,o={stid:t.getSTID(),mid:t.params.ids,bid:e.bid,hid:e.hid,name:Object(n.unescape)(e.name),"browser-supports":e["browser-supports"],from_template:e.from_template,template_hid:e.template_hid,template_mid:e.template_mid};return e.narod?(o.narodUrl=e.unsafeUrl,o.size=e.size,o.type=s.d.YADISK,o.folder=Boolean(e.folder),o.narodPreview=e.preview):(o.size=e.length,o.type=s.d.FILE,o.class=e.class,o.message=Boolean(e.message),o.external_transformer=e.external_transformer,o.external_transformer_filetype=e.external_transformer_filetype),o}},1073:function(e,t,o){"use strict";var n=o(357);t.a=function(e){return e.type===n.d.YADISK?Boolean(e.narodPreview):Boolean(e.extension.preview)||"audio"===e.class&&"mp3"===e.extension.icon}},1080:function(e,t,o){"use strict";var n=o(357),s=o(457);t.a=function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=t.meta,i=o&&o.mediatype||"unknown";"image"===i&&(e=o&&o.preview);var a,r=t.type===s.d;return a=r?o&&o.group&&o.group.size:o&&o.size,{name:t.name,type:n.d.YADISK,size:a,narodPreview:e,folder:r,mediaType:i,diskSrcPath:t.id}}},1081:function(e,t,o){"use strict";var n=o(357),s=o(479),i=function(e){return e.map(function(e){return Object(s.a)(e.info)||0}).reduce(function(e,t){return e+t},0)};t.a=function(e){var t=e.filter(function(e){return e.info.type===n.d.FILE}),o=e.filter(function(e){return e.info.type===n.d.YADISK}),s=e.filter(function(e){return e.info.type===n.d.FORWARDED_MAIL}).map(function(e){return e.info.mid});return{hasAttachments:e.length>0,fileAttachmentsCount:t.length,fileAttachmentsSize:i(t),diskAttachmentsCount:o.length,diskAttachmentsSize:i(o),forwardedMailsAttachmentsCount:s.length,relatedMailIds:s}}},1082:function(e,t,o){"use strict";var n=o(357),s=o(587);t.a=function(e){var t,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2?arguments[2]:void 0;return e.type!==n.d.YADISK&&(e.att_id?t=o.filter(function(t){return t.att_id===e.att_id})[0]:e.hid&&(t=o.filter(function(t){return t.old_hid===e.hid})[0]),!!t&&(e.from_template=void 0,e.template_hid=void 0,e.template_mid=void 0,e.att_id=void 0,e.url=void 0,e.hid=t.hid,e.mid=i,e.id=Object(s.a)(e),o.splice(o.indexOf(t),1),!0))}},1083:function(e,t,o){"use strict";function n(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}o.d(t,"a",function(){return s});var s=function(){function e(t,o){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.isOn=!1,this.wasPageHidden=!1,this.prevTime=null,this.fpsLevels=[],this.counters={},this._onPageVisibilityChanged=function(e,t){n.wasPageHidden=n.wasPageHidden||!t.value},this.area=t,this.fpsLevels=Object.keys(o).map(function(e){return{key:e,value:o[e]}}).sort(function(e,t){return e.value-t.value}),this._resetCounters()}return function(e,t,o){t&&n(e.prototype,t),o&&n(e,o)}(e,[{key:"_hasPerformance",value:function(){return Boolean(window.performance&&window.performance.now)}},{key:"_resetCounters",value:function(){var e=this;this.counters={total:0},this.fpsLevels.forEach(function(t){return e.counters[t.key]=0})}},{key:"processFrame",value:function(){var e=performance.now();if(this.prevTime&&!this.wasPageHidden){var t=e-this.prevTime,o=Math.round(1e3/t),n="";if(this.fpsLevels.some(function(e){return n=e.key,e.value>=o})&&this.counters.hasOwnProperty(n)){var s=Math.floor(t/(1e3/30));this.counters[n]+=s}this.counters.total++}this.prevTime=e,this.wasPageHidden=!1}},{key:"start",value:function(){var e=this;this.stop(),this._resetCounters(),this.isOn=this._hasPerformance(),this.prevTime=null;!function t(){e.isOn&&(e.processFrame(),requestAnimationFrame(t))}(),ns.events.on("pageVisible.change",this._onPageVisibilityChanged)}},{key:"stop",value:function(){this.isOn=!1,ns.events.off("pageVisible.change",this._onPageVisibilityChanged)}},{key:"logCounters",value:function(){this._hasPerformance()&&Daria.monitoring.performance.fps(this.area,this.counters)}},{key:"finish",value:function(){this.stop(),this.logCounters()}}]),e}();s.defaultConfig={slow:30,freeze:5}},1120:function(e,t){},1121:function(e,t,o){"use strict";var n=o(1122);o.d(t,"a",function(){return n.a})},1122:function(e,t,o){"use strict";o.d(t,"a",function(){return P});var n,s,i,a,r=o(135),c=o.n(r),u=o(338),l=o.n(u),d=o(339),h=o.n(d),p=o(341),f=o(342),m=o(719),g=o.n(m),b=o(1123),_=o(760),v=o(503),y=o(1124),C=o(367),S=o(1125);o.n(S);function E(){return(E=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e}).apply(this,arguments)}function D(e){"@babel/helpers - typeof";return(D="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function M(e,t){if(null==e)return{};var o,n,s=function(e,t){if(null==e)return{};var o,n,s={},i=Object.keys(e);for(n=0;n<i.length;n++)o=i[n],t.indexOf(o)>=0||(s[o]=e[o]);return s}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)o=i[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(s[o]=e[o])}return s}function w(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function A(e,t){return!t||"object"!==D(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function k(e){return(k=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function T(e,t){return(T=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function O(e,t,o,n){a||(a="function"==typeof Symbol&&Symbol.for&&Symbol.for("react.element")||60103);var s=e&&e.defaultProps,i=arguments.length-3;if(t||0===i||(t={children:void 0}),1===i)t.children=n;else if(i>1){for(var r=new Array(i),c=0;c<i;c++)r[c]=arguments[c+3];t.children=r}if(t&&s)for(var u in s)void 0===t[u]&&(t[u]=s[u]);else t||(t=s||{});return{$$typeof:a,type:e,key:void 0===o?null:""+o,ref:null,props:t,_owner:null}}var F=function(){return Jane.Services.runModules(["disk-resources.js","disk-resources.css"]).then(function(){return Daria.React.DiskResourcesContainer})},I=O("div",{className:"diskResources-Placeholder"},void 0,O(v.a,{size:"m"})),P=Object(f.inject)("services")(n=Object(f.observer)((i=s=function(e){function t(){var e,o;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);for(var n=arguments.length,s=new Array(n),i=0;i<n;i++)s[i]=arguments[i];return(o=A(this,(e=k(t)).call.apply(e,[this].concat(s))))._disposer=new C.a,o._shortcutsConnected=!1,o}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&T(e,t)}(t,c.a.Component),function(e,t,o){t&&w(e.prototype,t),o&&w(e,o)}(t,[{key:"_renderPlaceholder",value:function(){return I}},{key:"componentDidMount",value:function(){var e=this;this._togglePageInteraction(this.props.isVisible),this._disposer.add(this,Object(p.reaction)(function(){return e.props.isVisible},function(t){return e._togglePageInteraction(t)}))}},{key:"componentWillUnmount",value:function(){this.props.isVisible&&this._togglePageInteraction(!1),this._disposer.dispose(this)}},{key:"_togglePageInteraction",value:function(e){Object(y.a)(e),this.toggleSelectionOutside(!e),this.toggleShortcuts(e)}},{key:"toggleSelectionOutside",value:function(e){document.body.onselectstart=function(){return e}}},{key:"toggleShortcuts",value:function(e){e?$.Shortcuts.modalListPush("disk-resources")&&(this._shortcutsConnected=!0):this._shortcutsConnected&&($.Shortcuts.modalListPop("disk-resources"),this._shortcutsConnected=!1)}},{key:"render",value:function(){var e=this.props,t=e.isVisible,o=e.onClose,n=M(e,["isVisible","onClose"]),s=this.props.services.settings.isMobile;n.isMobile=s;var i=h()("diskResources",s?"diskResources_mobile":"diskResources_desktop");return O(g.a,{cls:i,visible:t,fullscreen:!0,onClose:o},void 0,O("div",{className:"diskResources-Content"},void 0,c.a.createElement(_.a,E({},n,{loader:F,renderPlaceholder:this._renderPlaceholder}))))}}]),t}(),s.displayName="DiskResources",s.propTypes={isVisible:l.a.bool,services:b.a.isRequired,scope:l.a.instanceOf(Element),onClose:l.a.func},n=i))||n)||n},1123:function(e,t,o){"use strict";var n=o(338),s=o.n(n);t.a=s.a.shape({settings:s.a.shape({isMobile:s.a.bool})})},1124:function(e,t,o){"use strict";t.a=function(e){Daria.toggleVerticalScrollBar(e),Daria.toggleHorizontalScrollBar(e)}},1125:function(e,t){},1133:function(e,t,o){var n=o(786).SEPARATORS,s=new RegExp("["+Object.keys(n).join("")+"]","g");var i={tokenizer:function(e){return"string"!=typeof e?[]:e.split(s).filter(function(e){return Boolean(e)})},update:function(e){new(this||Daria.BaseBubble)(e).applyTo(e)},node2object:function(e){var t=(this||Daria.BaseBubble).toString(e),o=t.indexOf('"');o=-1!==o?o+1:0;var n=t.lastIndexOf('"');return{text:t,startOffset:o,endOffset:n=n>o?n:t.length}},getCopyString:function(e){var t=Daria.Constants.CONTACTS.DELIMITER,o=this||Daria.BaseBubble;return e.map(o.toString,o).join(t)},checkPaste:function(){return!0},checkDrop:function(e){var t=this||Daria.BaseBubble;return Array.isArray(e)&&e.every(function(e){return e.className.split(" ").indexOf(t.BUBBLE_CLASS)>-1})},toString:function(e){return _.unescape(e.getAttribute("data-yabble-value"))||e.innerText}};e.exports=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t){var o=Object.assign({},i,e);return Object.keys(o).forEach(function(e){t[e]=o[e].bind(t)}),t}}},1532:function(e,t,o){"use strict";var n=o(3202);t.a={DEBOUNCES:n.a}},1533:function(e,t,o){"use strict";var n=o(407);function s(e,t,o,n,s,i,a){try{var r=e[i](a),c=r.value}catch(e){return void o(e)}r.done?t(c):Promise.resolve(c).then(n,s)}function i(){return(i=function(e){return function(){var t=this,o=arguments;return new Promise(function(n,i){var a=e.apply(t,o);function r(e){s(a,n,i,r,c,"next",e)}function c(e){s(a,n,i,r,c,"throw",e)}r(void 0)})}}(regeneratorRuntime.mark(function e(t){var o,s,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.save({force:!0});case 3:return o=t.get(".overwrite"),s=o?{ids:o}:t.params,e.next=7,Daria.forceRefreshModelsForCompose(s);case 7:i=ns.page.history.getPreviousPageUrl({mismatch:"compose2"}),Daria.enableReactiveCompose(!0),ns.page.go(i||"#").always(function(){Daria.startScenarioForCompose(n.c)}),e.next=14;break;case 12:e.prev=12,e.t0=e.catch(0);case 14:case"end":return e.stop()}},e,null,[[0,12]])}))).apply(this,arguments)}t.a=function(e){return i.apply(this,arguments)}},203:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(3067);o.n(n);Jane.module("compose2.js",function(){ns.View.prototype.composeUpdate=function(){this.info&&!this.info.isCollection&&this.invalidate(),this.isVisible()&&this.getModel("compose-state").trigger("ns-model:compose:update")},Daria.composeEqualRoutes=function(e,t){var o=_.omit(t.params,["_cuid"]),n=_.omit(e.params,["_cuid"]);return!(e.page!==t.page||!_.isEqual(n,o))},o(3068),o(3071),o(3072),o(3095),o(3119),o(3120),o(3633),o(3634)})},3067:function(e,t){},3068:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(3069);Daria.utils=Daria.utils||{},Daria.utils.dirname=function(e){var t="/"===(e=e||"").charAt(0),o=$.grep(e.split("/"),function(e){return e.length});return o.pop(),(t?"/":"")+o.join("/")},Daria.utils.checkReplaceFakeMessage=function(e){if("message"===ns.page.current.page)return!1;if("yes"!==ns.page.current.params.threaded)return!1;if(!ns.Model.get("settings").isThreaded())return!1;var t=no.jpath(".message.hdr_message_id",e),o=no.jpath(".message.mid",e),n=no.jpath(".message.thread_id",e);return!!(n&&t&&o)&&!!ns.Model.get("messages",{thread_id:"t"+n}).isValid()},Daria.utils.getDiskParams=n.a},3069:function(e,t,o){"use strict";var n=o(3070),s=o.n(n),i=o(426),a=o.n(i),r=o(353);t.a=function(e){return s()({name:e.name,url:e.narodUrl,preview_url:e.previewSrc,size:e.size?Number(e.size):null,folder:e.folder?Object(r.default)("compose-react/Attachments_Disk_folder"):null,hash:e.hash},a.a)}},3071:function(e,t){Daria.UI=Daria.UI||{},Daria.UI.IEvent=function(e){e=e||{};var t={},o={},n={},s={};function i(o){return t[o]||(s[o]=e[o]||"unique",t[o]=$.Callbacks(s[o])),t[o]}function a(e){if(n[e]){for(var t=0,o=n[e].length;t<o;t++)i(e).add(n[e][t]);delete n[e]}}return{_events:{lock:function(e){o[e]=!0,n[e]=[]},unlock:function(e){delete o[e]},empty:function(e){e?(i(e).empty(),delete n[e]):(t={},n={})}},on:function(e,t){o[e]?-1===$.inArray(t,n[e])&&n[e].push(t):i(e).add(t);return this},off:function(e,t){if(o[e]){var s=$.inArray(t,n[e]);-1!==s&&n[e].splice(s,1)}return i(e).remove(t),this},trigger:function(e,t){if(!o[e]){var n=s[e]&&-1!==s[e].indexOf("memory");n||a(e),i(e).fireWith(this,t),n&&a(e)}return this}}}},3072:function(e,t,o){Daria.ComposeComponents={},o(3073),o(3074),o(3075),o(3077),o(3078),o(3079),o(3080),o(3081),o(3082),o(3083),o(3084),o(3085),o(3086),o(3087),o(3088),o(3090),o(3091),o(3092),o(3093),o(3094)},3073:function(e,t){ns.action.define("attachments.retry",function(e,t){ns.events.trigger("daria:vComposeAttachArea:retryAttach",t)})},3074:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(782),s=o(1067),i=o(1065),a=o(1064),r=o(707),c=o(1061),u=o(1070),l=o(1068),d=o(783),h=o(1072),p=o(1082),f=o(357),m=o(1066),g=o(357);function b(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),o.push.apply(o,n)}return o}function v(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?b(Object(o),!0).forEach(function(t){y(e,t,o[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):b(Object(o)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))})}return e}function y(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function C(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function S(e,t,o){return t&&C(e.prototype,t),o&&C(e,o),e}!function(){var e={ATTACHING_TO_DISK:"ATTACHING_TO_DISK",ATTACHING_TO_DISK_FAILED:"ATTACHING_TO_DISK_FAILED"},t=function(){function t(e,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.bindMethodsToContext(),this._collection=o,this._aborted=!1,this.deleted=!1,this._uploadDeferred=$.Deferred(),this._requests=[];var n=Object(d.a)(e),s=n.info,i=n.previewSupported,a=n.status;this.info=s,this.previewSupported=i,this.status=a,ns.assert(s.mComposeMessage,"Daria.Attachment2",'"mComposeMessage" parameter is not passed to the constructor'),this.mComposeMessage=s.mComposeMessage}return S(t,null,[{key:"fromMessageBody",value:function(e,o,n){var s=Object(h.a)(e,o);return s.mComposeMessage=n,new t(s)}}]),S(t,[{key:"bindMethodsToContext",value:function(){this._updateShrinker=this._updateShrinker.bind(this)}},{key:"isCancelled",value:function(){return this._aborted||this.deleted}},{key:"setNode",value:function(e){return this._$node&&this._$node.replaceWith(e),this._$node=e,this.bindEvents(),_.defer(this._updateShrinker),this.status===f.c.FAILED&&this.setStatus(f.c.FAILED),this._addToComposeMessage(),this.trigger("update"),this}},{key:"bindEvents",value:function(){this._$node&&this._$node.on("click",".js-mark-deleted",this.markDeleted.bind(this)).on("click",".js-unmark-deleted",this.unmarkDeleted.bind(this)).on("click",".js-retry",this.retry.bind(this))}},{key:"getNode",value:function(e){if(e||!this._$node){var t=this._collection?this._collection.templateMode:"compose2:attachments",o=Jane.tt(t,{attachment:[this.getJSONForTransform()]});this.setNode($(o.firstChild))}return this._$node}},{key:"getJSONForTransform",value:function(){return Object(n.a)(this.info,{status:this.status,previewSupported:this.previewSupported})}},{key:"_updateShrinker",value:function(){var e=this.getNode().find(".b-shrinker");if(e[0]){var t=e.find(".b-shrinker__right").width();e.css("margin-right",t)}}},{key:"markDeleted",value:function(){return this.status===f.c.COMPLETED&&this.info.type===f.d.YADISK?(this.getNode().removeClass("b-file_deletable").addClass("b-file_deleted"),this.deleted=!0,this._removeFromComposeMessage(),!1):(this.forceRemove(),!0)}},{key:"forceRemove",value:function(){this.remove(),this._uploadDeferred.reject()}},{key:"unmarkDeleted",value:function(){this.getNode().removeClass("b-file_deleted").addClass("b-file_deletable"),this._addToComposeMessage(),this.deleted=!1}},{key:"removeIfMarked",value:function(){return!!this.deleted&&(this.remove(),!0)}},{key:"stop",value:function(){this.status!==f.c.COMPLETED&&(this.getNode().remove(),this._aborted=!0,this._requests.forEach(function(e){e instanceof Vow.Promise?e.notify("abort"):e.abort&&e.abort()}),this.info.diskSrcPath&&ns.Model.get("disk-resources").removeAttach(this.info.diskSrcPath),this._stopNarod(),this._requests=[])}},{key:"_stopNarod",value:function(){this.info.narod&&(Object(m.b)(this.info.narod),delete this.info.narod)}},{key:"remove",value:function(){this._removeFromComposeMessage(),this.stop(),this.getNode().remove(),this.deleted=!1,this.trigger("attachment.removed",this)}},{key:"metrika",value:function(t){var o=[],n=this.info.folder;switch(t){case e.ATTACHING_TO_DISK:o.push(["Аттачи из Диска","Прикрепление",n?"Папка":"Файл"]),n||o.push(["Аттачи из Диска","Типы файлов",this.info.mediaType]),Jane.Metrika.counter&&Jane.Metrika.counter.reachGoal("ATTACHFROMDISK");break;case e.ATTACHING_TO_DISK_FAILED:o.push(["Аттачи из Диска","Ошибка загрузки"])}o.forEach(function(e){Jane.c.apply(null,e)})}},{key:"attachFromYaDisk",value:function(){var t=this;return this.setStatus(f.c.UPLOADING),this.retry=function(){return t.attachFromYaDisk()},this.metrika(e.ATTACHING_TO_DISK),Object(u.a)(this.info,{onUploadProgress:this._onUploadProgress.bind(this),onSuccess:function(){return t._onUploadSuccess(!0)},onFail:function(){t.metrika(e.ATTACHING_TO_DISK_FAILED),t.setStatus(f.c.FAILED)}})}},{key:"upload",value:function(){return this.status=f.c.UPLOADING,this.info.type===f.d.YADISK?this._fileUploadDisk():this.info.file&&this._fileUploadXHR(),this._uploadDeferred}},{key:"_getUploadUrl",value:function(){return Daria.url.upload()}},{key:"_onUploadProgress",value:function(e){if(this.status!==f.c.FAILED){var t=e>=0&&e<100;this._setBlockMod(t?"loading":"wait"),this.getNode().find(".js-progress").width("".concat(t?e:100,"%"))}}},{key:"_getDiskProgress",value:function(){var e=this;return Object(i.a)(this.info,{onError:function(t){var o=t.info,n=t.status,s=t.errorCode;Object(m.b)(e.info.narod),Jane.ErrorLog.log(v({},o,{method:"_getDiskProgress"})),e.setStatus(n,s)},onUploadProgress:this._onUploadProgress.bind(this),onUploadComplete:function(){Object(m.b)(e.info.narod),e._onUploadSuccess(!0)}})}},{key:"_simpleUploadComplete",value:function(e){var t=this;this._removeRequest(e),Object(l.a)({info:this.info,previewSupported:this.previewSupported,xhr:e},{onAuthFail:function(){return Jane.doLogin("upload_attachment")},onError:function(e){var o=e.info,n=e.status,s=e.errorCode;o.aborted=t._aborted,t._aborted||Jane.ErrorLog.log(v({},o,{method:"_simpleUploadComplete"})),t.setStatus(n,s)},onSuccess:function(){return t._onUploadSuccess(!0)}})}},{key:"_setBlockMod",value:function(e){e=e||"";var t=this.getNode();t.removeClass("b-file_wait b-file_loading b-file_error"),e&&t.addClass("b-file_"+e)}},{key:"setStatus",value:function(e,t){this.status=e,e===f.c.FAILED?(this._onUploadFail(t),this._setBlockMod("error")):e===f.c.VIRUS?(this._onUploadFail(t),this._setBlockMod("virus")):(delete this._failErrorCode,this._setBlockMod(""))}},{key:"retry",value:function(){Daria.Dialog.close(),this.setStatus(f.c.NEW),this._setBlockMod("wait"),this._uploadDeferred=$.Deferred()}},{key:"_onUploadSuccess",value:function(e){this.isCancelled()?this._uploadDeferred.reject():(this.previewSupported&&Object(r.a)(this.info),this.setStatus(f.c.COMPLETED),this.getNode(e),this._addToComposeMessage(),this._uploadDeferred.resolve())}},{key:"_addToComposeMessage",value:function(){this.mComposeMessage.addAttachment(this)}},{key:"_removeFromComposeMessage",value:function(){this.mComposeMessage.removeAttachment(this.info.id)}},{key:"_onUploadFail",value:function(e){var t,o=(y(t={},f.e.UNKNOWN,i18n("%Attachments_Error_Code_0")),y(t,f.e.FILE_LIMIT,this._getSizeError({prod:"%Attachments_Error_Code_1_prod",corp:"%Attachments_Error_Code_1_corp",prodNoDisk:"%Attachments_Error_Code_1_nodisk_prod"})),y(t,f.e.TOTAL_LIMIT,this._getSizeError({prod:"%Attachments_Error_Code_2_prod",corp:"%Attachments_Error_Code_2_corp",prodNoDisk:"%Attachments_Error_Code_2_prod_no_disk"})),y(t,f.e.VIRUS,i18n("%Attachments_Error_Code_106_full")),y(t,f.e.DISK_FULL,i18n("%Attachments_Error_Code_507",Daria.url.cleanUpYaDisk(),Daria.url.increaseYaDiskSize(),"b-pseudo-link")),t);e===f.e.VIRUS&&this.getNode(!0),(e=e||this._failErrorCode||f.e.UNKNOWN)in o||(e=f.e.UNKNOWN),this._failErrorCode=e;var n=o[e]+(e===f.e.UNKNOWN?'  <a class="b-pseudo-link ns-action" data-click-action="attachments.retry" data-params="id='+this.info.id+'">'+i18n("%Повторить")+"</a>":"");this.getNode().find(".b-file__fail").attr("data-params","width=30em&side=top&text="+encodeURIComponent(n)),this._aborted||(this.trigger("attachment.failed"),Jane.ErrorLog.send({errorType:"UploadFail",aborted:this._aborted,fileName:this.info.name,uploaderType:this.info.type,errorCode:e})),this._uploadDeferred.reject()}},{key:"_getSizeError",value:function(e){var t=e.prod,o=e.corp,n=e.prodNoDisk;if(g.a.HAS_DISK)return i18n(t);var s=g.a.MAX_SIZE_FOR_SINGLE_FILE/g.a.MB_SIZE;return g.a.IS_CORP?i18n(o,s):i18n(n,s,Daria.url.signUpDisk(),"b-pseudo-link")}},{key:"_diskUploadXHR",value:function(){var e=this,t=Object(a.a)(this.info,{onUploadProgress:this._onUploadProgress.bind(this),onUploadComplete:function(){e._removeRequest(t),e.info.narod&&Object(m.a)(e.info.narod,e._getDiskProgress.bind(e))},onError:function(o){var n=o.info,s=o.status,i=o.errorCode;e._removeRequest(t),e._aborted||Jane.ErrorLog.log(v({},n,{method:"_diskUploadXHR"})),e.setStatus(s,i)}});this._requests.push(t)}},{key:"_removeRequest",value:function(e){Jane.Array.remove(this._requests,e)}},{key:"_fileUploadXHR",value:function(){var e=Object(s.a)(this.info,{uploadUrl:this._getUploadUrl(),onUploadProgress:this._onUploadProgress.bind(this),onUploadComplete:this._simpleUploadComplete.bind(this)});this._requests.push(e)}},{key:"_fileUploadDisk",value:function(){var e=this,t=Object(c.a)(this.info,{onError:function(o){var n=o.info,s=o.status,i=o.errorCode;e._removeRequest(t),e._aborted||Jane.ErrorLog.log(v({},n,{method:"_fileUploadDisk"})),e.setStatus(s,i)},onSuccess:function(){return e._diskUploadXHR()}}).always(function(){return e._removeRequest(t)});this._requests.push(t),this._onUploadProgress(0)}},{key:"updateInfo",value:function(e,t){var o=Object(p.a)(this.info,e,t);return o&&(this._removeFromComposeMessage(),this._onUploadSuccess()),o}}]),t}();t.AttachStatus=f.c,t.METRIKA_EVENTS=e,_.extend(t.prototype,ns.Events),Daria.Attachment2=t}()},3075:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(357),s=o(3076),i=o(479),a=o(1080),r=o(1081);function c(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),o.push.apply(o,n)}return o}function u(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}!function(e,t){var o=t.AttachmentCollection2=function(e){this.bindMethodsToContext(),this._attachments={},this._totalAttachmentsSize=0,this._id=t.getRandomNumber(),this._init=!1,e&&this.setOptionsAndInit(e)};o.prototype={MAX_ATTACH_SIZE:n.a.MAX_TOTAL_ATTACHMENTS_SIZE,HAS_DISK:n.a.HAS_DISK,setOptionsAndInit:function(e){ns.assert(e,"Daria.AttachmentCollection2",'"options" parameter is not passed to the #setOptions method'),this.options=e,ns.assert(e.node||e.$node,"Daria.AttachmentCollection2",'neither "options.node" nor "options.$node" parameter is passed to the #setOptions method'),this.$node=$(e.node||e.$node),ns.assert(e.mComposeMessage,"Daria.AttachmentCollection2",'"options.mComposeMessage" parameter is not passed to the #setOptions method'),this.mComposeMessage=e.mComposeMessage,ns.assert(e.mComposeState,"Daria.AttachmentCollection2",'"options.mComposeState" parameter is not passed to the #setOptions method'),this.mComposeState=e.mComposeState,this.templateMode=e.templateMode||"compose2:js-attachments-collection",this.$files=this.$node.find(".js-compose-attachments-container");var t={_$attsImg:".js-compose-attachments-images",_$attsRecent:".js-compose-attachments-common",_$attsNarodCommon:".js-compose-attachments-narod-common",_$attsNarodImages:".js-compose-attachments-narod-images",_$attsDiskInfo:".js-compose-attachments-narod-header"};_.keys(t).forEach(function(e){this[e]=this.$files.find(t[e])},this),this._init=!0,this.checkVisibility()},_appendAttach:function(e,t,o){var s=e.getNode(t);e.previewSupported?e.info.type===n.d.YADISK?this._$attsNarodImages.append(s):this._$attsImg.append(s):e.info.type===n.d.FILE?this._$attsRecent.append(s):this._$attsNarodCommon.append(s),o||(this.checkVisibility(),this.trigger("attachments.appended",e))},addAttachToCollection:function(e,t){(t=t||{}).processAttachSize=!_.isBoolean(t.processAttachSize)||t.processAttachSize,this._attachments[e.info.id]=e,t.processAttachSize&&this._processAttachmentSize(e),t.silent||this.trigger("attachments.added",e),this.bindEventsToAttach(e)},removeAttachFromCollection:function(e,t){t=t||{},this.unbindEventsFromAttach(e),this._reduceAttachmentsSize(e),this.checkVisibility(),delete this._attachments[e.info.id],t.silent||this.trigger("attachments.removed",e)},bindMethodsToContext:function(){this.onAttachmentUpdated=this.onAttachmentUpdated.bind(this),this.onAttachmentRemoved=this.onAttachmentRemoved.bind(this),this.onAttachmentFailed=this.onAttachmentFailed.bind(this),this._processAttachmentSize=this._processAttachmentSize.bind(this)},bindEventsToAttach:function(e){e.on("update",this.onAttachmentUpdated),e.on("attachment.removed",this.onAttachmentRemoved),e.on("attachment.failed",this.onAttachmentFailed)},unbindEventsFromAttach:function(e){e.off("update",this.onAttachmentUpdated),e.off("attachment.removed",this.onAttachmentRemoved),e.off("attachment.failed",this.onAttachmentFailed)},onAttachmentUpdated:function(){this.trigger("attachments.updated")},onAttachmentRemoved:function(e,t){this.removeAttachFromCollection(t)},onAttachmentFailed:function(){this.trigger("attachments.failed")},checkVisibility:function(){var e=this._$attsImg.find("> .b-file").length,t=this._$attsRecent.find("> .b-file").length,o=this._$attsNarodCommon.find("> .b-file").length,n=this._$attsNarodImages.find("> .b-file").length;this._$attsDiskInfo.toggleClass("g-hidden",o+n===0),this._$attsImg.toggleClass("g-hidden",0===e),this._$attsRecent.toggleClass("g-hidden",0===t),this._$attsNarodCommon.toggleClass("g-hidden",0===o),this._$attsNarodImages.toggleClass("g-hidden",0===n)},isCompleted:function(){return _.every(this._attachments,function(e){return e.status!==n.c.NEW&&e.status!==n.c.UPLOADING})},isUploading:function(){for(var e in this._attachments){var t=this._attachments[e];if(!t.isCancelled()&&t.status===n.c.UPLOADING)return!0}return!1},isFailed:function(){return _.some(this._attachments,function(e){return e.status===n.c.FAILED})},hasFiles:function(){return!$.isEmptyObject(this._attachments)},reset:function(){if(this._init){for(var e in this.$node.off(),this.off(),$(document).off(".compose"),this._attachments)this._attachments[e].remove();this._attachments={},this._$attsImg.addClass("g-hidden").empty(),this._$attsRecent.addClass("g-hidden").empty(),this._$attsNarodCommon.addClass("g-hidden").empty(),this._$attsNarodImages.addClass("g-hidden").empty(),this.$dropzone&&this.$dropzone.remove()}},add:function(e,t){this.removeMarkedAsDeleted(),t?this._addAttaches(e,t):this._addAttach(e)},_addAttaches:function(e,o){for(var i=[],a=[],r=0,c=o.length;r<c;r++){var u=new t.Attachment2({mComposeMessage:this.mComposeMessage,input:e,file:o[r]},this);u.info.type=n.d.FILE,this.addAttachToCollection(u,{processAttachSize:!1}),a.push(Object(s.a)(u.info.file)),i.push(u)}$.when.apply(null,a).done(function(){for(var e=[],t=0,o=arguments.length;t<o;t++)if(!1!==arguments[t]){var n=i[t];this._attachments[n.info.id]=n,e.push(n),this._processAttachmentSize(n)}this.redrawAttachesBulk(e),this._uploadQueue()}.bind(this))},_processAttachmentSize:function(e){if(e.info.type===n.d.FILE){var t=Object(i.a)(e.info);if(t>this.MAX_FILE_SIZE)e.setStatus(n.c.FAILED,n.e.FILE_LIMIT);else{var o=Number(t)+this._totalAttachmentsSize,s=o<this.MAX_ATTACH_SIZE,a=this.HAS_DISK;if(!(e.status===n.c.NEW))return this._totalAttachmentsSize=o,void(e.inSize=!0);s?(e.inSize=!0,this._totalAttachmentsSize=o):a?(e.info.type=n.d.YADISK,"audio"===e.info.class&&(e.previewSupported=!1)):e.setStatus(n.c.FAILED,n.e.TOTAL_LIMIT)}}},getAttaches$Html:function(t,o,n){for(var s=[],i=0,a=t.length;i<a;i++)s.push(t[i].getJSONForTransform());var r={"collection-id":this._id,attachment:s};return o&&(r.mid=o),n&&(r=$.extend({},r,n)),$(e.tt(this.templateMode,r))},redrawAttachesBulk:function(e,t,o){e||(e=_(this._attachments).chain().values().filter(function(e){return!e.isCancelled()}).value());var n=this.getAttaches$Html(e,t);this._appendAttachBulk(e,n,o)},_appendAttachBulk:function(e,t,o){if(e.length){for(var n=0,s=e.length;n<s;n++){var i=e[n],a=i.info.id,r=t.find("#att_"+this._id+"_"+a);i.setNode(r),this._appendAttach(i,!1,!0)}o||(this.checkVisibility(),this.trigger("attachments.appended",e))}},_addAttach:function(e,o){var s=new t.Attachment2({mComposeMessage:this.mComposeMessage,input:e,file:o},this);s.info.type=n.d.FILE,this.addAttachToCollection(s,{processAttachSize:!1}),this._processAttachmentSize(s),this._appendAttach(s,!0),this._scrollToAttachInput(),this._uploadQueue()},addDiskAttach:function(e,o){var s=this,i=new t.Attachment2(function(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?c(Object(o),!0).forEach(function(t){u(e,t,o[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):c(Object(o)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))})}return e}({},Object(a.a)(o),{mComposeMessage:this.mComposeMessage}),this);i.info.type=n.d.YADISK,this.addAttachToCollection(i,{processAttachSize:!1}),this._appendAttach(i,!0),i.attachFromYaDisk().then(function(){s._uploadQueue()}),this.removeMarkedAsDeleted()},_uploadQueue:function(){var e,t=this;for(var o in this._attachments){var s=this._attachments[o];if(s.status===n.c.UPLOADING)return!1;if(!e&&s.status===n.c.NEW){s.removeIfMarked()?(this._reduceAttachmentsSize(s),delete this._attachments[o]):e=s;break}}e?this.isUploading()||e.upload().always(function(){e.info.type===n.d.YADISK&&e._addToComposeMessage(),e.status===n.c.FAILED&&t._reduceAttachmentsSize(e),Promise.resolve().then(function(){t._uploadQueue()})}):ns.events.trigger("attachments.all-uploaded")},removeMarkedAsDeleted:function(){for(var e in this._attachments){var t=this._attachments[e];t.removeIfMarked()&&(this._reduceAttachmentsSize(t),delete this._attachments[e])}this.checkVisibility(),this.isUploading()||ns.events.trigger("attachments.all-uploaded")},_reduceAttachmentsSize:function(e){if(e.inSize){e.inSize=!1;var t=Object(i.a)(e.info);this._totalAttachmentsSize-=t}},updateAfterSave:function(e,t,o){if(e){var n=[],s={};_.each(this._attachments,function(o,i){if(o.updateInfo(e,t)){var a=o.info.id;s[a]=o,n.push(o)}else s[i]=o}),this._attachments=s,this.redrawAttachesBulk(n,t,o)}},stopUploading:function(){for(var e in this._attachments)this._attachments[e].stop();this.checkVisibility()},retryAttach:function(e){var t=this._attachments[e];t&&(t.retry(),this._uploadQueue())},getSummary:function(){var e=this,t=Object.keys(this._attachments).map(function(t){return e._attachments[t]});return Object(r.a)(t)}},_.extend(o.prototype,ns.Events),o.prototype.MAX_FILE_SIZE=n.a.MAX_SIZE_FOR_SINGLE_FILE}(Jane,Daria)},3076:function(e,t,o){"use strict";t.a=function(e){if(!e||Modernizr.webkit)return Promise.resolve(!0);if(!window.FileReader){var t=e.size,o=0===t||102===t||4096===t;return Promise.resolve(!(o&&""===e.type&&-1===e.name.indexOf(".")))}return window.opera&&navigator.platform.toLowerCase().indexOf("mac")>-1&&"12.00"===window.opera.version()?Promise.resolve(null):e.size>4096?Promise.resolve(!0):new Promise(function(t){try{var o=new FileReader;o.onerror=function(){o.onloadend=o.onprogress=o.onerror=null,t(!1)},o.onloadend=o.onprogress=function(e){o.onloadend=o.onprogress=o.onerror=null;try{"loadend"!==e.type&&o.abort()}catch(e){}t(!0)},o.readAsDataURL(e)}catch(e){t(!1)}})}},3077:function(e,t){!function(){function e(e,t){this.$node=e,this.selector=t,this.$target=null,this.currentValue=""}$.fn.startEmulateInputEvent=function(t){return"string"==typeof t?this.each(function(){var o=$(this),n=new e(o,t);n.init(),o.data("inputEmulator",n)}):this},$.fn.stopEmulateInputEvent=function(){return this.each(function(){var t=$(this),o=t.data("inputEmulator");o instanceof e&&o.destroy(),t.data("inputEmulator",null)})},e.prototype.$doc=$(document),e.prototype.init=function(){"string"==typeof this.selector&&this.$node.on("focusin.inputEmulator",this.selector,this.startEmulate.bind(this)).on("focusout.inputEmulator",this.selector,this.stopEmulate.bind(this))},e.prototype.destroy=function(){this.stopEmulate(),this.$node.off(".inputEmulator")},e.prototype.startEmulate=function(e){this.$target=$(e.currentTarget),this.currentValue=this.$target.val(),this.$target.on("keydown.inputEmulator keyup.inputEmulator",this.triggerInputEvent.bind(this)),this.$doc.on("selectionchange.inputEmulator",this.triggerInputEvent.bind(this))},e.prototype.stopEmulate=function(){this.$target&&this.$target.off(".inputEmulator"),this.$target=null,this.currentValue="",this.$doc.off(".inputEmulator")},e.prototype.triggerInputEvent=function(){if(this.$target){var e=this.$target.val();e!==this.currentValue&&this.$target.trigger("input"),this.currentValue=e}},Daria.InputEventEmulator=e}()},3078:function(e,t){Daria.ComposeComponents.confirmations={_confirmations:{},addConfirmation:function(e,t){this._confirmations[e]=t},getConfirmation:function(e){return this._confirmations[e]},getConfirmations:function(){return _.map(this._confirmations,function(e){return e})}}},3079:function(e,t){!function(){var e="send-without-to";Daria.ComposeComponents.confirmations.addConfirmation(e,function(t){var o=t.get(".to"),n=t.get(".cc"),s=t.get(".bcc");return!(o||!n&&!s)&&e})}()},3080:function(e,t){!function(){var e="attachments-forgotten",t=new RegExp(["attach","аттач","прилагается","приложил","прикладываю","прикрепляю","приложенный","приложенном","вложил","вложение","вложенном","вложенный","вкладываю","прилагаю","см. файл","см.файл","лови файл","прикрепил","во вложении","в приложении"].join("|"),"i");Daria.ComposeComponents.confirmations.addConfirmation(e,function(o,n){if(o.hasAttach())return!1;var s=o.get(".send"),i=o.get(".subj");/^RE:/i.test(i)||(s=i+" "+s),s=(s=(s=s.replace(new RegExp("(?:^\\s*>.*$)|(?:[\\n\\r])","gmi"),"")).replace(/<blockquote[^>]*>.*<\/blockquote>/gi,"")).replace(/<[^>]+>/g,"");var a=t.exec(s);if(!a)return!1;var r=[];return $.each([a.index,a.index+a[0].length-1],function(e,t){e=2*e-1;for(var o=3,n=!1,i=t,a=s.length;i>=0&&i<a;i+=e)if(/[\s,.!?\-+:;()]/i.test(s.charAt(i))){if(!n){if(!--o)break;n=!0}}else n=!1;r.push(i)}),n.stopWordGroup=$.trim(s.substring.apply(s,r)),e})}()},3081:function(e,t){!function(e,t){"use strict";t.Signature=function(){e.extend(this,t.UI.IEvent()),this._log("create"),this.__init=!1,this._isMouseenter=!1,this._isMouseleave=!0,this._coordYBegin=0,this._coordYEnd=0,this._currentYCursor=0,this._limitRangeFind=100,this._maxSignLine=100,this._range=[],this._updateCoords=_.debounce(this._updateCoords,0),this._onInput=_.debounce(this._onInput,50)};var o=t.Signature.prototype;o._log=function(){},o._mouseEnter=function(){this._isMouseenter||(this._isMouseenter=!0,this._isMouseleave=!1,this.trigger("mouseenter",[this]))},o._mouseLeave=function(){this._isMouseleave||(this._isMouseleave=!0,this._isMouseenter=!1,this.trigger("mouseleave",[this]))},o._mouseMove=function(e){this._coordYBegin>=this._coordYEnd?this._mouseLeave():(this._currentYCursor=e,this._currentYCursor>=this._coordYBegin&&this._currentYCursor<=this._coordYEnd?(this._mouseEnter(),this.trigger("mousemove",[this])):this._mouseLeave())},o._updateCoords=function(){var e=this._offset();e&&(this._log("_updateCoords"),this._coordYBegin===e.top&&this._coordYEnd===e.bottom||(this._coordYBegin=e.top>0?e.top:0,this._coordYEnd=e.bottom>0?e.bottom:0,this._currentYCursor&&this._mouseMove(this._currentYCursor),this.trigger("change",[this])))},o.__onInput=function(){if(this._log("__onInput"),this._range=this._findRange(),!this._range.length)return this._coordYBegin=0,this._coordYEnd=0,void this._mouseLeave();this._updateCoords()},o._onInput=function(t){t&&e.inArray(t.keyCode,[37,38,39,40,16,17,18])>-1||(this._log("_onInput"),this.__onInput())},o._onClick=function(){this._range.length&&this._isMouseenter&&(this._log("_onClick"),this.trigger("click",[this]))},o._onScroll=function(){this._range.length&&(this._log("_onScroll"),this._updateCoords())},o.isMouseEntered=function(){return this._isMouseenter},o.offset=function(){return{top:this._coordYBegin,bottom:this._coordYEnd}},o.update=function(){this._range=this._findRange();var e=this._offset();e&&(this._coordYBegin=e.top>0?e.top:0,this._coordYEnd=e.bottom>0?e.bottom:0,this._currentYCursor&&this._mouseMove(this._currentYCursor),this.trigger("change",[this]))},o._destroy=function(e){this.__init&&(this._log("_destroy"),this.__init=!1,this._updateCoords.cancel(),this._onInput.cancel(),this._events.empty(),this._range=[],this._currentYCursor=0,this._coordYBegin=0,this._coordYEnd=0,this._isMouseenter=!1,this._isMouseleave=!0,e&&e.call(this))},o._init=function(e){this.__init||(this._log("_init"),this.__init=!0,e&&e.call(this),this.__onInput())},o.__offsetY=function(e){var t;return void 0!==e.offsetY?t=e.offsetY:e.originalEvent&&void 0!==e.originalEvent.layerY&&(t=e.originalEvent.layerY),t},o.setFirstSignatureMatch=function(e){this._firstSignatureMatch=e},o.getFirstSignatureMatch=function(){return this._firstSignatureMatch||"--\\s"},o._offset=function(){},o.getLinesCount=function(){return 0},o._findRange=function(){return[]},o._onMouseMove=function(){},o._onMouseLeave=function(){},o._onMouseEnter=function(){},o.destroy=function(){},o.init=function(){},o.select=function(){},o.replace=function(){},o.get=function(){},o.getText=function(){}}(jQuery,Daria)},3082:function(e,t){!function(e,t){"use strict";t.SignatureTextarea=function(o){t.SignatureTextarea.superClass.constructor.apply(this,arguments),this._$node=e(o)},Jane.extend(t.SignatureTextarea,t.Signature);var o=t.Signature.prototype;o._widthNode=function(){var e=0,t=this._$node[0].scrollWidth||this._$node[0].clientWidth;return window.getComputedStyle&&(e=-1!==(e=window.getComputedStyle(this._$node[0],null).getPropertyValue("width")).indexOf("px")?parseFloat(e):0),e?Math.min(e,t):t},o._textCoords=function(t,o,n){this._$placeholder.width(this._widthNode()).text(t);var s=parseInt(this._$placeholder.css("top"),10),i=this._$placeholder[0].firstChild,a=document.createRange();a.setStart(i,o),a.setEnd(i,n);var r=a.cloneRange(),c={};if(!Modernizr.msie&&!Modernizr.opera&&(r.getBoundingClientRect&&(c={top:(c=r.getBoundingClientRect()).top,bottom:c.bottom}),!c.top&&!c.bottom&&r.getClientRects)){var u=r.getClientRects();u.length&&(c.top=u[0].top,c.bottom=u[u.length-1].bottom)}if(c.top||c.bottom){var l=e(window).scrollTop();c.top=c.top+l,c.bottom=c.bottom+l}else{r.surroundContents(this._highlight);var d=e(this._highlight);c.top=d.offset().top,c.bottom=c.top+d.height()}return c.top&&c.bottom?(c.top=c.top-s,c.bottom=c.bottom-s,c):null},o._offset=function(){if(!this._range.length)return null;var e=this._$node.scrollTop();return{top:this._range[0].top-e,bottom:this._range[1].bottom-e}},o._findRange=function(){if(!this._lineHeight)return[];for(var e,t=new RegExp("^"+this.getFirstSignatureMatch()+"$","gm"),o=this._$node.val(),n=/^--------[^\-]+.*--------$/gm,s=[-1,-1],i=!1;null!==(e=n.exec(o));)i||(i=!0,s[0]=e.index),s[1]=n.lastIndex;var a,r,c=t.exec(o);if(c&&c.index>s[0]&&c.index<s[1]&&(t.lastIndex=s[1],c=t.exec(o)),c){a={simbol:c.index,simbolOffset:t.lastIndex+1,top:void 0};var u,l=this._maxSignLine,d=/^.+$/gm,h=!1,p=[0,0],f=/^\s*>/,m=/^\s*$/;for(d.lastIndex=t.lastIndex;null!==(u=d.exec(o))&&l;){if(f.test(u[0])){h=!0;break}if(d.lastIndex>=s[0]&&d.lastIndex<=s[1])break;m.test(u[0])||(p=[d.lastIndex,p[0]]),l--}if(p=h&&p[1]?p[1]:p[0]?p[0]:a.simbolOffset-1){r={simbol:p,bottom:void 0};var g=this._textCoords(o,a.simbol,r.simbol);g?(a.top=g.top,r.bottom=g.bottom):(a=null,r=null)}}return a&&r?[a,r]:[]},o._onMouseMove=function(e){this._isNodeMouseenter||this._onMouseEnter(e),this._log("mousemove"),this._mouseMove(this.__offsetY(e))},o._onMouseLeave=function(){this._log("mouseleave"),this._mouseLeave(),this._currentYCursor=0,this._isNodeMouseenter=!1},o._onMouseEnter=function(e){this._log("mouseenter"),this._currentYCursor=this.__offsetY(e),this.__onInput(),this._isNodeMouseenter=!0},o.get=function(){return this._range.length?this._$node.val().slice(this._range[0].simbol,this._range[1].simbol):""},o.getText=function(){return this.get()},o.replace=function(e){if(this._range.length){var t=this._$node.val();t=t.substr(0,this._range[0].simbol)+e+t.substr(this._range[1].simbol),this._$node.val(t),this.__onInput()}},o.select=function(){this._range.length&&t.setSelection(this._$node[0],this._range[0].simbol,this._range[1].simbol)},o.init=function(t,o){t=t||{},this._init(function(){this.setFirstSignatureMatch(t.firstSignatureMatch);var n=parseInt(this._$node.css("font-size"),10)||13;if(this._lineHeight=n+2,this._$node.css("line-height",this._lineHeight+"px"),this._highlight=document.createElement("span"),this._$placeholder=e("<pre></pre>").css({font:this._$node.css("font"),fontFamily:this._$node.css("fontFamily"),fontSize:this._$node.css("fontSize"),fontStyle:this._$node.css("fontStyle"),fontVariant:this._$node.css("fontVariant"),fontWeight:this._$node.css("fontWeight"),lineHeight:this._$node.css("lineHeight"),padding:this._$node.css("padding"),paddingTop:this._$node.css("paddingTop"),paddingBottom:this._$node.css("paddingTop"),paddingLeft:this._$node.css("paddingLeft"),paddingRight:this._$node.css("paddingRight"),margin:this._$node.css("margin"),marginTop:this._$node.css("marginTop"),marginBottom:this._$node.css("marginTop"),marginLeft:this._$node.css("marginLeft"),marginRight:this._$node.css("marginRight"),width:this._widthNode()+"px",wordWrap:"break-word",whiteSpace:"pre-wrap",visibility:"hidden",position:"absolute",top:"-9999px",left:"-9999px"}).appendTo("body"),this._$node.on("keyup",e.proxy(this._onInput,this)).on("mouseleave",e.proxy(this._onMouseLeave,this)).on("mouseenter",e.proxy(this._onMouseEnter,this)).on("click",e.proxy(this._onClick,this)).on("mousemove",e.proxy(this._onMouseMove,this)).on("scroll",e.proxy(this._onScroll,this)),Modernizr.msie){var s=this,i=this._$node.css("overflow-y");this._$node.css("overflow-y","hidden"),setTimeout(function(){s._$node.css("overflow-y",i)},0)}o&&o.call(this)})},o.destroy=function(){this._destroy(function(){this._highlight=null,this._$placeholder.remove(),this._$placeholder=null,this._lineHeight=0,this._$node.off("keyup",e.proxy(this._onInput,this)).off("mouseleave",e.proxy(this._onMouseLeave,this)).off("mouseenter",e.proxy(this._onMouseEnter,this)).off("click",e.proxy(this._onClick,this)).off("mousemove",e.proxy(this._onMouseMove,this)).off("scroll",e.proxy(this._onScroll,this))})},e.fn.signature=function(){return this.each(function(){this.signature||(this.signature=new t.SignatureTextarea(this))})},e.fn.signatureDestroy=function(){return this.each(function(){this.signature&&(this.signature.destroy(),this.signature=null,delete this.signature)})}}(jQuery,Daria)},3083:function(e,t){!function(e,t){"use strict";t.SignatureCkeditor=function(o){t.SignatureCkeditor.superClass.constructor.apply(this,arguments),this._ed=o,this._$node=e(this._ed.editable().$),this._isFirstSignature=!0,this._isNormalizeSupport="normalize"in document.createElement("div")},Jane.extend(t.SignatureCkeditor,t.Signature);var o=t.SignatureCkeditor.prototype;o._offset=function(){if(!this._range.length)return null;var e,t,o;try{if(!(e=this._range[0][0].getBoundingClientRect()).height)return null;if(!(t=this._range[1][0].getBoundingClientRect()).height)return null;if(!(o=this._$node[0].getBoundingClientRect()).height)return null}catch(e){return null}return{top:e.top-o.top,bottom:t.bottom-o.top}},o._findForwardRange=function(){var t=[-1,-1],o=this._ed.getData(!0);if(void 0===o)return t;if(!/<div>--------[^\-]+.*--------<\/div>/i.test(o))return t;var n=this._$node[0],s=n.childNodes.length;if(!s)return t;for(var i,a=0,r=/^--------[^\-]+.*--------$/;a<s;a++)if("DIV"===(i=n.childNodes[a]).nodeName&&r.test(e.text(i))){t[0]=a;break}for(;s--;)if("DIV"===(i=n.childNodes[s]).nodeName&&r.test(e.text(i))){t[1]=s;break}return t},o._checkFirstRange=function(e){var o=t.Html2Text.html2text(e.innerHTML),n=new RegExp("^"+this.getFirstSignatureMatch()+"$","m").exec(o);return!(!n||0!==n.index)},o._findFirstRangeForward=function(e,t){var o,n,s=this._$node[0],i=s.childNodes.length,a=0;if(!((n=e?Math.min(this._limitRangeFind,i-this._limitRangeFind):Math.min(this._limitRangeFind,i))<=a)){for(;a<n;a++)if(!(a>=t[0]&&a<=t[1])){var r=s.childNodes[a];if(this._checkFirstRange(r)){o=r;break}}return o}},o._findFirstRangeBack=function(e,t){var o,n,s=this._$node[0],i=s.childNodes.length,a=i-1;if(!(a<(n=e?Math.max(this._limitRangeFind,i-this._limitRangeFind):Math.max(0,i-this._limitRangeFind)))){for(;a>=n;--a)if(!(a>=t[0]&&a<=t[1])){var r=s.childNodes[a];if(this._checkFirstRange(r)){o=r;break}}return o}},o._findFirstRange=function(){var e,t=this._findForwardRange();return this._isFirstSignature?(e=this._findFirstRangeForward(!1,t))||(e=this._findFirstRangeBack(!0,t)):(e=this._findFirstRangeBack(!1,t))||(e=this._findFirstRangeForward(!0,t)),e},o._findRange=function(){var t,o=this._findFirstRange();if(o){t=[];var n=this._maxSignLine,s=!1,i=/^--------[^\-]+.*--------$/,a=/^\s*>/,r=/^\s*$/,c=/<img[^>]*>/;e(o).nextAll().each(function(){if("BLOCKQUOTE"===this.nodeName)return s=!0,!1;var o=e.text(this);return a.test(o)?(s=!0,!1):!i.test(o)&&(!!n&&(r.test(o)?this.childNodes.length>0&&c.test(this.innerHTML)&&(t=[this,t[0]]):t=[this,t[0]],void n--))}),t=s&&t[1]?t[1]:t[0]?t[0]:o}return o&&t?[e(o),e(t)]:[]},o._createRange=function(){if(!this._range.length)return!1;var e=this._ed.createRange();return this._range[0][0]===this._range[1][0]?e.selectNodeContents(new CKEDITOR.dom.node(this._range[0][0])):(e.setStartBefore(new CKEDITOR.dom.node(this._range[0][0])),e.setEndAfter(new CKEDITOR.dom.node(this._range[1][0]))),e},o._onMouseMove=function(e){this._isNodeMouseenter||this._onMouseEnter(e),this._log("mousemove");var t=e.currentTarget.getBoundingClientRect(),o=e.clientY-t.top;this._mouseMove(o)},o._onMouseLeave=function(){this._log("mouseleave"),this._mouseLeave(),this._currentYCursor=0,this._isNodeMouseenter=!1},o._onMouseEnter=function(e){this._log("mouseenter"),this._currentYCursor=this.__offsetY(e),this.__onInput(),this._isNodeMouseenter=!0},o.get=function(){if(this._range.length)return this._range[0][0]===this._range[1][0]?this._range[0]:this._range[0].nextUntil(this._range[1]).andSelf().add(this._range[1])},o.getText=function(){var e=this.get();return e?e.map(function(){return t.Html2Text.html2text(this.innerHTML).replace(/^[\u0020\u00a0]+$/gm,"")}).get().join("\n"):""},o.replace=function(e){if(this._range.length){var t=this._createRange();this._ed.insertHtml(e,"html",t),this.__onInput()}},o.select=function(){if(!this._range.length)return!1;var e=this._createRange();return this._ed.getSelection().selectRanges([e]),!0},o.init=function(t,o){t=t||{},this._init(function(){"firstSignature"in t&&(this._isFirstSignature=Boolean(t.firstSignature)),this.setFirstSignatureMatch(t.firstSignatureMatch),this._$node.on("mouseleave",e.proxy(this._onMouseLeave,this)).on("mouseenter",e.proxy(this._onMouseEnter,this)).on("scroll",e.proxy(this._onScroll,this)).on("keyup",e.proxy(this._onInput,this)).on("mousemove",e.proxy(this._onMouseMove,this)).on("click",e.proxy(this._onClick,this)),this._ed.on("setData",e.proxy(this.__onInput,this)),o&&o.call(this)})},o.destroy=function(){this._destroy(function(){this._$node.off("mouseleave",e.proxy(this._onMouseLeave,this)).off("mouseenter",e.proxy(this._onMouseEnter,this)).off("scroll",e.proxy(this._onScroll,this)).off("mousemove",e.proxy(this._onMouseMove,this)).off("click",e.proxy(this._onClick,this)).off("keyup",e.proxy(this._onInput,this)),this._ed.removeListener("setData",e.proxy(this.__onInput,this))})}}(jQuery,Daria)},3084:function(e,t,o){var n,s,i;function a(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function r(e,t,o){return t&&a(e.prototype,t),o&&a(e,o),e}var c={value:null},u=o(1133)()((i=s=function(){function e(t){var o=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.AVATAR_SIZE=20;var n=t.dataset,s=this._fields;this._data=Object.keys(s).reduce(function(e,t){var i="yabble".concat(_.capitalize(t)),a=_.unescape(n[i]);return a=s[t]?_.method(s[t][0],a)(o):a,e[t]=a,e},{})}return r(e,[{key:"_fields",get:function(){return c}}],[{key:"updateBubbleAtNode",value:function(e){if(e.classList.contains(Daria.ContactBubble.BUBBLE_CLASS))Daria.ContactBubble.update(e);else if(e.classList.contains(Daria.PhoneBubble.BUBBLE_CLASS))Daria.PhoneBubble.update(e);else{if(Daria.debug.enabled)throw new Error("uknown bubble type");Daria.BaseBubble.update(e)}}}]),r(e,[{key:"toString",value:function(){return String(this.get("value"))}},{key:"needUpdate",value:function(){return!1}},{key:"get",value:function(e){return _.get(this._data,e)}},{key:"getText",value:function(){return this.get("value")}},{key:"getAvatar",value:function(){return{href:!1,size:this.AVATAR_SIZE,className:"mail-Bubble-Avatar mail-User-Avatar"}}},{key:"applyTo",value:function(e){var t=this,o=this.renderBubbleNode();for(Object.keys(this._data).forEach(function(o){var n=t._data[o];(n=t._fields[o]?_.method(t._fields[o][1],n)(t):n)&&e.setAttribute("data-yabble-".concat(o),_.escape(n))}),this.get("tid")&&e.setAttribute("readonly","readonly");e.firstChild;)e.removeChild(e.firstChild);e.appendChild(o)}},{key:"getCustomProps",value:function(){return{}}},{key:"renderBubbleNode",value:function(){return ns.renderNode(_.extend({avatar:Daria.Recipients.add(this.getAvatar()),text:this.getText()},this.getCustomProps()),"bubble","compose2")}},{key:"_fieldToArray",value:function(e){return _.compact(this.constructor.tokenizer(String(e||"").trim()))}},{key:"_fieldToString",value:function(e){return String(e)}}]),e}(),s.BUBBLE_CLASS="js-base-bubble",n=i))||n;Daria.BaseBubble=u},3085:function(e,t,o){var n,s,i;function a(e){"@babel/helpers - typeof";return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e,t){return!t||"object"!==a(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function u(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function l(e,t,o){return t&&u(e.prototype,t),o&&u(e,o),e}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var h=o(1133),p=o(786)();var f={cid:null,tid:null,name:null,type:null,phone:null,shared:null,email:["_fieldToArray","_fieldToString"],value:["_fieldToArray","_fieldToString"]},m=h({tokenizer:function(e){return p(e)},checkPaste:function(e){return Jane.FormValidation.checkContacts(e)}})((i=s=function(e){function t(e){var o;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(o=r(this,c(t).call(this,e))).get("tid"))return r(o);if(_.isEmpty(o.get("value"))){var n=Jane.FormValidation.contact2obj(e.innerText);o._data.name=n.name,o._data.email=o._fieldToArray(n.email)}if(!o.get("cid")&&!_.isEmpty(o.get("email"))){var s=ns.Model.get("abook-contacts").getContactDataByEmail(o.getHeadEmail());s&&(o._data.cid=s.cid,o._data.shared=Number(s.isShared))}var i=o.get("cid"),a=Boolean(Number(o.get("shared")));if(i){var u=ns.Model.get("abook-contact",{cid:i,shared:a});u.isValid()&&(o.get("name")||(o._data.name=u.getName()),o.get("phone")||(o._data.phone=u.getPhone()))}return o._data.value=o._fieldToArray(Jane.FormValidation.obj2contact({name:o.get("name"),email:o.getHeadEmail()})),o}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&d(e,t)}(t,Daria.BaseBubble),l(t,[{key:"_fields",get:function(){return f}}]),l(t,[{key:"getCustomProps",value:function(){return{isGroup:this.isGroup(),isContact:this.isContact(),hasInvalidEmail:this.hasInvalidEmail(),hasExternalEmail:this.hasExternalEmail()}}},{key:"needUpdate",value:function(){var e=!this.get("tid")&&!this.get("cid"),t=!this.hasInvalidEmail()&&this.getHeadEmail()&&this.getHeadEmail().length<this.constructor.EMAIL_LEN_REQUEST;return e&&t}},{key:"setEmail",value:function(e){this._data.email=this._fieldToArray(e),this._data.value=this._fieldToArray(Jane.FormValidation.obj2contact({name:this._data.name,email:e}))}},{key:"appendEmail",value:function(e,t){this._data.email=_.uniq(this.get("email").concat(e));for(var o=Jane.FormValidation.obj2contact({name:t,email:e}),n=!1,s=0;s<this._data.value.length;){var i=Jane.FormValidation.contact2obj(this.get("value")[s]);i.email===e&&(i.name!==t&&this._data.value.splice(s,1,o),n=!0),s++}n||this._data.value.push(o)}},{key:"removeEmail",value:function(e){this._data.email=_.difference(this.get("email"),[e]);for(var t=0;t<this._data.value.length;){Jane.FormValidation.contact2obj(this.get("value")[t]).email===e?this._data.value.splice(t,1):t++}}},{key:"getHeadEmail",value:function(){return this.get("email")[0]}},{key:"getPhone",value:function(){if(this.get("phone"))return{status:this.constructor.PHONE.FOUND,value:this.get("phone")};var e,t;if(!((this.isContact()||this.isGroup())&&!this.hasInvalidEmail()&&1===this.get("email").length))return{status:this.constructor.PHONE.NOT_FOUND,value:null};if(this.isContact())e=(t=ns.Model.get("abook-contact",{cid:this.get("cid"),shared:Boolean(Number(this.get("shared")))})).isValid()?t.getPhone():null;else if(this.isGroup()&&1===this.get("email").length){if(t=ns.Model.get("abook-contacts").getContactDataByEmail(this.getHeadEmail()),!(t=ns.Model.get("abook-contact",{cid:t&&t.cid,shared:t&&t.isShared||!1})).isValid())return{status:this.constructor.PHONE.SHOULD_REQUEST,value:null};e=t.getPhone()}return e?{status:this.constructor.PHONE.FOUND,value:e}:{status:this.constructor.PHONE.NOT_FOUND,value:null}}},{key:"isGroup",value:function(){return Boolean(this.get("tid"))}},{key:"isContact",value:function(){return Boolean(this.get("cid"))}},{key:"hasExternalEmail",value:function(){return this._data.email&&this._data.email.some(Jane.FormValidation.checkExternalEmail)}},{key:"hasInvalidEmail",value:function(){return this._data.email&&!this._data.email.every(Jane.FormValidation.checkEmail.bind(Jane.FormValidation))}},{key:"getText",value:function(){return this.get("name")||this.getHeadEmail()}},{key:"getAvatar",value:function(){return{email:this._data.tid?this._data.tid:_.escape(this.getHeadEmail()),name:_.escape(this.getText()),href:!1,size:this.AVATAR_SIZE,className:"mail-Bubble-Avatar",isGroup:this.isGroup()}}}]),t}(),s.EMAIL_LEN_REQUEST=256,s.BUBBLE_CLASS="js-contact-bubble",s.PHONE={FOUND:"found",SHOULD_REQUEST:"should_request",NOT_FOUND:"not_found"},n=i))||n;Daria.ContactBubble=m},3086:function(e,t,o){var n,s,i;function a(e){"@babel/helpers - typeof";return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e,t){return!t||"object"!==a(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function u(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function l(e,t,o){return t&&u(e.prototype,t),o&&u(e,o),e}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var h={phone:null,value:null,email:null,name:null,cid:null,type:null,shared:null},p=o(1133)({checkPaste:function(e){return Jane.FormValidation.checkPhoneNumber(e)},tokenizer:function(e){return Jane.FormValidation.splitPhones(e)}})((i=s=function(e){function t(e){var o;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(o=r(this,c(t).call(this,e))).get("phone")||(o._data.phone=e.innerText);var n=o.get("phone");if(!o.get("cid")&&n){var s=ns.Model.get("abook-contacts").getContactDataByPhone(n);s&&(o._data.cid=s.cid,o._data.shared=Number(s.isShared))}var i=o.get("cid"),a=Boolean(Number(o.get("shared"))),u=i?ns.Model.get("abook-contact",{cid:i,shared:a}):ns.Model.get("abook-contact").findContactByPhone(n);return u&&u.isValid()&&(o._data.cid=i||u.get(".cid"),o._data.shared=o.get("shared")||Number(u.isShared()),o._data.email=o.get("email")||u.getHeadEmail(),o._data.name=o.get("name")||u.getName()),o._data.value=o.get("phone"),o}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&d(e,t)}(t,Daria.BaseBubble),l(t,[{key:"_fields",get:function(){return h}}]),l(t,[{key:"renderBubbleNode",value:function(){return ns.renderNode({isPhone:!0,isValid:this.isValidPhoneNumber(),avatar:Daria.Recipients.add(this.getAvatar()),text:this.getText()},"bubble-phone","compose2")}},{key:"needUpdate",value:function(){return!1}},{key:"isValidPhoneNumber",value:function(){return!this.getText()||Jane.FormValidation.checkPhoneNumber(this.getText())}},{key:"getAvatar",value:function(){return{email:_.escape(this._data.email),name:_.escape(this._data.name||this._data.email),href:!1,size:this.AVATAR_SIZE,className:"mail-Bubble-Avatar",isGroup:!1}}}]),t}(),s.BUBBLE_CLASS="js-phone-bubble",n=i))||n;Daria.PhoneBubble=p},3087:function(e,t){ns.action.define("yabble.change-email",function(e,t){return Daria.Dropdown.closeAll(),ns.events.trigger(e,t),!0}),ns.action.copy("yabble.change-email","yabble.edit"),ns.action.copy("yabble.change-email","yabble.remove"),ns.action.copy("yabble.change-email","yabble.single-target"),ns.action.define("yabble.change-group",function(e,t){return ns.events.trigger(e,t),!0}),ns.action.define("yabble.add-to-abook",function(e,t){Jane.Services.run("#contacts",function(){ns.View.create("abook-person-popup").open({where:$(window),how:{my:"center",at:"center",of:window,fixed:!0}},{email:[t.email],first_name:t.name,yabbleId:t.id})}),Daria.Dropdown.closeAll()})},3088:function(e,t,o){function n(e){"@babel/helpers - typeof";return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!function(e,t){Daria.Yabble=function(e){var t=this;this.id=Daria.Yabble.genId(),this.value={},e&&this.val(e),this.root=$(Daria.Yabble.getHTML()),this.text=this.root.find(".js-yabble-content"),this.input=this.root.find(".js-yabble-input"),this.$smsLink=this.root.find(".js-sms-open-link"),this.$smsLink.on("click",function(e){e.stopPropagation();var o=t.value;t.$smsLink.trigger("sms-link-click",o)}),this.$smsLink.on("dblclick",function(e){e.stopPropagation()}),this.hideSmsLink(),Modernizr.msie&&this.root.on("selectstart",function(e){t.focused||e.preventDefault()}),$.isEmptyObject(this.value)||this.pasteValue()},Daria.Yabble.KEY={UP:38,LEFT:37,RIGHT:39,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:44,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8,SHIFT:16,SEMI:59,SPACE:32,META:91,END:35,HOME:36,C:67,X:88,V:86,A:65,Z:90,ALT:18};var s=0,i={contact:"mail-Yabble_contact",group:"mail-Yabble_group",unreachable:"mail-Yabble_unreachable",external:"mail-Yabble_external",selected:"mail-Yabble_selected",focused:"mail-Yabble_focused"};Daria.Yabble.YC=i,Daria.Yabble.genId=function(){return s++},Daria.Yabble.getHTML=function(){return Daria.Yabble.template||(Daria.Yabble.template=$("<div></div>").html(Jane.tt("compose2:yabble"))),Daria.Yabble.template.html()},Daria.Yabble.template=null,Daria.Yabble.mergeContact=function(t,o){return"string"==typeof t&&(t=e.contact2obj(t)),"string"==typeof o&&(o=e.contact2obj(o)),o.email!==t.email?$.extend({},o):$.extend({},t,o)},Daria.Yabble.prototype={value:null,focused:!1,selected:!1,isContact:!1,isGroup:!1,isUnreachable:!1,isExternal:!0,doInput:function(e,t){var o=this.input[0];switch(e){case"focus":try{(t||document.activeElement!==o)&&(o.focus(),o.select())}catch(e){Jane.ErrorLog.sendException("activeElement",e)}break;case"enable":o.removeAttribute("disabled");break;case"disable":o.setAttribute("disabled","disabled")}},focus:function(){if(!this.focused&&!this.isGroup){this.deselect(!0),this.focused=!0;var t=e.obj2contact(this.value),o=this.value.name;this.doInput("enable"),this.doInput("focus"),t&&(this.text.text(t),this.input.val(t),Daria.setSelection(this.input[0],o?1:0,o?o.length+1:t.length)),this.root&&this.root.length&&(Modernizr.msie&&this.root.css("min-width",this.root.parent().width()-this.root.position().left-20),this.root.attr("draggable",""),this.root.addClass(i.focused))}},blur:function(e){this.focused&&(this.val(Daria.Yabble.mergeContact(this.value,this.getValue())),this.pasteValue(),e||this.doInput("disable"),this.root.attr("draggable","true"),Modernizr.msie&&this.root.removeAttr("style"),this.focused=!1)},select:function(){this.selected?this.doInput("focus"):(this.blur(!0),this.selected=!0,this.root.addClass(i.selected),this.doInput("enable"),this.doInput("focus"))},deselect:function(e){this.selected&&(e||this.doInput("disable"),this.root&&(this.root.removeClass(i.selected),this.selected=!1))},validate:function(){this.value.email?(this.isUnreachable=!e.checkEmail(this.value.email),this.root.toggleClass(i.unreachable,this.isUnreachable),this.isExternal=e.checkExternalEmail(this.value.email),this.root.toggleClass(i.external,this.isExternal)):this.isUnreachable=!1},pasteValue:function(){var e=this.value.name||this.value.email,t=this.root.find(".js-yabble-avatar");if(t.length){var o={href:!1,size:20,className:"mail-Yabble__avatar"};this.value&&this.value.email&&(o.email=this.value.email,o.name=e),t.replaceWith(Daria.Recipients.add(o))}this.input.val(this.val()),this.text.text(e),this.root.removeClass(i.focused),this.isContact=Boolean(this.value.cid),this.isGroup=Boolean(this.value.tid),this.root.toggleClass(i.contact,this.isContact),this.root.toggleClass(i.group,this.isGroup),this.validate()},userVal:function(){return this.input.val()},getValue:function(){var e=this.input,t=e.data("suggest")||$.trim(this.userVal()).replace(/(?:,|;)$/,"");return e.removeData("suggest"),t},val:function(t){var o=Daria.Constants.CONTACTS.DELIMITER;if(void 0===t)return this.value.tid?$.map(this.value.contacts,function(t){return!t.ignored&&e.obj2contact(t)||null}).join(o):e.obj2contact(this.value);"object"===n(t)?this.value=t:this.value=e.contact2obj(t)},showSmsLink:function(){this.$smsLink.removeClass("is-hidden")},hideSmsLink:function(){this.$smsLink.addClass("is-hidden")},destroy:function(){this.root.remove(),this.root=this.text=this.input=null},onkeypress:function(){this.focused&&this.text.text(this.userVal())},onkeyup:function(){this.focused&&this.text.text(this.userVal())}},o(3089)}(Jane.FormValidation)},3089:function(e,t){var o=".b-mail-dropdown__box__content_yabble-",n={timeout:null,request:null,delay:150,template:"compose2:yabble-dropdown",json:{},toggle:function(e){var t=$(o+e.id).is(":visible");n.close(e),t||(n.remove(e),this.yabble=e,this.getParams(),this.load())},close:function(e){"number"==typeof this.timeout?(clearTimeout(this.timeout),this.timeout=null):this.request?(this.request.notify("abort"),this.request=null):(Daria.Dropdown.closeCurrent(),e&&n.remove(e))},remove:function(e){$(o+e.id).remove()},getParams:function(){var e=this.yabble,t=e.id,o=e.value,n=_.escape(o.name||""),s=_.escape(o.email||"");switch(!0){case e.isPhone:this.params=null,this.handlers=null,this.template="compose2:yabble-dropdown-phone",this.json={email:s,id:t};break;case e.isContact:this.params={cid:o.cid},this.handlers=["abook-contact"],this.template="compose2:yabble-dropdown-contact",this.json={email:s,id:t};break;case e.isGroup:this.params={tid:o.tid},this.handlers=["abook-contacts"],this.template="compose2:yabble-dropdown-group",this.json={id:t,email:$.map(o.contacts,function(e){return!e.ignored&&e.email||null})};break;case e.isUnreachable:this.params=null,this.handlers=null,this.template="compose2:yabble-dropdown",this.json={id:t,name:n,email:s};break;case e.fromMessage:this.params=null,this.handlers=null,this.template="message:dropdown-contact",this.json={id:t,email:s,name:n,my:e.my,cid:e.cid};break;default:this.params=null,this.handlers=null,this.template="compose2:yabble-dropdown",this.json={id:t,email:s,name:n}}},load:function(){var e=this.delay;if(this.handlers){var t,o=$.now();this.request=ns.request(this.handlers,this.params).then(function(){e-=$.now()-o,t=!0,this.request=null,this.open(e<0?0:e)},this),t&&(this.request=null)}else this.open(e)},initializeNanoislands:function(e){nb.init(e)},open:function(e){var t=this,n=this.yabble,s=o+n.id,i=$(Jane.tt(this.template,this.json,this.handlers,this.params));e="delay"in n?n.delay:e,this.initializeNanoislands(i),$(s).remove();var a=function(){t.timeout=null,Daria.Dropdown.toggle(null,{content:$(i).find(s),dropdown:t.yabble.root,handle:t.yabble.root}),n.value&&n.value.email&&ns.action.run("common.copy",{container:s,text:n.value.email,onmouseup:function(){$(document).trigger("b-mail-dropdown-closeall")},doNotCloseDropdown:!0})};e<0?a():this.timeout=setTimeout(a,e)}};Daria.YabbleDropdown=n},3090:function(e,t){!function(){var e=Daria.Constants.CONTACTS.DELIMITER,t=Jane.FormValidation,o={onlyFirstEmail:!0,joinName:!0},n=function(e,t){this.options=$.extend({},{maxItems:Number.MAX_VALUE,yabbleCtor:Daria.Yabble,yabbleType:"contact"},t||{}),this.id=Daria.Yabble.genId(),this.ids={},this.yabbles=[],this.strVal="",this.root=e,this.wrapper=e.find(".js-yabbles-container"),this.input=e.find(".js-yabbles-controller"),this.init(),this.multi=new Daria.YabbleMulti(this),Daria.YabbleHistory.start(this)};n.actions=["yabble.change-email","yabble.change-group","yabble.edit","yabble.remove","yabble.add-to-abook","yabble.single-target"],n.yabbleEvents=["dblclick","paste","keydown","keypress","keyup","focusout","focusin"],n.directEvents=["mousedown","mouseup","click"],n.prototype={option:function(e,t){var o=arguments.length;if(1===o)return this.options[e];2===o&&(this.options[e]=t)},getEmails:function(){return _.uniq($.map(this.yabbles,function(e){return e.value.email}).sort())},recalcStrVal:function(t){t=t||{};var o=[];$.each(this.yabbles,function(e,t){o.push(t.val())}),this.strVal=$.map(o,function(e){return e||null}).join(e),this.root.find("input[type=hidden]").val(this.strVal),t.silent||this.trigger("change")},init:function(){var e=this;this.input.focus(function(){e.focus()}),$.each(n.directEvents,function(t,o){e["ondirect"+o]&&e.root.bind(o,function(t){e.e=t,e["ondirect"+o].apply(e,arguments)})}),$.each(n.yabbleEvents,function(t,o){e._setYabbleEvent(o)}),this.onactionRef=function(){e.onaction.apply(e,arguments)},n.actions.forEach(function(t){ns.events.on(t,e.onactionRef)})},ondirectmousedown:function(e){if(!Daria.isLeftButton(e))return e.preventDefault(),void(Modernizr.opera||Modernizr.msie?this.add().focus():setTimeout(function(){this.add().focus()}.bind(this),200));var t=this.find("fromEvent",e);this.clicked=!1,this.mousedownId=null,t&&(this.mousedownId=t.id,this.onmousedown&&this.onmousedown(e,t))},ondirectmouseup:function(e){if(Daria.isLeftButton(e)&&this.mousedownId){var t=this.find("fromEvent",e),o=this.find("id",this.mousedownId);this.onmouseup&&this.onmouseup(e,o),o!==t&&(this.onclick&&this.onclick(e,o),this.clicked=!0,this.mousedownId=null)}},ondirectclick:function(e){if(Daria.isLeftButton(e)){var t=this.find("fromEvent",e);if(this.mousedownId){var o=this.find("id",this.mousedownId);o!==t&&this.onmouseup&&this.onmouseup(e,o),this.onclick&&this.onclick(e,o),this.clicked=!0,this.mousedownId=null}t||this.clicked||($(e.target).hasClass("js-sms-open-link")||(this.directclick=!0),this.add().focus(),this.directclick=!1)}},onaction:function(e,t){if(t.id in this.ids){var o=this.find("id",t.id);switch(e){case"yabble.change-email":o.value.email=t.email,o.pasteValue(),this.recalcStrVal(),o.select();break;case"yabble.change-group":$.each(o.value.contacts,function(e,o){o.cid===t.cid&&o.email===t.email&&(o.ignored=!o.ignored)}),this.recalcStrVal();break;case"yabble.edit":o.focus();break;case"yabble.single-target":this.trigger("single-target",o);break;case"yabble.remove":this.remove(o);break;case"yabble.add-to-abook":this.update(o,t.cid)}}},onclick:function(e,t){t.focused||(t.select()||Daria.YabbleDropdown.toggle(t))},ondblclick:function(e,t){Daria.YabbleDropdown.close(),t.focus()},onfocusin:function(e,t){e=e||$.Event("focusin",{target:this.root[0]});if(Daria.composeParams){var o=this.input.closest(".js-compose-mail-input_to").length>0;Daria.composeParams["field-to-focused"]=o}var n=this.option("suggest");n&&(n.changeInputField(t.input[0]),t.focused?(n.setOptions({hide:function(){n.options.yabble.blur()},disabled:!1,timeoutOfCopyToSms:!0,yabble:t,previousValues:this.val().split(/,\s*/)}),this.directclick&&(n.show(""),setTimeout(function(){this.directclick=!1}.bind(this)))):n.setOptions({disabled:!0,hide:_.noop})),t.id!==this.mousedownId&&Daria.YabbleDropdown.close(),this.input.attr("disabled","disabled"),this.root.trigger($.Event(e,{target:this.root[0]}))},onfocusout:function(e,o){var n=this;if(this.mousedownId!==o.id){var s=this.option("suggest");if(s){if(s.dontClose)return;s.setOptions({hide:_.noop}),s.hide()}var i=$.trim(o.userVal()).replace(/(?:,|;)$/,"");if(i||o.input.data("suggest"))if(o.focused){if(Daria.YabbleHistory.push(n),Daria.YabbleHistory.ignore=!0,i.indexOf(",")>-1||i.indexOf(";")>-1){var a=t.splitContacts(i),r=[];$.each(a,function(e,t){r.push(n.add(t,o))}),this.remove(o),"contact"===this.options.yabbleType&&this.resolveContacts(a,r)}else o.blur(),this.recalcStrVal(),o.isContact||o.isGroup||o.isUnreachable||"contact"===this.options.yabbleType&&this.resolveContacts([o.value],[o]);Daria.YabbleHistory.ignore=!1}else o.selected&&o.deselect();else this.remove(o);this.input.removeAttr("disabled"),this.root.trigger($.Event(e,{target:this.root[0]}))}},onkeydown:function(e,t){var o=this;switch(e.which){case Daria.Yabble.KEY.TAB:!e.shiftKey&&this.options.maxItems>this.yabbles.length&&(t.focused&&$.trim(t.userVal())||t.selected)&&(e.preventDefault(),this.add().focus());break;case Daria.Yabble.KEY.RETURN:Daria.isCtrlPressed(e)||e.preventDefault(),this.multi.history.length>1?this.add().focus():$.trim(t.userVal())&&(t.focused?this.add().focus():(t.focus(),this.onfocusin(null,t)));break;case Daria.Yabble.KEY.BACKSPACE:case Daria.Yabble.KEY.DEL:if(this.multi.history.length>1)e.preventDefault(),this.multi.remove();else{var n=this.find(e.which===Daria.Yabble.KEY.DEL?"next":"prev",t),s=this.find(e.which===Daria.Yabble.KEY.DEL?"prev":"next",t);(t.focused&&!$.trim(t.userVal())&&(n||s)||t.selected)&&(e.preventDefault(),this.remove(t),n?n.select():s?s.select():this.add().focus())}break;case Daria.Yabble.KEY.LEFT:if(t.selected||t.focused&&!$.trim(t.userVal())){e.preventDefault();var i=this.find("prev",t);i&&i.select()}break;case Daria.Yabble.KEY.RIGHT:if(t.selected){e.preventDefault();var a=this.find("next",t);a?a.select():this.add().focus()}break;case Daria.Yabble.KEY.HOME:if(t.selected||t.focused&&!$.trim(t.userVal())){e.preventDefault();var r=this.find("first");r&&r.select()}break;case Daria.Yabble.KEY.END:if(t.selected){e.preventDefault();var c=this.find("last");c&&c.select()}break;default:if(t.focused)Daria.isCtrlPressed(e)&&!$.trim(t.val())&&(e.which===Daria.Yabble.KEY.A?this.multi.selectAll():e.which===Daria.Yabble.KEY.Z&&Daria.YabbleHistory.pop(this));else if(Daria.isCtrlPressed(e))switch(e.which){case Daria.Yabble.KEY.C:this.multi.onCtrlC(t);break;case 17:case 91:case 224:break;case Daria.Yabble.KEY.V:o.add().focus();break;case Daria.Yabble.KEY.X:o.multi.history.length&&(o.multi.onCtrlX(t),setTimeout(function(){o.multi.remove()},16));break;case Daria.Yabble.KEY.A:this.multi.selectAll();break;case Daria.Yabble.KEY.Z:Daria.YabbleHistory.pop(this);break;default:o.add().focus()}else e.which!==Daria.Yabble.KEY.SHIFT&&this.add().focus()}},onkeypress:function(e,o){var n,s=this;switch(e.which){case Daria.Yabble.KEY.SPACE:case Daria.Yabble.KEY.SEMI:case Daria.Yabble.KEY.COMMA:if(n=o.userVal().replace(/[,;\s]/g,""),o.focused&&n){if(e.which===Daria.Yabble.KEY.SPACE&&!t.checkEmail(n))break;setTimeout(function(){s.add().focus()},0)}else e.preventDefault()}},onpaste:function(e,t){var o=this;setTimeout(function(){o.add().focus(),t.isUnreachable&&(t.focus(),Daria.setSelection(t.input[0],9999))},0)},add:function(e,t){if(this.options.maxItems<=this.yabbles.length){var o=this.find("last");return o&&o.input&&o.input.val()?(o.select(),this.recalcStrVal()):o&&o.focus(),{focus:$.noop}}var n=this.multi.wrap(new this.options.yabbleCtor(e)),s=t&&$.inArray(t,this.yabbles);return this.ids[n.id]=!0,e&&Daria.YabbleHistory.push(this),s>-1?(n.root.insertBefore(t.root),this.yabbles.splice(s,0,n)):(this.wrapper.append(n.root),this.yabbles.push(n)),n},showSmsYabble:function(){this.yabbles.forEach(function(e){e.showSmsLink&&e.showSmsLink()})},hideSmsYabble:function(){this.yabbles.forEach(function(e){e.hideSmsLink&&e.hideSmsLink()})},update:function(e,t){ns.request("abook-contact",{cid:t}).then(function(t){var n=t[0].getContactInfo(o);$.isEmptyObject(n)||(e.val(n),e.pasteValue()),e.select()})},remove:function(e,t){var o=$.inArray(e,this.yabbles);if(-1!==o){Daria.YabbleHistory.push(this),this.yabbles.splice(o,1),delete this.ids[e.id],Daria.YabbleDropdown.close(e),e.destroy();var n=this.option("suggest");n&&n.destroy(),this.recalcStrVal(t)}},find:function(e,t){var o;if("fromEvent"===e)return(o=$(t.target).closest(".js-yabble",this.wrapper[0])[0])&&this.find("target",o);if("first"===e)return this.yabbles[0];if("last"===e)return this.yabbles[this.yabbles.length-1];for(var n=0;n<this.yabbles.length;n++)if(o=this.yabbles[n],"target"===e){if(o.root[0]===t)return o}else if("prev"===e||"next"===e){if(o===t){if("prev"===e)return this.yabbles[n-1];if("next"===e)return this.yabbles[n+1]}}else if("id"===e){if(o.id===t)return o}else if(o[e])return o},_setYabbleEvent:function(e,t){var o=this;t=t||this["on"+e],this.root.on(e,".js-yabble",function(n){if(o.e=n,"focusout"!==e||"input"===n.target.tagName.toLowerCase()){var s=o.find("target",n.currentTarget);s&&(t&&t.call(o,n,s),s["on"+e]&&s["on"+e].call(s,n))}})},resolveContacts:function(e,t){if(e.length){var n=this;t=t||this.yabbles;var s,i=1/0,a=[];e.forEach(function(e){e.email.length<256&&((i+=e.email.length+1)>256&&(i=0,s=[],a.push(s)),s.push(e.email))}),a.forEach(function(s){var i=[],a=s.join(",");i.push({id:"abook-contacts",params:{emails:a}}),Daria.Config.workspace&&i.push({id:"abook-contacts",params:{emails:a,shared:1}}),ns.request(i).then(function(i){var a=!1,r=i[0].getContactsInfoByEmails(s,o),c=(i[1]?i[1].getContactsInfoByEmails(s,_.extend({shared:!0},o)):[]).concat(r);$.each(e,function(e,o){var n=o.email,s=t[e];if(s&&s.value.email===n)for(var i=c.length;i--;)if(n===c[i].email)return a=!0,s.val(Daria.Yabble.mergeContact(c[i],s.value)),s.pasteValue(),!0}),a&&n.recalcStrVal()})})}},val:function(e){var o,n=this;if(void 0===e)return this.strVal;for(;this.yabbles[0];)this.remove(this.yabbles[0],{silent:!0});"string"==typeof e&&e?(o="contact"===this.options.yabbleType?t.splitContacts(e):e.split(/[;\s]/),$.each(o,function(e,t){n.add(t)}),"contact"===this.options.yabbleType&&(n.recalcStrVal(),n.resolveContacts(o))):$.isArray(e)&&($.each(e,function(e,t){n.add(t)}),"contact"===this.options.yabbleType&&(n.recalcStrVal(),n.resolveContacts(e))),Daria.YabbleHistory.ignore||Daria.YabbleHistory.start(this)},focus:function(e){e&&(this.directclick=!0),this.add().focus()},isFocused:function(){return _.some(this.yabbles,"focused",!0)},validate:function(){for(var e=this.yabbles.length;e--;)if(this.yabbles[e].isUnreachable)return!1;return!0},destroy:function(){var e=this;this.val(""),n.actions.forEach(function(t){ns.events.off(t,e.onactionRef)}),this.root.unbind(),this.input.unbind(),this.multi.destroy(),Daria.YabbleHistory.stop(this);var t=this.option("suggest");t&&t.destroy()}},no.extend(n.prototype,ns.Events),Daria.Yabbles=n}()},3091:function(e,t){!function(){var e=Daria.Constants.CONTACTS.DELIMITER,t=Daria.Yabble.prototype,o=Daria.YabbleMulti=function(e){this.set=e,this.clear()};o.prototype={history:null,push:function(e){this.pop(e),this.history.push(e),this.focusLast=void 0},pop:function(e){for(var t=this.history.length;t--;)this.history[t]===e&&this.history.splice(t,1)},clear:function(){this.shiftFirst=void 0,this.focusLast=void 0,this.history=[]},first:function(){return this.history[0]},last:function(){return this.history[this.history.length-1]},val:function(){return $.map(this.history,function(e){return e.val()}).join(e)},ids:function(){return $.map(this.history,function(e){return e.id})},wrap:function(e){var o=this;return e.deselect=function(){var e=o.set.mousedownId;if(!o.set.find("id",e)){var t=o.ids().join(",");setTimeout(function(){t===o.ids().join(",")&&o.deselectAll()},0)}},e.select=function(){var n=o.set.e||{},s=Daria.isCtrlPressed(n),i=n.shiftKey,a=$.inArray(n.which,[Daria.Yabble.KEY.LEFT,Daria.Yabble.KEY.RIGHT])>-1;if(i&&(!a||0!==o.history.length)||s&&!a)return i?o.selectTo(e):e.selected?(o.pop(e),t.deselect.apply(e),o.last()&&t.select.apply(o.last())):(t.select.apply(e,arguments),o.push(e)),!0;o.deselectAll(),o.push(e),t.select.apply(this,arguments)},e.focus=function(){var n=o.set.find("prev",e);o.deselectAll(),setTimeout(function(){o.focusLast=n},16),t.focus.apply(e,arguments)},e.destroy=function(){o.pop(e),t.destroy.apply(e,arguments)},e},onCtrlC:function(e){if(this.history.length>1){var t=this.val();e.input.val(t),e.doInput("focus",!0),e.input.one("keyup blur",function(){e.root&&e.doInput("focus",!0)})}},remove:function(){var e=this;Daria.YabbleHistory.push(this.set),Daria.YabbleHistory.ignore=!0,$.each(this.history.slice(),function(t,o){e.set.remove(o)});var t=e.set.add();t&&t.focus(),Daria.YabbleHistory.ignore=!1},selectAll:function(){var e=this,o=$.map(this.set.yabbles,function(e){return e.selected?null:e});$.each(o,function(o,n){n&&!n.focused&&(t.select.apply(n),e.push(n))})},selectTo:function(e){var o=this.shiftFirst||this.focusLast||this.last()||this.set.yabbles[0];this.deselectAll(),this.shiftFirst=o;for(var n=$.inArray(o,this.set.yabbles)>$.inArray(e,this.set.yabbles)?"prev":"next";o&&o!==e;)t.select.apply(o),this.push(o),o=this.set.find(n,o);t.select.apply(e),this.push(e)},deselectAll:function(){this.clear(),$.each(this.set.yabbles,function(e,o){t.deselect.apply(o)})},unwrap:function(e){},destroy:function(){this.clear()}},o.prototype.onCtrlX=o.prototype.onCtrlC}()},3092:function(e,t){Daria.YabbleHistory={sets:{},history:{},ignore:!1,start:function(e){this.history[e.id]=[],this.sets[e.id]=e},stop:function(e){delete this.history[e.id]},key:function(e){return $.map(e,function(e){return e.email||""}).join(",")},values:function(e){return $.map(e.yabbles,function(e){return!$.isEmptyObject(e.value)&&$.extend({},e.value)||null})},push:function(e,t){if(!this.ignore&&this.history[e.id]){var o=this.history[e.id],n=o[o.length-1],s=this.values(e),i=this.key(s);if(n&&n.key===i)t&&(n.link=t);else{var a={values:s,key:i};t&&(a.link=t),o.push(a)}}},pop:function(e){this.ignore=!0;var t=this.history[e.id];if(t&&t.length){var o=t.pop();e.val(o.values);var n=e.add();if(n&&n.focus(),o.link)for(var s in this.history){var i=this.history[s];i.length&&o.link===i[i.length-1].link&&this.pop(this.sets[s])}}this.ignore=!1}}},3093:function(e,t){function o(e){"@babel/helpers - typeof";return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Daria.YabblePhone=function(){Daria.Yabble.apply(this,arguments)},Jane.extend(Daria.YabblePhone,Daria.Yabble),Daria.YabblePhone.prototype.validate=function(){var e=this.value;e?(this.isUnreachable=!Jane.FormValidation.checkPhoneNumber(e),this.root.toggleClass(Daria.Yabble.YC.unreachable,this.isUnreachable)):this.isUnreachable=!1},Daria.YabblePhone.prototype.blur=function(e){this.focused&&(this.val(this.getValue()),this.pasteValue(),e||this.doInput("disable"),this.root.attr("draggable","true"),Modernizr.msie&&this.root.removeAttr("style"),this.focused=!1)},Daria.YabblePhone.prototype.val=function(e){if(void 0===e)return this.value;"object"===o(e)?this.value=e.phone:this.value=e},Daria.YabblePhone.prototype.pasteValue=function(){var e=this.value;this.input.val(this.val()),this.text.text(e),this.root.removeClass(Daria.Yabble.YC.focused),this.isContact=!0,this.isPhone=!0,this.isGroup=!1,this.root.toggleClass(Daria.Yabble.YC.contact,this.isContact),this.root.toggleClass(Daria.Yabble.YC.group,this.isGroup);var t=this.root.find(".js-yabble-avatar");t.length&&t.replaceWith(Daria.Recipients.add({href:!1,size:20,className:"mail-Yabble__avatar"})),this.validate()}},3094:function(e,t){!function(){if("ontouchend"in window&&/iPad|iPhone/.test(navigator.userAgent)){var e=Daria.Yabble.KEY,t=Daria.Yabbles;t.directEvents=["touchend"];var o=t.prototype.onkeydown;$.extend(t.prototype,{ondirecttouchend:function(e){var t=this.find("fromEvent",e);if(t&&this.onclick&&(!t.focused||t.userVal()))this.onclick(e,t);else{var o=this.add();o&&o.focus()}},onkeydown:function(t,n){if(t.which===e.BACKSPACE||t.which===e.DEL){var s=this.find(t.which===e.DEL?"next":"prev",n),i=this.find(t.which===e.DEL?"prev":"next",n);if(n.focused&&!$.trim(n.userVal())&&(s||i))t.preventDefault(),s?this.remove(s):i&&this.remove(i);else if(n.selected)if(t.preventDefault(),this.remove(n),s)s.select();else if(i)i.select();else{var a=this.add();a&&a.focus()}}else o.apply(this,arguments)}})}}()},3095:function(e,t,o){o(3096),o(3097),o(3098),o(3099),o(3100),o(3101),o(3102),o(3103),o(3104),o(3105),o(3107),o(3108),o(3109),o(3110),o(3111),o(3112),o(3113),o(3114),o(3115),o(3116),o(3117),o(3118)},3096:function(e,t){ns.Model.define("do-attach-file-status",{params:{oid:null}})},3097:function(e,t){ns.Model.define("do-attach-file-store",{params:{file:null,checkLimit:null,size:null}})},3098:function(e,t){!function(){var e=ns.ModelStatic,t=["attachments.added","attachments.appended","attachments.updated","attachments.removed","attachments.failed"];ns.Model.define("compose-attachments",{params:{ids:null,tids:null,oper:null},ctor:function(){this._attachments=null,this.processCollectionEvent=this.processCollectionEvent.bind(this)},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=!this._mComposeMessage||this._mComposeMessage.canRequest();return e&&t},request:function(){var e=this,t=ns.Model.info("message-body").calculateParamsForMessageBody(this.params);return t?ns.request(["message-body","compose-message"],t).then(function(t){e._initByModels(t[0],t[1])}):(e.setData({}),vow.resolve())},init:function(e){this._attachments?this._attachments.setOptionsAndInit(e):(this._attachments=new Daria.AttachmentCollection2(e),this.bindEventsToAttachments())},_initByModels:function(e,t){this.setData({}),this._mMessageBody=e,this._mComposeMessage=t;var o=new Daria.AttachmentCollection2;o.mComposeMessage=t,this._attachments=o,this.bindEventsToAttachments(),t.isReplyAny()||e.getAttachments().forEach(function(e){e.inline||this.addAttachData(e)},this)},addAttachData:function(e,t){if(this._attachments){var o=t&&t.mMessageBody?t.mMessageBody:this._mMessageBody,n=t&&t.mComposeMessage?t.mComposeMessage:this._mComposeMessage,s=Daria.Attachment2.fromMessageBody(e,o,n);return this._attachments.addAttachToCollection(s,{silent:!0,processAttachSize:!0}),s}},destroy:function(){e.prototype.destroy.apply(this,arguments),this.unbindEventsFromAttachments(),this._attachments&&(this._attachments.reset(),this._attachments=null)},bindEventsToAttachments:function(){this._attachments&&_.each(t,function(e){this._attachments.on(e,this.processCollectionEvent)},this)},unbindEventsFromAttachments:function(){this._attachments&&_.each(t,function(e){this._attachments.off(e,this.processCollectionEvent)},this)},processCollectionEvent:function(e,t){this.trigger("ns-model:"+e,t)},addAttach:function(e){this._attachments&&(e.resource?this._attachments.addDiskAttach(e.id,e.resource):this._attachments.add(e.input,e.files))},appendAttach:function(e,t,o){this._attachments&&this._attachments._appendAttach(e,t,o)},drawAttaches:function(){if(this._attachments){var e=this.params.ids||Daria.getPageComposeIds();this._attachments.redrawAttachesBulk(null,e)}},updateAfterSave:function(e,t){this._attachments&&this._attachments.updateAfterSave(e,t,!0)},isUploading:function(){return this._attachments&&this._attachments.isUploading()},isFailed:function(){return!!this._attachments&&this._attachments.isFailed()},hasFiles:function(){return this._attachments&&this._attachments.hasFiles()},retryAttach:function(e){this._attachments.retryAttach(e)},getSummary:function(){return this._attachments.getSummary()}}})}()},3099:function(e,t){ns.Model.define("disk-default-folders",{methods:{isPhotostream:function(e){return e&&this.get(".photostream")===e}}})},3100:function(e,t){!function(e,t){var o=null;ns.Model.define("disk-resources",{params:{path:null,offset:null,sort:null,order:null},methods:{cancelledAttachPaths:[],getDefaultSort:function(e){return ns.Model.get("disk-default-folders").isPhotostream(e)?"etime":"name"},removeAttach:function(e){this.cancelledAttachPaths.push(e)},getDefaultOrder:function(e){return ns.Model.get("disk-default-folders").isPhotostream(e)?"0":"1"},deselect:function(){var e=o;o=null,ns.events.trigger("disk-resources.selected",{before:e})},select:function(e){if(e&&e!==o){var t=o;o=e,ns.events.trigger("disk-resources.selected",{before:t,now:e})}},getSelected:function(){return o},extractError:function(e){return 404===Number(jpath(e,".error.http_status")[0])?(ns.events.trigger("disk-resources.not-found",e.error),e.data={},null):e.error},preprocessData:function(e){var t=jpath(e,".resource.resource")[0];if(Array.isArray(t)){if(t.forEach(i),this.params.hasOwnProperty("offset")){var o=$.extend({},this.params);delete o.offset;var n=ns.Model.get(this.id,o),s=n.getData();if(s){var a=no.jpath(".resource",s)[0];a&&(Array.prototype.push.apply(a.resource,t),n.__offset=t.length+(n.__offset||0))}else n.setData(e),n.__offset=t.length;return n.__complete=0===t.length,e}this.__offset=t.length,this.__complete=0===t.length}return e},getPreview:function(e){var t=$.Deferred(),o={private_hash:e,meta:"preview"};return ns.request("do-disk-get-public-preview",o).then(function(e){var o=jpath(e[0].getData(),".resource.meta.preview")[0];o?t.resolve(o):t.reject("no disk preview")},function(){t.reject()}),t.promise()},attach:function(e,t){var o=$.Deferred(),n=this;function s(e,t){ns.forcedRequest("do-disk-attach-file",{src:e,dst:t}).then(function(t){var s=t[0];if(s.getError())ns.Model.invalidate(n.id),o.reject(s.getError());else{var i=s.getData();if(i&&i.oid){var a={oid:i.oid,meta:"short_url,public,size,public_hash"};n.poll(a,e).done(function(e){var t=e.file||e.folder;t.type=e.file?"file":"dir",o.resolve({url:t.meta&&t.meta.short_url,name:t.name,type:t.type,size:t.meta&&t.meta.size,hash:t.meta&&t.meta.public_hash})}).fail(function(e){o.reject(e)})}else o.reject("disk-attach-file: no data oid")}},function(e){ns.Model.invalidate(n.id),o.reject(e.data||e)})}return s(e,t),o.promise()},poll:function(e,t){var o=$.Deferred(),n=1500,s=this;return function i(){ns.forcedRequest("do-attach-file-status",e).then(function(e){var a=e[0],r=jpath(a.getData(),".operation")[0];if(!r)return o.reject("attach file status: unknown operation");if(-1!==s.cancelledAttachPaths.indexOf(t))return _.remove(s.cancelledAttachPaths,t),o.reject("attach file status: uknown resourceId");var c=r.status;"EXECUTING"===c||"WAITING"===c?window.setTimeout(i,n):"FAILED"===c?o.reject(c.error):"DONE"===c&&o.resolve(r)},function(){o.reject()})}(),o.promise()},loadMore:function(e){var t=$.Deferred(),o=$.extend({},e);delete o.offset;var n=ns.Model.get(this.id,o);return n.__complete?t.reject():(ns.forcedRequest("disk-resources",$.extend({offset:n.__offset},o)).then(function(e){var o=e[0],n=no.jpath(".resource.resource",o.getData())[0];if(n){var s=n[0];if(s)return t.resolve(s)}t.reject("disk-resources: no resource")},function(){t.reject()}),t.promise())},find:function(e){var o=t.utils.dirname(e)+"/",n=ns.Model.get(this.id,{path:o,sort:this.getDefaultSort(o),order:this.getDefaultOrder(o)});if(!n.getData()||!n.get(".resource")||!n.get(".resource")[0])return!1;for(var s=n.get(".resource")[0],i=0,a=s.resource.length;i<a;i+=1)if(s.resource[i].id===e)return s.resource[i];return!1}}});var n=new RegExp("("+t.Config.domainZonesForReg+"|([^\\.]+)$)"),s=/^(https?:)/;function i(e){e.meta&&e.meta.sizes&&$.each(e.meta.sizes,function(o,n){var i=t.Config["downloader-domain-zone"];"mail"===e.service?-1===n.url.indexOf("yandex.net")&&(n.url=a(n.url,i)):"ua"===i&&(n.url=a(n.url,"ru")),n.url=function(e){return e.replace(s,"")}(n.url)})}function a(e,t){var o=e.match(/(?:(?:https?\:)?\/\/)?[^\/]*/g)[0];return e.replace(o,o.replace(n,t))}}(Jane,Daria)},3101:function(e,t){ns.Model.define("do-disk-attach-file",{params:{dst:null,src:null}})},3102:function(e,t){ns.Model.define("do-disk-get-public-preview",{params:{private_hash:null,meta:null}})},3103:function(e,t){!function(){var e="no_reply_notify",t="no_reply_notify_time",o="noreply_popup_shown",n=[{time:{hours:1}},{time:{hours:12}},{time:{days:1}},{time:{days:2}},{time:{days:3}},{time:{days:5},default:!0},{time:{weeks:1}},{time:{weeks:2}}];ns.Model.define("compose-notify-noreply-options",{params:{ids:null,oper:null},methods:{request:function(){var e=this._constructModelRequest();return ns.request(e).then(this._initFromModels,this)},_constructModelRequest:function(){return[{id:"settings"}]},_initFromModels:function(e){this.mSettings=e[0],this.setData({enabledNotify:!1,alwaysNotify:!1,currentTimeDelta:null,timeDeltaItems:this._generateTimeDeltaItems(n)}),this.initData()},_getTimeDeltasUnitToStore:function(){return"seconds"},_generateTimeDeltaItems:function(e){var t=this.mSettings.getSetting("no_reply_notify_time"),o=this._getTimeDeltasUnitToStore(),n=Boolean(this.isSetInSettings()&&t);return t=t?parseInt(t,10):0,e=_.clone(e,!0),_.map(e,function(e){var s=!1,i=Daria.timify(e.time,o);return n?s=i===t:e.default&&(s=!0),_.extend(e,{value:Daria.timify(e.time,o),text:Jane.Date.daysIntervalLocalization(e.time,!0),selected:s})})},getCurrentTimeDelta:function(){return this.get(".currentTimeDelta")},setCurrentTimeDelta:function(e){(e=this.findTimeDeltaItem(e))||(e=this.getDefaultTimeDeltaItem()),this.set(".currentTimeDelta",e),this.set(".enabledNotify",!0)},getCurrentTimeDeltaLocalizedText:function(){var e=Jane.Date.daysIntervalLocalization(this.getCurrentTimeDelta().time);return i18n("%Compose_Checkbox_No_Reply_Active_Text_3",e)},findTimeDeltaItem:function(e){var t=e;return e&&e.value&&(t={value:Number(e.value)}),_.find(this.get(".timeDeltaItems"),t)},getSelectedTimeDeltaItem:function(){return this.findTimeDeltaItem({selected:!0})},getDefaultTimeDeltaItem:function(){return this.findTimeDeltaItem({default:!0})},isSetInSettings:function(){return Boolean(this.mSettings.isSet(e))},setAlwaysNotifyOption:function(o){var n={};o?(n[e]=!0,n[t]=this.getCurrentTimeDelta().value,this.set(".alwaysNotify",!0),this.set(".enabledNotify",!0)):(n[e]=!1,this.set(".alwaysNotify",!1)),this.mSettings.setSettings(n)},wasFirstVisitPopupShown:function(){return this.mSettings.isSet(o)},setFirstVisitPopupWasShown:function(){this.mSettings.setSettingOn(o)},initData:function(){this.set(".currentTimeDelta",this.getSelectedTimeDeltaItem()),this.set(".enabledNotify",this.isSetInSettings()),this.set(".alwaysNotify",this.isSetInSettings())}}})}()},3104:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(1531);!function(){var e=Daria.Constants.CONTACTS.DELIMITER,t=Vow.resolve();ns.Model.define("compose-predefined-data",{events:{"ns-model-init":"_onInit"},params:{},methods:{request:function(){return t},_replaceParams:{mailto:"to",body:"send",subject:"subj"},_pickableParams:["to","cc","bcc","save_symbol","send","subj","qrText"],_normalizableParams:["to","cc","bcc"],_onInit:function(){var e=this._createDataFromUrl();this.setData(e),_.isEmpty(e)||this._cleanUrl()},_replaceParamsCallback:function(e,t){this.hasOwnProperty(t)&&(this[e]=this[t],delete this[t])},_createDataFromUrl:function(){return Daria.isComposePage()?this.extractDataFromParams(ns.page.current.params):{}},extractDataFromParams:function(t){var o=_.clone(t);_.forEach(this._replaceParams,this._replaceParamsCallback,o),_.forEach(this._normalizableParams,function(t){var n=o[t];if(n){var s=Jane.FormValidation.splitContacts(n);s.forEach(function(e){Jane.FormValidation.reEmail.test(e.name||"")&&(e.name=e.email)});var i=_.map(s,Jane.FormValidation.obj2contact);o[t]=i.join(e)}});var n=_.pick(o,this._pickableParams);return n.send&&(n.send=this._getBody(n.send)),n.qrText&&(n.qrText=this._getBody(n.qrText)),n},_getBody:function(e){if(this._shouldReturnPlainText())return this._isHtml(e)?Daria.Html2Text.html2text(e):e;this._isHtml(e)||(e=_.escape(e).replace(/(?:\r\n|\r|\n)/g,"<br>"));return n.a.sanitize(e,{ALLOW_DATA_ATTR:!1,USE_PROFILES:{html:!0}})},_isHtml:function(e){var t=(new DOMParser).parseFromString(e,"text/html");return Array.from(t.body.childNodes).some(function(e){return 1===e.nodeType})},_shouldReturnPlainText:function(){return Daria.UA.isMobile},_cleanUrl:function(){var e=this._pickableParams.concat(Object.keys(this._replaceParams)),t=_.omit(ns.page.current.params,e);ns.page.replacePage(ns.page.current.page,t)}}})}()},3105:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(3106),s=o(702),i=o(1069),a=o(1084),r=o(355),c=(o.n(r),o(137)),u=(o.n(c),o(71));function l(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),o.push.apply(o,n)}return o}function d(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}!function(){var e=Daria.Constants.CONTACTS.DELIMITER,t={att_ids:null,bcc:"",captcha_entered:null,captcha_key:null,cc:"",charset:null,confirm_limit:null,current_folder:null,doit:null,errors:{to:"",cc:"",bcc:"",phone:""},fid:null,from_mailbox:null,from_name:null,get_abook:null,html:null,idcs:null,ids:[],ign_overwrite:null,initial_cc:"",initial_to:"",inreplyto:null,lids:[],mark_as:null,mark_ids:[],disk_att:null,nosave:null,nosend:null,notify_on_send:null,overwrite:null,parts:null,phone:null,references:null,remind_period:null,"recipients-diff":{added:[],removed:[]},retpath:null,returl:null,saveDraft:null,save_symbol:c.WellKnownFolderSymbol.DRAFT,send:"",send_time:null,store_fid:null,store_name:null,strict_charset:null,style:null,subj:null,to:"",ttype:null,where:null,withUpdatedUndoAndDelayedErrorHandling:"yes"},o=_.map(["to","cc","bcc","phone","subj","send","from_mailbox","from_name","ttype","att_ids","parts","disk_att","save_symbol","lids"],function(e){return"."+e}),h=ns.Model;ns.Model.define("compose-message",{params:{ids:null,tids:null,oper:null},events:{"ns-model-destroyed":"_onDestroyed","ns-model-changed.to":"_onRecipientsChanged","ns-model-changed.cc":"_onRecipientsChanged","ns-model-changed.bcc":"_onRecipientsChanged"},ctor:function(){this._attachments={},this.mSettings=null,this.mComposePredefinedData=null,this.mMessage=null,this.mMessageBody=null,this.mComposeState=null,this._saveDraftPromise=null,this._cancelled=!1,this._cancelSendCallback=null,this._isIgnoreUndo=!1,this._syncService=new s.b},methods:{_onDestroyed:function(){this._isDirty=!1,this._cancelled=!1,this._cancelSendCallback=null,this._isIgnoreUndo=!1},setIfChanged:function(e,t){if(this.isValid()&&this.data){var o=!0;if(-1!==[".to",".cc",".bcc"].indexOf(e)){var n=/,\s*$/;o=this.get(e).replace(n,"")!==t.replace(n,"")}o&&ns.Model.prototype.setIfChanged.apply(this,arguments)}},_dataPathToActionLogName:{".to":"редактирование письма/получатель (To:)",".subj":"редактирование письма/тема",".send":"редактирование письма/текст",".parts":"редактирование письма/аттачи",".disk_att":"редактирование письма/аттачи",".parts_json":"редактирование письма/аттачи"},set:function(e,t){if(!_.isEqual(t,this.get(e))){_.contains(o,e)&&(this._isDirty=!0);var n=Daria.SendMail.getUndoSendLogger(this.params.ids),s=this._dataPathToActionLogName[e];return s&&n.logActionOnceAfterCancel(s),h.prototype.set.apply(this,arguments)}},setData:function(){return this._isDirty=!0,h.prototype.setData.apply(this,arguments)},setPhoneIfExist:function(e,t){if(!this.get(".phone")||t){var o=ns.Model.get("abook-contacts").getContactDataByEmail(e);if(o&&o.cid){var n=ns.Model.get("abook-contact",{cid:o.cid,shared:o.isShared}),s=n.isValid()&&n.getPhone();return s&&this.setIfChanged(".phone",s),vow.Promise.resolve()}return ns.request("abook-contact",{email:e}).then(function(e){var t=e[0].getPhone();t&&this.setIfChanged(".phone",t)},this)}},setSingleRecipient:function(e){this.setIfChanged(".to",e),this.setIfChanged(".cc",""),this.setIfChanged(".bcc","")},canRequest:function(){var e=ns.Model.infoLite("message-body").calculateParamsForMessageBody(this.params),t=ns.Model.get("message-body",e),o=ns.Model.get("signs");return t.canRequest()&&!t.get(".error")&&o.status!==ns.M.STATUS.ERROR},request:function(){var e=this;return Daria.requestModelsForCompose(this.params).then(function(t){return e._initFromModels(t)})},isDraft:function(){return this.composeParamsService.isDraft()},getMessageType:function(){return this.composeParamsService.getMessageType()},getDraftMid:function(){var e=this.get(".overwrite");if(this.isDraft()&&e)return e},getTemplateMid:function(){var e=this.get(".overwrite");if(this.isTemplate()&&e)return e},_constructModelRequest:function(){var e=[{id:"settings"},{id:"compose-predefined-data"}];return this.params.ids&&_.isString(this.params.ids)&&!this.params.tids&&e.push({id:"message",params:{ids:this.params.ids}},{id:"message-body",params:ns.Model.infoLite("message-body").calculateParamsForMessageBody(this.params)}),e},_prepareDataForSet:function(e){var o=_.extend(_.cloneDeep(t),this.mComposePredefinedData.getData(),e,this._customizerPrepareData),n=function(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?l(Object(o),!0).forEach(function(t){d(e,t,o[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):l(Object(o)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))})}return e}({},o,{},Object(s.c)(o));return this.mComposePredefinedData.destroy(),n},_customizerPrepareData:function(e,t,o){return"send"===o?t||e:t},_initFromModels:function(e){this.mMessage=_.find(e,"id","message"),this.mSettings=_.find(e,"id","settings"),this.mMessageBody=_.find(e,"id","message-body"),this.mComposePredefinedData=_.find(e,"id","compose-predefined-data"),this.mComposeState=ns.Model.get("compose-state",this.params);var t=this.mComposePredefinedData.getData();this.composeParamsService=new s.a(this.params,t),this.composeParamsService.newMessageId=Object(a.a)(e);var o=this.composeParamsService.getComposeMessageData();this.needCollapsedQuotedMessage()&&(o.send="",o.collapsedMessage=!0);var n=this._prepareDataForSet(o);this.setData(n),this.markSaved(),this.composeParamsService.data=this.data},isMessageCollapsed:function(){return Boolean(this.get(".collapsedMessage"))},needCollapsedQuotedMessage:function(){return!Daria.isComposePage()},expandMessage:function(){this.isMessageCollapsed()&&(this.isReplyAny()&&this.set(".send",this.getSendMessage()),this.set(".collapsedMessage",!1))},getSendMessage:function(){var e=this.get(".send");if(this.isMessageCollapsed()&&this.isReplyAny()){var t=this.get(".ttype"),o=this.get(".from_mailbox");e+=this.mMessageBody.getReplyBody(t,o)}return e},isHtmlType:function(){return"html"===this.get(".ttype")},isDirty:function(){return this._isDirty},wasSendCancelled:function(){return this._cancelled},setDirty:function(e){this._isDirty=e},setSendWithoutUndo:function(){this._isIgnoreUndo=!0},markSaved:function(){this._isDirty=!1},changeRecipientsToOpposite:function(){var e=this.isReplyAll(),t={to:this.get(".to"),cc:this.get(".cc")},o=this.mMessageBody.getRecipients(e),n=this.mMessageBody.getRecipients(!e);this.set(".to",this._calculateOppositeRecipients(t.to,o.to,n.to)),this.set(".cc",this._calculateOppositeRecipients(t.cc,o.cc,n.cc))},_extractEmailsFromContacts:function(e){return _(e).pluck("email").compact().value()},_calculateOppositeRecipients:function(e,t,o){e=Jane.FormValidation.splitContacts(e),t=Jane.FormValidation.splitContacts(t),o=Jane.FormValidation.splitContacts(o);var n=this._extractEmailsFromContacts(t),s=_.filter(e,function(e){return!_.contains(n,e.email)}),i=this._extractEmailsFromContacts(s),a=_.filter(o,function(e){return!_.contains(i,e.email)});return Daria.formatContacts([].concat(s,a))},_checkData:function(){return n.a.validate(this)},storeErrors:function(e){_.each(e,function(e,t){this.setIfChanged(".errors."+t,e)},this),this.triggerFieldErrors(e)},triggerFieldErrors:function(e){this.trigger("ns-model:validation-error",e)},cleanErrors:function(){_.each(["to","cc","bcc","phone","att_ids"],function(e){this.setIfChanged(".errors."+e,"")},this)},getFieldError:function(e){return this.get(".errors."+e)},confirmations:Daria.ComposeComponents.confirmations.getConfirmations(),checkConfirmations:function(){var e=!1,t={};return _.each(this.confirmations,function(o){return!(e=o(this,t))},this),e&&this.trigger("ns-model:need-to-confirm:"+e,t),e},hasAttach:function(){return!_.isEmpty(this._attachments)||this.get(".ids").length},_getAttributeFromData:function(e,t){return _(e).pluck(t).compact().value()},_excludeFromProperty:function(e,t){return _.without(this.get("."+e),t)},addAttachment:function(e,t){this._attachments[e.info.id]=e,this._saveAttachmentData(),t&&this._savePartsJsonAttachmentData()},removeAttachment:function(e){delete this._attachments[e],this._saveAttachmentData()},addTextFromMessageBody:function(e){var t=this.get(".ttype"),o=e.getComposeHTML();"html"===t?o+="<br>":o=Daria.Html2Text.html2text(o)+"\n";var n=this.get(".send");this.set(".send",o+n)},addAttachmentsFromTemplateMessageBody:function(e){var t=ns.Model.get("compose-attachments",this.params);e.getAttachments().forEach(function(o){if(!o.inline){delete(o=_.extend({},o,{from_template:!0,template_mid:e.params.ids,template_hid:o.hid})).hid;var n=t.addAttachData(o,{mMessageBody:e,mComposeMessage:this});n.mComposeMessage.addAttachment(n,!0),t.appendAttach(n,!0)}},this)},setRecepientsFromMessageBody:function(e){var t=this;["to","cc","bcc"].forEach(function(o){var n=e.getAddressField(o);n&&t.set("."+o,n)}),this.mComposeState.set(".isCcVisible",Boolean(this.get(".cc"))),this.mComposeState.set(".isBccVisible",Boolean(this.get(".bcc")))},addForwardedMessages:function(e){if("forwarded"===this.get(".mark_as")){e=$.makeArray(e);var t=_.uniq(this.get(".mark_ids").concat(e));this.set(".mark_ids",t);var o=_.uniq(this.get(".ids").concat(e));this.set(".ids",o)}},removeForwardedMessages:function(e){if("forwarded"===this.get(".mark_as")){e=$.makeArray(e);var t=_.difference(this.get(".mark_ids"),e);this.set(".mark_ids",t);var o=_.difference(this.get(".ids"),e);this.set(".ids",o)}},_saveAttachmentData:function(){var e=_.map(this._attachments,function(e){return Object(i.a)(e.info,e.status)});this.set(".att_ids",this._getAttributeFromData(e,"att_id")),this.set(".parts",this._getAttributeFromData(e,"hid"));var t=this._getAttributeFromData(e,"disk"),o=t.length?JSON.stringify(t):"";this.set(".disk_att",o)},_savePartsJsonAttachmentData:function(){var e=_.map(this._attachments,function(e){return Object(i.a)(e.info,e.status)});this.set(".parts_json",this._getPartsJsonFromAttachmentData(e))},_getPartsJsonFromAttachmentData:function(e){var t=_.filter(e,"from_template").map(function(e){return{mid:e.template_mid,hid:e.template_hid}});return t.length>0?JSON.stringify(t):""},_getCommonSendParams:function(){var e={};return ns.request.addRequestParams(e),e},_updateDataAfterSave:function(e){this.set(".ign_overwrite","no"),e.storedmid&&this.set(".overwrite",e.storedmid),e.store_fid&&this.set(".current_folder",e.store_fid),this.composeParamsService.data=this.data},_processSaveResponse:function(e){var t,o=e.storedmid||this.getDraftMid();if(o&&this.mMessage){t=this.mMessage.get(".mid");var n=ns.Model.get("message-draft",{ids:this.mMessage.params.ids});n.isValid()&&n.setIfChanged(".mid",o)}if(!e.storedmid||this.inNotInitedState())return this.isDraft()?e.storedmid?this._syncService.updateDraftAfterAction(!0,e.storedmid):this._syncService.updateFolders(c.DraftLikeFoldersShort):this.isTemplate()&&this._syncService.updateFolders(c.DraftTemplateLikeFoldersShort),vow.Promise.reject(e.storedmid?"no response mid":"leave compose");if(this._updateDataAfterSave(e),this.isDraft())this._syncService.updateDraftAfterAction(!0,this.getDraftMid());else if(this.isTemplate()){this._syncService.updateTemplateAfterAction(this.getTemplateMid());var s=this.getTemplateMid();ns.events.trigger("daria:mComposeMessage:template-saved",{oldMid:t,mid:s})}return this.markSaved(),this.trigger("ns-model:draft-saved",{mid:e.storedmid,attachments:e.attachment}),e},_processSendResponse:function(e){var t=no.jpath(".limited.recipient",e);t&&this.set(".limited",this._parseLimited(t));var o=no.jpath(".message_id",e);o&&this.set(".sentMessageId",o);var n=no.jpath(".storedmid",e);n&&this.set(".sentMid",n),this._syncService.updateDraftAfterAction(!1,this.getDraftMid()),this._syncService.updateMessageFlagsAfterSend(this.get(".mark_ids"),{isForward:this.isForward(),isReply:this.isReplyAny(),replyMessageId:this.get(".inreplyto")})},_parseLimited:function(t){var o=[],n=[],s={},i=function(e,t){o.push(t.limit),n.push("<"+t.login+"@"+t.$t+">")};return $.isArray(t)?($.each(t,i),o.sort(),s.recipients=n.join(e)):(i(0,t),s.recipient=n[0]),s.limit=Jane.getHumanSize(o[0]),s},isTemplate:function(){return this.composeParamsService.isTemplate()},isNewMessage:function(){return!this.params.ids},isForward:function(){return this.composeParamsService.isForward()},isReplyAll:function(){return this.composeParamsService.isReplyAll()},isReply:function(){return this.composeParamsService.isReply()},isReplyAny:function(){return this.composeParamsService.isReplyAny()},isNewTemplate:function(){var e=!1;return this.mMessage||this.get(".save_symbol")!==c.WellKnownFolderSymbol.TEMPLATE||(e=!0),e},isAutosaveEnabled:function(){return!this.isTemplate()&&(Daria.isReactiveCompose()||this.mSettings.isSet("enable_autosave"))},withUndo:function(){var e=Daria.SendMail.getUndoSendTime();return!this._isIgnoreUndo&&e>0},_prepareDataForMailSend:function(e,t){if((e=_.omit(e,["errors","recipients-diff"])).current_time=Math.floor(Daria.now()/1e3),t?(e.lids=_.filter(e.lids,_.negate(this._systemLabelFilter),this),e.remind_period=null,e.send_time=null):(this.isTemplate()&&(e.ign_overwrite="yes"),this.withUndo()&&!this.isDelayed()&&(e.send_time=Daria.SendMail.getUndoSendTime(),e.relative=!0)),Daria.IS_CORP&&!this.mComposeState.get(".recipients-diff-pane-close")){var o="",n=this._getRecipientsDiffStr();n.length>0&&(o=this.isHtmlType()?Daria.Html2Text.text2html(n)+"<div>&nbsp;</div>":n+"\n\n",e.send=o+e.send)}return e},createTemplateFolder:function(){var e=ns.Model.get("folders"),t=e.getFidBySymbol(c.WellKnownFolderSymbol.TEMPLATE),o=vow.Promise.resolve();return t?this.set(".templates_fid",t):o=e.createTemplateFolder().then(function(e){return this.set(".templates_fid",e.fid),e},this),o},save:function(e){var t=this;return this._saveDraftPromise=this._save(e).always(function(e){return t._saveDraftPromise=null,e}),this._saveDraftPromise},_save:function(e){e=e||{};var t=vow.Promise.resolve();if(!e.force&&!this.isDirty())return t;this.isTemplate()&&(t=this.createTemplateFolder());var o=this.getData(),n=this._getCommonSendParams(),s=_.extend({},o,n,{nosend:"yes"});(s=this._prepareDataForMailSend(s,!0)).send=this.getSendMessage();var i=t.then(this.makeRequest.bind(this,s,"_save=true","save")),a=i.then(this._processSaveResponse,this);return e.httpResponse?i:a},waitForDraftSave:function(){return this._saveDraftPromise?this._saveDraftPromise.always(function(){return vow.resolve()}):vow.resolve()},makeRequest:function(e,t,o){var n=this;if(this._cancelled)return vow.reject("send-cancelled");var s=this;return this.isTemplate()&&!e.templates_fid&&(e.templates_fid=this.get(".templates_fid")),new vow.Promise(function(i,a){n._cancelSendCallback=function(){Jane.ErrorLog.send({errorType:"cancel_send_while_sending",overwriteMid:e.overwrite})},e._eexp=Daria.Config["eexp-boxes"],$.ajax({url:Daria.api["do-send"]+"?"+t,method:"POST",dataType:"json",cache:!1,data:e,success:function(t,n,r){if(Daria.parseLoginInfo(t)){s.onXHRSuccess(t,i,a,o);var c=s.isDelayed()&&!e.relative;s._cancelIfNeeded(t,c)}else s.onXHRError(r,"no_auth",a,o)},error:function(e,t){s.onXHRError(e,t,a,o)},complete:function(){s._cancelSendCallback=null}})})},_cancelIfNeeded:function(e,t){var o=no.jpath(".storedmid",e);o&&this._cancelled&&Daria.SendMail.cancelSendMessage(o,"sending_message",t)},_waitForAttachmentsUploaded:function(){var e=this;return this._cancelled?vow.reject("send-cancelled"):new vow.Promise(function(t,o){e._cancelSendCallback=o;var n=ns.Model.get("compose-attachments",e.params);n.isValid()&&n.isUploading()?(ns.events.once("attachments.all-uploaded",t),n.once("ns-model:attachments.failed",function(){e._checkData().fail(function(t){e.storeErrors(t),o("attachments-failed")})})):t()})},_preSend:function(e){var t=this;return this._cancelled=!1,this.cleanErrors(),new vow.Promise(function(o,n){t._cancelSendCallback=n,t._checkData().fail(function(e){return t.storeErrors(e),vow.reject("message-not-valid")}).then(function(){if(t._cancelled)return vow.reject("send-cancelled");if(!e.force&&t.checkConfirmations())return vow.reject("need-confirm");var o={};if(t.withUndo()){var n=Daria.SendMail.getUndoSendLogger(t.params.ids);n.logShow(),o.onClose=function(){n.logClose()},o.onCancel=function(){n.logCancel(),t._cancelled=!0,t._cancelSendCallback&&(t._cancelSendCallback("send-cancelled"),t._cancelSendCallback=null)}}return Daria.SendMail.showSendingMessage(o),t.trigger("ns-model:store-subject-for-autocomplete"),t._waitForAttachmentsUploaded()}).then(o,n)})},_send:function(){var e=this;if(this._cancelled)return vow.reject("send-cancelled");var t=this.getData(),o=this._getCommonSendParams(),n=_.extend({},t,o);return n.send=this.getSendMessage(),n=this._prepareDataForMailSend(n,!1),this._draftMid=this.getDraftMid(),ns.Model.get("message-failed").setMid(this._draftMid),new vow.Promise(function(t,o){e._cancelSendCallback=o,e.makeRequest(n,"_send=true","send").then(e._processSendResponse,e).then(t,o)})},send:function(e){var t=this;e=e||{};var o=Daria.SendMail.getUndoSendLogger(this.params.ids);return o.logActionOnceAfterCancel("Клик в Отправить"),o.cancelled=!1,o.resetStartTime(),this._preSend(e).then(this._send,this).always(function(e){return t._cancelled&&t._draftMid&&(ns.Model.get("message-failed").removeMid(t._draftMid),t._draftMid=null),t._cancelSendCallback=null,e})},onXHRError:function(e,t,o,n){var s,i,a=e&&e.status;"parsererror"===t?(i="bad_json",s="no_data"):"no_auth"===t?(i="NoAuth",s="no_auth"):s=413===a?"attachment_too_big":a>0?"no_data":"http_status_0",i=i||s,Jane.ErrorLog.send({errorType:"compose.http",status:i},e.responseText),"NoAuth"!==i&&this.onSendError(s,o,n)},onXHRSuccess:function(e,t,o,n){var s=jpath(e,".limited.recipient")[0],i=Array.isArray(s)&&s.length?"ok":jpath(e,".status")[0];switch(i){case"ok":t(e);break;case"captcha_request":e.captcha_key&&ns.Model.get("captcha").setData({key:e.captcha_key,url:e.captcha_url,_:e.captcha_key}),this.trigger("ns-model:captcha-request"),this.onSendError(i,o,n);break;case r.SendError.UNDO_MESSAGE_SAVED:case r.SendError.DELAYED_MESSAGE_SAVED:this._updateDataAfterSave(e),this.onSendError(i,o,n);break;default:this.onSendError(i,o,n)}},onSendError:function(e,t,o){e=e||"internal_error",Jane.ErrorLog.send({errorType:"compose."+o+".failed",status:e}),ns.Model.get("message-failed").removeMid(this.getDraftMid()),t(e)},isSystemLabel:function(e){var t=Object(u.a)(),o=ns.Model.get("labels",{mailboxUid:t}),n=o.getLabelById(e);if(!n)return!1;if(n.user)return!1;var s=o.getWaitingForReplyLabel(),i=o.getDelayedMessageLabel();return _.contains([s,i],n)},getLabelsHash:function(){var e=Object(u.a)(),t=ns.Model.get("labels",{mailboxUid:e}).getLabelsHash(),o=this.get(".lids")||[];return _.each(o,function(e){t[e]=1}),t},addLid:function(e){e=$.makeArray(e);var t=this.get(".lids")||[];if((e=_.difference(e,t)).length){t=t.concat(e);var o=_.all(e,this._systemLabelFilter,this);this.set(".lids",t,{silent:o})}},removeLid:function(e){e=$.makeArray(e);var t=this.get(".lids");t&&t.length&&((t=_.difference(t,e)).length?this.set(".lids",t,{silent:this.isSystemLabel(e)}):(this.set(".lids",[]),delete this.getData().lids))},hasUserLabels:function(){return!_(this.get(".lids")).filter(this._userLabelFilter,this).isEmpty()},getUserLabels:function(){return _(this.get(".lids")).filter(this._userLabelFilter,this).value()},_userLabelFilter:function(e){var t=ns.Model.get("labels"),o=t.getLabelById(e),n=t.getImportantLID();return o&&(o.user||e===n)&&!this.isSystemLabel(e)},_systemLabelFilter:function(e){return this.isSystemLabel(e)},getFromEmails:function(){var e=String(this.get(".from_mailbox")||"");return _.map(ns.Model.get("account-information").getFromEmails(),function(t){return{text:t,value:t,selected:e.toLowerCase()===t.toLowerCase()}})},getLanguage:function(){var e="ru";if(this.isReply()){var t=this.params.ids;if(!(e=Daria.Translate.getLangByMid(t))){var o=this.mMessageBody.getComposeHTML();e=Daria.Translate.defineLanguage(o)}}else{var n=this.get(".send");_.trim(n.replace(/\&nbsp;/gi,"")).length?e=Daria.Translate.defineLanguage(n):_.contains(Daria.Translate.langs.all.s,Daria.Config.locale)&&(e=Daria.Config.locale)}return e},formatContacts:function(e,t){var o=this.get("."+e);return Jane.FormValidation.splitContacts(o).map(function(o){return o.type=e,o.ref=t.getEmailRef(o.email),o},this)},getContacts:function(e){var t=this.get("."+e);return"phone"===e?Jane.FormValidation.splitPhones(t):Jane.FormValidation.splitContacts(t)},getAllRecepients:function(){var e=this.getContacts("to"),t=this.getContacts("cc"),o=this.getContacts("bcc");return Array.prototype.concat.call(e,t,o)},getAllRecepientEmails:function(){return{to:this._extractEmailsFromContacts(this.getContacts("to")),cc:this._extractEmailsFromContacts(this.getContacts("cc")),bcc:this._extractEmailsFromContacts(this.getContacts("bcc"))}},setContacts:function(t,o){var n="."+t;this.set(n,_.map(o,function(e){return Jane.FormValidation.obj2contact(e)}).join(e)+",")},appendContact:function(e,t){t&&this.setContacts(e,this.getContacts(e).concat(t))},isDelayed:function(){return Boolean(this.get(".send_time"))},resetDelayed:function(){this.setIfChanged(".send_time",null)},getPassportSendDate:function(){var e=Jane.Date.parseCalendarDate(this.get(".send_time"));return e?Daria.getPassportDate(e):void 0},_getArrayOfEmails:function(e){return e.map(function(e){return e.email})},_onRecipientsChanged:function(){if(!Daria.IS_CORP)return vow.resolve();if(this.isTemplate()||this.isNewMessage()||this.isForward())return vow.resolve();if(!this.get(".initial_to")&&!this.get(".initial_cc"))return vow.resolve();var e=this;return vow.resolve().then(function(){var t=_.union(Jane.FormValidation.splitContacts(e.get(".initial_to")||""),Jane.FormValidation.splitContacts(e.get(".initial_cc")||"")),o=_.union(Jane.FormValidation.splitContacts(e.get(".to")||""),Jane.FormValidation.splitContacts(e.get(".cc")||"")),n=_.uniq(e._getArrayOfEmails(t)),s=_.uniq(e._getArrayOfEmails(o)),i=_.difference(s,n).sort(),a=_.difference(n,s);return n.length-a.length<2&&a.length>0?n.length-a.length==1?ns.Model.get("get-maillists-static").getMaillists(s).then(function(e){return 0===e.length&&(a=[i18n("%All")]),{removed:a,added:i}}).fail(function(e){throw e}):{removed:a=[i18n("%All")],added:i}:{removed:a,added:i}}).then(function(t){e.set(".recipients-diff",{added:t.added,removed:t.removed})}).fail(function(e){throw e})},_getRecipientsDiffStr:function(){var t=this.get(".recipients-diff"),o=[];return 0===t.added.length&&0===t.removed.length?o=[]:(t.added.length>0&&o.push("+ "+t.added.join(e)),t.removed.length>0&&o.push("- "+t.removed.join(e))),o.join("\n")},hasOnlyOneValidRecipient:function(e){var t=(e=["to","cc","bcc"].indexOf(e)>-1?e:"")?this.getContacts(e):this.getAllRecepients();return Array.isArray(t)&&1===t.length&&Jane.FormValidation.checkEmail(t[0].email||"")}}})}()},3106:function(e,t,o){"use strict";var n=function(e){return function(e){var t=Jane.FormValidation.splitContacts(e);return Daria.Recipients.requestContacts(t).always(function(){return t.filter(function(e){return!Jane.FormValidation.checkEmail(e.email)})})}(e).then(function(e){if(!e.length)return vow.resolve();var t=e.map(function(e){return e.name?"".concat(e.email," (").concat(e.name,")"):e.email}).join(", ");return vow.reject("".concat(i18n("%Compose_Error_Invalid_Emails")," ").concat(t))})},s={to:[function(e,t){return new vow.Promise(function(o,n){e||t.get(".cc")||t.get(".bcc")?o():n(i18n("%Compose_Email_Required"))})},n],phone:[function(e){return new vow.Promise(function(t,o){e&&!Jane.FormValidation.checkPhoneNumber(e)?o(i18n("%ValidatePhoneError_badnumformat")):t()})}],cc:[n],bcc:[n],att_ids:[function(e,t){return new vow.Promise(function(e,o){var n=ns.Model.get("compose-attachments",t.params);n.isValid()&&n.isFailed()?o(i18n("%Compose_Attachment_Failed")):e()})}]};t.a={validate:function(e){return new vow.Promise(function(t,o){var n=e.getData(),i={},a=!0;vow.all(Object.keys(n).map(function(t){var o=n[t];return vow.all((s[t]||[]).map(function(n){return n(o,e).fail(function(e){i[t]=i[t]||e,a=!1})}))})).always(function(){a?t():o(i)})})}}},3107:function(e,t){!function(){var e={editorMode:"",editorMaximize:2,messageHeight:190,bodyPos:0,editorBookmark:null,isCcVisible:!1,isBccVisible:!1,isReplyAllNoticeVisible:!1,isPhoneVisible:!1,isPhoneEnabled:!1,isOpenedWithToolbarAttachPopup:!1,saveTemplateAndLeave:!1,saveTemplateAndReset:!1,submitButtonText:i18n("%Отправить"),activeActionButtonView:"compose-send-link",focusField:"to",waitSuggest:!1,formRect:null,"recipients-diff-pane-close":!1,visibleNotices:{to:[],phone:[],cc:[],bcc:[]},translationEnabled:!1},t=ns.Model.prototype;ns.Model.define("compose-state",{events:{"ns-model-before-destroyed":"onBeforeDestroyed"},params:{ids:null,tids:null,oper:null},ctor:function(){this._onComposeMessageFieldChanged=this._onComposeMessageFieldChanged.bind(this),this._refreshSubmitButtonText=this._refreshSubmitButtonText.bind(this)},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=!this._mComposeMessage||this._mComposeMessage.canRequest();return e&&t},request:function(){var e=this._constructModelRequest();return ns.request(e).then(this._initFromModels,this)},_constructModelRequest:function(){var e=[{id:"compose-message",params:this.params}];return this.params.ids&&_.isString(this.params.ids)&&!this.params.tids&&e.push({id:"message-body",params:ns.Model.infoLite("message-body").calculateParamsForMessageBody(this.params)}),e},_initFromModels:function(t){this.mComposeMessage=_.find(t,"id","compose-message"),this.mMessageBody=_.find(t,"id","message-body"),this._bindModelEvents();var o="reply"===this.params.oper&&this.mMessageBody&&this.mMessageBody.allowedReplyAll();this.setData(_.extend({},e,{isReplyAllNoticeVisible:o,isCcVisible:Boolean(this.mComposeMessage&&this.mComposeMessage.get(".cc")),isBccVisible:Boolean(this.mComposeMessage&&this.mComposeMessage.get(".bcc")),isPhoneVisible:Boolean(this.mComposeMessage&&this.mComposeMessage.get(".phone")),focusField:this.mComposeMessage.isReplyAny()?"send":e.focusField})),this._refreshSubmitButtonText()},onBeforeDestroyed:function(){this._unbindModelEvents()},_bindModelEvents:function(){this.on("ns-model-changed.translationEnabled",this._refreshSubmitButtonText),this.mComposeMessage&&(this.mComposeMessage.on("ns-model-changed.send_time",this._refreshSubmitButtonText),_.each(["to","phone","cc","bcc"],function(e){this.mComposeMessage.on("ns-model-changed."+e,this._onComposeMessageFieldChanged)},this))},_unbindModelEvents:function(){this.mComposeMessage&&(this.mComposeMessage.off("ns-model-changed.send_time",this._refreshSubmitButtonText),_.each(["to","phone","cc","bcc"],function(e){this.mComposeMessage.off("ns-model-changed."+e,this._onComposeMessageFieldChanged)},this))},_isNdaNoticeNeeded:function(e){if(Daria.IS_CORP)return!1;var t=this.mComposeMessage.getContacts(e),o=!1,n=!1;return _(t).pluck("email").each(function(e){Jane.FormValidation.checkExternalEmail(e)?n=!0:o=!0}).value(),o&&n},_onComposeMessageFieldChanged:function(e,t){var o=t.substr(1),n={nda:this._isNdaNoticeNeeded.bind(this,o)},s=this.get(".visibleNotices."+o);_.each(n,function(e,t){s=e()?_.uniq(s.concat(t)):_.without(s,t)}),this.setIfChanged(".visibleNotices."+o,s)},setFocusField:function(e,t){this.set(".focusField",e,t)},getFocusField:function(){return this.get(".focusField")},setWaitSuggest:function(e,t){this.set(".waitSuggest",e,t)},getWaitSuggest:function(){return this.get(".waitSuggest")},set:function(e,o,n){n||(n={});var s=this.get(e);_.isEqual(s,o)&&!n.force||t.set.call(this,e,o,n)},setMessageHeight:function(e){e<190&&(e=190),this.set(".messageHeight",e)},hasSpellingCheck:function(){return"TUR"!==Daria.Config.product&&!_.contains(["ka","hy","ro"],Daria.Config.locale)},hasEnSpellingCheckIcon:function(){return!_.contains(["ru","uk","be"],Daria.Config.locale)},hasDisk:function(){return _.contains(Daria.SIDS,"59")},isFieldEnabled:function(e){return!_.contains(["phone"],e)||this.get(".is"+_.capitalize(e)+"Enabled")},isFieldVisible:function(e){return!_.contains(["phone","cc","bcc"],e)||this.get(".is"+_.capitalize(e)+"Visible")},isCcVisible:function(){return this.get(".isCcVisible")},isBccVisible:function(){return this.get(".isBccVisible")},isPhoneVisible:function(){return this.get(".isPhoneVisible")},isReplyAllNoticeVisible:function(e){return"to"===e&&this.get(".isReplyAllNoticeVisible")},isNdaNoticeVisible:function(e){return Daria.IS_CORP&&_.contains(this.get(".visibleNotices."+e),"nda")},setLastSaveTime:function(){this.set(".lastSaveTime",Jane.Date.format("%R",Daria.now()))},isMinWidth:function(){var e=ns.Model.get("settings"),t=Number(e.getSetting("size-view-app")),o=Number(e.getSetting("size-layout-left")),n=Daria.resize.elements.leftPane.params.maxWidth;return 1024===t&&o===n},getSubmitButtonText:function(){var e=this.get(".translationEnabled"),t=this.mComposeMessage.getPassportSendDate();if(t){var o=Jane.Date.toHumanFormat(t),n=Jane.Date.format("%Date_HM__colon",t);return e?i18n("%Compose_Translate_Send_With_Deferred_Option",o,n):i18n("%Compose_Send_With_Deferred_Option",o,n)}return e?i18n("%Compose_Translate_Send"):i18n("%Отправить")},_refreshSubmitButtonText:function(){this.setIfChanged(".submitButtonText",this.getSubmitButtonText())}}})}()},3108:function(e,t){ns.Model.define("compose-forwarded-messages",{params:{ids:null,tids:null,oper:null},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=!this.mComposeMessage||this.mComposeMessage.canRequest();return e&&t},request:function(){return this.mComposeMessage=ns.Model.get("compose-message",_.clone(this.params)),ns.request([this.mComposeMessage]).then(function(){this.setData([]),ns.request(this._constructModelRequest()).then(this._initFromModels,this)},null,this)},_constructModelRequest:function(){var e=[];if("forward"!==this.params.oper)return e;var t=$.makeArray(this.params.tids),o=$.makeArray(this.params.ids);return e=(e=e.concat(_.map(t,function(e){return{id:"messages",params:{thread_id:e,first:0,count:ns.Model.get("message",{ids:e}).getThreadCount()||500}}}))).concat(_.map(o,function(e){return{id:"message",params:{ids:e}}}))},_initFromModels:function(e){var t=[];_.each(e,function(e){switch(e.id){case"messages":t.push.apply(t,e.models);break;case"message":t.push(e)}}),this._setMessages(t)},_setMessages:function(e){var t=!1;e.length>1&&(t=!0);var o=_.map(e,function(e){return{mid:e.get(".mid"),subject:e.get(".subject"),checked:t,link:e.getMessageLink()}});this.setData(o),t&&this.mComposeMessage.addForwardedMessages(_.pluck(o,"mid"))},checkMessage:function(e){_.find(this.getData(),{mid:e}).checked=!0,this.mComposeMessage.addForwardedMessages(e)},uncheckMessage:function(e){_.find(this.getData(),{mid:e}).checked=!1,this.mComposeMessage.removeForwardedMessages(e)},getMessagesIds:function(){return this.getData().filter(function(e){return e.checked}).map(function(e){return e.mid})}}})},3109:function(e,t){ns.Model.define("compose-fsm",{params:{ids:null,oper:null},methods:{start:"edit",transitions:{save:["edit","sending","cancel"],edit:["save","sending","cancel"],sending:["edit","sent"],cancel:["edit"]},canAutosave:function(){return this._checkTransitionToState("save")}}},ns.ModelFsm)},3110:function(e,t){ns.Model.define("compose-signature",{params:{ids:null,tids:null,oper:null},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=!this.mComposeMessage||this.mComposeMessage.canRequest();return e&&t},request:function(){var e=this._constructModelRequest();return ns.request(e).then(this._initFromModels,this)},_constructModelRequest:function(){return[{id:"settings"},{id:"compose-message",params:_.clone(this.params)}]},_initFromModels:function(e){this.mSettings=e[0],this.mComposeMessage=e[1],this.setData({signature:""})},getSignatureList:function(){var e=this.mComposeMessage.get(".from_mailbox"),t=this.mComposeMessage.getLanguage(),o={mode:this.mComposeMessage.get(".ttype"),signs:[]};switch(o.mode){case"html":o.signs=Daria.signs.getHtml();break;case"plain":o.signs=Daria.signs.getPlain()}var n=Daria.signs.getFilteredSigns(o.signs,e);return 0===n.length?o.noSuitableSignature=!0:n.sort(Daria.signs.sort(e,t)),o.signs=_.uniq([].concat(n,o.signs)),o},hasSignatureControl:function(){return!Daria.Config.NO_SETTINGS&&!Modernizr.ios}}})},3111:function(e,t){ns.Model.define("do-cancel-send-delayed",{params:{ids:null}})},3112:function(e,t){ns.Model.define("do-cancel-send-undo",{params:{ids:null}})},3113:function(e,t){function o(e){return function(e){if(Array.isArray(e)){for(var t=0,o=new Array(e.length);t<e.length;t++)o[t]=e[t];return o}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}ns.Model.define("compose-popular-contacts",{events:{},params:{ids:null,oper:null,count:null},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=ns.Model.get("compose-message",this.params),o=!t||t.canRequest();return e&&o},request:function(){var e=this._constructModelRequest();return ns.request(e).then(function(e){var t=_.zipObject(_.pluck(e,"id"),e);this._initFromModels(t)},this)},_constructModelRequest:function(){return[{id:"abook-suggest",params:{q:"",popular:!0,climit:this.params.count}},{id:"compose-message",params:this.params},{id:"index-data"}]},_initFromModels:function(e){var t=e["abook-suggest"],n=e["compose-message"],s=e["index-data"].get(".email"),i=n.getAllRecepients(),a=_.filter(t.get(".contacts"),function(e){return e.email!==s}),r={name:i18n("%Compose_Send_it_to_me"),email:s},c=_.map([r].concat(o(a)),function(e){return e.name||(e.name=e.email),e.phone=_.get(e,["phones",0]),_.extend({},e,{used:_.any(i,{email:e.email})})},this);this.setData(c)},getContact:function(e){return _.find(this.getData(),e)},actualizeUsedContacts:function(e){_.each(this.getData(),function(t){t.used=_.any(e,{email:t.email})})},isAnyUnusedContact:function(){return!this.isValid()||_.any(this.getData(),function(e){return!e.used})},getUnusedContacts:function(){return _.filter(this.getData(),function(e){return!e.used})},clean:function(){_.each(this.getData(),function(e){e.used=!1})}}})},3114:function(e,t){ns.Model.define("compose-field-notice",{events:{"ns-model-init":"_onInit"},params:{ids:null,oper:null,field:null,type:null},methods:{_onInit:function(){this.setData({type:null})}}},ns.ModelStatic),ns.Model.define("compose-field-extras",{events:{"ns-model-init":"_onInit"},params:{ids:null,oper:null,field:null,type:null},methods:{_onInit:function(){this.setData({type:null})}}},ns.ModelStatic)},3115:function(e,t){ns.Model.define("compose-field-notices",{isCollection:!0,events:{"ns-model-init":"_onInit"},params:{ids:null,oper:null,field:null},methods:{_onInit:function(){this.setData({})}}},ns.ModelCollectionStatic),ns.Model.define("compose-field-extras-collection",{isCollection:!0,events:{"ns-model-init":"_onInit"},params:{ids:null,oper:null,field:null},methods:{_onInit:function(){this.setData({})}}},ns.ModelCollectionStatic)},3116:function(e,t){ns.Model.define("compose-emoticons",{events:{"ns-model-init":"_onInit"},params:{},methods:{_onInit:function(){this.setData({items:[{suid:21,name:"Улыбается"},{suid:22,name:"Подмигивает"},{suid:23,name:"Показывает язык"},{suid:24,name:"Благодарит"},{suid:25,name:"Крутой"},{suid:26,name:"Удивляется"},{suid:27,name:"Огорчается"},{suid:28,name:"Обижается"},{suid:29,name:"Плачет"},{suid:30,name:"Зевает"},{suid:31,name:"Смущается"},{suid:32,name:"Не может сказать вслух"},{suid:33,name:"Не в себе"},{suid:34,name:"Сумасшедший"},{suid:35,name:"Ехидный"},{suid:36,name:"Ангелочек"},{suid:37,name:"Влюбленный"},{suid:38,name:"Сердце разбито"},{suid:45,name:"Отдых"},{suid:51,name:"Подарок"},{suid:40,name:"Мокро"},{suid:43,name:"Дождь"},{suid:46,name:"Солнечно"},{suid:47,name:"Холодно"},{suid:50,name:"Планета"},{suid:42,name:"Не одобряю"},{suid:41,name:"Одобряю"},{suid:48,name:"Бомба"},{suid:49,name:"Идея!"},{suid:44,name:"Музыка"}]})}}},ns.ModelStatic)},3117:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(3);o.n(n);function s(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(!(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)))return;var o=[],n=!0,s=!1,i=void 0;try{for(var a,r=e[Symbol.iterator]();!(n=(a=r.next()).done)&&(o.push(a.value),!t||o.length!==t);n=!0);}catch(e){s=!0,i=e}finally{try{n||null==r.return||r.return()}finally{if(s)throw i}}return o}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var i=function(){};ns.Model.define("compose-autocomplete",{params:{text:null,id:null,text_limit:null,message_id:null,thread_id:null,init_session:null,extra_params:null,allow_pers_data:null},ctor:function(){this._failedRequests=0},methods:{MAX_FAILED_REQUESTS:3,_getTextLimit:function(){return 4096},canRequest:function(){return this.retries<1},getItemsData:function(e){var t=this,o=e,s=this._getTextLimit();return o.length>s&&(o=o.slice(o.length-s)),vow.Promise.resolve().then(function(){return t._requestItemsData(o)}).then(function(e){var o=e.items,n=e.requestId;return t.setData({items:o,autocompleteRequestId:n}),t.getData()}).catch(function(e){return Jane.ErrorLog.log({type:n.ErrorType.NsModel,source:n.ErrorSource.Request,sourceMethod:t.id,block:n.ErrorBlock.Compose,method:"getItemsData"},e)})},initSession:function(){return ns.forcedRequest(this.id,{id:this.params.id,thread_id:this.params.thread_id,init_session:!0,message_id:this.params.message_id}).then(i).fail(i)},request:function(){var e=this;return ns.request.fetchModels([this]).then(function(t){if(!1===ns.request.canProcessResponse(t))return Vow.reject({error:"CANT_PROCESS",invalid:[e],valid:[]});ns.request.extractModel(e,t.models[0],t)},function(t){var o=t.error;ns.request.extractModel(e,{error:o})})},setError:function(e){var t=ns.key("model=".concat(this.id),this._getParamsForLog());ns.Model.prototype.setError.apply(this,[e,t])},_requestItemsData:function(e){var t=this;return vow.Promise.resolve().then(function(){return t._failedRequests>=t.MAX_FAILED_REQUESTS?{items:[],requestId:""}:ns.forcedRequest(t.id,{id:t.params.id,text:e,text_limit:t._getTextLimit(),thread_id:t.params.thread_id,message_id:t.params.message_id,allow_pers_data:t._getPersonalDataSetting()}).then(function(e){var o=s(e,1)[0];t._failedRequests=0;var n=o.get(".items"),i=o.get(".autocompleteRequestId");return o.destroy(),{items:n,requestId:i}}).fail(function(){return++t._failedRequests,{items:[],requestId:""}})})},_getPersonalDataSetting:function(){return ns.Model.get("settings").getSign("allow_pers_data_autocomplete")?"on":""},_getParamsForLog:function(){var e=this.params.text;return{text_length:e?e.length:0,id:this.params.id,thread_id:this.params.thread_id,text_limit:this.params.text_limit}}}})},3118:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(3);o.n(n);function s(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(!(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)))return;var o=[],n=!0,s=!1,i=void 0;try{for(var a,r=e[Symbol.iterator]();!(n=(a=r.next()).done)&&(o.push(a.value),!t||o.length!==t);n=!0);}catch(e){s=!0,i=e}finally{try{n||null==r.return||r.return()}finally{if(s)throw i}}return o}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function i(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),o.push.apply(o,n)}return o}function a(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}var r=20480,c=100,u=100,l=1;ns.Model.define("compose-smartsubject",{params:{id:null,position:null,message_id:null,thread_id:null,text:null,to:null,cc:null,bcc:null,from:null,attaches:null,extra_params:null},ctor:function(){this._failedRequests=0},methods:{MAX_FAILED_REQUESTS:3,canRequest:function(){return this.retries<1},getItemsData:function(e){var t=this,o=e.text,s=e.addresses,i=e.attaches;return vow.Promise.resolve().then(function(){return t._requestItemsData({text:o,addresses:s,attaches:i})}).then(function(e){var o=e.items,n=e.requestId;return t.setData({items:o,requestId:n}),t.getData()}).catch(function(e){return Jane.ErrorLog.log({type:n.ErrorType.NsModel,source:n.ErrorSource.Request,sourceMethod:t.id,block:n.ErrorBlock.Compose,sessionId:t.id,method:"getItemsData"},e)})},request:function(){var e=this;return ns.request.fetchModels([this]).then(function(t){if(!1===ns.request.canProcessResponse(t))return Vow.reject({error:"CANT_PROCESS",invalid:[e],valid:[]});ns.request.extractModel(e,t.models[0],t)},function(t){var o=t.error;ns.request.extractModel(e,{error:o})})},setError:function(e){var t=ns.key("model=".concat(this.id),this._getParamsForLog());ns.Model.prototype.setError.apply(this,[e,t])},_requestItemsData:function(e){var t=this,o=e.text,n=e.addresses,c=e.attaches;return vow.Promise.resolve().then(function(){if(t._failedRequests>=t.MAX_FAILED_REQUESTS)return{items:[],requestId:""};var e="ssreq-".concat(Daria.uid,"-").concat(t.params.message_id,"-").concat(Daria.now()).concat(l++);return ns.forcedRequest(t.id,function(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?i(Object(o),!0).forEach(function(t){a(e,t,o[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):i(Object(o)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))})}return e}({},t.params,{id:e,text:(o||"").substr(0,r),to:JSON.stringify(t._limitAddresses(n.to)),cc:JSON.stringify(t._limitAddresses(n.cc)),bcc:JSON.stringify(t._limitAddresses(n.bcc)),from:JSON.stringify(n.from),attaches:JSON.stringify(t._mapAttaches(t._limitAttaches(c))),extra_params:t._getExtraParams()})).then(function(e){var o=s(e,1)[0];t._failedRequests=0;var n=o.get(".items"),i=o.get(".smartSubjectRequestId");return o.destroy(),{items:n,requestId:i}}).fail(function(){return++t._failedRequests,{items:[],requestId:""}})})},_limitAddresses:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).slice(0,c)},_limitAttaches:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).slice(0,u)},_mapAttaches:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).map(function(e){var t=e.info;return{id:t.id,name:t.name,mediaType:t.class}})},_getExtraParams:function(){return"exp=line_popup_final&chain=prod"},_getParamsForLog:function(){return{text_length:(this.params.text||"").length,id:this.params.id,message_id:this.params.message_id,thread_id:this.params.thread_id,recipients_length:(this.params.to||[]).length+(this.params.cc||[]).length+(this.params.bcc||[]).length,from:this.params.from,attaches_length:(this.params.attaches||[]).length}}}})},3119:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(587);yr.externals["get-attachment-id"]=function(e){var t=yr.nodeset2data(e);return Object(n.a)(t)}},3120:function(e,t,o){o(3121),o(3122),o(3123),o(3124),o(3125),o(3126),o(3129),o(3130),o(3131),o(3132),o(3133),o(3134),o(3135),o(3136),o(3137),o(3138),o(3139),o(3140),o(3141),o(3142),o(3143),o(3144),o(3145),o(3146),o(3147),o(3148),o(3149),o(3150),o(3151),o(3152),o(3153),o(3154),o(3155),o(3156),o(3157),o(3158),o(3159),o(3160),o(3161),o(3162),o(3163),o(3164),o(3165),o(3166),o(3167),o(3168),o(3169),o(3170),o(3171),o(3172),o(3173),o(3174),o(3175),o(3176),o(3177),o(3178),o(3179),o(3180),o(3181),o(3182),o(3183),o(3184),o(3185),o(3186),o(3187),o(3188),o(3189),o(3190),o(3191),o(3192),o(3193),o(3194),o(3195),o(3196),o(3197),o(3198),o(3199),o(3200),o(3201),o(3203),o(3204),o(3205),o(3206),o(3207),o(3208),o(3209),o(3210),o(3211),o(3212),o(3213),o(3214),o(3215),o(3216),o(3217),o(3218),o(3219),o(3220),o(3221),o(3222),o(3223),o(3224),o(3225),o(3226)},3121:function(e,t){ns.View.edefine("labels-actions-compose",{models:{labels:!1,settings:!1,"compose-message":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{_yateModule:"mail"})},yateModule:"toolbar",methods:{onShow:function(){this.$labelsHolder=this.$node.find(".js-labels-list"),this.$searchInput=this.$node.find(".js-search-input"),this.filterByComposeMessage()},filterByComposeMessage:function(){var e=this.getModel("compose-message").getLabelsHash();this._filterByLabelsHash(e,{showReadLabel:!1,showUnreadLabel:!1,messagesCount:1})},_onLabelClick:function(e){var t=this._getDataFromClickedLabel(e),o=this.getModel("compose-message");switch(t.action){case"label":o.addLid(t.lid);break;case"unlabel":o.removeLid(t.lid)}this.nbPopup.close()},getLabelCreatedCallback:function(){return this.getModel("compose-message").addLid.bind(this.getModel("compose-message"))}}},"labels-actions")},3122:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(370),s=o(709),i=o(405),a=o(585);!function(){ns.View.define("compose-leave-mixin",{yateModule:"compose2",events:{"beforeunload@show window":"onBeforeUnloadPage"},methods:{onBeforeUnloadPage:function(){this._areThereAnyUnsavedChanges()&&Daria.addUnloadText(i18n("%Setup_beforeunload"))},leaveInit:function(){ns.assert(this.getModel("compose-message"),"Daria.vComposeLeaveMixin","требует наличия модели mComposeMessage в зависимостях"),ns.assert(this.getModel("compose-fsm"),"Daria.vComposeLeaveMixin","требует наличия модели mComposeFsm в зависимостях"),ns.assert(this.getModel("compose-state"),"Daria.vComposeLeaveMixin","требует наличия модели mComposeState в зависимостях"),this.leaveComposeController=new a.a,this.leaveComposeController.pageGoUrl=null,_.bindAll(this,["_leaveOnPageGo","_leaveOnSent","_leaveOnCancel","_nbSaveChangesPopupResolve","_nbSaveChangesPopupReject","_onExternalComposeButtonClick"])},leaveStart:function(){ns.page.block.add(this._leaveOnPageGo);var e=this.getModel("compose-fsm");e.on("# sent",this._leaveOnSent),e.on("# cancel",this._leaveOnCancel);var t=this.getModel("compose-state");t.on("nbSaveChangesPopup:resolve",this._nbSaveChangesPopupResolve),t.on("nbSaveChangesPopup:reject",this._nbSaveChangesPopupReject),ns.events.on("daria:vLeftColToolbar:composeClick",this._onExternalComposeButtonClick)},leaveStop:function(){ns.page.block.remove(this._leaveOnPageGo);var e=this.getModel("compose-fsm");e.off("# sent",this._leaveOnSent),e.off("# cancel",this._leaveOnCancel);var t=this.getModel("compose-state");t.off("nbSaveChangesPopup:resolve",this._nbSaveChangesPopupResolve),t.off("nbSaveChangesPopup:reject",this._nbSaveChangesPopupReject),ns.events.off("daria:vLeftColToolbar:composeClick",this._onExternalComposeButtonClick)},checkSameUrlParams:function(e){if(!e)return!1;var t=ns.router(ns.page.currentUrl),o=ns.router(e);if(Daria.composeEqualRoutes(t,o))return!0;var n=_.get(o,"params._cuid");return!("compose2"!==o.page&&!Daria.composeHasParams(n))},_onExternalComposeButtonClick:function(){var e=Daria.composeGo();this._leaveOnPageGo(e,!0)},_leaveOnPageGo:function(e,t){var o=this.getModel("compose-state").get(".nbSaveChangesPopup");return(!o||!o.isOpen())&&(!t&&e===ns.page.currentUrl||(!(t||!e||!this.checkSameUrlParams(e))||(this.leaveComposeController.pageGoUrl=e,this._areThereAnyUnsavedChanges()?!this._showSaveChangesPopup(t):(t&&this.hardResetCompose(),i.a.finishScenario(n.a,s.c),!0))))},_areThereAnyUnsavedChanges:function(){var e=this.getModel("compose-message").isDirty(),t=!this.getModel("compose-fsm").isCurrentState(["save","sent"]);return e&&t},_showSaveChangesPopup:function(e){var t=this,o=this.getModel("compose-state");if(o.get(".nbSaveChangesPopup"))return!1;this.autosaveStop(),nb.trigger("popup-close"),Daria.Dropdown.closeAll(),Daria.Dialog.close();var n=this.params,s=ns.View.create("compose-unsaved-popup");return s.on("resolve",function(t,o){ns.Model.get("compose-state",n).trigger("nbSaveChangesPopup:resolve",o,e)}),s.on("reject",function(){ns.Model.get("compose-state",n).trigger("nbSaveChangesPopup:reject"),t.autosaveStart()}),o.set(".nbSaveChangesPopup",s,{silent:!0}),s.open(),!0},_nbSaveChangesPopupResolve:function(e,t,o){var a=this.getModel("compose-state");a.set(".nbSaveChangesPopup",null,{silent:!0}),this.getModel("compose-fsm").isCurrentState("sending")||(this.getModel("compose-fsm").switchOff(),"save"===t?(o&&a.set(".saveTemplateAndReset",!0),this.getModel("compose-message").save({force:!0,httpResponse:!0}).then(function(){i.a.finishScenario(n.a,s.f)},function(){i.a.finishScenario(n.a,s.d)})):o&&this.hardResetCompose(),"save"!==t&&i.a.finishScenario(n.a,s.b),this.leaveComposeController.leaveCompose({clearPageBlock:!0}))},_nbSaveChangesPopupReject:function(){this.getModel("compose-state").set(".nbSaveChangesPopup",null,{silent:!0}),this.getModel("compose-fsm").isCurrentState("sending")||(this.getModel("compose-fsm").setState("edit"),ns.Model.get("focus").setLastActionFocus(),ns.page.refresh())},_showMessageSentNotification:function(){var e=this.getModel("compose-message");this.leaveComposeController.showMessageSentNotification({sentMid:e.get(".sentMid"),wasSendCancelled:e.wasSendCancelled(),withUndo:e.withUndo(),isDelayed:e.isDelayed(),sendTime:e.getPassportSendDate()})},_onAfterSent:function(){var e=this;this._showMessageSentNotification();var t=this.leaveComposeController.pageGoUrl=this.leaveComposeController.whereToGoAfterSend();return vow.resolve().then(function(){return e.leaveComposeController.leaveCompose({clearPageBlock:!0,neverReturn:!0})}).fail(function(e){return function(e,t){Jane.ErrorLog.send(_.assign({},t,{event:"after_send_failed",loadingHash:e})),Daria.Dialog.notice({title:i18n("%Произошла_ошибка"),body:"<p>"+i18n("%Compose_after_sent_leave_failed")+"</p>"})}(t,e)}).always(function(){return vow.resolve()})},_leaveOnSent:function(){return this.leaveComposeController.sendMetrika(),this._onAfterSent()},_leaveOnCancel:function(){return this.leaveComposeController.leaveCompose()}}})}()},3123:function(e,t){ns.View.define("compose-autosave-mixin",{yateModule:"compose2",methods:{AUTOSAVE_PERIOD:Daria.timify({seconds:10}),autosaveInit:function(){ns.assert(this.getModel("compose-message"),"Daria.vComposeAutosaveMixin","требует наличия модели mComposeMessage в зависимостях"),ns.assert(this.getModel("compose-fsm"),"Daria.vComposeAutosaveMixin","требует наличия модели mComposeFsm в зависимостях"),this._autosaveSaveMessageModel=this._autosaveSaveMessageModel.bind(this),this._autosaveTimerAction=this._autosaveTimerAction.bind(this),this._autosaveTimer=0},autosaveStart:function(){this.getModel("compose-fsm").on("# save",this._autosaveSaveMessageModel),this._setAutosaveTimeout()},autosaveStop:function(){this._clearAutosaveTimeout(),this.getModel("compose-fsm").off("# save",this._autosaveSaveMessageModel)},_isAutosaveEnabled:function(){return this.isValid()&&this.getModel("compose-message").isAutosaveEnabled()},_autosaveSaveMessageModel:function(){this._clearAutosaveTimeout(),this.getModel("compose-message").save().always(this._onAutosave,this)},_onAutosave:function(){if(this.isValid()){var e=this.getModel("compose-fsm");e.isCurrentState("save")&&!e.inTransition()&&(e.setState("edit"),this._setAutosaveTimeout())}},_clearAutosaveTimeout:function(){this._autosaveTimer&&(window.clearTimeout(this._autosaveTimer),this._autosaveTimer=0)},_setAutosaveTimeout:function(){this._isAutosaveEnabled()&&(this._clearAutosaveTimeout(),this._autosaveTimer=window.setTimeout(this._autosaveTimerAction,this.AUTOSAVE_PERIOD))},_autosaveTimerAction:function(){var e=this.getModel("compose-fsm");e.canAutosave()?e.setState("save"):this._setAutosaveTimeout()}}})},3124:function(e,t){ns.View.define("compose-disable-on-sending-mixin",{yateModule:"compose2",methods:{disableOnSendingInit:function(){ns.assert(this.getModel("compose-fsm"),"vComposeDisableOnSendingMixin","должен иметь mComposeFsm в зависимостях"),this.onToggleControl=this.onToggleControl.bind(this)},disableOnSendingStart:function(){var e=this.getModel("compose-fsm");e.on("# *",this.onToggleControl),e.on("* > *",this.onToggleControl)},disableOnSendingStop:function(){var e=this.getModel("compose-fsm");e.off("# *",this.onToggleControl),e.off("* > *",this.onToggleControl)},onToggleControl:function(e,t){var o=!0,n=this.getModel("compose-fsm");n.isCurrentState(["edit","save"])?n.inTransition()&&(_([t.from,t.to]).difference(["save","edit"]).isEmpty()||(o=!1)):o=!1,this.$node.toggleClass("is-disabled",!o)}}})},3125:function(e,t){ns.View.define("compose-field-base-hotkeys",{yateModule:"compose2",events:{"keydown@show":"_onKeydown"},methods:{_onKeydown:function(e){var t=ns.Model.get("settings").getSetting("enable_hotkeys");"compose2"!==ns.page.current.page&&t&&Boolean(Modernizr.mac?e.metaKey:e.ctrlKey)&&e.keyCode===Jane.Common.keyCode.ENTER&&(e.preventDefault(),this.getModel("compose-fsm").setState("sending"))}}})},3126:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(3127),s=o(483);function i(e,t,o,n,s,i,a){try{var r=e[i](a),c=r.value}catch(e){return void o(e)}r.done?t(c):Promise.resolve(c).then(n,s)}Daria.AttachDiskPopupMixin={_openDiskOnClick:function(){this._popup=n.a.create({path:this._getPath(),onCancel:this._onDiskPopupClosed.bind(this),onAttach:this._onAttachAdded.bind(this)})},_onAttachAdded:function(e){var t=e.selectedItems.map(function(e){return{id:e.id,resource:e}});this._attachDirectly(t)},_attachDirectly:function(e){var t=ns.Model.get("compose-attachments",this.params);e.forEach(function(e){return t.addAttach(e)}),this._onDiskPopupClosed()},_onDiskPopupClosed:function(){var e=function(e){return function(){var t=this,o=arguments;return new Promise(function(n,s){var a=e.apply(t,o);function r(e){i(a,n,s,r,c,"next",e)}function c(e){i(a,n,s,r,c,"throw",e)}r(void 0)})}}(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._popup){e.next=4;break}return e.next=3,this._popup.unmount();case 3:this._popup=null;case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}(),_getMetrikaPart:function(){return this.METRIKA_PARTS[this.MODE]},_getPath:function(){return this.PATHS[this.MODE]},METRIKA_PARTS:{mail:"Клик по Прикрепить из почты",disk:"Клик по Прикрепить с диска"},PATHS:{mail:s.b,disk:s.a}}},3127:function(e,t,o){"use strict";var n=o(3128);Daria.DiskResources=new n.a,t.a=Daria.DiskResources},3128:function(e,t,o){"use strict";o.d(t,"a",function(){return g});var n,s=o(135),i=o.n(s),a=o(139),r=o.n(a),c=o(342),u=o(1121);function l(e,t,o,n,s,i,a){try{var r=e[i](a),c=r.value}catch(e){return void o(e)}r.done?t(c):Promise.resolve(c).then(n,s)}function d(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),o.push.apply(o,n)}return o}function h(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?d(Object(o),!0).forEach(function(t){p(e,t,o[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):d(Object(o)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))})}return e}function p(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function f(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var m=function(e){return new Promise(function(t){return setTimeout(t,e)})},g=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.services={settings:{isMobile:!1}}}return function(e,t,o){t&&f(e.prototype,t),o&&f(e,o)}(e,[{key:"create",value:function(e){return this.rendered||(this.rendered=!0,this.props=e,this.node=document.createElement("div"),document.body.appendChild(this.node),this._render(h({isVisible:!0},e))),this}},{key:"_render",value:function(e){r.a.render(function(e,t,o,s){n||(n="function"==typeof Symbol&&Symbol.for&&Symbol.for("react.element")||60103);var i=e&&e.defaultProps,a=arguments.length-3;if(t||0===a||(t={children:void 0}),1===a)t.children=s;else if(a>1){for(var r=new Array(a),c=0;c<a;c++)r[c]=arguments[c+3];t.children=r}if(t&&i)for(var u in i)void 0===t[u]&&(t[u]=i[u]);else t||(t=i||{});return{$$typeof:n,type:e,key:void 0===o?null:""+o,ref:null,props:t,_owner:null}}(c.Provider,{services:this.services},void 0,i.a.createElement(u.a,e)),this.node)}},{key:"unmount",value:function(){var e=function(e){return function(){var t=this,o=arguments;return new Promise(function(n,s){var i=e.apply(t,o);function a(e){l(i,n,s,a,r,"next",e)}function r(e){l(i,n,s,a,r,"throw",e)}a(void 0)})}}(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.rendered){e.next=7;break}return this._render(h({isVisible:!1},this.props)),this.rendered=!1,e.next=5,m(200);case 5:r.a.unmountComponentAtNode(this.node),this.node=null;case 7:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()}]),e}()},3129:function(e,t){ns.View.edefine("compose-attach-open-disk-mixin",{yateModule:"compose2",methods:_.extend({openDiskInit:function(){this.openDiskOnClick=this.openDiskOnClick.bind(this),this.$node.on("click",this.openDiskOnClick)},openDiskDestroy:function(){this.$node.off("click",this.openDiskOnClick)},openDiskOnClick:function(e){this._openDiskOnClick(e)},_popup:null,PATH:null},Daria.AttachDiskPopupMixin,{_onAttachAdded:function(e){var t=e.selectedItems.map(function(e){return{id:e.id,resource:e}});this._attachDirectly(t)}})},ns.View)},3130:function(e,t){ns.View.define("compose-field-phone-error-mixin",{yateModule:"compose2",methods:{getErrorMessage:function(){var e=this.getModel("compose-message").getAllRecepients();return e.length>1?i18n("%Compose_Phone_Error_Manymail"):e.some(function(e){return ns.Model.get("account-information").isMyEmail(e.email)})?i18n("%Compose_Phone_Error_Usermail"):""}}})},3131:function(e,t){ns.View.define("compose-template-list-popup-mixin",{yateModule:"compose2",methods:{openTemplateListInit:function(){this._openTemplateListOnClick=this._openTemplateListOnClick.bind(this),this.$node.on("click",this._openTemplateListOnClick)},openTemplateListDestroy:function(){this.$node.off("click",this._openTemplateListOnClick),this.popup&&this.popup.close()},_openTemplateListOnClick:function(){this.popup=ns.View.create("compose-template-list",this.params),this.popup.open({where:this.node,autofocus:!0}),Jane.c("Написание письма","Шапка письма",'Клик в "Шаблон"')}}})},3132:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(370),s=o(407),i=o(589),a=o(709),r=o(498),c=(o.n(r),o(405)),u=o(791),l=o(532),d=o(137);o.n(d);function h(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),o.push.apply(o,n)}return o}function p(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}!function(){var e,t=(p(e={virus_found:i18n("%Compose_virus_found"),strongspam_found:i18n("%Compose_strongspam_found"),incorrect_to:i18n("%Compose_incorrect_to"),incorrect_cc:i18n("%Compose_incorrect_cc"),incorrect_bcc:i18n("%Compose_incorrect_bcc"),msg_too_big:i18n("%Compose_msg_too_big"),no_recipients:i18n("%Compose_no_recipients"),fail_limit:i18n("%Compose_fail_limit"),too_many_emails:i18n("%Compose_too_many_emails"),max_email_addr_reached:i18n("%Compose_exceeded_limit_of_N_recipients",Daria.Constants.MAX_MESSAGES_TO_SEND),no_data:i18n("%Compose_no_data"),http_status_0:i18n("%Нет_доступа_к_интернету"),attachment_too_big:i18n("%_Compose_attachment_too_big_custom",Daria.Constants.MAX_MESSAGES_TO_FORWARD,ns.Model.get("system-status").getAttachmentsMaxSize()),internal_error:i18n("%Compose_internal_error"),access_denied:i18n("%Compose_access_denied_error"),illegal_params:i18n("%Compose_illegal_params_error")},r.UNDO_CANNOT_SAVE,i18n("%Compose_undo_cannot_save_error")),p(e,r.UNDO_PAUSED,i18n("%Compose_undo_cannot_save_error")),p(e,r.UNDO_MESSAGE_SAVED,i18n("%Compose_undo_message_saved_error")),p(e,r.DELAYED_CANNOT_SAVE,i18n("%Compose_delayed_cannot_save_error")),p(e,r.DELAYED_MESSAGE_SAVED,i18n("%Compose_delayed_message_saved_error")),e),o=[void 0,"","message-not-valid","captcha_request","need-confirm","attachments-failed","send-cancelled"],f=["compose-forwarded-messages","compose-state","compose-fsm","compose-attachments","compose-notify-noreply-options","compose-signature","compose-message"],m=["to","cc","bcc"];Daria.composeKey=function(e){return e&&e._cuid||"compose"};var g=_.memoize(function(e){return _.pick(e,["ids","tids","oper","qrIds","_cuid"])},Daria.composeKey);Daria.getPageComposeIds=function(){var e=ns.page.current.params,t=Daria.composeKey(e);if(Daria.composeHasParams(t))return t},Daria.getRealComposeIds=function(e){var t=e.ids,o=ns.page.current.params;return!t&&g.cache.has(Daria.composeKey(o))&&Daria.isComposePage()&&o._cuid&&o.ids&&(t=o.ids),t},Daria.composeHasParams=function(e){var t=g.cache.get(e);return!_.isUndefined(t)&&ns.Model.get("compose-message",t).isValid()},Daria.composeKeyParams=function(e){return{_cuid:Daria.composeKey(e)}},ns.View.edefine("compose2",{events:{"ns-view-init":"onInit","ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","ns-view-destroyed":"onDestroyed","ns-page-before-load@show":"onPageBeforeLoad","daria:MOPS:delete":"onMessageRemoved","daria:vCompose2:send@show":"onSend","daria:vCompose2:save@show":"onSave"},models:{"compose-message":{"ns-model-changed":!1,"ns-model-changed.lids":"onLidsChange","ns-model:validation-error":"onValidationError","ns-model:draft-saved":"onDraftSaved","ns-model:captcha-request":"showCaptcha","ns-model:need-to-confirm:send-without-to":"showConfirmPopup","ns-model:need-to-confirm:attachments-forgotten":"showForgottenAttachmentsDialog"},"compose-state":{"ns-model-changed":!1,"ns-model:compose:update":"_composeUpdate"},"compose-fsm":{"ns-model-changed":!1,"# sending":"onSending","# cancel":"onCancel","# sent":"onSent","save > sending":"onSaveToSending","sending > sent":"onSendingToSent","sending !> sent":"onSendingToSentFailed"},"compose-attachments":!1,"compose-forwarded-messages":!1,"compose-notify-noreply-options":!1,"compose-signature":!1,signs:!1},params:function(e){return g(e)},ctor:function(){this._forgottenAttachView=null,this._popup=null,this._composeUpdate=_.debounce(this._composeUpdate.bind(this),50)},yateModule:"compose2",methods:{ERROR_CODES:t,VIEWPORT_PADDING_WITH_LEFT_COL_COMPOSE_BUTTON:8,_composeUpdate:function(){this.isVisible()&&this.update()},onInit:function(){this.autosaveInit()},onMessageRemoved:function(e,t){if(t.originalAction&&"remove.draft"===t.originalAction&&t.messageInfo&&t.messageInfo.data){var o=ns.router.generateUrl("messages",{current_folder:t.messageInfo.data.fid});ns.page.go(o),Jane.c("Написание письма","Шапка письма",'Клик в "Удалить черновик"')}},onHtmlInit:function(){this.leaveInit(),Daria.isComposePage()&&ns.Model.get("focus").resetFocus(!0);var e=this.getModel("compose-message");if((e.isTemplate()||e.isDraft())&&e.mMessage){var t=ns.Model.get("messages-checked");t.resetChecked(),t.check(e.mMessage,!0)}this.scrollToComposeTop()},onShow:function(){this.isDestroyed=!1,this.getModel("compose-fsm").switchOn(),this.autosaveStart(),this.leaveStart(),ns.events.trigger("daria:vToolbarButton:restruct",{force:!0}),this._logComposeOpen(c.a);var e=ns.Model.get("settings").isSet("liza_minified_header");Daria.isComposePage()&&($(".js-mail-Layout-Panes").addClass("mail-Layout-Panes_compose"),ns.Model.get("app-state").updatePageClasses({"mail-Page_compose":!0,"mail-Page_compose-minified":e})),Daria.SendMail.getUndoSendLogger(this.params.ids).composeLoaded=!0},_logComposeOpen:function(e){if(e.hasActiveScenario(n.a)){var t=e.getActiveScenario(n.a),o=t.getTimeFromStart();t.logStep(i.d,{duration:o})}else if(ns.page.history.getPrevious())e.startScenario(n.a,s.d);else{var a=_.get(window,"performance.timing.navigationStart");if(a){var r=Date.now()-a,c=Daria.now()-r;e.startScenario(n.a,s.e,{startTime:c}).logStep(i.d,{duration:r})}else e.startScenario(n.a,s.e)}},onHide:function(){Daria.SendMail.getUndoSendLogger(this.params.ids).composeLoaded=!1,this.autosaveStop(),this.leaveStop(),_.defer(function(){"message"!==ns.page.current.page&&(ns.Model.get("messages-checked").resetChecked(),ns.events.trigger("daria:vToolbarButton:restruct",{force:!0}))}),$(".js-mail-Layout-Panes").removeClass("mail-Layout-Panes_compose"),ns.Model.get("app-state").updatePageClasses({"mail-Page_compose":!1,"mail-Page_compose-minified":!1})},onDestroyed:function(){this._destroy()},onPageBeforeLoad:function(e,t,o){if(o!==ns.page.currentUrl){var n=t[0],s=t[1];if(!Daria.composeEqualRoutes(n,s)){var i=s.params._cuid,a=s.params.save_symbol===d.WellKnownFolderSymbol.TEMPLATE&&!n.params.save_symbol,r=this.getModel("compose-message").wasSendCancelled();if(!a&&s.params.ids&&(!n.params.ids||n.params.ids!==s.params.ids))a=ns.Model.get("message",{ids:s.params.ids}).isTemplate();if(("compose2"!==n.page||a||r||"compose2"!==s.page&&!Daria.composeHasParams(i))&&("compose2"===n.page||"compose2"!==s.page||!Daria.composeHasParams(i))){if("compose2"!==s.page)Daria.SendMail.getUndoSendLogger(s.params.ids).composeLoaded=!1;this.shouldClearModel=!0,this._destroy()}}}},onDraftSaved:function(e,t){if(this.isVisible()){var o=this.getModel("compose-state");if(o.get(".saveTemplateAndLeave"))o.set(".saveTemplateAndLeave",!1);else{if(o.get(".saveTemplateAndReset"))return o.set(".saveTemplateAndReset",!1),void this.hardResetCompose();var n=_(ns.page.current.params).pick("_cuid").assign({ids:t.mid}).value(),s=ns.router.generateUrl("compose2",n);ns.page.go(s,"replace")}}},hardResetCompose:function(){this.clean(),Daria.composeGo()},_destroy:function(){this.isDestroyed||(this.isDestroyed=!0,this.shouldClearModel&&(delete this.shouldClearModel,this.clean()))},setState:function(e,t){return this.getModel("compose-fsm").setState(e,t)},onSending:function(e,t){this.isVisible()&&(this.setState("sent",t.data),c.a.hasActiveScenario(n.a)&&c.a.getActiveScenario(n.a).logStep(i.f))},onCancel:function(){this.isVisible()&&(this.shouldClearModel=!0)},onSent:function(){if(this.isVisible()){this.shouldClearModel=!0;var e=this.getModel("compose-message"),t=this.getModel("compose-attachments"),o=this.getModel("compose-forwarded-messages"),s=e.isDelayed()?a.g:a.h,i=t.getSummary(),r=o.getMessagesIds(),d=i.fileAttachmentsCount+i.diskAttachmentsCount+r.length>0,f=r.length?r:e.get(".mark_ids");c.a.finishScenario(n.a,s,function(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?h(Object(o),!0).forEach(function(t){p(e,t,o[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):h(Object(o)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))})}return e}({autocomplete:Object(l.c)()},i,{bodyLength:Object(u.a)(e.get(".send")),hasAttachments:d,forwardedMailsAttachmentsCount:r.length,relatedMailIds:f}))}},onSaveToSending:function(){return this.getModel("compose-message").waitForDraftSave()},onSendingToSent:function(e,t){if(this.isVisible())return this.closePopup(),this.send(t.data)},onSendingToSentFailed:function(e,t){if(this.isVisible()&&(this.setState("edit"),!_.contains(this.silentStatuses,t.error)&&(this.showErrorPopup(t.error),c.a.hasActiveScenario(n.a)))){var o=this.getModel("compose-message").isDelayed()?i.e:i.g,s={error:t.error};c.a.getActiveScenario(n.a).logStep(o,s)}},send:function(e){return e=_.extend({},{force:this.params.sendWithForce},e),this.getModel("compose-message").send(e)},silentStatuses:o,showErrorPopup:function(e){var t=this,o=i18n("%Произошла_ошибка"),n=this.getErrorMessageByCode(e);r.UNDO_ERRORS.includes(e)?Daria.SendMail.showTryAgainPopup({title:o,message:n,onRetry:function(){t.getModel("compose-message").setSendWithoutUndo(),t.onSend()},onCancel:null}):[r.DELAYED_CANNOT_SAVE,r.DELAYED_MESSAGE_SAVED].includes(e)?Daria.SendMail.showTryAgainPopup({title:o,message:n,isDelayed:!0,onRetry:function(){var e=t.getModel("compose-message");e.setSendWithoutUndo(),e.resetDelayed(),t.onSend()},onCancel:null}):Daria.Dialog.notice({title:o,body:"<p>"+n+"</p>"})},getErrorMessageByCode:function(e){var t=this.ERROR_CODES[e];return t||(t=i18n("%Compose_send_failed")),t},showCaptcha:function(){if(this.isVisible()){var e=ns.View.create("compose-captcha");e.update().then(function(){Daria.Dialog.open({title:e.popupData.title,body:e.$node,width:e.popupData.width,onopen:function(){e.focusInput()},onclose:function(){e.invalidate(),e.destroy()}})}),c.a.hasActiveScenario(n.a)&&c.a.getActiveScenario(n.a).logStep(i.a)}},showForgottenAttachmentsDialog:function(e,t){if(this.isVisible()){var o=_.clone(this.params),n=this._forgottenAttachView=ns.View.create("compose-forgotten-attach",o);n.data=t,n.updateByLayout("forgotten-attach",o).then(this.onForgottenAttachUpdated.bind(this)),n.once("ns-view:close",this.onForgottenAttachClose.bind(this))}},onForgottenAttachUpdated:function(){var e=this._forgottenAttachView;this.closePopup(),this._popup=Daria.Dialog.open({width:e.popupData.width,body:e.$node})},onForgottenAttachClose:function(){this.closePopup();var e=this._forgottenAttachView;setTimeout(function(){e.destroy(),e=null},0)},closePopup:function(){this._popup&&this._popup.isOpen()&&(this._popup.close(),this._popup=null)},showConfirmPopup:function(){this.isVisible()&&Daria.Dialog.confirm({body:'<div class="b-popup__p">'+i18n("%Compose_Empty_To")+"</div>",width:360,okValue:i18n("%Отправить"),okHandler:function(){this.setState("sending",{force:!0})}.bind(this),oncancel:function(){}})},onLidsChange:function(){this.isVisible()&&this._composeUpdate()},onValidationError:function(e,t){if(this.isVisible()){var o=_.find(m,function(e){return t.hasOwnProperty(e)});this.scrollToComposeTop(),this.getModel("compose-state").setFocusField(o,{force:!0})}},scrollToComposeTop:function(){var e=this.node.getBoundingClientRect().top;window.scrollTo(0,window.pageYOffset+e-this.VIEWPORT_PADDING_WITH_LEFT_COL_COMPOSE_BUTTON)},clean:function(){_.each(f,function(e){this.getModel(e).destroy()},this);var e=ns.View.infoLite("compose-popular-contacts").params(this.params);ns.Model.get("compose-popular-contacts",e).clean(),this.invalidate(),g.cache.delete(Daria.composeKey(this.params))},onSend:function(){this.setState("sending")},onSave:function(){this.setState("save")}}},"compose-autosave-mixin","compose-leave-mixin",ns.View)}()},3133:function(e,t){ns.View.define("compose-send-loader",{models:{"compose-fsm":{"sending > sent":"showLoader","# *":"hideLoader"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{CLASS_HIDDEN:"is-hidden",showLoader:function(){this.$node.removeClass(this.CLASS_HIDDEN)},hideLoader:function(){this.$node.addClass(this.CLASS_HIDDEN)}}})},3134:function(e,t){ns.View.define("compose-head",{params:ns.View.info("compose2").params,yateModule:"compose2"})},3135:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(137);o.n(n);ns.View.define("compose-template-list",{models:{messages:!1,"compose-message":!1,"compose-state":!1,"compose-fsm":!1},events:{"click@show":"_onClick","click@show .js-template-item":"onTemplateClick","click@show .js-new-template":"onCreateTemplateClick","click@show .js-create-template":"onCreateTemplateClick","click@show .js-save-template":"onSaveTemplateClick"},ctor:function(){this._defaultOptions={withoutTail:!1,autofocus:!1,autoclose:!0},this._options={},this._popup=null},yateModule:"compose2",params:function(e){var t=ns.Model.get("folders").getFidBySymbol(n.WellKnownFolderSymbol.TEMPLATE);return _.extend({},ns.View.info("compose2").params(e),{current_folder:t,allow_empty:!0})},methods:{onTemplateClick:function(e){var t=$(e.currentTarget).data("mid");if(t){Jane.c("Шаблоны:","Шаблоны дропдаун","Выбор шаблона");var o=this.getModel("compose-message");o.isDraft()||o.isReplyAny()||o.isForward()?ns.request(["message","message-body"],{ids:t,draft:!0}).then(this.onMessageBodyRequestSuccess.bind(this,o)):ns.page.go(ns.router.generateUrl("compose2",{ids:t}))}},onMessageBodyRequestSuccess:function(e,t){var o=t[0],n=t[1];if(e.addTextFromMessageBody(n),0===e.getAllRecepients().length&&e.setRecepientsFromMessageBody(n),!e.get(".subj")){var s=o.get(".subject");s&&e.set(".subj",s)}e.addAttachmentsFromTemplateMessageBody(n)},onCreateTemplateClick:function(){Jane.c("Шаблоны:","Шаблоны дропдаун","Новый шаблон");var e=this.getModel("compose-message"),t={save_symbol:n.WellKnownFolderSymbol.TEMPLATE},o=ns.Model.get("compose-predefined-data"),s=e.getData(),i=Object.assign({},s,t);o.setData(i),ns.page.go(ns.router.generateUrl("compose2",t)).then(function(){ns.Model.get("compose-message",t).setDirty(!0)})},onSaveTemplateClick:function(){Jane.c("Шаблоны:","Шаблоны дропдаун","Сохранить шаблон");var e=this.getModel("compose-message"),t=this.getModel("compose-fsm");e.set(".save_symbol",n.WellKnownFolderSymbol.TEMPLATE),t.setState("save")},open:function(e){return this._options=_.extend({},this._defaultOptions,e),this.updateByLayout("compose-template-list",this.params).then(this._onAfterRender,this)},close:function(){this._popup&&this._popup.close()},_onClick:function(){this.close()},_onAfterRender:function(){this._popup=nb.block(Jane.tt("compose2:js-compose-template-list")),this._popup.setContent(this.node),this._popup.on("nb-closed",this._onDestroyed.bind(this)),this._popup.open(this._options)},_onDestroyed:function(){this._popup&&(this._popup.destroy(),this._popup=null),this._options={},this.destroy()}}})},3136:function(e,t){ns.View.edefine("compose-template-list-button",{models:{},events:{"ns-view-show":"onShow","ns-view-hide":"onHide"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onShow:function(){this.openTemplateListInit()},onHide:function(){this.openTemplateListDestroy()}}},"compose-template-list-popup-mixin")},3137:function(e,t){ns.View.define("compose-field-message-resize",{yateModule:"compose2",methods:{messageResizeInit:function(){ns.assert(this.getModel("compose-state"),"Daria.vComposeFieldMessageResize","Должна быть определена модель compose-state"),this._messageResizeInitShow=this._messageResizeInitShow.bind(this),this._onChangeMessageHeight=this._onChangeMessageHeight.bind(this)},messageResizeStart:function(){this.getModel("compose-state").on("ns-model-changed.messageHeight",this._onChangeMessageHeight),ns.Model.get("app-state").on("ns-model-changed.timelineHeight",this._messageResizeInitShow),this._messageResizeInitShow()},messageResizeStop:function(){this.getModel("compose-state").off("ns-model-changed.messageHeight",this._onChangeMessageHeight),ns.Model.get("app-state").off("ns-model-changed.timelineHeight",this._messageResizeInitShow)},getHeight:function(){return this._getHeight()},onChangeHeight:function(){ns.assert(!1,"Daria.vComposeFieldMessageResize",'"onChangeHeight" must be implemented by subclass')},_onChangeMessageHeight:function(){this.onChangeHeight()},_getHeight:function(){return this.getModel("compose-state").get(".messageHeight")},_messageResizeInitShow:function(){var e=this.$node.closest(".js-form").children(":last-child");if(e.length){var t=e[0].getBoundingClientRect();if(t&&(t.width||t.height)){var o=this._$window.height(),n=ns.Model.get("app-state").get(".timelineHeight");if(o&&!(o<t.bottom)){var s=this.$node.outerHeight(!1)-10,i=Math.floor(s+o-t.bottom-n);this.getModel("compose-state").setMessageHeight(i)}}}}}})},3138:function(e,t){ns.View.define("compose-field-base-abook",{models:{"compose-message":!1},events:{"click .js-field-caption":"onCaptionClick"},yateModule:"compose2",methods:{abookInit:function(){this._loadModulesOnce()},isAbookPopupAvailable:!0,onCaptionClick:function(e){e.preventDefault(),e.stopImmediatePropagation(),this.showAbookContactsPopup("compose-field-caption")},showAbookContactsPopup:function(e){Jane.Services.runModules(["abook.css","abook.js","abook.yate"],this._showPopupWhenReady.bind(this,e))},_showPopupWhenReady:function(e){var t={};t[this.FIELD_NAME]=this.getModel("compose-message").getContacts(this.FIELD_NAME);var o=new vow.Deferred;o.promise().then(this.onAbookContactsSelected.bind(this),this.onAbookPopupClosed.bind(this)),ns.action.run("mail-common.abook-popup",{popupType:"select",emails:t,resultDeferred:o}),this._countAbookPopupShow(e)},onAbookContactsSelected:function(e){this.getModel("compose-message").setContacts(this.FIELD_NAME,e),this.onAbookPopupClosed()},onAbookPopupClosed:function(){this.focus()},_countInfo:{sourceType:{"compose-field-caption":"через клик на подпись поля композа","compose-field-suggest":'через клик на "Все контакты" в саджесте'},fieldName:{to:"Кому",cc:"Копия",bcc:"Скрытая копия"}},_countAbookPopupShow:function(e){Jane.c(["АК в саджесте композа","показ попапа",this._countInfo.sourceType[e],this._countInfo.fieldName[this.FIELD_NAME]])},_loadModulesOnce:function(){var e=!1;return function(){e||(e=!0,Jane.Services.load("#abook"))}}()}})},3139:function(e,t){ns.View.define("compose-field-base-suggest",{yateModule:"compose2",methods:{suggestInit:function(e,t){this._suggestItemSelect=this._suggestItemSelect.bind(this),this._suggestValueSet=this._suggestValueSet.bind(this),this._suggestGetPositionNode=this._suggestGetPositionNode.bind(this);var o=$.extend({getPositionNode:this._suggestGetPositionNode,fieldType:this.FIELD_NAME,multiple:this.areYabblesDisabled(),position:{my:"left top",at:"left+9px bottom-1px",collision:"none"},showAbookPopupButton:this.isAbookPopupAvailable},t);"phone"===e?this.suggestInstance=new Daria.Suggest.Phones(null,o):(o.exclude=function(){var e=this.getModel("compose-message").getAllRecepientEmails();return this.areYabblesDisabled()&&e[this.FIELD_NAME].pop(),e}.bind(this),this.suggestInstance=new Daria.Suggest.Contacts(null,o))},suggestStart:function(){return!!this.areYabblesDisabled()&&(this.suggestInstance.on("select",this._suggestItemSelect),this.suggestInstance.on("value-set",this._suggestValueSet),this.suggestInstance.changeInputField(this.getControllerNode()),!0)},suggestStop:function(){return!!this.areYabblesDisabled()&&(this.suggestInstance.off("select",this._suggestItemSelect),this.suggestInstance.off("value-set",this._suggestValueSet),this.suggestInstance.destroy(),!0)},_suggestGetPositionNode:function(){return this.node},_suggestValueSet:function(e,t,o,n){this.setFieldData(n)},_suggestItemSelect:function(e,t,o){switch(o.item.type){case"abook-popup-button":t.preventDefault(),this.isAbookPopupAvailable&&this.showAbookContactsPopup("compose-field-suggest")}}}})},3140:function(e,t){!function(){function e(e,t){return t.reduce(function(t,o){var n=_.isPlainObject(o),s=n?o.from:o,i="yabble-"+(n?o.to:o),a=e[s];return a&&(t[i]=a),t},{})}var t=Daria.Constants.CONTACTS.DELIMITER;ns.View.define("compose-field-base-yabble-ng",{models:{"compose-state":!1,"compose-message":!1},yateModule:"compose2",methods:{CLASS_YABBLE_FOCUS:"mail-Bubbles-FocusArea",_bindMethods:function(){_.bindAll(this,["_bubbleSuggestItemSelect","_bubbleSuggestOpen","_bubbleSuggestClose","_yabbleSyncViewToData","_bubbleDragStart","_bubbleDragEnter","_bubbleDragLeave","_bubbleDragEnd","_bubbleEdit","_bubbleInput","_bubblesetFocus","_bubblesetBlur","_bubblesetKeydown","_bubblesetClick","_bubbleClick","_bubblesUpdate","_onBubbleDropdownDestroy","_onBubbleDropdownOpened","_onBubbleDropdownClosed","_onBubbleFieldValueChanged"])},yabbleInit:function(){this._bindMethods(),this._BubbleClass=this._BubbleClass||Daria.BaseBubble,this.CLASS_CUSTOM_BUBBLE=this._BubbleClass.BUBBLE_CLASS,this._bubblesUpdateDebounce=_.debounce(this._bubblesUpdate,100),this._bubbleClickDebounce=_.debounce(this._bubbleClick,200),this._onBubbleFieldValueChangedDebounce=_.debounce(this._onBubbleFieldValueChanged,50)},getCustomBubbleClass:function(){return this.CLASS_CUSTOM_BUBBLE},yabbleStart:function(){if(this.areYabblesDisabled())return!1;var e=this.getControllerNode();return e&&e[0]&&e[0].options&&e[0].options("lineBreakReplacer","; "),e.on({blur:this._bubblesetBlur,"bubble-input":this._bubbleInput,"bubble-edit":this._bubbleEdit,change:this._yabbleSyncViewToData,click:this._bubblesetClick,dragstart:this._bubbleDragStart,dragenter:this._bubbleDragEnter,dragleave:this._bubbleDragLeave,dragend:this._bubbleDragEnd,focus:this._bubblesetFocus,keydown:this._bubblesetKeydown}),this.suggestInstance&&(this.$suggestProxy=this.$node.find(".js-suggest-proxy"),this.suggestInstance.on("select",this._bubbleSuggestItemSelect).on("open",this._bubbleSuggestOpen).on("close",this._bubbleSuggestClose)),this._customSyncDataToView=this._yabbleSyncDataToView,this._customSyncViewToData=this._yabbleSyncViewToData,this._customOnInput=_.noop,this._bubblesUpdateDebounce(),this._onBubbleFieldValueChanged(),!0},yabbleStop:function(){return!this.areYabblesDisabled()&&(this.getControllerNode().off(),this.suggestInstance&&(this.$suggestProxy=null,this.suggestInstance.off("select",this._bubbleSuggestItemSelect).off("open",this._bubbleSuggestOpen).off("close",this._bubbleSuggestClose),this.suggestInstance.destroy()),this._customSyncDataToView=null,this._customSyncViewToData=null,this._customOnInput=null,!0)},_getBubbleset:function(){return this.getControllerNode()[0]},_bubbleSuggestOpen:function(){this._getBubbleset().options("disableControls",!0)},_bubbleSuggestClose:function(){this._getBubbleset().options("disableControls",!1)},_bubbleInput:function(e){this.$suggestProxy.val(e.originalEvent.detail.data).trigger("keydown")},_bubbleEdit:function(){this._bubbleClickDebounce.cancel(),this._bubbleDropdownDestroy()},_bubblesetFocus:function(){this.suggestInstance.changeInputField(this.$suggestProxy)},_bubblesetBlur:function(){this.suggestInstance&&this.suggestInstance.hide()},_bubblesetKeydown:function(e){if(this.suggestInstance){var t=e.charCode||e.keyCode,o=Jane.Common.keyCode;switch(t){case o.TAB:this.suggestInstance.isOpen()&&this.suggestInstance.focusedSelect();break;case o.ENTER:case o.ESC:case o.UP:case o.DOWN:this.suggestInstance.isOpen()&&this.suggestInstance.$inputField.trigger(e)}}},onWaitSuggestChanged:function(){var e=this.getModel("compose-state"),t=e.getFocusField(),o=e.getWaitSuggest();this.isVisible()&&this.FIELD_NAME===t&&o&&(this.getControllerNode().focus(),e.setWaitSuggest(!1))},_onBubbleFieldValueChanged:function(){},_bubbleSuggestItemSelect:function(t,o,n){o.preventDefault();var s,i=n.item,a=this._getBubbleset();switch(a.focus(),i.type){case"group":a.addBubble(i.name,e(i,[{from:"id",to:"tid"},"value","email","name","type"]));break;case"contact":case"wsContainer":a.addBubble(i.value,e(i,[{from:"id",to:"cid"},"type","phone","email","name"]));break;case"popdom":(s=Object.assign({},i)).id<0&&delete s.id,a.addBubble(s.value,e(s,[{from:"id",to:"cid"},"type"]));break;case"abook-popup-button":this.isAbookPopupAvailable&&this.showAbookContactsPopup("compose-field-suggest")}this._yabbleSyncViewToData()},_bubblesetChange:function(){var e=this.getControllerNode().prop("items").map(this._BubbleClass.toString).join(t);this.setFieldData(e),this._bubblesUpdateDebounce()},_bubbleDragStart:function(e){this.suggestInstance&&this.suggestInstance.hide();var t=_.get(e,"detail.target")||e.target;this._toggleGlobalDragData(t)},_bubbleDragEnter:function(){this._getDragClasses().indexOf(this.CLASS_CUSTOM_BUBBLE)>-1&&this.$node.addClass(this.CLASS_YABBLE_FOCUS)},_bubbleDragLeave:function(){this.$node.removeClass(this.CLASS_YABBLE_FOCUS)},_bubbleDragEnd:function(e){this._bubbleDragLeave(e),this._toggleGlobalDragData()},_toggleGlobalDragData:function(e){var t=document.documentElement;e?(t.setAttribute("data-dragged-yabbles-class-names",e.className),t.classList.add("yabbles-drag")):(t.removeAttribute("data-dragged-yabbles-class-names"),t.classList.remove("yabbles-drag"))},_getDragClasses:function(){var e=document.documentElement.getAttribute("data-dragged-yabbles-class-names");return e?e.split(" "):[]},_yabbleSyncDataToView:function(){var e=this.getModel("compose-message").getContacts(this.FIELD_NAME);this._getBubbleset().setContent(this._syncDataToViewFormatContacts(e).join(t))},_syncDataToViewFormatContacts:function(e){return e},_yabbleSyncViewToData:function(){this.suggestInstance&&(this.suggestInstance.hide(),(this.suggestInstance.currentTerm||this.suggestInstance.prevTerm)&&this.suggestInstance.log({suggest_used:"no"})),this._bubbleDropdown&&this._bubbleDropdown.destroy(),this._bubblesetChange()},_bubblesUpdate:function(){},_onBubbleDropdownDestroy:function(){this._bubbleDropdown&&this._bubbleDropdown.$node&&this._unsetBubbleDropdownEventHandlers(this._bubbleDropdown.$node),this._bubbleDropdown=null},_onBubbleDropdownOpened:function(e,t){if(_.get(t,"where.parentNode")){var o=this;_.defer(function(){var e=t.$node&&t.$node.find(".js-bubble-copy");if(e.length){var n=new Daria.Clipboard(e);n.on("ready",function(){if(t.where){var n=new o._BubbleClass(t.where).getHeadEmail();this.setText(n),e.removeClass("is-disabled")}}),n.on("complete",function(){t.destroy()}),t.on("nb-closed",_.debounce(function(){n.destroy()},50))}}),this._onBubbleDropdownDestroy=t.destroy.bind(t),this._$window.one("scroll",this._onBubbleDropdownDestroy),this._$document.one("keydown",this._onBubbleDropdownDestroy),ns.events.once("daria:vScrollerCompose:scroll",this._onBubbleDropdownDestroy),ns.events.once("daria:layout-changed",this._onBubbleDropdownDestroy)}else t.destroy()},_onBubbleDropdownClosed:function(e,t){this._onBubbleDropdownDestroy&&(this._$window.off("scroll",this._onBubbleDropdownDestroy),this._$document.off("keydown",this._onBubbleDropdownDestroy),ns.events.off("daria:vScrollerCompose:scroll",this._onBubbleDropdownDestroy),ns.events.off("daria:layout-changed",this._onBubbleDropdownDestroy),delete this._onBubbleDropdownDestroy),t.destroy()},_bubblesetClick:function(e){var t=$(e.target).closest("[bubble]")[0];if(t){var o=!0;this._bubbleDropdown&&(o=this._bubbleDropdown.where!==t,this._bubbleDropdown.close()),this._bubbleClickDebounce(e,t,o)}else this.suggestInstance.show()},_bubbleClick:function(e,t,o){if(o){var n=new this._BubbleClass(t);t.parentNode&&this._bubbleOpenDropdown(n,t)}},_getBubbleDropdownData:function(){return{}},_setBubbleDropdownEventHandlers:function(){},_unsetBubbleDropdownEventHandlers:function(){},_bubbleOpenDropdown:function(e,t){this._bubbleDropdown=nb.block(ns.renderNode(this._getBubbleDropdownData(e),"js-bubble-dropdown","compose2")),this._bubbleDropdown.on("nb-destroyed",this._onBubbleDropdownDestroy),this._bubbleDropdown.on("nb-opened",this._onBubbleDropdownOpened),this._bubbleDropdown.on("nb-closed",this._onBubbleDropdownClosed),this._setBubbleDropdownEventHandlers(this._bubbleDropdown.$node,e,t),this._updateItemsGroupBubble(),this._bubbleDropdown.open({withoutTail:!1,autofocus:!1,animation:!1,where:t})},_bubbleDropdownDestroy:function(){this._bubbleDropdown&&this._bubbleDropdown.destroy()},_onClickRemoveBubble:function(e){this._bubbleDropdownDestroy(),this._getBubbleset().removeBubble(e)},_onClickSingleTargetBubble:function(e){this._bubbleDropdownDestroy();var t=new this._BubbleClass(e),o=this._getBubbleset();o.items.forEach(function(t){t!==e&&o.removeBubble(t)}),this.getModel("compose-message").setSingleRecipient(t.toString())},_onClickEditBubble:function(e){this._bubbleDropdownDestroy();var t=this._getBubbleset();t.focus(),t.editBubble(e)},_onClickAddAbookBubble:function(e){this._bubbleDropdownDestroy(),this._onSuccessAddAbookBubble&&(ns.events.off("yabble.add-to-abook",this._onSuccessAddAbookBubble),this._onSuccessAddAbookBubble=null);var t=_.uniqueId(),o=new this._BubbleClass(e);ns.action.run("yabble.add-to-abook",{id:t,name:o.get("name"),email:o.getHeadEmail()}),this._onSuccessAddAbookBubble=_.bind(function(o,n){this._onSuccessAddAbookBubble=null,n.id===t&&e.parentNode&&this._bubblesUpdate()},this),ns.events.once("yabble.add-to-abook",this._onSuccessAddAbookBubble)},_onClickChangeEmailBubble:function(e,t){this._bubbleDropdownDestroy();var o=$(t.currentTarget).data("email"),n=new this._BubbleClass(e);n.setEmail(o),n.applyTo(e),this._bubblesetChange()},_onChangeGroupBubble:function(e,t){var o=$(t.currentTarget),n=o.find("input"),s=n.prop("checked"),i=n.val(),a=new this._BubbleClass(e);s?a.appendEmail(i,o.data("name")):a.removeEmail(i),a.applyTo(e),this._updateItemsGroupBubble(),this._bubblesetChange()},_updateItemsGroupBubble:function(){if(this._bubbleDropdown){var e=this._bubbleDropdown.$node.find("input:checked");e.closest(".js-bubble-change-group").toggleClass("is-disabled",1===e.length)}}}})}()},3141:function(e,t){!function(){var e=ns.View.info("compose-field-base-yabble-ng");ns.View.edefine("compose-field-contact-yabble-ng",{yateModule:"compose2",methods:{CLASS_YABBLE_SMS_LINK:"mail-Bubbles-Sms",_BubbleClass:Daria.ContactBubble,_bindMethods:function(){e.methods._bindMethods.call(this),this._onBubbleSmsLinkToggle=this._onBubbleSmsLinkToggle.bind(this)},yabbleStart:function(){var t=e.methods.yabbleStart.call(this);return t&&(this.getModel("compose-state").on("sms-link-toggle",this._onBubbleSmsLinkToggle),this.getModel("compose-message").on("ns-model-changed.to",this._onBubbleFieldValueChangedDebounce).on("ns-model-changed.cc",this._onBubbleFieldValueChangedDebounce).on("ns-model-changed.bcc",this._onBubbleFieldValueChangedDebounce)),t},yabbleStop:function(){var t=e.methods.yabbleStop.call(this);return t&&(this.getModel("compose-state").off("sms-link-toggle",this._onBubbleSmsLinkToggle),this.getModel("compose-message").off("ns-model-changed.to",this._onBubbleFieldValueChangedDebounce).off("ns-model-changed.cc",this._onBubbleFieldValueChangedDebounce).off("ns-model-changed.bcc",this._onBubbleFieldValueChangedDebounce)),t},_bubblesUpdate:function(){for(var e=this.getControllerNode(),t=e.prop("items"),o=t.length,n=[];o--;){var s=t[o];if(!s.hasAttribute("lock")){var i=new this._BubbleClass(s);i.needUpdate()&&(n.push(i.getHeadEmail()),s.setAttribute("lock","lock"))}}if(n.length){var a,r=1/0,c=this;n.reduce(function(e,t){return t.length<c._BubbleClass.EMAIL_LEN_REQUEST&&((r+=t.length+1)>c._BubbleClass.EMAIL_LEN_REQUEST&&(r=0,a=[],e.push(a)),a.push(t)),e},[]).forEach(function(t){var o=[],n=t.join(",");o.push({id:"abook-contacts",params:{emails:n}}),Daria.Config.workspace&&o.push({id:"abook-contacts",params:{emails:n,shared:1}}),ns.request(o).then(function(o){for(var n=o[0].getContactsInfoByEmails(t,{onlyFirstEmail:!0,joinName:!0}),s=(o[1]?o[1].getContactsInfoByEmails(t,{onlyFirstEmail:!0,joinName:!0,shared:!0}):[]).concat(n).reduce(function(e,t){return e[t.email]=!0,e},{}),i=e.prop("items"),a=i.length;a--;){var r=i[a],u=new c._BubbleClass(r);s[u.getHeadEmail()]&&u.applyTo(r)}c._bubblesetChange()})})}},_bubbleClick:function(e,t,o){var n,s,i=Boolean($(e.target).closest(".js-sms-open-link").length),a=new this._BubbleClass(t);if(i)return s={phone:(n=a.getPhone()).value,email:a.getHeadEmail(),name:a.getText(),canRequest:n.status!==this._BubbleClass.PHONE.NOT_FOUND},void this.getModel("compose-state").trigger("sms-link-click",s);if(o){this._bubbleDropdownPromise&&!this._bubbleDropdownPromise.isResolved()&&this._bubbleDropdownPromise.reject();var r=vow.resolve();a.isGroup()?r=ns.request("abook-contacts",{tid:a.get("tid")}):a.isContact()&&(r=ns.request("abook-contact",{cid:a.get("cid"),shared:Boolean(a.get("shared"))})),r.then(function(){t.parentNode&&this._bubbleOpenDropdown(a,t)},this),this._bubbleDropdownPromise=r}},_onBubbleFieldValueChanged:function(){this._toggleSmsLink(this._canShowSmsLink())},_bubbleDragStart:function(){e.methods._bubbleDragStart.apply(this,arguments);var t=this.getModel("compose-state");t.setIfChanged(".isCcVisible",!0),t.setIfChanged(".isBccVisible",!0)},_canShowSmsLink:function(){var e=this.getModel("compose-state");if(!e.get(".isPhoneEnabled")||e.get(".isPhoneVisible"))return!1;var t=this.getModel("compose-message"),o=t.getAllRecepients(),n=t.getContacts(this.FIELD_NAME);return 1===o.length&&1===n.length},_toggleSmsLink:function(e){this.getControllerNode().toggleClass(this.CLASS_YABBLE_SMS_LINK,e)},_onBubbleSmsLinkToggle:function(e,t){this._toggleSmsLink(this._canShowSmsLink()&&t)},_syncDataToViewFormatContacts:function(e){return e.map(Jane.FormValidation.obj2contact)},_getBubbleDropdownData:function(e){var t={canCopy:Daria.Clipboard.canUse,contact:{isContact:e.isContact(),isGroup:e.isGroup(),email:e.getHeadEmail()},emails:e.get("email")};if(e.isGroup())t.contacts=ns.Model.get("abook-contacts",{tid:e.get("tid")}).get(".contact"),t.contacts=_(t.contacts).chain().reduce(function(e,o){return _.forEach(o.email,function(n){e.push({name:_.get(o,"name.full"),email:n.value,checked:-1!==t.emails.indexOf(n.value)})}),e},[]).value();else if(e.isContact()){var o=ns.Model.get("abook-contact",{cid:e.get("cid"),shared:Boolean(e.get("shared"))}).get(".email");t.emails=_(o).chain().map("value").concat(t.emails).compact().uniq().value()}return t},_setBubbleDropdownEventHandlers:function(e,t,o){e.on("click",".js-bubble-remove",this._onClickRemoveBubble.bind(this,o)).on("click",".js-bubble-single-target",this._onClickSingleTargetBubble.bind(this,o)).on("click",".js-bubble-edit",this._onClickEditBubble.bind(this,o)).on("click",".js-bubble-add-to-abook",this._onClickAddAbookBubble.bind(this,o)).on("click",".js-bubble-change-email",this._onClickChangeEmailBubble.bind(this,o)).on("change",".js-bubble-change-group",this._onChangeGroupBubble.bind(this,o))},_unsetBubbleDropdownEventHandlers:function(e){e.off("click",".js-bubble-remove").off("click",".js-bubble-single-target").off("click",".js-bubble-edit").off("click",".js-bubble-add-to-abook").off("click",".js-bubble-change-email").off("change",".js-bubble-change-group")}}},"compose-field-base-yabble-ng",ns.View)}()},3142:function(e,t){ns.View.edefine("compose-field-phone-yabble-ng",{yateModule:"compose2",methods:{_BubbleClass:Daria.PhoneBubble,_getBubbleDropdownData:function(){return{canCopy:Daria.Clipboard.canUse,contact:{isPhone:!0}}},_setBubbleDropdownEventHandlers:function(e,t,o){e.on("click",".js-bubble-remove",this._onClickRemoveBubble.bind(this,o)).on("click",".js-bubble-edit",this._onClickEditBubble.bind(this,o))},_unsetBubbleDropdownEventHandlers:function(e){e.off("click",".js-bubble-remove").off("click",".js-bubble-edit")}}},"compose-field-base-yabble-ng",ns.View)},3143:function(e,t){ns.View.define("compose-field-base-sms-controls",{yateModule:"compose2",methods:{smsControlsInit:function(){this.suggestItemButtonClick=this.suggestItemButtonClick.bind(this),this.onFieldValueChanged=this.onFieldValueChanged.bind(this),this.onPhoneFieldStateChanged=this.onPhoneFieldStateChanged.bind(this),this.smsLinkClick=this.smsLinkClick.bind(this)},smsControlsStart:function(){this.getModel("compose-message").on("ns-model-changed."+this.FIELD_NAME,this.onFieldValueChanged);var e=this.getModel("compose-state");return e&&(e.on("ns-model-changed.isPhoneEnabled",this.onPhoneFieldStateChanged),e.on("ns-model-changed.isPhoneVisible",this.onPhoneFieldStateChanged),e.on("sms-link-click",this.smsLinkClick)),this.suggestInstance&&this.suggestInstance.on("button-click",this.suggestItemButtonClick),this.onPhoneFieldStateChanged(),!0},smsControlsStop:function(){this.getModel("compose-message").off("ns-model-changed."+this.FIELD_NAME,this.onFieldValueChanged);var e=this.getModel("compose-state");return e&&(e.off("ns-model-changed.isPhoneEnabled",this.onPhoneFieldStateChanged),e.off("ns-model-changed.isPhoneVisible",this.onPhoneFieldStateChanged),e.off("sms-link-click",this.smsLinkClick)),this.suggestInstance&&this.suggestInstance.off("button-click",this.suggestItemButtonClick),!0},onFieldValueChanged:function(){var e=this.getModel("compose-state").get(".isPhoneEnabled"),t=this.getModel("compose-state").get(".isPhoneVisible");if(e&&t){var o=this.getModel("compose-message");if(o.hasOnlyOneValidRecipient(this.FIELD_NAME)){var n=o.getContacts(this.FIELD_NAME);o.setPhoneIfExist(n[0].email)}}},onPhoneFieldStateChanged:function(){var e=this.getModel("compose-state"),t=e.get(".isPhoneEnabled"),o=e.get(".isPhoneVisible");this.refreshSmsYabbles(t,o)},refreshSmsYabbles:function(e,t){this.getModel("compose-state").atrigger("sms-link-toggle",e&&!t)},suggestItemButtonClick:function(e,t,o){var n=o.item,s=n.email,i=n.phone;o.button.hasClass("js-compose-add-phone")&&i&&this.setPhoneValue({email:s,phone:i,canRequest:!0})},smsLinkClick:function(e,t){t=t||{},this.setPhoneValue(t)},setPhoneValue:function(e){var t=this.getModel("compose-state"),o=this.getModel("compose-message"),n=e.email,s=e.canRequest;if(t.get(".isPhoneEnabled"))return t.setIfChanged(".isPhoneVisible",!0),s?o.setPhoneIfExist(n,!0).then(function(){t.setFocusField("phone")}):void t.setFocusField("phone")}}})},3144:function(e,t){ns.View.define("compose-field-base-resize",{yateModule:"compose2",methods:{resizeInit:function(){this._$resizeInputController=null,this._$resizeMeasurer=null,this._resizeMeasurerHeight=0,this._resizeKeypressPrevent=this._resizeKeypressPrevent.bind(this),this._resizeCheck=this._resizeCheck.bind(this),this._resizeCheckDebounce=_.debounce(this._resizeCheck,50)},resizeStart:function(){return!!this.areYabblesDisabled()&&(this._$resizeInputController=this.getControllerNode(),this._resizeMeasurerInit(),this._resizeBindEvents(),!0)},resizeStop:function(){return!!this.areYabblesDisabled()&&(this._resizeUnbindEvents(),this._resizeMeasurerDestroy(),this._$resizeInputController=null,!0)},_resizeBindEvents:function(){this._$resizeInputController.on("keypress",this._resizeKeypressPrevent),this.on("ns-view-show",this._resizeCheck),this.getModel("compose-message").on("ns-model-changed."+this.FIELD_NAME,this._resizeCheckDebounce)},_resizeUnbindEvents:function(){this._$resizeInputController.off("keypress",this._resizeKeypressPrevent),this.off("ns-view-show",this._resizeCheck),this.getModel("compose-message").off("ns-model-changed."+this.FIELD_NAME,this._resizeCheckDebounce)},_resizeKeypressPrevent:function(e){e.which===Jane.Common.keyCode.ENTER&&e.preventDefault()},_resizeMeasurerInit:function(){this._$resizeMeasurer=$('<div class="is-vhidden">measurer</div>').insertAfter(this._$resizeInputController),this._resizeMeasurerHeight=this._$resizeMeasurer.height()},_resizeMeasurerDestroy:function(){this._$resizeMeasurer.remove(),this._$resizeMeasurer=null,this._resizeMeasurerHeight=0},_resizeCheck:function(){var e=1,t="auto";if(this._resizeMeasurerHeight){this._$resizeMeasurer.text(this.getFieldData()),this._$resizeMeasurer.width(this._$resizeInputController.width());var o=e=Math.ceil(this._$resizeMeasurer.height()/this._resizeMeasurerHeight);e<1?o=1:e>3&&(o=3),t=o*this._resizeMeasurerHeight}this._$resizeInputController.height(t).toggleClass("is-multiline",e>3)}}})},3145:function(e,t){ns.View.define("compose-field-base-focus",{events:{"focusin@show .js-compose-field":"onFocus","focusout@show .js-compose-field":"onBlur"},yateModule:"compose2",methods:{FIELD_NAME:null,CLASS_FOCUSED:"is-focused",_customFocus:null,_customIsFocused:null,focusInit:function(){this.onFocusFieldChanged()},focusDestroy:function(){},onFocusFieldChanged:function(){var e=this.getModel("compose-state").getFocusField();this.isVisible()&&this.FIELD_NAME===e&&this.focus()},onFocus:function(){this.toggleFocus(!0)},onBlur:function(){this.toggleFocus(!1)},toggleFocus:function(e){this.getModel("compose-state").setFocusField(e?this.FIELD_NAME:null,{silent:!0}),this.$node.toggleClass(this.CLASS_FOCUSED,e),this.$node.find(".js-compose-field-wrapper").toggleClass(this.CLASS_FOCUSED,e)},focus:function(){this._customFocus?this._customFocus():this.$node.find(".js-compose-field").focus(0)},isFocused:function(){return this._customIsFocused?this._customIsFocused():this.$node.find(".js-compose-field").is(":focus")}}})},3146:function(e,t){ns.View.edefine("compose-field-base",{models:{"compose-message":!1,"compose-state":!1},events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide","input@show .js-compose-field":"onInput"},params:{},ctor:function(){this.onFieldDataChanged=this.onFieldDataChanged.bind(this)},yateModule:"compose2",methods:{NEED_TO_EMULATE:Modernizr.ie9&&Modernizr.opera<15,_customSyncDataToView:null,_customSyncViewToData:null,getContextNode:function(){return this.$node.closest(".js-form")},getControllerNode:function(){return this.$node.find(".js-compose-field")},setFieldData:function(e){this.getModel("compose-message").setIfChanged("."+this.FIELD_NAME,e,{data:{needUpdate:!1}})},getFieldData:function(){return this.getModel("compose-message").get("."+this.FIELD_NAME)},onFieldDataChanged:function(e,t,o,n){!1!==(n=n||{}).needUpdate&&this.syncDataToView()},syncDataToView:function(){this.isVisible()&&(this._customSyncDataToView?this._customSyncDataToView():this.getControllerNode().val(this.getFieldData()))},syncViewToData:function(){if(this.isVisible())if(this._customSyncViewToData)this._customSyncViewToData();else{var e=this.getControllerNode().val();this.setFieldData(e)}},onInit:function(){},onShow:function(){this.startEmulateInputEvent(),this.focusInit(),this.getModel("compose-message").on("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged)},onHide:function(){this.stopEmulateInputEvent(),this.focusDestroy(),this.getModel("compose-message").off("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged)},startEmulateInputEvent:function(){this.NEED_TO_EMULATE&&this.$node.startEmulateInputEvent(".js-compose-field")},stopEmulateInputEvent:function(){this.NEED_TO_EMULATE&&this.$node.stopEmulateInputEvent()},onInput:function(e){if(e.target===e.currentTarget)if(this._customOnInput)this._customOnInput();else{var t=$(e.currentTarget);this.setFieldData(t.val())}},areYabblesDisabled:function(){return ns.Model.get("settings").isSet("disable_yabbles")}}},"compose-field-base-focus")},3147:function(e,t){!function(){var e=ns.View.infoLite("compose-field-base");ns.View.defineNg("compose-field-to",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-state":ns.View.defineModelEvents({"ns-model-changed.focusField":"onFocusFieldChanged","ns-model-changed.waitSuggest":"onWaitSuggestChanged"}),"compose-message":ns.View.defineModelEvents({"ns-model-changed.to":"onFieldValueChanged"}),"compose-fsm":!1},mixins:["compose-field-contact-yabble-ng"],params:ns.View.info("compose2").params,ctor:function(){e.ctor.apply(this,arguments)},yateModule:"compose2",methods:{FIELD_NAME:"to",onInit:function(){this.resizeInit(),this.suggestInit("contact"),this.yabbleInit(),this.smsControlsInit(),this.abookInit(),e.methods.onInit.apply(this,arguments)},onShow:function(){this.resizeStart(),this.suggestStart(),this.yabbleStart(),this.smsControlsStart(),e.methods.onShow.apply(this,arguments)},onHide:function(){this.resizeStop(),this.suggestStop(),this.yabbleStop(),this.smsControlsStop(),e.methods.onHide.apply(this,arguments)}}},"compose-field-base-resize","compose-field-base-suggest","compose-field-base-sms-controls","compose-field-base-hotkeys","compose-field-base-abook","compose-field-base")}()},3148:function(e,t){!function(){var e=ns.View.infoLite("compose-field-base");ns.View.defineNg("compose-field-cc",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-state":ns.View.defineModelEvents({"ns-model-changed.isCcVisible":"composeUpdate","ns-model-changed.focusField":"onFocusFieldChanged","ns-model-changed.waitSuggest":"onWaitSuggestChanged"}),"compose-message":!1,"compose-fsm":!1},mixins:["compose-field-contact-yabble-ng"],params:ns.View.info("compose2").params,ctor:function(){e.ctor.apply(this,arguments)},yateModule:"compose2",methods:{FIELD_NAME:"cc",onInit:function(){this.resizeInit(),this.suggestInit("contact"),this.yabbleInit(),this.smsControlsInit(),this.abookInit(),e.methods.onInit.apply(this,arguments)},onShow:function(){this.resizeStart(),this.suggestStart(),this.yabbleStart(),this.smsControlsStart(),e.methods.onShow.apply(this,arguments)},onHide:function(){this.resizeStop(),this.suggestStop(),this.yabbleStop(),this.smsControlsStop(),e.methods.onHide.apply(this,arguments)}}},"compose-field-base-resize","compose-field-base-suggest","compose-field-base-sms-controls","compose-field-base-hotkeys","compose-field-base-abook","compose-field-base")}()},3149:function(e,t){!function(){var e=ns.View.infoLite("compose-field-base");ns.View.defineNg("compose-field-bcc",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-state":ns.View.defineModelEvents({"ns-model-changed.isBccVisible":"composeUpdate","ns-model-changed.focusField":"onFocusFieldChanged","ns-model-changed.waitSuggest":"onWaitSuggestChanged"}),"compose-message":!1,"compose-fsm":!1},mixins:["compose-field-contact-yabble-ng"],params:ns.View.info("compose2").params,ctor:function(){e.ctor.apply(this,arguments)},yateModule:"compose2",methods:{FIELD_NAME:"bcc",onInit:function(){this.resizeInit(),this.suggestInit("contact"),this.yabbleInit(),this.smsControlsInit(),this.abookInit(),e.methods.onInit.apply(this,arguments)},onShow:function(){this.resizeStart(),this.suggestStart(),this.yabbleStart(),this.smsControlsStart(),e.methods.onShow.apply(this,arguments)},onHide:function(){this.resizeStop(),this.suggestStop(),this.yabbleStop(),this.smsControlsStop(),e.methods.onHide.apply(this,arguments)}}},"compose-field-base-resize","compose-field-base-suggest","compose-field-base-sms-controls","compose-field-base-hotkeys","compose-field-base-abook","compose-field-base")}()},3150:function(e,t){ns.View.define("compose-field-phone",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.isPhoneVisible":"composeUpdate","ns-model-changed.isPhoneEnabled":"composeUpdate"},"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){return this.getModel("compose-state").get(".isPhoneEnabled")?"layout-compose-field-phone-input":"layout-compose-field-phone-input-error"}}})},3151:function(e,t){!function(){var e=ns.View.infoLite("compose-field-base");ns.View.defineNg("compose-field-phone-input",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-state":ns.View.defineModelEvents({"ns-model-changed.focusField":"onFocusFieldChanged"}),"compose-message":!1},mixins:["compose-field-phone-yabble-ng"],params:ns.View.info("compose2").params,ctor:function(){e.ctor.apply(this,arguments)},yateModule:"compose2",methods:{FIELD_NAME:"phone",onInit:function(){this.resizeInit(),this.suggestInit("phone",{multiple:!1}),this.yabbleInit(),e.methods.onInit.apply(this,arguments)},onShow:function(){this.resizeStart(),this.suggestStart(),this.yabbleStart(),e.methods.onShow.apply(this,arguments)},onHide:function(){this.resizeStop(),this.suggestStop(),this.yabbleStop(),e.methods.onHide.apply(this,arguments)}}},"compose-field-base-resize","compose-field-base-suggest","compose-field-base")}()},3152:function(e,t){ns.View.define("compose-field-phone-input-error",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{}},"compose-field-phone-error-mixin")},3153:function(e,t){ns.View.edefine("compose-field-subject",{models:{"compose-message":{"ns-model-changed":!1,"ns-model:store-subject-for-autocomplete":"_storeSubjectForAutocomplete"},"compose-state":{"ns-model-changed":!1,"ns-model-changed.focusField":"onFocusFieldChanged"},"compose-fsm":!1},events:{"focus .js-editor-tabfocus-prev":"preventSelectAllOnTabFocus"},params:ns.View.info("compose2").params,ctor:function(){ns.View.info("compose-field-base").ctor.apply(this,arguments)},yateModule:"compose2",methods:{FIELD_NAME:"subj",preventSelectAllOnTabFocus:function(e){setTimeout(function(){return e.target.selectionStart=e.target.selectionEnd})},_storeSubjectForAutocomplete:function(){var e=this.$node.find(".js-compose-field");if(e.length){var t="subj-".concat(Daria.getRandomString()),o="/monitoring_liza.txt?ffs=".concat(t),n=$('<iframe name="'.concat(t,'" class="is-hidden">')).appendTo(document.body),s=$('<form target="'.concat(t,'" class="is-hidden">')).attr("action",o).appendTo(document.body);e.clone().appendTo(s),$('<button type="submit"></button>').appendTo(s).click(),s.remove(),n.remove()}}}},"compose-field-base-hotkeys","compose-field-base")},3154:function(e,t){ns.View.define("compose-field-placeholder",{events:{"click@show .js-recipient":"onClickRecipient","mouseenter@show .js-recipient":"onMouseEnterLeaveRecipient","mouseleave@show .js-recipient":"onMouseEnterLeaveRecipient","click@show .js-recipients-edit":"onClickEditButton"},models:{"compose-state":!1,"compose-message":{"ns-model-changed":"keepValid","ns-model-changed.to":"invalidate","ns-model-changed.cc":"invalidate","ns-model-changed.bcc":"invalidate"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onMouseEnterLeaveRecipient:function(e){var t=$(e.target).closest(".js-recipients"),o="mouseenter"===e.type;t.toggleClass("has-inner-target",o)},onClickRecipient:function(e){var t=this.getModel("compose-message"),o=t.get(".to"),n=t.get(".cc"),s=t.get(".bcc"),i=Jane.FormValidation.obj2contact({name:e.target.dataset.name,email:e.target.dataset.email});(n||s||o!==i)&&(e.preventDefault(),e.stopPropagation(),t.setSingleRecipient(i))},onClickEditButton:function(e){e.preventDefault(),e.stopPropagation();var t=this.getModel("compose-state"),o=$(e.target).data("field");t.setFocusField(o),t.setWaitSuggest(!0)},_getFieldItems:function(e){var t=this.getModel("compose-message").get("."+e);return t?Jane.FormValidation.splitContacts(t):""},getRecipients:function(){return this._getFieldItems("to")},getCopies:function(){return this._getFieldItems("cc")},getCopyCount:function(){return this.getCopies().length}}})},3155:function(e,t){ns.View.define("compose-field-to-extras",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.isCcVisible":"composeUpdate","ns-model-changed.isBccVisible":"composeUpdate","ns-model-changed.isPhoneVisible":"composeUpdate","ns-model-changed.isPhoneEnabled":"composeUpdate"},"compose-field-extras-collection":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"to"})},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-state"),t=this.getModel("compose-field-extras-collection");return t.clear(),e.isFieldVisible("cc")||t.insert(ns.Model.get("compose-field-extras",_.extend({type:"extras-cc"},this.params)).setData({type:"extras-cc"})),e.isFieldVisible("bcc")||t.insert(ns.Model.get("compose-field-extras",_.extend({type:"extras-bcc"},this.params)).setData({type:"extras-bcc"})),"layout-compose-field-to-extras"}}})},3156:function(e,t){ns.View.define("compose-field-to-extras-cc",{events:{"click@show":"onClick"},models:{"compose-state":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(e){e.preventDefault();var t=this.getModel("compose-state"),o=ns.View.infoLite("compose-field-cc").methods.FIELD_NAME;t.setFocusField(o),t.setIfChanged(".isCcVisible",!0),Jane.c("Написание письма","Шапка письма",'Клик в "Копия"')}}})},3157:function(e,t){ns.View.define("compose-field-to-extras-bcc",{events:{"click@show":"onClick"},models:{"compose-state":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(e){e.preventDefault();var t=this.getModel("compose-state"),o=ns.View.infoLite("compose-field-bcc").methods.FIELD_NAME;t.setFocusField(o),t.setIfChanged(".isBccVisible",!0),Jane.c("Написание письма","Шапка письма",'Клик в "Скрытая копия"')}}})},3158:function(e,t){ns.View.define("compose-field-to-extras-phone",{events:{"click@show":"onClick"},models:{"compose-message":!1,"compose-state":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(e){e.preventDefault();var t=this.getModel("compose-state"),o=ns.View.infoLite("compose-field-phone-input").methods.FIELD_NAME;if(t.get(".isPhoneEnabled")){t.setFocusField(o),t.setIfChanged(".isPhoneVisible",!0);var n=this.getModel("compose-message");if(n.hasOnlyOneValidRecipient()){var s=n.getAllRecepients();n.setPhoneIfExist(s[0].email,!0)}}else{var i=nb.block(Jane.tt("common:js-hint",{content:this.getErrorMessage()}));i.on("nb-closed",function(){this.destroy()}),i.open({where:this.$node,how:{autoclose:!0,at:"center bottom",my:"center top"}}),$(window).one("scroll",function(){i.close()})}Jane.c("Написание письма","Шапка письма",'Клик в "СМС"')}}},"compose-field-phone-error-mixin")},3159:function(e,t){ns.View.define("compose-field-to-notice-replyall",{events:{"click@show .js-reply-all-link":"onReplyAllLinkClick"},models:{"compose-state":!1,"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onReplyAllLinkClick:function(e){e.preventDefault();var t=this.getModel("compose-state"),o=this.getModel("compose-message");o.changeRecipientsToOpposite(),t.set(".isReplyAllNoticeVisible",!1),t.set(".isCcVisible",Boolean(o.get(".cc")),{force:t.isCcVisible()}),t.set(".isBccVisible",Boolean(o.get(".bcc")),{force:t.isBccVisible()})}}})},3160:function(e,t){ns.View.define("compose-field-to-notice-nda",{yateModule:"compose2"})},3161:function(e,t){ns.View.define("compose-field-cc-notice-nda",{yateModule:"compose2"})},3162:function(e,t){ns.View.define("compose-field-bcc-notice-nda",{yateModule:"compose2"})},3163:function(e,t){ns.View.define("compose-field-phone-notice-help",{yateModule:"compose2"})},3164:function(e,t){ns.View.edefine("compose-recipients",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{_getFieldItems:function(e){var t=this.getModel("compose-message").get("."+e);return t?Jane.FormValidation.splitContacts(t):""},getRecipients:function(){return this._getFieldItems("to")},getCopies:function(){return this._getFieldItems("cc")},getCopyCount:function(){return this.getCopies().length}}})},3165:function(e,t){ns.View.define("compose-field-error-mixin",{yateModule:"compose2",methods:{FIELD_NAME:null,getErrorMessage:function(){return this.getModel("compose-message").getFieldError(this.FIELD_NAME)}}})},3166:function(e,t){ns.View.define("compose-field-to-error",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{FIELD_NAME:"to"}},"compose-field-error-mixin")},3167:function(e,t){ns.View.define("compose-field-phone-error",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{FIELD_NAME:"phone"}},"compose-field-error-mixin")},3168:function(e,t){ns.View.define("compose-field-cc-error",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{FIELD_NAME:"cc"}},"compose-field-error-mixin")},3169:function(e,t){ns.View.define("compose-field-bcc-error",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{FIELD_NAME:"bcc"}},"compose-field-error-mixin")},3170:function(e,t){ns.View.define("compose-field-att_ids-error",{models:{"compose-message":!1},params:ns.View.infoLite("compose2").params,yateModule:"compose2",methods:{FIELD_NAME:"att_ids"}},"compose-field-error-mixin")},3171:function(e,t){ns.View.define("compose-field-to-notices-wrapper",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.visibleNotices.to":"composeUpdate","ns-model-changed.isReplyAllNoticeVisible":"composeUpdate"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.to":"onFieldChanged","ns-model-changed.errors.to":"composeUpdate"},"compose-field-notices":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"to"})},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-message"),t=this.getModel("compose-state"),o=this.getModel("compose-field-notices");return o.clear(),e.getFieldError("to")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"error"},this.params)).setData({type:"error"})),t.isFieldVisible("to")&&t.isNdaNoticeVisible("to")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"nda"},this.params)).setData({type:"nda"})),t.isReplyAllNoticeVisible("to")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"replyall"},this.params)).setData({type:"replyall"})),"layout-compose-field-notices-to"},onFieldChanged:function(){this.getModel("compose-message").setIfChanged(".errors.to","")}}})},3172:function(e,t){ns.View.define("compose-field-cc-notices-wrapper",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.visibleNotices.cc":"composeUpdate"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.cc":"onFieldChanged","ns-model-changed.errors.cc":"composeUpdate"},"compose-field-notices":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"cc"})},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-message"),t=this.getModel("compose-state"),o=this.getModel("compose-field-notices");return o.clear(),e.getFieldError("cc")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"error"},this.params)).setData({type:"error"})),t.isFieldVisible("cc")&&t.isNdaNoticeVisible("cc")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"nda"},this.params)).setData({type:"nda"})),t.isReplyAllNoticeVisible("cc")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"replyall"},this.params)).setData({type:"replyall"})),"layout-compose-field-notices-cc"},onFieldChanged:function(){this.getModel("compose-message").setIfChanged(".errors.cc","")}}})},3173:function(e,t){ns.View.define("compose-field-bcc-notices-wrapper",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.visibleNotices.bcc":"composeUpdate"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.bcc":"onFieldChanged","ns-model-changed.errors.bcc":"composeUpdate"},"compose-field-notices":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"bcc"})},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-message"),t=this.getModel("compose-state"),o=this.getModel("compose-field-notices");return o.clear(),e.getFieldError("bcc")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"error"},this.params)).setData({type:"error"})),t.isFieldVisible("bcc")&&t.isNdaNoticeVisible("bcc")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"nda"},this.params)).setData({type:"nda"})),t.isReplyAllNoticeVisible("bcc")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"replyall"},this.params)).setData({type:"replyall"})),"layout-compose-field-notices-bcc"},onFieldChanged:function(){this.getModel("compose-message").setIfChanged(".errors.bcc","")}}})},3174:function(e,t){ns.View.define("compose-field-phone-notices-wrapper",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.visibleNotices.phone":"composeUpdate"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.phone":"onFieldChanged","ns-model-changed.errors.phone":"composeUpdate"},"compose-field-notices":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"phone"})},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-message"),t=this.getModel("compose-state"),o=this.getModel("compose-field-notices");return o.clear(),e.getFieldError("phone")?o.insert(ns.Model.get("compose-field-notice",_.extend({type:"error"},this.params)).setData({type:"error"})):t.isFieldVisible("phone")&&t.isFieldEnabled("phone")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"help"},this.params)).setData({type:"help"})),"layout-compose-field-notices-phone"},onFieldChanged:function(){this.getModel("compose-message").setIfChanged(".errors.phone","")}}})},3175:function(e,t){ns.View.define("compose-field-att_ids-notices-wrapper",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-message":{"ns-model-changed":!1,"ns-model-changed.att_ids":"onFieldChanged","ns-model-changed.errors.att_ids":"onErrorChanged"},"compose-field-notices":!1,"compose-state":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"att_ids"})},ctor:function(){this._autoHide=!1,this.autoHideDebounce=_.debounce(this.autoHide.bind(this),5e3)},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-message"),t=this.getModel("compose-field-notices");return t.clear(),!this._autoHide&&e.getFieldError("att_ids")&&t.insert(ns.Model.get("compose-field-notice",_.extend({type:"error"},this.params)).setData({type:"error"})),"layout-compose-field-notices-att_ids"},onShow:function(){this.getModel("compose-field-notices").models.length&&this.autoHideDebounce()},onHide:function(){this.autoHideDebounce.cancel()},onFieldChanged:function(){this.getModel("compose-message").setIfChanged(".errors.att_ids","")},onErrorChanged:function(){this._autoHide=!1,this.composeUpdate()},autoHide:function(){this._autoHide=!0,this.getModel("compose-field-notices").clear(),this.composeUpdate()}}})},3176:function(e,t){ns.View.define("compose-fields-wrapper",{models:{"compose-state":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){return"layout-compose-fields"}}})},3177:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(588);!function(){var e={show:Daria.hasExperiment("77088")};ns.View.define("compose-popular-contacts",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-htmldestroy":"onHtmlDestroy","ns-view-init":"onInit","click .js-contact":"onContactClick","click .js-close":"onCloseClick",mouseenter:"onMouseEnter",mouseleave:"onMouseLeave"},models:{"index-data":"keepValid","compose-state":!1,"compose-message":{"ns-model-changed":!1,"ns-model-changed.to":"onRecipientFieldChanged","ns-model-changed.cc":"onRecipientFieldChanged","ns-model-changed.bcc":"onRecipientFieldChanged"},"compose-popular-contacts":!1},params:function(e){return _.extend({},ns.View.info("compose2").params(e),{count:10})},ctor:function(){this.onMouseEnter=this.onHover.bind(this,!0),this.onMouseLeave=this.onHover.bind(this,!1),this._$closeButton=null},yateModule:"compose2",methods:{onHtmlInit:function(){this._$closeButton=this.$node.find(".js-close")},onHtmlDestroy:function(){this._$closeButton=null},onInit:function(){e.show&&(ns.Model.get("settings").getSetting("popular-contacts_s")?e.show=!1:(this.on("ns-view-show",this.showPromo.bind(this)),this.on("ns-view-hide",this.hidePromo.bind(this))))},onContactClick:function(e){var t=$(e.currentTarget),o=["email","name"],n=_.zipObject(o,_.map(o,function(e){return t.data(e)}));this.log({email:n.email,position:t.data("position")});var s=_.clone(this.getModel("compose-popular-contacts").getContact(n)),i=this.getModel("index-data").get(".email");s&&s.email===i&&s.name===i18n("%Compose_Send_it_to_me")&&delete s.name,this.getModel("compose-message").appendContact("to",s),this.updateContacts()},onCloseClick:function(){var e=ns.Model.get("settings"),t=e.getSign(e.POPULAR_CONTACTS_SETTING_NAME);if(void 0===e.getSetting(e.POPULAR_CONTACTS_SETTING_NAME)){var o={};o[e.POPULAR_CONTACTS_SETTING_NAME]=t,e.setSettings(o)}e.setSettingOff(e.POPULAR_CONTACTS_SETTING_NAME),this.getModel("compose-state").trigger("ns-model:contacts:redraw"),Jane.c("Написание письма","Шапка письма",'Клик в крестик "Скрыть favorites"')},onHover:function(e){this._$closeButton.toggleClass("is-hidden",!e)},onRecipientFieldChanged:function(){this.updateContacts(),this.composeUpdate()},updateContacts:function(){var e=this.getModel("compose-message").getAllRecepients();this.getModel("compose-popular-contacts").actualizeUsedContacts(e)},log:function(e){var t=e.email,o=e.position,s={project:"search_mail",action:"suggest-compose",product:n.b,uid:Daria.uid,filed:"to",field:"to",suggest_used:"yes",suggest_show:"yes",pos:o,count:Math.min(this.getModel("compose-popular-contacts").getUnusedContacts().length,6),search_text:encodeURIComponent(t)};1===o&&this.getModel("index-data").get(".email")===t?(s.self="yes",Jane.c("Написание письма","Шапка письма",'Клик в саджест контакта "себе"')):Jane.c("Написание письма","Шапка письма","Клик в саджест другого контакта"),Daria.searchClickCounter(_.pairs(s).map(function(e){return e.join("=")}))},showPromo:function(){var t=e;if(t.show){var o=this.$node.find(".js-contact").get(0);o?(t.setAnchor||Object.assign(t,Daria.React.promoPopularContacts.create(function(){ns.Model.get("settings").setSettings(function(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}({},"popular-contacts_s",Date.now())),t.show=!1})),t.timer&&(clearTimeout(t.timer),t.timer=null),t.setAnchor(o)):t.show=!1}},hidePromo:function(){var t=e;t.timer||(t.timer=setTimeout(function(){return t.close()},150))}}})}()},3178:function(e,t){ns.View.define("compose-popular-contacts-wrapper",{models:{"compose-state":{"ns-model-changed":!1,"ns-model:contacts:redraw":"composeUpdate"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){var e=ns.Model.get("settings");return e.getSign(e.POPULAR_CONTACTS_SETTING_NAME)?"layout-compose-popular-contacts":"layout-compose-popular-contacts-empty"}}})},3179:function(e,t){ns.View.define("compose-popup-button",{yateModule:"compose2",methods:{ASSERT_CLASS_NAME:"Daria.vComposePopupButton",onHtmlInit:function(){this.initNbs()},onHtmlDestroy:function(){this.destroyNbs()},initNbs:function(){this.nbs={},this.nanoislands&&(_.each(this.nanoislands.blocks,function(e,t){this.nbs[t]=nb.$block(e,this.$node)},this),this._nbsInited=!0,this.bindNbs())},destroyNbs:function(){this.unbindNbs(),this._nbsInited=!1,nb.destroy(this.node)},bindNbs:function(){this.handleBinding("on")},unbindNbs:function(){this.handleBinding("off")},handleBinding:function(e){this._nbsInited&&this.nanoislands&&_.each(this.nanoislands.events,function(t,o){var n,s=(o=o.split(" "))[0],i=o[1],a=o[2];if(this.nbs[i])switch(n=3===o.length?this.nbs[i].$node.find(a):this.nbs[i],e){case"on":n.on(s,this[t].bind(this));break;default:n.off(s)}else ns.assert(!1,this.ASSERT_CLASS_NAME,"Don't exist nanoblock with name of "+i)},this)},showBubble:function(){this.containerSelector||ns.assert(!1,this.ASSERT_CLASS_NAME,"Don't exist selector of container for popup");var e=this.nbs.popup;return e.isOpen()?vow.reject():(e.open({where:this.$node.find(this.containerSelector),how:{at:"top",my:"bottom"}}),vow.resolve(e))},setCheckboxState:function(e,t){var o=this.nbs[e];o?o.isChecked()!==t&&(t?o.check():o.uncheck()):ns.assert(!1,this.ASSERT_CLASS_NAME,"Can't find nbCheckbox with name of "+e)}}})},3180:function(e,t){ns.View.define("compose-action-buttons",{models:{"compose-state":!1,"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){var e,t,o=this.getModel("compose-message"),n=this.getModel("compose-state");return o.isTemplate()?o.isNewTemplate()?(e="compose-save-link",t="layout-compose-action-buttons-new-template"):(e="compose-send-link",t="layout-compose-action-buttons-template"):(e="compose-send-link",t="layout-compose-action-buttons"),n.set(".activeActionButtonView",e),t}}})},3181:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(137);o.n(n);ns.View.define("compose-save-link",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide","click .js-save-button":"onSave"},params:ns.View.info("compose2").params,models:{"compose-message":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.activeActionButtonView":"composeUpdate"},"compose-fsm":!1},yateModule:"compose2",methods:{onInit:function(){this.disableOnSendingInit()},onShow:function(){this.disableOnSendingStart()},onHide:function(){this.disableOnSendingStop()},setState:function(e){return this.getModel("compose-fsm").setState(e)},onSave:function(){this.getModel("compose-state").set(".saveTemplateAndLeave",!0),this.getModel("compose-message").once("ns-model:draft-saved",function(){var e=ns.Model.get("folders").getFidBySymbol(n.WellKnownFolderSymbol.TEMPLATE),t=ns.router.generateUrl("messages",{current_folder:e});ns.page.go(t)}),this.setState("save")}}},"compose-disable-on-sending-mixin")},3182:function(e,t){!function(){var e={size:"m",text:i18n("%Отправить"),highlight:!0,class:["js-send-button"],type:"submit",attrs:{tabindex:"10",title:i18n("%Compose_send_letter")+Daria.Shortcuts.getShortcutLabelFor("Send","compose2",!0)}};ns.View.define("compose-send-link",{events:{"ns-view-init":"onInit","ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","ns-view-destroy":"onHtmlDestroy","click .js-send-button":"onSendingToSent"},params:ns.View.info("compose2").params,models:{"compose-message":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.submitButtonText":"onChangeSubmitButtonText","ns-model-changed.activeActionButtonView":"composeUpdate"},"compose-fsm":!1},ctor:function(){this._nbButton=null},yateModule:"compose2",methods:{onInit:function(){this.disableOnSendingInit()},onHtmlInit:function(){nb.init(this.node),this._nbButton=nb.$block(".js-send-button",this.node)},onHtmlDestroy:function(){nb.destroy(this.node),this._nbButton=null},onShow:function(){this.disableOnSendingStart()},onHide:function(){this.disableOnSendingStop()},setState:function(e){return this.getModel("compose-fsm").setState(e)},onSendingToSent:function(){this.onSendingToSentWithMetricSource()},onSendingToSentWithMetricSource:function(e){this.composeMetrics(e),this.setState("sending")},getButtonSpec:function(){var t=this.getModel("compose-state"),o=t.get(".submitButtonText"),n=t.get(".activeActionButtonView");return e.highlight="compose-send-link"===n,o&&(e.text=o),e},onChangeSubmitButtonText:function(){var e=this.getModel("compose-state").get(".submitButtonText");this._nbButton.setContent(e)},composeMetrics:function(e){Jane.c("Написание письма",e||"Шапка письма",'Клик в "Отправить"'),Jane.c("Отправка письма","compose")}}},"compose-disable-on-sending-mixin")}()},3183:function(e,t){ns.View.define("compose-cancel-button",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide","click@show":"onClick"},models:{"compose-fsm":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onInit:function(){this.disableOnSendingInit()},onShow:function(){this.disableOnSendingStart()},onHide:function(){this.disableOnSendingStop()},onClick:function(){this.getModel("compose-fsm").setState("cancel"),Jane.c("Написание письма","Шапка письма","Клик в крестик")}}},"compose-disable-on-sending-mixin")},3184:function(e,t){ns.View.define("compose-delete-button",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide",click:"onClick"},models:{"compose-message":!1,"compose-fsm":{"ns-model-changed":!1,"# save":"onSaving","# edit":"onSaveComplete"}},params:ns.View.info("compose2").params,ctor:function(){this._isSaving=!1,this._isRemovePending=!1},yateModule:"compose2",methods:{_getMessage:function(e){return ns.Model.get("message",{ids:e})},onInit:function(){this.disableOnSendingInit()},onShow:function(){(this.disableOnSendingStart(),this.params.ids)&&(this._getMessage(this.params.ids).isDraftLike()||this.$node.addClass("is-hidden"))},onHide:function(){this.disableOnSendingStop()},_closeCompose:function(){this.getModel("compose-fsm").setState("cancel")},_removeDraft:function(){var e=this.getModel("compose-message").getDraftMid();e&&Daria.MOPS["remove.draft"](this._getMessage(e).getMessagesCheckedModel()),this._closeCompose()},onClick:function(){if(this._isSaving)this._isRemovePending=!0;else{if(this.getModel("compose-message").isDirty())return this._isRemovePending=!0,void this.getModel("compose-fsm").setState("save");this._removeDraft()}},onSaveComplete:function(){this._isSaving=!1,this._isRemovePending&&(this._isRemovePending=!1,this._removeDraft())},onSaving:function(){this._isSaving=!0}}},"compose-disable-on-sending-mixin")},3185:function(e,t){ns.View.define("compose-label-button",{events:{click:"onClick"},yateModule:"compose2",methods:{onClick:function(e,t){t=t||ns.action.getParams(e.currentTarget),Jane.ToolbarMetric.setToolbarMetrics(e,t,"label",this.getCurrentMessageIfSingle()),this.vLabelsActions&&this.vLabelsActions._isOpen||(this.vLabelsActions=ns.View.create.apply(null,["labels-actions-compose",ns.page.current.params]),this.vLabelsActions.open(e.currentTarget,ns.Model.get("messages-checked"),t))},getCurrentMessageIfSingle:function(){var e=ns.Model.get("messages-checked");if(!e)return null;var t=e.getIds();return t&&0===t.tids.length&&1===t.ids.length?ns.Model.get("messages",ns.page.current.params).getMessageByMid(t.ids[0]):null}}})},3186:function(e,t){!function(){var e=ns.View.infoLite("compose-send-link");ns.View.edefine("compose-send-button-complex",{models:{"compose-message":{"ns-model-changed":!1,"ns-model-changed.send_time":"onChangedSendTime"},"compose-state":{"ns-model-changed":!1,"ns-model-changed.submitButtonText":"onChangeSubmitButtonText"},"compose-fsm":{"ns-model-changed":!1,"# sent":"onSendingMessage"}},events:{"ns-view-show":"onShow","ns-view-hide":"onHide","click@show .js-send":"onSendingToSentWithMetricSource"},params:ns.View.info("compose2").params,yateModule:"compose2",ctor:function(){this.onSendingToSentWithMetricSource=this.onSendingToSentWithMetricSource.bind(this,"Подвал письма"),_.bindAll(this,["onClickSendtime","onClosedSendtimePopup"])},methods:{onShow:function(){e.methods.onShow.apply(this,arguments),this.nbSendtime=nb.$block(".js-sendtime",this.node),this.nbSendtime.on("click",this.onClickSendtime),this.nbSend=nb.$block(".js-send",this.node)},onHide:function(){e.methods.onHide.apply(this,arguments),nb.destroy(this.node)},onClickSendtime:function(e){e.preventDefault(),this._sendtimePopup?this._sendtimePopup.close():(this._sendtimePopup=ns.View.create("compose-send-button-complex-popup",_.clone(this.params)),this._sendtimePopup.on("closed",this.onClosedSendtimePopup),this._sendtimePopup.open({where:e.currentTarget})),Jane.c("Написание письма","Подвал письма",'Клик в "Отправить сегодня в ..."')},onClosedSendtimePopup:function(){delete this._sendtimePopup},onChangedSendTime:function(){this.getModel("compose-message").get(".send_time")?this.nbSendtime.check():this.nbSendtime.uncheck()},onSendingMessage:function(){this.getModel("compose-message").get(".send_time")&&Jane.c("Написание письма","Подвал письма",'Клик в "Отправить сегодня в ..."',"Отправка письма с настройкой")},onChangeSubmitButtonText:function(){var e=this.getModel("compose-state").get(".submitButtonText");this.nbSend.setContent(e)}}},"compose-send-link")}()},3187:function(e,t){ns.View.define("compose-send-button-complex-popup",{events:{"ns-view-show":"_onShow","click@show .send_time-date":"_onClickSendDateTime","click@show .js-help":"_onClickShowHelp","click@show .js-close":"_onClickClose","daria:vScrollerMessages:scroll@show":"_onScroll","daria:vScrollerMessage:scroll@show":"_onScroll","daria:layout-changed@show":"_onScroll"},models:{"compose-state":!1,"compose-message":!1},params:ns.View.info("compose2").params,ctor:function(){this._defaultOptions={withoutTail:!0,autofocus:!0,autoclose:!0,how:{my:"center bottom",at:"center top"}},this._options={},this._popup=null,this._date=null},yateModule:"compose2",methods:{open:function(e){return this._date=this.getModel("compose-message").getPassportSendDate(),this._options=_.extend({},this._defaultOptions,e),this._dateValidation(),this.update(this.params,{execFlag:ns.U.EXEC.PARALLEL}).then(this._onAfterRender,this)},close:function(){_.method("close")(this._popup)},_onClickClose:function(){this.close(),Jane.c("Написание письма","Подвал письма",'Клик в "Отправить сегодня в ..."',"Клик в крестик")},_onScroll:function(){var e=_.get(this._popup,"node.widget");_.method("_position")(e)},_onAfterRender:function(){this._popup=nb.block(ns.renderNode({},"js-compose-send-button-complex-popup","compose2"));var e=this,t=this._popup._move;this._popup._move=function(){var o=Array.prototype.slice.call(arguments);t.apply(this,o),e._popupMove()},this._popup.setContent(this.node),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open(this._options)},_popupMove:function(){var e=this,t=this._popup.$node.data("nbContextDialog").close;this._popup.$node.data("nbContextDialog").close=function(o){e._nbContextDialogClose.call(this,e,t,o)}},_nbContextDialogClose:function(e,t,o){var n=e._nbTime&&e._nbTime.$dropdown&&e._nbTime.$dropdown[0],s=o&&o.target;s&&n&&n.contains(s)?this.options.closedByOuterClick=!1:t.call(this,o)},_onOpened:function(){this.trigger("opened")},_onClosed:function(e,t){t.destroy(),this.trigger("closed")},_onDestroyed:function(){delete this._popup,this._options={},this.destroy()},_onShow:function(){this._nbTime=nb.$block(".js-time",this.node),this._nbTime.on("nb-changed",this._onChangedTime.bind(this)),this._nbActivate=nb.$block(".js-activate",this.node),this._nbActivate.on("nb-checked",this._onCheckedActivate.bind(this)),this._nbActivate.on("nb-unchecked",this._onUncheckedActivate.bind(this));var e=Daria.passportNow(),t=new Date(e),o=new Date(e);o.setFullYear(o.getFullYear()+1),this.$node.find(".send_time-date").date_input({action:"click",zIndex:105,container:this.$node,usePosition:!0,autoOrientation:!0,minDate:t,maxDate:o,dateToString:this._dateToString,stringToDate:this._stringToDate,keydownHandler:!1,setInputVal:this._onSetInputVal.bind(this),getInputVal:this._onGetInputVal.bind(this)}),this._updateDisplay()},_onGetInputVal:function(){return this._dateToString(this._date)},_onSetInputVal:function(e){var t=this._stringToDate(e);if(t){var o=t.getFullYear(),n=t.getMonth(),s=t.getDate();this._date.getFullYear()===o&&this._date.getMonth()===n&&this._date.getDate()===s||(this._date.setFullYear(t.getFullYear(),t.getMonth(),t.getDate()),this._updateDisplay())}},_onClickSendDateTime:function(e){e.stopPropagation(),e.preventDefault(),this._nbActivate.isChecked()||this._nbActivate.check()},_onCheckedActivate:function(){Jane.c("Написание письма","Подвал письма",'Клик в "Отправить сегодня в ..."',"Простановка чекбокса"),this._nbTime.enable(),this._updateData()},_onUncheckedActivate:function(){this._nbTime.disable(),this._updateData()},_onChangedTime:function(){var e=this._nbTime.getState(),t=e.value&&e.value.match(/^(\d{2}):(\d{2})$/);if(t){var o=parseInt(t[1],10);o!==this._date.getHours()&&(this._date.setHours(o,0,0,0),this._updateDisplay()),this.close()}},_updateDisplay:function(){if(this._dateValidation())this._updateDisplay();else{this.$node.find(".send_time-date").text(Jane.Date.toHumanFormat(this._date));var e=new Date(Daria.passportNow());e.setHours(e.getHours(),0,0,0);var t=new Date(this._date),o=_.times(24).filter(function(o){return t.setHours(o,0,0,0),t>e}).map(this._dateItemGenerate);this._nbTime.setSource(o),this._nbTime.setState(this._dateItemGenerate(this._date.getHours())),this._updateData()}},_dateItemGenerate:function(e){var t=Jane.Common.n(e)+":00";return{text:t,value:t}},_dateToString:function(e){return Jane.Date.format("%F",e)},_stringToDate:function(e){var t=String(e||"").match(/^(\d{2,4})\-(\d{2})\-(\d{2})$/);return t?new Date(parseInt(t[1],10),parseInt(t[2],10)-1,parseInt(t[3],10)):null},_dateValidation:function(){var e=new Date(Daria.passportNow());return e.setHours(e.getHours()+1,0,0,0),(!this._date||this._date<e)&&(this._date=e,!0)},_onClickShowHelp:function(){this.$node.find(".js-compose-sendtime-help-text").toggleClass("is-hidden")},_updateData:function(){var e=this.getModel("compose-message"),t=null;this._nbActivate.isChecked()&&this._date&&(t=Daria.convertPassportDateToTimestamp(this._date)),e.setIfChanged(".send_time",t)}}})},3188:function(e,t){ns.View.edefine("compose-button-translate-apply",{models:{"compose-message":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.translationEnabled":"composeUpdate"},"compose-fsm":!1},events:{"click@show .js-click":"onClick"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(){this.getModel("compose-state").trigger("daria:mComposeState:translate-edit"),Jane.c("Написание письма","Подвал письма","Переводчик","Редактировать")}}},"compose-send-link")},3189:function(e,t){ns.View.edefine("compose-button-translate-close",{models:{"compose-message":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.translationEnabled":"composeUpdate"},"compose-fsm":!1},events:{"click@show .js-click":"onClick"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(){this.getModel("compose-state").trigger("daria:mComposeState:translate-cancel"),Jane.c("Написание письма","Подвал письма","Переводчик","Отмена")}}},"compose-send-link")},3190:function(e,t){ns.View.define("compose-message-toolbar-button-common",{events:{"ns-view-show":"_onNsViewShow"},yateModule:"compose2",methods:{_onNsViewShow:function(){this.rect=this.node.getBoundingClientRect()},checkShortlink:function(){return this.$node.hasClass("is-shortlink")},isShortlink:function(){return this._isShortlink},setShortlink:function(){this._isShortlink=!0,this.$node.addClass("is-shortlink")},removeShortlink:function(){this._isShortlink=!1,this.$node.removeClass("is-shortlink")}}})},3191:function(e,t){ns.View.edefine("compose-message-toolbar-spellcheck",{models:{"compose-state":!1},yateModule:"compose2"},"compose-message-toolbar-button-common")},3192:function(e,t){ns.View.defineNg("compose-attach-area",{events:{"ns-view-show":"onShow","click@show .js-eml-preview":"previewEml","daria:vComposeAttachArea:retryAttach@show":"onRetryAttach"},models:{"compose-state":!1,"compose-message":{"ns-model-changed":!1,"ns-model:draft-saved":"onDraftSaved"},"compose-attachments":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onShow:function(){var e=this.getModel("compose-attachments"),t=this.getModel("compose-message"),o=this.getModel("compose-state");e.init({node:this.node,ids:this.params.ids,operation:this.params.oper,mComposeMessage:t,mComposeState:o}),(this.params.ids||e.hasFiles())&&(e.drawAttaches(),t.markSaved())},onDraftSaved:function(e,t){this.isVisible()?(this.getModel("compose-attachments").updateAfterSave(t.attachments,t.mid),this.getModel("compose-message").markSaved()):this.invalidate()},onRetryAttach:function(e,t){this.getModel("compose-attachments").retryAttach(t.id)}}},"count-attachments-ops-mixin","preview-eml-mixin")},3193:function(e,t){ns.View.define("compose-footer",{models:{"compose-message":!1,"compose-attachments":{"ns-model-changed":!1,"ns-model:attachments.appended":"onAttachmentsAppended"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onAttachmentsAppended:function(){this.isVisible()&&Jane.DOM.placeInViewport(this.node)}}})},3194:function(e,t){!function(){var e=ns.View.infoLite("compose-field-base");ns.View.edefine("compose-from",{events:{"ns-view-htmlinit":"onHtmlInit","keydown@show .js-compose-field":"onInputKeydown"},models:{"account-information":!1,"index-data":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.focusField":"onFocusFieldChanged"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.from_mailbox":"forceUpdate"}},params:ns.View.info("compose2").params,ctor:function(){e.ctor.apply(this,arguments)},yateModule:"compose2",methods:{FIELD_NAME:"from_name",onHtmlInit:function(){this._nbEmailSelect=nb.$block(".js-compose-changemail",this.$node),this._nbEmailSelect.on("nb-changed",this.onEmailChange.bind(this)),this._$input=this.$node.find(".js-compose-field"),this.shouldResizeByFakeField()&&(this.resizeField=this.resizeFieldIE,this._$inputFakeDiv=this.$node.find(".js-compose-field-fake")),this.resizeField()},resizeField:function(){this.isVisible()&&(this._$input.width(0),this._$input.width(this._$input[0].scrollWidth))},setValueToFakeDivInput:function(){this._$inputFakeDiv.text(this._$input.val())},resizeFieldIE:function(){this.isVisible()&&(this._$input.width(0),this.setValueToFakeDivInput(),this._$input.width(this._$inputFakeDiv.width()+2))},onInputKeydown:function(e){e.keyCode!==Jane.Common.keyCode.ENTER&&e.keyCode!==Jane.Common.keyCode.ESC||(e.preventDefault(),this._$input.blur())},onInput:function(){this.resizeField(),e.methods.onInput.apply(this,arguments)},onEmailChange:function(e,t){this.getModel("compose-message").set(".from_mailbox",t.value)},shouldResizeByFakeField:function(){return Boolean(Modernizr.ie11||Modernizr.edge)}}},"compose-field-base")}()},3195:function(e,t){ns.View.define("compose-signature-list-popup",{events:{"click@show .js-signature-add-button":"_onClickAddSignature","click@show .js-signature-list-item":"_onClickSelectFromList"},models:{"compose-signature":!1},params:ns.View.info("compose2").params,yateModule:"compose2",ctor:function(){this._defaultOptions={withoutTail:!0,autofocus:!1,autoclose:!0,how:{at:"center+60px bottom"}},this._options={},this._popup=null},methods:{open:function(e){return this._options=_.extend(this._defaultOptions,e||{}),this.update(this.params,{execFlag:ns.U.EXEC.PARALLEL}).then(this._onAfterRender,this)},_onAfterRender:function(){this._popup=nb.block(ns.renderNode({},"js-compose-signature-list-popup","compose2")),this._popup.setContent(this.node),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open(this._options)},_onOpened:function(){Jane.c("Подписи","Окно выбора","Показ")},_onClosed:function(){this._popup&&(this._popup.destroy(),this._popup=null)},_onDestroyed:function(){this._options={},this.destroy(),this._signatureIsSelected||Jane.c("Подписи","Окно выбора","Закрыто без выбора")},_getSignatureList:function(){return this.getModel("compose-signature").getSignatureList()},_onClickSelectFromList:function(e){this._signatureIsSelected=!0;var t=$(e.currentTarget),o=parseInt(t.attr("data-signature-index"),10);0===o&&Jane.c("Подписи","Окно выбора","Выбор первой"),Jane.c("Подписи","Окно выбора","Выбор подписи");var n=this.getModel("compose-signature").getSignatureList().signs[o].convert;this.trigger("select",n),this._popup.close()},_onClickAddSignature:function(){this._signatureIsSelected=!0,ns.View.create("compose-signature-add-popup",this.params).open(),this._popup.close()}}})},3196:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(136),s=o.n(n),i=o(358),a=(o.n(i),o(359)),r=(o.n(a),o(353)),c=o(1134);o.n(c);function u(e,t,o,n,s,i,a){try{var r=e[i](a),c=r.value}catch(e){return void o(e)}r.done?t(c):Promise.resolve(c).then(n,s)}ns.View.define("compose-signature-add-popup",{models:{"compose-signature":!1,signs:!1},params:ns.View.info("compose2").params,yateModule:"compose2",ctor:function(){this._defaultOptions={withoutTail:!0,autofocus:!1,autoclose:!0},this._options={},this._popup=null},methods:{open:function(e){return this._options=s.a.extend(this._defaultOptions,e||{}),this.update(this.params,{execFlag:ns.U.EXEC.PARALLEL}).then(this._onAfterRender,this)},_onAfterRender:function(){this._popup=nb.block(ns.renderNode({},"js-compose-signature-add-popup","compose2")),this._popup.setContent(this.node),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open(this._options)},_onOpened:function(){Jane.c("Подписи","Окно выбора","Окно добавления","Показ"),this._popup.$node.on("click",".js-save",this._onSave.bind(this)),this._popup.$node.on("click",".js-cancel",this._onClosed.bind(this))},_onClosed:function(){this._popup&&(this._popup.destroy(),this._popup=null)},_onDestroyed:function(){this._options={},this.destroy(),this._clickSave||Jane.c("Подписи","Окно выбора","Окно добавления","Закрыть без добавления")},_onSave:function(){var e=function(e){return function(){var t=this,o=arguments;return new Promise(function(n,s){var i=e.apply(t,o);function a(e){u(i,n,s,a,r,"next",e)}function r(e){u(i,n,s,a,r,"throw",e)}a(void 0)})}}(regeneratorRuntime.mark(function e(){var t,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._clickSave=!0,Jane.c("Подписи","Окно выбора","Окно добавления","Добавление"),t=$.trim(this._popup.$node.find(".js-signature-new").val())){e.next=5;break}return e.abrupt("return");case 5:if(o=Daria.signs.getHtml(),!s.a.any(o,function(e){return Daria.signs.compare(e.convert,t)})){e.next=10;break}return this._popup.close(),e.abrupt("return");case 10:return e.prev=10,e.next=13,Daria.signs.addSignature({text:s.a.escape(t)});case 13:e.next=19;break;case 15:return e.prev=15,e.t0=e.catch(10),this._handleAppendError(e.t0),e.abrupt("return");case 19:this._popup.close(),Object(i.showSuccessMessage)(a.StatuslineName.SignatureAppended,i18n("%Signature_append_success"));case 21:case"end":return e.stop()}},e,this,[[10,15]])}));return function(){return e.apply(this,arguments)}}(),_handleAppendError:function(e){var t=this.getModel("signs").SignsError;if(e&&e.constructor===t)switch(e.code){case t.codes.MAX_COUNT:return this._popup.close(),void Object(i.showErrorMessage)(a.StatuslineName.SignatureMaxCountLimitExceeded,Object(r.default)("statusline/max_signature_count_limit_exceeded"));case t.codes.MAX_LENGTH:return void Object(i.showErrorMessage)(a.StatuslineName.SignatureMaxLengthLimitExceeded,Object(r.default)("statusline/signatureMaxLengthLimitExceeded",{count:c.SIGNATURE_MAX_LENGTH}))}Daria.debug.error("Error occurred while appending sign:",e),Object(i.showErrorMessage)(a.StatuslineName.SignatureAppendError,i18n("%Signature_append_error"))}}})},3197:function(e,t){ns.View.define("compose-message-editor-bottom-buttons",{params:ns.View.info("compose2").params,yateModule:"compose2"})},3198:function(e,t){ns.View.define("compose-message-editor-top",{params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){return"layout-compose-message-editor-top"}}})},3199:function(e,t){ns.View.define("compose-message-editor-bottom",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.editorMaximize":"editorViewUpdate"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){return this.getModel("compose-state").get(".editorMaximize")===CKEDITOR.TRISTATE_ON?"layout-compose-message-editor-bottom":"layout-compose-message-editor-bottom-buttons-empty"},editorViewUpdate:function(){this.getEditor().execCommand("viewUpdate")}}})},3200:function(e,t){!function(){var e={attachmentcomputer:'Клик на "Прикрепить файл с компьютера"',attachmentdisk:'Клик на "Прикрепить файл из Диска"',attachmentmail:'Клик на "Прикрепить файлы из Почты"',undo:'Клик на "Отменить"',redo:'Клик на "Повторить"',bold:'Клик на "Полужирный"',italic:'Клик на "Курсив"',underline:'Клик на "Подчёркнутый"',strike:'Клик на "Перечёркнутый"',link:'Клик на "Вставить/изменить ссылку"',unlink:'Клик на "Удалить ссылку"',addimage:'Клик на "Добавить изображение"',blockquote:'Клик на "Цитата"',mailtextcolor:'Клик на "Цвет текста"',mailbgcolor:'Клик на "Цвет фона"',mailfont:'Клик на "Шрифт"',mailfontsize:'Клик на "Размер шрифта"',emoticons:'Клик на "Смайлик"',numberedlist:'Клик на "Нумерованный список"',bulletedlist:'Клик на "Маркированный список"',justifyleft:'Клик на "Выравнивание по левому краю"',justifycenter:'Клик на "Выравнивание по центру"',justifyright:'Клик на "Выравнивание по правому краю"',maximize:'Клик на "Развернуть на весь экран"',removeformat:'Клик на "Убрать форматирование"',translate:'Клик на "Переводчик"',switchmode:'Клик на "Без оформления"'};ns.View.define("compose-metrics-mixin",{methods:{saveMetricOfTheToolbarButtonKeypress:function(t){var o=t.currentTarget.className.split(/\s+/),n=_.find(o,function(e){return 0===e.indexOf("cke_button__")});if(n){var s=n.slice("cke_button__".length),i=e[s];i&&Jane.c("Написание письма","Визивиг в композе",i)}}}})}()},3201:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(1083),s=o(1532),i=o(88),a=o.n(i);!function(){var e=ns.View.infoLite("compose-field-base"),t=["onDOMNodeRemoved","onDOMNodeInserted","onFocus","onBlur","syncDataToView","syncViewToData","saveBookmark","onFocusFieldChanged","onChangeHeight","onEditorInit","onEditorShortcutSave","onEditorShortcutSend","onEditorChange","onEditorPaste","onEditorPastefile","onEditorSwitchedMode","onEditorMaximize","_applyTmpContent"];ns.View.edefine("compose-message-editor",{models:{"module-editor":!1,"compose-message":{"ns-model-changed":!1,"ns-model-changed.from_mailbox":"onFromMailboxChanged"},"compose-attachments":!1,"compose-signature":!1,"compose-fsm":{"ns-model-changed":!1,"edit > sending":"syncViewToData","edit > save":"syncViewToData","edit > cancel":"syncViewToData"},"compose-state":{"ns-model-changed":!1,"ns-model-changed.focusField":"onFocusFieldChanged","daria:mComposeState:translate-edit":"onTranslateEdit","daria:mComposeState:translate-cancel":"onTranslateCancel"}},events:{"click@show .cke_button__translate":"onClickShowTranslator","click@show .cke_toolbox .cke_button":"saveMetricOfTheToolbarButtonKeypress","mouseup@show .cke_button__attachmentcomputer":"saveMetricOfTheToolbarButtonKeypress"},params:ns.View.info("compose2").params,ctor:function(){e.ctor.apply(this,arguments),_.bindAll(this,t),this.editorId=_.uniqueId("editor_".concat(Daria.Config.connection_id,"_")),this.onEditorChangeDebounce=_.debounce(this.onEditorChange,s.a.DEBOUNCES.EDITOR_CHANGE),this.onChangeHeightDebounce=_.debounce(this.onChangeHeight,s.a.DEBOUNCES.HEIGHT_CHANGE)},yateModule:"compose2",methods:{TOOLBAR_HEIGHT:47,FIELD_NAME:"send",getConfig:function(){var e,t,o=this,n=this,s={},i=_.get(ns.page.current,"params.translate","").match(/^([a-z]{2,3})\-([a-z]{2,3})$/);return i?(e=i[1],t=i[2]):this.params.ids&&(e=this.getModel("compose-message").getLanguage(),t=Daria.Translate.getDefaultLangTo(e)),CKEDITOR.editorConfig(s),_.extend(s,CKEDITOR.ConfigFactory.getConfig(CKEDITOR.ConfigFactory.COMPOSE,{blur:this.onBlur,focus:this.onFocus,instanceReady:this.onEditorInit,change:this.onEditorChangeDebounce,paste:this.onEditorPaste,maximize:this.onEditorMaximize,"pastefile:dropfile":this.onEditorPastefile,"hotkeys:save":this.onEditorShortcutSave,"hotkeys:send":this.onEditorShortcutSend,"switchmode:switched":this.onEditorSwitchedMode,"switchmode:savebookmark":this.saveBookmark,"translate:enabled":function(){n.onChangeHeight(),n.$node.addClass("mail-Compose-Field-Translate"),n.getModel("compose-state").setIfChanged(".translationEnabled",!0)},"translate:disabled":function(){n.onChangeHeight(),n.$node.removeClass("mail-Compose-Field-Translate"),n.getModel("compose-state").setIfChanged(".translationEnabled",!1)}},{enableHotkeys:ns.Model.get("settings").isSet("enable_hotkeys"),translateInfo:Daria.Config["help-url"]+"/web/letter/translation.html#translation-outgoing",translateAutoEnable:i,translateFrom:e,translateTo:t,pastefileGetPlaceholderContext:function(){var e=n.$node.closest(".js-pastefile-compose")[0];return e||(e=document.body),new CKEDITOR.dom.element(e)},pastefileGetDropContext:function(){var e=n.$node.closest(".js-pastefile-compose")[0];return e||(e=document),e},translate:function(e,t,o,s){s||(s=Daria.Translate.getDefaultLangTo(n.getModel("compose-message").getLanguage()));var i={text:t,format:"wysiwyg"===e.mode?"html":"plain",lang:s};return o&&s&&(i.lang=o+"-"+s),new vow.Promise(function(e,t){ns.request("do-translate",i).then(function(t){var n=_.find(t,"id","do-translate"),i=(n.get(".text")||[]).join(""),a=n.get(".detected.lang");e({data:i,langFrom:o||a,langTo:s})},t)})},translateLangSelect:function(e,t,o,s){return new vow.Promise(function(e,i){var a="_popupTranslateSelectLang_"+s,r=n[a];if(r)return r.close(),void i();var c=_.assign({},n.params,{currentLang:t});(r=ns.View.create("translate-select-lang",c)).on("selected",function(t,o){e({lang:o,direction:s}),this.close()}),r.on("closed",function(){delete n[a],i()}),r.open({where:o.$}),n[a]=r})},mailAutocomplete:{getDraftId:function(){return o.getModel("compose-message").getDraftMid()||""},getMessageId:function(){return o.getModel("compose-message").get(".message_id")},getThreadId:function(){return o.getModel("compose-message").composeParamsService.relatedThreadId},toggleAutocomplete:function(){ns.Model.get("settings").toggleSetting("disable_compose_autocomplete")}}},this)),s},getEditor:function(){var e=CKEDITOR.instances[this.editorId];if(e&&"ready"===e.status)return e},getEditorId:function(){return this.editorId},onInit:function(){this.messageResizeInit(),e.methods.onInit.apply(this,arguments),this.fpsCounter=new n.a("compose",n.a.defaultConfig)},onShow:function(e,t,o){this._timings=o,this._timings.showEditor=Date.now(),this._timings.versionEditor=CKEDITOR.version,this.messageResizeStart();var n=this.getModel("compose-message"),s=this.getConfig();s.height=this.getHeight()-this.TOOLBAR_HEIGHT,s.startupMode=n.isHtmlType()?"wysiwyg":"source",s.viewParams=_.clone(this.params),s.firstSignature=ns.Model.get("settings").isSet("signature_top"),s.firstSignatureMatch=Daria.signs.getSignatureMatch(),s.hasSignature=this.getModel("compose-signature").hasSignatureControl(),s.fileInputMultiple=Daria.Config["input-multiple"],s.canShowDisk=this.getModel("compose-state").hasDisk()&&!Daria.Config["is-corp"],this._timeoutEditorCreate=setTimeout(function(){this.getControllerNode().width()<795&&(s.toolbar="Min"),CKEDITOR.replace(this.getEditorId(),s)}.bind(this),0),this.getControllerNode().on({"x-attached":this.onDOMNodeInserted,"x-detached":this.onDOMNodeRemoved}),n.on("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged),this.getModel("compose-state").setIfChanged(".editorMode",s.startupMode),this.fpsCounter.start()},onHide:function(){clearTimeout(this._timeoutApplyTmpContent),clearTimeout(this._timeoutEditorCreate),this.getControllerNode().off({"x-attached":this.onDOMNodeInserted,"x-detached":this.onDOMNodeRemoved}),this.getModel("compose-message").off("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged),this.onEditorChangeDebounce.cancel(),this.onChangeHeightDebounce.cancel(),this.messageResizeStop(),this.destroyEditor(),this.fpsCounter.finish()},onDOMNodeRemoved:function(){if(!this.__removed){var e=this.getModel("compose-state"),t=this.getEditor(),o=t&&t.editable();this.__removed={focusField:e.getFocusField(),scrollTop:o&&o.$.scrollTop},this.saveBookmark()}},onDOMNodeInserted:function(){if(this.__removed){var e=this.getEditor(),t=e&&e.editable();if(t&&(t.$.scrollTop=this.__removed.scrollTop||0),this.__removed.focusField)this.getModel("compose-state").setFocusField(this.__removed.focusField),t&&t.hasFocus?(this.onFocusFieldChanged(),this.onFocus()):this.onFocusFieldChanged();this.__removed=null}},onBlur:function(){clearTimeout(this._timeoutApplyTmpContent),this.toggleFocus(!1),this.resetBookmark()},onFocus:function(){this.toggleFocus(!0),this.restoreBookmark()},_applyTmpContent:function(e){var t=this.getEditor();t&&("source"===t.mode&&(e=Daria.Html2Text.html2text(e)),t.execCommand("pasteContent",{content:e,breakAfter:!0}),this.syncViewToData())},destroyEditor:function(){var e=this.getEditor();e&&e.destroy(!0)},onChangeHeight:function(){var e=this.getHeight();this.getControllerNode().height(e).css("min-height",e);var t=this.getEditor();t&&t.resize("100%",e)},syncViewToData:function(e){if(this.isVisible()){var t=this.getEditor();if(t&&("edit > sending"===e&&this.getModel("compose-state").get(".translationEnabled")&&(t.execCommand("translate_apply"),Jane.c("Написание письма","Подвал письма","Переводчик","Ответить с переводом")),t.checkDirty())){var o=t.getData();void 0!==o&&(this.setFieldData(o),t.resetDirty())}}},syncDataToView:function(){var e=this.getEditor();if(e&&!e.undoManager.locked){e.fire("saveSnapshot"),e.fire("lockSnapshot");var t=this.getFieldData();e.setData(t,function(){e.updateElement(),e.resetDirty(),e.fire("unlockSnapshot")})}},onInput:function(){},onEditorInit:function(){this.logTimings(this._timings,[a.a.write,a.a.message]),this.syncDataToView(),this.onFocusFieldChanged(),this.onChangeHeightDebounce()},onEditorChange:function(){this.syncViewToData()},onEditorPaste:function(e){if("html"===e.data.type&&e.data.dataValue){var t=Daria.bubblingQuote(e.data.dataValue);!1!==t&&(e.data.dataValue=t)}},onEditorPastefile:function(e){this.getModel("compose-attachments").addAttach({input:null,files:e.data.files})},onEditorShortcutSave:function(){this.getModel("compose-fsm").setState("save")},onEditorShortcutSend:function(){this.getModel("compose-fsm").setState("sending")},onEditorSwitchedMode:function(e){var t=e.editor,o="wysiwyg"===t.mode?"html":"plain",n=t.getData();this.getModel("compose-state").setIfChanged(".editorMode",t.mode),this.getModel("compose-message").setIfChanged(".ttype",o),this.setFieldData(n),t.resetDirty();var s=ns.Model.get("settings");"source"===t.mode?s.setSettingOff("enable_richedit"):s.setSettingOn("enable_richedit")},onEditorMaximize:function(e){var t=this.getModel("compose-state");t.setIfChanged(".editorMaximize",e.data),e.data===CKEDITOR.TRISTATE_OFF&&(this.$node.toggleClass("mail-Compose-Field-Translate",t.get(".translationEnabled")),this.onChangeHeightDebounce()),_.defer(function(){this.getModel("compose-message").expandMessage()}.bind(this))},onFromMailboxChanged:function(){var e=this.getEditor(),t="wysiwyg"===e.mode;if(e){var o,n=this.getModel("compose-signature").getSignatureList();o=n.noSuitableSignature?Daria.signs.setEmptySign(t):_.first(n.signs),e.fire("signature:set",o.convert)}},_customFocus:function(){var e=this.getEditor();e&&e.execCommand("retryFocus",function(){var e=this.getModel("compose-state").getFocusField();return this.FIELD_NAME===e}.bind(this))},_customIsFocused:function(){var e=this.getEditor();return e&&e.editable().hasFocus},saveBookmark:function(){var e=this.getEditor();if(e){var t=this.getModel("compose-state");if("source"===e.mode){var o=Daria.getSelection(e.editable().$).start;t.setIfChanged(".bodyPos",o)}else{var n=e.getSelection(),s=n&&!n.isLocked&&n.getRanges();t.setIfChanged(".editorBookmark",s)}}},restoreBookmark:function(){var e=this.getEditor();if(e){var t=this.getModel("compose-state");if("source"===e.mode){var o=t.get(".bodyPos");Daria.setSelection(e.editable().$,o)}else{var n=t.get(".editorBookmark");if(t.set(".editorBookmark",null),Array.isArray(n)&&n.length){var s=e.getSelection();s&&s.selectRanges(n)}}}},resetBookmark:function(){var e=this.getEditor();if(e){var t=e.getSelection();t&&(t.removeAllRanges(),t.reset())}},onTranslateEdit:function(){if(this.isVisible()){var e=this.getEditor();e&&e.execCommand("translate_apply")}},onTranslateCancel:function(){if(this.isVisible()){var e=this.getEditor();e&&e.execCommand("translate_toggle",!1)}},onClickShowTranslator:function(){var e=this.getEditor();if(e){var t=e.getCommand("show_translator");if(t)switch(t.state){case CKEDITOR.TRISTATE_ON:Jane.c("Message view",Daria.is2pane()?"2pane":"3pane","Translator","Click on Translate");break;case CKEDITOR.TRISTATE_OFF:Jane.c("Message view",Daria.is2pane()?"2pane":"3pane","Translator","Click on Cancel")}}}}},"compose-metrics-mixin","compose-field-message-resize","compose-field-base")}()},3202:function(e,t,o){"use strict";t.a={EDITOR_CHANGE:50,HEIGHT_CHANGE:50}},3203:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(137);o.n(n);ns.View.define("compose-autosave-status",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-htmldestroy":"onHtmlDestroy","click .mail-ui-Link":"togglePopup"},models:{"compose-message":{"ns-model-changed":!1,"ns-model:draft-saved":"onDraftSaved"},"compose-state":!1,"compose-fsm":!1},params:ns.View.info("compose2").params,ctor:function(){this._nbPopup=null},yateModule:"compose2",methods:{onHtmlInit:function(){nb.init(this.node),this._nbPopup=nb.$block(".js-template-popup",this.node),this.bindEvents()},onHtmlDestroy:function(){this.unbindEvents(),nb.destroy(this.node)},bindEvents:function(){var e=_.get(this._nbPopup,"$node");e&&e.on("click",".js-template-link",this.onClickTemplateLink.bind(this))},unbindEvents:function(){var e=_.get(this._nbPopup,"$node");e&&e.off("click")},onClickTemplateLink:function(e){e.preventDefault(),this._nbPopup.close(),this.getModel("compose-message").set(".save_symbol",n.WellKnownFolderSymbol.TEMPLATE),this.getModel("compose-fsm").setState("save"),Jane.c("Написание письма","Подвал письма",'Клик на "Сохранено как черновик"','Клик на "Шаблон"')},togglePopup:function(e){this._nbPopup.isOpen()?this._nbPopup.close():this._nbPopup.open({where:e.target,how:{at:"top",my:"bottom"},autoclose:!0}),Jane.c("Написание письма","Подвал письма",'Клик на "Сохранено как черновик"')},onDraftSaved:function(){this.getModel("compose-state").setLastSaveTime(),this.composeUpdate()}}})},3204:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(1533);ns.View.define("compose-turn-on-beta",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide","mouseenter .js-beta-button":"onMouseEnter","mouseleave .js-beta-button":"onMouseLeave","click .js-beta-button":"onClick","daria:vApp:changeAppWidth":"onResize"},models:{"compose-message":!1,settings:!1,"compose-state":{messageHeight:"onResize"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(e){e.preventDefault(),this._closePromo(),Object(n.a)(this.getModel("compose-message")),Jane.c("Написание письма","Подвал письма",'Клик на "Перейти в Новый Композ"')},isPromoMode:function(){return!this.getModel("settings").getSetting("react_compose_promo_closed")},disablePromoMode:function(){this.getModel("settings").setSettings({react_compose_promo_closed:!0})},onShow:function(){this.scopeNode=document.querySelector(".js-compose-scroller"),this.isPromoMode()&&this._showPromo()},_closePromo:function(){this.disablePromoMode(),this._hidePromo()},onHide:function(){this._hidePromo()},onMouseEnter:function(){this._showPromo()},onMouseLeave:function(){this.isPromoMode()||this._hidePromo()},_showPromo:function(){var e=this;Daria.React.promoComposeSwitcher.showPromo(this.node,this.scopeNode,function(){return e._closePromo()})},_hidePromo:function(){Daria.React.promoComposeSwitcher.hidePromo(this.node)},onResize:function(){this.isPromoMode()&&this._showPromo()}}})},3205:function(e,t){ns.View.edefine("compose-attach-buttons-wrapper",{models:{"compose-state":!1,"compose-fsm":!1},events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onInit:function(){this.disableOnSendingInit()},onShow:function(){this.disableOnSendingStart()},onHide:function(){this.disableOnSendingStop()},patchLayout:function(){return"layout-compose-attach-buttons-wrapper"}}},"compose-disable-on-sending-mixin",ns.View)},3206:function(e,t){ns.View.define("compose-attach-button-mail",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide",click:"sendMetric"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{MODE:"mail",onShow:function(){this.openDiskInit()},onHide:function(){this.openDiskDestroy()},sendMetric:function(){Jane.c("Написание письма","Подвал письма",'Клик на "Прикрепить файлы из Почты"')}}},"compose-attach-open-disk-mixin")},3207:function(e,t){ns.View.define("compose-attach-button-disk",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide",click:"sendMetric"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{MODE:"disk",onShow:function(){this.openDiskInit()},onHide:function(){this.openDiskDestroy()},sendMetric:function(){Jane.c("Написание письма","Подвал письма",'Клик на "Прикрепить файл из Диска"')}}},"compose-attach-open-disk-mixin")},3208:function(e,t){ns.View.define("compose-attach-button-computer",{events:{"ns-view-htmlinit":"_onNsViewHtmlinit","ns-view-htmldestroy":"_onNsViewHtmldestroy","click@show .js-controller":"_onClickController","change@show .js-controller":"_onChangeController"},models:{"compose-attachments":{"ns-model-changed":!1,"ns-model:attachments.added":"_onNsModelAttachmentsAdded"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{_$controllerNode:null,_onNsViewHtmlinit:function(){this._$controllerNode=this._getControllerNode().clone()},_onNsViewHtmldestroy:function(){this._$controllerNode=null},_onClickController:function(){Jane.c("Написание письма","Подвал письма",'Клик на "Прикрепить файл с компьютера"')},_onChangeController:function(e){var t={input:e.target,files:e.target.files};this.getModel("compose-attachments").addAttach(t)},_getControllerNode:function(){return this.$node.find(".js-controller")},_onNsModelAttachmentsAdded:function(){this._$controllerNode.clone().replaceAll(this._getControllerNode())}}})},3209:function(e,t){!function(){var e=i18n("%Compose_Captcha_title");ns.View.define("compose-captcha",{events:{"ns-view-show":"onShow","click .js-captcha-submit":"send","keydown .js-captcha-input":"onInputKeydown","click .js-captcha-another-image":"showAnotherImage"},models:{captcha:!1,"compose-message":!1,"compose-fsm":!1},yateModule:"compose2",params:ns.View.info("compose2").params,methods:{popupData:{title:e,width:550},onShow:function(){this.focusInput()},showAnotherImage:function(){this.getModel("captcha").invalidate(),this.update()},onInputKeydown:function(e){e.keyCode===Jane.Common.keyCode.ENTER&&(e.preventDefault(),this.send())},getInputValue:function(){return $.trim(this.$node.find(".js-captcha-input").val())},focusInput:function(){this.$node.find(".js-captcha-input").focus()},send:function(){var e=this.getModel("compose-message"),t=this.getInputValue();if(!t)return this.focusInput(),!1;e.set(".captcha_entered",t),e.set(".captcha_key",this.getModel("captcha").get(".key")),this.getModel("compose-fsm").setState("sending",{force:!0}),Daria.Dialog.close()}}})}()},3210:function(e,t){ns.View.define("compose-forgotten-attach",{events:{"click .js-close":"onClose","click .js-forgotten-attach-send":"onSend"},models:{"compose-attachments":{"ns-model-changed":!1,"ns-model:attachments.added":"onAttachAdded"},"compose-fsm":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{popupData:{width:440},data:{},onSend:function(){Jane.ErrorLog.send({event:"attachStopWord",word:_.get(this.data,"stopWordGroup",""),decision:!0}),this.getModel("compose-fsm").setState("sending",{force:!0}),this.triggerCloseEvent()},onAttachAdded:function(){Jane.ErrorLog.send({event:"attachStopWord",word:_.get(this.data,"stopWordGroup",""),decision:!1}),this.triggerCloseEvent()},onClose:function(){Jane.ErrorLog.send({event:"attachStopWord",word:_.get(this.data,"stopWordGroup",""),decision:!1}),this.triggerCloseEvent()},triggerCloseEvent:function(){this.trigger("ns-view:close")}}})},3211:function(e,t){ns.View.edefine("compose-forgotten-attach-button",{models:{"compose-attachments":{"ns-model-changed":!1,"ns-model:attachments.added":"_onNsModelAttachmentsAdded"}},params:function(e){return _.extend({},ns.View.info("compose2").params(e),e)},yateModule:"compose2"},"compose-attach-button-computer")},3212:function(e,t){ns.View.define("compose-forwarded-messages",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-htmldestroy":"onHtmlDestroy"},models:{"compose-state":!1,"compose-message":!1,"compose-forwarded-messages":{"ns-model-changed":"composeUpdate"}},params:ns.View.info("compose2").params,ctor:function(){this.onCheckboxChanged=this.onCheckboxChanged.bind(this)},yateModule:"compose2",methods:{onHtmlInit:function(){var e=this;nb.init(this.node),this.$node.find(".js-message-checkbox").each(function(t,o){nb.block(o).on("nb-changed",e.onCheckboxChanged)})},onHtmlDestroy:function(){nb.destroy(this.node)},onCheckboxChanged:function(e,t){var o=t.isChecked()?"checkMessage":"uncheckMessage";this.getModel("compose-forwarded-messages")[o](t.getValue())}}})},3213:function(e,t){ns.View.define("compose-labels-wrapper",{models:{"compose-message":!1},params:ns.View.infoLite("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){return this.getModel("compose-message").hasUserLabels()?"layout-compose-labels":"layout-compose-labels-empty"}}})},3214:function(e,t){ns.View.define("compose-labels",{events:{"click@show .js-compose-label-unlabel":"onClickRemoveLabel"},models:{labels:!1,"compose-message":{"ns-model-changed":!1,"ns-model-changed.lids":"invalidate"}},params:ns.View.infoLite("compose2").params,ctor:function(){this.getDataForLabel=this.getDataForLabel.bind(this)},yateModule:"compose2",methods:{getDataForLabel:function(e){return this.getModel("labels").getLabelById(e)},getDataForLabels:function(){var e=this.getModel("compose-message").getUserLabels();return e?_.map(e,this.getDataForLabel):[]},onClickRemoveLabel:function(e){var t=e.currentTarget.dataset.lid;this.getModel("compose-message").removeLid(t)}}})},3215:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(1532),s=o(71);ns.View.define("compose-notify-noreply-button",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-destroy":"onHtmlDestroy"},models:{"compose-message":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.messageHeight":"showFirstVisitPopup","ns-model-changed.translationEnabled":"composeUpdate"},"compose-fsm":{"ns-model-changed":!1,"# sent":"onSendEmail"},"compose-notify-noreply-options":{"ns-model-changed":!1,"ns-model-changed.currentTimeDelta":"onChangedCurrentTimeDelta","ns-model-changed.alwaysNotify":"onChangedAlwaysNotify","ns-model-changed.enabledNotify":"onChangedEnabledNotify"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{ASSERT_CLASS_NAME:"Daria.vComposeNotifyNoreplyButton",nanoislands:{blocks:{notifyCheckbox:".js-compose-notify-noreply-button",popup:".js-compose-noreply-notify-popup",firstVisitPopup:".js-noreply-first-visit-popup",toggleCheckbox:".js-compose-noreply-toggle-checkbox",alwaysCheckbox:".js-compose-noreply-always-notify-checkbox",daysSelect:".js-compose-noreply-days-select"},events:{"click notifyCheckbox":"onNotifyCheckboxClick","nb-checked notifyCheckbox":"onNotifyCheckboxChecked","nb-unchecked notifyCheckbox":"onNotifyCheckboxUnchecked","nb-checked toggleCheckbox":"onToggleCheckboxChecked","nb-unchecked toggleCheckbox":"onToggleCheckboxUnchecked","nb-checked alwaysCheckbox":"onAlwaysCheckboxChecked","nb-unchecked alwaysCheckbox":"onAlwaysCheckboxUnchecked","nb-changed daysSelect":"onDaysSelectChanged","click popup .js-close-popup":"onClosePopupClick"}},containerSelector:".js-compose-notify-noreply-button",onShow:function(){this.isEnabledNotify()?this.addNotifyToMessage():this.removeNotifyFromMessage()},isMinimize:function(){return this.getModel("compose-state").get(".translationEnabled")},isEnabledNotify:function(){return this.getModel("compose-notify-noreply-options").get(".enabledNotify")},isAlwaysNotify:function(){return Boolean(this.getModel("compose-notify-noreply-options").get(".alwaysNotify"))},_showFirstVisitPopup:function(){if(this.isVisible()){var e=this.getModel("compose-notify-noreply-options");if(!e.wasFirstVisitPopupShown()){var t=this.nbs.firstVisitPopup,o={where:this.containerSelector,how:{at:"top",my:"bottom"}};t.isOpen()?t.onposition(null,o):t.open(o),e.setFirstVisitPopupWasShown()}}},showFirstVisitPopup:_.debounce(function(){this._showFirstVisitPopup()},n.a.DEBOUNCES.HEIGHT_CHANGE),hasCurrentTimeDelta:function(){var e=this.getModel("compose-notify-noreply-options").getCurrentTimeDelta(),t=this.nbs.daysSelect.getState(),o=Number(t.value);return e.value===o},replaceTextInWaitForReply:function(e,t){e.$node.find(".js-nb-icon-wait-for-reply").text(t)},resetTextInWaitForReply:function(){this.replaceTextInWaitForReply(this.nbs.notifyCheckbox,i18n("%Compose_Checkbox_No_Reply_Normal_Text"))},onChangedCurrentTimeDelta:function(){if(this.isVisible()&&!this.hasCurrentTimeDelta()){var e=this.getModel("compose-notify-noreply-options").getCurrentTimeDelta();this.nbs.daysSelect.setState(e)}},onChangedAlwaysNotify:function(){this.isVisible()&&this.setCheckboxState("alwaysCheckbox",this.isAlwaysNotify())},onChangedEnabledNotify:function(){if(this.isVisible()){var e=this.getModel("compose-notify-noreply-options"),t=this.isEnabledNotify();if(this.setCheckboxState("notifyCheckbox",t),this.setCheckboxState("toggleCheckbox",t),t){var o=e.getCurrentTimeDeltaLocalizedText();this.replaceTextInWaitForReply(this.nbs.notifyCheckbox,o),this.addNotifyToMessage()}else this.resetTextInWaitForReply(),this.removeNotifyFromMessage()}},onNotifyCheckboxClick:function(){this.showBubble()},onNotifyCheckboxChecked:function(){this.isEnabledNotify()||this.nbs.notifyCheckbox.uncheck()},onNotifyCheckboxUnchecked:function(){this.isEnabledNotify()&&this.nbs.notifyCheckbox.check()},getNotifyLabelId:function(){var e=Object(s.a)(),t=ns.Model.get("labels",{mailboxUid:e});return jpath(t.getWaitingForReplyLabel(),".lid")[0]},addNotifyToMessage:function(){var e=this.getNotifyLabelId();if(e){var t=this.getModel("compose-message"),o=this.getModel("compose-notify-noreply-options").getCurrentTimeDelta().value;t.addLid(e),t.setIfChanged(".remind_period",o)}},removeNotifyFromMessage:function(){var e=this.getNotifyLabelId();if(e){var t=this.getModel("compose-message");t.removeLid(e),t.setIfChanged(".remind_period",null)}},onToggleCheckboxChecked:function(){this.getModel("compose-notify-noreply-options").set(".enabledNotify",!0),Jane.c("Написание письма","Подвал письма",'Клик в "Напомнить"','Простановка чекбокса "Напомнить через 5 дней"')},onToggleCheckboxUnchecked:function(){this.getModel("compose-notify-noreply-options").set(".enabledNotify",!1)},onAlwaysCheckboxChecked:function(){this.getModel("compose-notify-noreply-options").setAlwaysNotifyOption(!0),Jane.c("Написание письма","Подвал письма",'Клик в "Напомнить"','Простановка чекбокса "Напоминать всегда"')},onAlwaysCheckboxUnchecked:function(){this.getModel("compose-notify-noreply-options").setAlwaysNotifyOption(!1)},onDaysSelectChanged:function(){if(!this.hasCurrentTimeDelta()){var e=this.getModel("compose-notify-noreply-options"),t=this.nbs.daysSelect.getState();e.setCurrentTimeDelta(t),this.nbs.popup.close()}},onClosePopupClick:function(){this.nbs.popup.close(),Jane.c("Написание письма","Подвал письма",'Клик в "Напомнить"',"Клик в крестик")},onSendEmail:function(){this.isVisible()&&(this.isEnabledNotify()&&Jane.c("Написание письма","Подвал письма",'Клик в "Напомнить"','Отправка письма с настройкой "Напомнить через 5 дней"'),this.isAlwaysNotify()&&Jane.c("Написание письма","Подвал письма",'Клик в "Напомнить"','Отправка письма с настройкой "Напоминать всегда"'))}}},"compose-popup-button")},3216:function(e,t){ns.View.define("compose-notify-on-send-button",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-htmldestroy":"onHtmlDestroy"},models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.translationEnabled":"composeUpdate"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.notify_on_send":"onChangedNotifyOnSend"},"compose-fsm":{"ns-model-changed":!1,"# sent":"onSendEmail"}},params:ns.View.info("compose2").params,yateModule:"compose2",ctor:function(){this.closeBubble=this.closeBubble.bind(this)},methods:{ASSERT_CLASS_NAME:"Daria.vComposeNotifyOnSend",nanoislands:{blocks:{checkbox:".js-compose-remind-button",popup:".js-compose-remind-popup"},events:{"nb-checked checkbox":"onChecked","nb-unchecked checkbox":"onUnchecked","click popup .js-close-popup":"onClosePopupClick"}},containerSelector:".js-compose-remind-button",isMinimize:function(){return this.getModel("compose-state").get(".translationEnabled")},onChangedNotifyOnSend:function(){if(this.isVisible())switch(this.getModel("compose-message").get(".notify_on_send")){case"yes":this.showBubble(),this.setCheckboxState("checkbox",!0);break;default:this.setCheckboxState("checkbox",!1),clearTimeout(this._popupTimeout)}},onChecked:function(){this.getModel("compose-message").set(".notify_on_send","yes")},onUnchecked:function(){this.getModel("compose-message").set(".notify_on_send",null)},onClosePopupClick:function(){this.closeBubble(),Jane.c("Написание письма","Подвал письма",'Клик в "Уведомить"',"Клик на крестик")},closeBubble:function(){clearTimeout(this._popupTimeout),this._$window.off("scroll",this.closeBubble),ns.events.off("daria:vScrollerMessage:scroll",this.closeBubble),ns.events.off("daria:vScrollerMessages:scroll",this.closeBubble),ns.events.off("daria:layout-changed",this.closeBubble),this.nbs.popup.close()},showBubble:function(){this.super_.showBubble.call(this).then(this._activateClosingTimeout.bind(this))},_activateClosingTimeout:function(){var e=Daria.timify({seconds:3});this._popupTimeout=setTimeout(this.closeBubble,e),this._$window.one("scroll",this.closeBubble),ns.events.once("daria:vScrollerMessage:scroll",this.closeBubble),ns.events.once("daria:vScrollerMessages:scroll",this.closeBubble),ns.events.once("daria:layout-changed",this.closeBubble)},onSendEmail:function(){this.isVisible()&&this.isNotifyOnSend()&&Jane.c("Написание письма","Подвал письма",'Клик в "Уведомить"',"Отправка письма с настройкой")},isNotifyOnSend:function(){return"yes"===this.getModel("compose-message").get(".notify_on_send")}}},"compose-popup-button")},3217:function(e,t){!function(){var e={byModel:"compose-field-notices",intoViews:function(e){var t=e.get(".type"),o=e.params.field;switch(t){case"error":return"compose-field-"+o+"-error";case"nda":return"compose-field-"+o+"-notice-nda";case"help":return"compose-field-"+o+"-notice-help";case"replyall":return"compose-field-"+o+"-notice-replyall"}return null}};["phone","to","cc","bcc","att_ids"].forEach(function(t){var o="compose-field-notices-"+t;ns.ViewCollection.define(o,{models:{"compose-field-notices":!0},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:t})},split:_.clone(e),yateModule:"compose2"})})}()},3218:function(e,t){ns.ViewCollection.define("compose-field-extras-to",{models:{"compose-field-extras-collection":!0},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"to"})},split:{byModel:"compose-field-extras-collection",intoViews:function(e){switch(e.get(".type")){case"extras-phone":return"compose-field-to-extras-phone";case"extras-cc":return"compose-field-to-extras-cc";case"extras-bcc":return"compose-field-to-extras-bcc";case"extras-qr-close":return"compose-field-to-extras-qr-close"}return null}},yateModule:"compose2"})},3219:function(e,t){ns.View.define("compose-recipients-diff",{events:{"click@show .js-compose-recipients-diff-close":"onSelectorClick"},models:{"compose-message":{"ns-model-changed":!1,"ns-model-changed.recipients-diff":"selfUpdate"},"compose-state":{"ns-model-changed":!1,"ns-model-changed.recipients-diff-pane-close":"selfUpdate"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{selfUpdate:function(){this.invalidate(),this.update()},onSelectorClick:function(){this.getModel("compose-state").set(".recipients-diff-pane-close",!0)},hasRecipients:function(){var e=this.getModel("compose-message").get(".recipients-diff");return e.added.length||e.removed.length},getRecipientsEmails:function(){var e=this.getModel("compose-message").get(".recipients-diff");return e.added=e.added.map(this.recipientsMapIterator),e.removed=e.removed.map(this.recipientsMapIterator),e},recipientsMapIterator:function(e){var t=e.indexOf("@");return-1===t&&(t=e.length-1),e.substring(0,t+1)}}})},3220:function(e,t){ns.View.define("compose-switchmode-popup",{params:{},yateModule:"compose2",ctor:function(){this._popup=null},methods:{open:function(){this._promise=new Vow.Promise,this._promise.then(this.trigger.bind(this,"resolve"),this.trigger.bind(this,"reject")),this._popup=nb.block(ns.renderNode({},"js-compose-switchmode-popup","compose2")),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open({withoutTail:!0,autofocus:!0,autoclose:!1})},_onOpened:function(){this._popup.$node.on("click",".js-resolve",this._onResolve.bind(this)),this._popup.$node.on("click",".js-reject",this._onClosed.bind(this))},_onResolve:function(){this._promise.fulfill(),this._popup.close()},_onClosed:function(){this._popup&&(this._popup.destroy(),this._popup=null)},_onDestroyed:function(){this._promise.reject("error destroying popup"),this.destroy()}}})},3221:function(e,t){ns.View.define("compose-emoticons-select",{models:{"compose-emoticons":!1},events:{"click@show .js-click":"_onClick","daria:vScrollerMessages:scroll@show":"_onScroll","daria:vScrollerMessage:scroll@show":"_onScroll"},params:ns.View.info("compose2").params,ctor:function(){this._defaultOptions={withoutTail:!0,autofocus:!1,autoclose:!0},this._options={},this._popup=null},yateModule:"compose2",methods:{open:function(e){return this._options=_.extend({},this._defaultOptions,e),this.update(this.params).then(this._onAfterRender,this)},close:function(){this._popup&&this._popup.close()},_onAfterRender:function(){this._popup=nb.block(ns.renderNode({},"js-compose-emoticons-select","compose2")),this._popup.setContent(this.node),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open(this._options)},_onOpened:function(e,t){t.$node.on("mousedown",function(e){e.preventDefault()}),this.trigger("opened")},_onClosed:function(){this._popup&&(this._popup.destroy(),this._popup=null),this._options={},this.trigger("closed")},_onDestroyed:function(){this.destroy()},_onClick:function(e){e.preventDefault(),this.trigger("select",$(e.currentTarget).data("suid")),this._popup.close()},_onScroll:function(){var e=this._popup&&this._popup.node&&this._popup.node.widget;e&&e._position()}}})},3222:function(e,t){ns.View.define("compose-maillink-dialog",{events:{"click@show .js-update":"_onClickUpdate","click@show .js-cancel":"_onClickCancel"},params:ns.View.info("compose2").params,ctor:function(){this._onKeyup=this._onKeyup.bind(this),this._popup=null,this._data={}},yateModule:"compose2",methods:{REG_CHECK_EMAIL:/^(http(s?):\/\/|ftp:\/\/|mailto:)/,getData:function(e,t){return this._data[e]||t||""},open:function(e){this._data=_.isObject(e)?_.clone(e):{},this.update(this.params).then(this._onAfterRender,this)},close:function(){this._popup&&this._popup.close()},isEdit:function(){return Boolean(this.getData("href"))},getHrefView:function(){return this.getData("href")},getTextView:function(){var e=this.getData("text");return e===this.getData("href")?"":e},isDisableText:function(){return this.getData("isDisableText")},_onAfterRender:function(){this._popup=nb.block(ns.renderNode({},"js-compose-maillink-dialog","compose2")),this._popup.setContent(this.node),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open({autofocus:!0,autoclose:!1,animation:!1})},_onOpened:function(){this._nbInputText=nb.$block(".js-text",this.node),this._nbInputHref=nb.$block(".js-href",this.node),this.$node.on("keyup",this._onKeyup),this.trigger("opened"),this._nbInputHref.focus(),this.getData("href")||Daria.setSelection(this._nbInputHref.$control[0],this.getHrefView().length),this.isDisableText()&&this._nbInputText.disable()},_onClosed:function(){this.$node.off("keyup",this._onKeyup),nb.destroy(this.node),this._popup&&(this._popup.destroy(),this._popup=null),this.trigger("closed"),this._data=null},_onDestroyed:function(){this.destroy()},_onClickCancel:function(){this._popup.close()},_onKeyup:function(e){13===e.keyCode&&this._onClickUpdate()},_onClickUpdate:function(){var e=this._nbInputHref.getValue().trim();if(e){this.REG_CHECK_EMAIL.test(e)||(e="http://"+e);var t=this._nbInputText.getValue().trim()||e,o=this.getData("href"),n=this.getData("text");this._popup.close(),e===o&&t===n||this.trigger("update",{text:t,href:e})}else this._nbInputHref.showError({autoclose:!0})}}})},3223:function(e,t){ns.View.define("compose-unsaved-popup",{params:{},yateModule:"compose2",ctor:function(){this._popup=null},methods:{open:function(){this._promise=new Vow.Promise,this._promise.then(this.trigger.bind(this,"resolve"),this.trigger.bind(this,"reject")),this._popup=nb.block(ns.renderNode({},"js-compose-unsaved-popup","compose2")),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open({withoutTail:!0,autofocus:!0,autoclose:!1})},isOpen:function(){return!!this._popup&&this._popup.isOpen()},_onOpened:function(){this._popup.$node.on("keydown click",".js-resolve",this._onResolve.bind(this)),this._popup.$node.on("keydown click",".js-reject",this._onClosed.bind(this))},_onResolve:function(e){if(!(e instanceof $.Event&&"keydown"===e.type&&e.which!==Jane.Common.keyCode.ENTER)){var t=$(e.currentTarget).data("action");this._promise.fulfill(t),this._popup.close()}},_onClosed:function(e){e instanceof $.Event&&"keydown"===e.type&&e.which!==Jane.Common.keyCode.ENTER||this._popup&&(this._popup.destroy(),this._popup=null)},_onDestroyed:function(){this._promise.reject("error destroying popup"),this.destroy()}}})},3224:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(88),s=o.n(n);!function(){var e=ns.View.infoLite("compose-field-base"),t=["onDOMNodeRemoved","onDOMNodeInserted","onFocus","onBlur","syncDataToView","syncViewToData","saveBookmark","onFocusFieldChanged","onEditorInit","onEditorShortcutSave","onEditorShortcutSend","onEditorChange","onEditorPaste","onEditorSwitchedMode","_applyTmpContent"];ns.View.edefine("compose-message-editor-tiny",{models:{"module-editor":!1,"compose-message":!1,"compose-attachments":!1,"compose-fsm":{"ns-model-changed":!1,"edit > sending":"syncViewToData","edit > save":"syncViewToData","edit > cancel":"syncViewToData"},"compose-state":{"ns-model-changed":!1,"ns-model-changed.focusField":"onFocusFieldChanged"}},params:ns.View.info("compose2").params,ctor:function(){e.ctor.apply(this,arguments),_.bindAll(this,t),this.editorId=_.uniqueId("editor"),this.onEditorChangeDebounce=_.debounce(this.onEditorChange,50)},yateModule:"compose2",methods:{FIELD_NAME:"send",getConfig:function(){var e=this,t={};return CKEDITOR.editorConfig(t),_.extend(t,CKEDITOR.ConfigFactory.getConfig(CKEDITOR.ConfigFactory.COMPOSE_TINY,{blur:this.onBlur,focus:this.onFocus,instanceReady:this.onEditorInit,change:this.onEditorChangeDebounce,paste:this.onEditorPaste,"hotkeys:save":this.onEditorShortcutSave,"hotkeys:send":this.onEditorShortcutSend,"switchmode:switched":this.onEditorSwitchedMode,"switchmode:savebookmark":this.saveBookmark},{enableHotkeys:ns.Model.get("settings").isSet("enable_hotkeys"),pastefileGetPlaceholderContext:function(){var t=e.$node.closest(".js-pastefile-compose")[0];return t||(t=document.body),new CKEDITOR.dom.element(t)},pastefileGetDropContext:function(){var t=e.$node.closest(".js-pastefile-compose")[0];return t||(t=document),t}},this)),t},getEditor:function(){var e=CKEDITOR.instances[this.editorId];if(e&&"ready"===e.status)return e},getEditorId:function(){return this.editorId},onShow:function(e,t,o){this._timings=o,this._timings.showEditor=Date.now();var n=this.getModel("compose-message"),s=this.getConfig();s.height=60,s.startupMode=n.isHtmlType()?"wysiwyg":"source",s.viewParams=_.clone(this.params),this._timeoutEditorCreate=setTimeout(function(){CKEDITOR.replace(this.getEditorId(),s)}.bind(this),50),this.getControllerNode().on({"x-attached":this.onDOMNodeInserted,"x-detached":this.onDOMNodeRemoved}),n.on("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged),this.getModel("compose-state").setIfChanged(".editorMode",s.startupMode)},onHide:function(){clearTimeout(this._timeoutApplyTmpContent),clearTimeout(this._timeoutEditorCreate),this.getControllerNode().off({"x-attached":this.onDOMNodeInserted,"x-detached":this.onDOMNodeRemoved}),this.getModel("compose-message").off("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged),this.onEditorChangeDebounce.cancel(),this.destroyEditor()},onDOMNodeRemoved:function(){if(!this.__removed){var e=this.getModel("compose-state"),t=this.getEditor(),o=t&&t.editable();this.__removed={focusField:e.getFocusField(),scrollTop:o&&o.$.scrollTop},this.saveBookmark()}},onDOMNodeInserted:function(){if(this.__removed){var e=this.getEditor(),t=e&&e.editable();if(t&&(t.$.scrollTop=this.__removed.scrollTop||0),this.__removed.focusField)this.getModel("compose-state").setFocusField(this.__removed.focusField),t&&t.hasFocus?(this.onFocusFieldChanged(),this.onFocus()):this.onFocusFieldChanged();this.__removed=null}},onBlur:function(){clearTimeout(this._timeoutApplyTmpContent),this.toggleFocus(!1),this.resetBookmark()},onFocus:function(){this.toggleFocus(!0),this.restoreBookmark()},_applyTmpContent:function(e){var t=this.getEditor();t&&("source"===t.mode&&(e=Daria.Html2Text.html2text(e)),t.execCommand("pasteContent",{content:e,breakAfter:!0}),this.syncViewToData())},destroyEditor:function(){var e=this.getEditor();e&&e.destroy(!0)},syncViewToData:function(){if(this.isVisible()){var e=this.getEditor();if(e&&e.checkDirty()){var t=e.getData();void 0!==t&&(this.setFieldData(t),e.resetDirty())}}},syncDataToView:function(){var e=this.getEditor();if(e&&!e.undoManager.locked){e.fire("saveSnapshot"),e.fire("lockSnapshot");var t=this.getFieldData();e.setData(t,{callback:function(){e.updateElement(),e.resetDirty(),e.fire("unlockSnapshot")}})}},onInput:function(){},onEditorInit:function(){this.logTimings(this._timings,[s.a.write,s.a.message,s.a.tiny]),this.syncDataToView(),this.onFocusFieldChanged()},onEditorChange:function(){this.syncViewToData()},onEditorPaste:function(e){if("html"===e.data.type&&e.data.dataValue){var t=Daria.bubblingQuote(e.data.dataValue);!1!==t&&(e.data.dataValue=t)}},onEditorShortcutSave:function(){this.getModel("compose-fsm").setState("save")},onEditorShortcutSend:function(){this.getModel("compose-fsm").setState("sending")},onEditorSwitchedMode:function(e){var t=e.editor,o="wysiwyg"===t.mode?"html":"plain",n=t.getData();this.getModel("compose-state").setIfChanged(".editorMode",t.mode),this.getModel("compose-message").setIfChanged(".ttype",o),this.setFieldData(n),t.resetDirty();var s=ns.Model.get("settings");"source"===t.mode?s.setSettingOff("enable_richedit"):s.setSettingOn("enable_richedit")},_customFocus:function(){var e=this.getEditor();e&&e.execCommand("retryFocus",function(){var e=this.getModel("compose-state").getFocusField();return this.FIELD_NAME===e}.bind(this))},_customIsFocused:function(){var e=this.getEditor();return e&&e.editable().hasFocus},saveBookmark:function(){var e=this.getEditor();if(e){var t=this.getModel("compose-state");if("source"===e.mode){var o=Daria.getSelection(e.editable().$).start;t.setIfChanged(".bodyPos",o)}else{var n=e.getSelection(),s=n&&!n.isLocked&&n.getRanges();t.setIfChanged(".editorBookmark",s)}}},restoreBookmark:function(){var e=this.getEditor();if(e){var t=this.getModel("compose-state");if("source"===e.mode){var o=t.get(".bodyPos");o&&Daria.setSelection(e.editable().$,o)}else{var n=t.get(".editorBookmark");if(t.set(".editorBookmark",null),Array.isArray(n)&&n.length){var s=e.getSelection();s&&s.selectRanges(n)}}}},resetBookmark:function(){var e=this.getEditor();if(e){var t=e.getSelection();t&&(t.removeAllRanges(),t.reset())}}}},"compose-field-base")}()},3225:function(e,t){ns.View.define("compose-addimage-popup",{yateModule:"compose2",events:{"wheel window":"onWheel"},methods:{_popup:null,_input:null,open:function(e){this.update({},{execFlag:ns.U.EXEC.PARALLEL}).then(function(){this._popup=nb.block(this.node),this._popup.on("nb-opened",this._onOpened.bind(this,e)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.open({withoutTail:!0,autofocus:!0,autoclose:!1})},this)},_hideError:function(e){e.data.error&&(e.$node.removeClass("_nb-is-wrong"),e.error.close())},_onOpened:function(e){this._input=nb.$block(".js-imageurl-input",this.node),e&&e.defaultValue&&"string"==typeof e.defaultValue&&this._input.setValue(e.defaultValue),e&&e.showError&&this._input.showError(),this._input.on("nb-changed",function(){Jane.FormValidation.isUrl(this.getValue())||this.showError()});var t=function(){this._hideError(this._input)}.bind(this);this._input.$control.on("keydown",t),this._input.$control.on("click",t),this._popup.$node.on("click",".js-resolve",this._onResolve.bind(this)),this._popup.$node.on("click",".js-reject",this._onClosed.bind(this))},_onResolve:function(){this._input&&this._input.getValue&&Jane.FormValidation.isUrl(this._input.getValue())?(this.trigger("resolve",this._input.getValue()),this._popup.close()):this._input.showError()},_onClosed:function(){var e=this;_.defer(function(){e._popup.$node.off("click"),e._input&&(e._input.$control&&e._input.$control.off(),e._input.destroy(),e._input=null),e._popup&&(e._popup.destroy(),e._popup=null),e.trigger("reject"),e.destroy()})},getScrollContent:function(){return null}}},"prevent-scroll-propagation-mixin",ns.View)},3226:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(1135),s=o(1533),i=o(3630);function a(e,t,o,n,s,i,a){try{var r=e[i](a),c=r.value}catch(e){return void o(e)}r.done?t(c):Promise.resolve(c).then(n,s)}ns.View.define("compose-turn-off-promo",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-message":!1,settings:!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{settingName:function(){return"promo_turn_off_ns_compose"},canShow:function(){return!this.getModel("settings").isSet(this.settingName())},onShow:function(){this.canShow()&&Object(n.renderReactComponent)(i.a,this.node,{onCancel:this.close.bind(this),onAction:this.onAction.bind(this)})},onHide:function(){Object(n.unmountReactBox)(this.node)},onAction:function(){var e=function(e){return function(){var t=this,o=arguments;return new Promise(function(n,s){var i=e.apply(t,o);function r(e){a(i,n,s,r,c,"next",e)}function c(e){a(i,n,s,r,c,"throw",e)}r(void 0)})}}(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.close(),e.next=3,Object(s.a)(this.getModel("compose-message"));case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}(),close:function(){this.getModel("settings").setSettingOn(this.settingName()),this.onHide()}}})},355:function(e,t,o){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,o,n){void 0===n&&(n=o),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[o]}})}:function(e,t,o,n){void 0===n&&(n=o),e[n]=t[o]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&n(t,e,o);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.BanReason=t.WorkModes=t.TimePresets=t.SuggestTypes=t.SmartSubjectType=t.Settings=t.SendError=t.ResolutionTypes=t.PromoTypes=t.Popups=t.Limits=t.LeaveTypes=t.InputTypes=t.FixedModes=void 0;var a=i(o(523));t.FixedModes=a;var r=i(o(524));t.InputTypes=r;var c=i(o(496));t.LeaveTypes=c;var u=i(o(497));t.Limits=u;var l=i(o(450));t.Popups=l;var d=i(o(525));t.PromoTypes=d;var h=i(o(526));t.ResolutionTypes=h;var p=i(o(498));t.SendError=p;var f=i(o(527));t.Settings=f;var m=i(o(528));t.SmartSubjectType=m;var g=i(o(529));t.SuggestTypes=g;var b=i(o(470));t.TimePresets=b;var _=i(o(530));t.WorkModes=_;var v=o(531);Object.defineProperty(t,"BanReason",{enumerable:!0,get:function(){return v.BanReason}})},357:function(e,t,o){"use strict";var n=o(703),s=o(586),i=o(704),a=o(1062),r=o(1063);o.d(t,"a",function(){return r}),o.d(t,"c",function(){return n}),o.d(t,"d",function(){return i}),o.d(t,"b",function(){return a}),o.d(t,"e",function(){return s})},3633:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(349),s=(o.n(n),o(71));!function(){var e=_.extend({"compose-head":{"compose-action-buttons":{},"compose-from":{},"compose-cancel-button":{}},"compose-footer":function(){var e={"compose-attach-buttons-wrapper":{},"compose-send-button-complex":{},"compose-button-translate-apply":{},"compose-button-translate-close":{},"compose-autosave-status":{},"compose-notify-noreply-button-box@":{}};if("TUR"!==Daria.Config.product){e["compose-notify-on-send-button"]={};var t=Object(s.a)();ns.Model.get("labels",{mailboxUid:t}).getWaitingForReplyLabel()&&(e["compose-notify-noreply-button-box@"]={"compose-notify-noreply-button":{}})}return e["compose-turn-on-beta"]={},e}},{"compose-fields-wrapper":{},"compose-attach-area":{},"compose-field-att_ids-notices-wrapper":{},"compose-forwarded-messages":{},"compose-message-editor":{}});Object(n.hasFeature)(n.Features.WEB_TURN_OFF_NS_COMPOSE_PROMO)&&(e["compose-turn-off-promo"]={}),e["compose-head"]["compose-delete-button"]={},e["compose-head"]["compose-label-button"]={},ns.layout.define("layout-compose-action-buttons",{"compose-action-buttons-box@":{"compose-send-link":{}}}),ns.layout.define("layout-compose-action-buttons-template",{"compose-action-buttons-box@":{"compose-send-link":{},"compose-save-link":{}}}),ns.layout.define("layout-compose-action-buttons-new-template",{"compose-action-buttons-box@":{"compose-save-link":{},"compose-send-link":{}}});var t={compose2:e};Daria.is2pane()&&(t.footer={"footer-help-link":{}});var o={"app right-box@":{"compose-box@":t},"app toolbar-box@":{},"app fake-head-background-box@":function(){return Daria.CompactMode.isCompactHeader()?{"fake-head-background":{}}:{}}};o["app "+Daria.getDirectBlockLayoutInfo("messages-direct").name]={},ns.layout.define("compose2",o,"common+left+toolbar"),ns.layout.define("browse-disk",{"browse-disk":{"browse-disk-crumbs-box@":function(e){return e.path?"browse-disk-crumbs":null},"browse-disk-listing-box@":function(e){return e.path?"browse-disk-listing&":null}}}),ns.layout.define("forgotten-attach",{"compose-forgotten-attach":{"compose-forgotten-attach-button":{}}}),ns.layout.define("compose-attach-select-location",{"compose-attach-select-location":function(){var e={"compose-attach-button-computer":{}};return ns.Model.get("compose-state").hasDisk()&&!Daria.Config["is-corp"]&&(e["compose-attach-button-disk"]={},e["compose-attach-button-mail"]={}),e}}),ns.layout.define("layout-compose-attach-buttons-wrapper",{"compose-attach-buttons-box@":function(){var e={"compose-attach-button-computer":{}};return ns.Model.get("compose-state").hasDisk()&&(e["compose-attach-button-disk"]={},e["compose-attach-button-mail"]={}),e}}),ns.layout.define("compose-template-list",{"compose-template-list":{}}),ns.layout.define("layout-compose-labels",{"compose-labels-box@":{"compose-labels":{}}}),ns.layout.define("layout-compose-labels-empty",{"compose-labels-box@":{}}),ns.layout.define("layout-compose-popular-contacts",{"compose-popular-contacts-box@":{"compose-popular-contacts&":{}}}),ns.layout.define("layout-compose-popular-contacts-empty",{"compose-popular-contacts-box@":{}}),ns.layout.define("layout-compose-field-to-extras",{"compose-field-to-extras-box@":{"compose-field-extras-to":{}}}),ns.layout.define("layout-compose-message-editor-bottom",{"compose-message-editor-bottom-box@":{"compose-message-editor-bottom-buttons":{"compose-action-buttons":{}}}}),ns.layout.define("layout-compose-message-editor-bottom-buttons-empty",{"compose-message-editor-bottom-box@":{}}),ns.layout.define("layout-compose-message-editor-top",{"compose-message-editor-top-box@":{"compose-recipients-diff":{}}}),ns.layout.define("layout-compose-field-notices-att_ids",{"compose-field-notices-box@":{"compose-field-notices-att_ids":{}}}),ns.layout.define("layout-compose-field-notices-to",{"compose-field-notices-box@":{"compose-field-notices-to":{}}}),ns.layout.define("layout-compose-field-notices-phone",{"compose-field-notices-box@":{"compose-field-notices-phone":{}}}),ns.layout.define("layout-compose-field-notices-cc",{"compose-field-notices-box@":{"compose-field-notices-cc":{}}}),ns.layout.define("layout-compose-field-notices-bcc",{"compose-field-notices-box@":{"compose-field-notices-bcc":{}}}),ns.layout.define("layout-compose-fields",{"compose-fields-box@":{"compose-field-to":{"compose-field-to-extras":{}},"compose-field-to-notices-wrapper":{},"compose-popular-contacts-wrapper":{},"compose-field-cc":{},"compose-field-cc-notices-wrapper":{},"compose-field-bcc":{},"compose-field-bcc-notices-wrapper":{},"compose-field-phone":{},"compose-field-phone-notices-wrapper":{},"compose-field-subject":{"compose-template-list-button":{}},"compose-labels-wrapper":{}}}),ns.layout.define("layout-compose-fields-placeholder",{"compose-fields-box@":{"compose-field-placeholder":{"compose-field-to-extras":{}}}}),ns.layout.define("layout-compose-field-phone-input",{"compose-field-phone-input-box@":{"compose-field-phone-input":{}}}),ns.layout.define("layout-compose-field-phone-input-error",{"compose-field-phone-input-box@":{"compose-field-phone-input-error":{}}})}()},3634:function(e,t){!function(e){var t={};function o(n){if(t[n])return t[n].exports;var s=t[n]={exports:{},id:n,loaded:!1};return e[n].call(s.exports,s,s.exports,o),s.loaded=!0,s.exports}o.m=e,o.c=t,o.p="",o(0)}([function(e,t,o){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t){return!t||"object"!==n(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function i(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function a(e,t,o){return t&&i(e.prototype,t),o&&i(e,o),e}function r(e){var t="function"==typeof Map?new Map:void 0;return(r=function(e){if(null===e||!function(e){return-1!==Function.toString.call(e).indexOf("[native code]")}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,o)}function o(){return c(e,arguments,l(this).constructor)}return o.prototype=Object.create(e.prototype,{constructor:{value:o,enumerable:!1,writable:!0,configurable:!0}}),u(o,e)})(e)}function c(e,t,o){return(c=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,o){var n=[null];n.push.apply(n,t);var s=new(Function.bind.apply(e,n));return o&&u(s,o.prototype),s}).apply(null,arguments)}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var d=o(1),h=o(2),p=o(6),f=o(38),m=function(e){function t(){var e,o;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];var r=o=s(this,(e=l(t)).call.apply(e,[this].concat(i)));return g(r),p.ready(r),s(o,r)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(t,r(HTMLDivElement)),a(t,null,[{key:"observedAttributes",get:function(){return f.attributes}}]),a(t,[{key:"connectedCallback",value:function(){g(this),this.editor.bubbling()}},{key:"disconnectedCallback",value:function(){!function(e){e.editor&&(h.destroy(e),delete e.editor)}(this)}},{key:"attributeChangedCallback",value:function(){f(this)}},{key:"options",value:function(e,t){return f(this,e,t)}},{key:"setContent",value:function(e){return this.editor.setContent(e)}},{key:"canAddBubble",value:function(){return this.editor.canAddBubble()}},{key:"addBubble",value:function(e,t){return this.editor.addBubble(e,t)}},{key:"removeBubble",value:function(e){return this.editor.removeBubble(e)}},{key:"editBubble",value:function(e){return this.editor.editBubble(e)}},{key:"bubbling",value:function(){return this.editor.bubbling()}},{key:"items",get:function(){return this.editor.getItems()}},{key:"inputValue",get:function(){return this.editor.inputValue()}}]),t}();function g(e){e.editor||Object.defineProperty(e,"editor",{configurable:!0,value:h.init(e)})}d.customElements.define("x-bubbles",m,{extends:"div"}),e.exports=m},function(e,t){e.exports=function(){return this||(0,eval)("this")}()},function(e,t,o){var n=o(1),s=o(3),i=o(4),a=o(13),r=o(12),c=r.EV,u=r.PROPS,l=o(5),d=o(10),h=o(6),p=o(16),f=o(14),m={blur:o(22),click:o(23),focus:o(24),keydown:o(25)},g={blur:o(26),click:o(27),mousedown:o(28),focus:o(29),keydown:o(30),keypress:o(31),keyup:o(32),paste:o(33)},b={blur:o(34),click:o(35),keydown:o(36),keypress:o(37)},_={blur:d.proxyLocal,click:d.proxyLocal,mousedown:d.proxyLocal,focus:d.proxyLocal,keydown:d.proxyLocal,keypress:d.proxyLocal,keyup:d.proxyLocal,mscontrolselect:d.prevent,paste:d.proxyLocal,resize:d.prevent,resizestart:d.prevent};function v(){var e=l.currentTextRange(this);return e&&l.textClean(e.toString())||""}function y(e){d.dispatch(this,c.BUBBLE_EDIT,{bubbles:!1,cancelable:!1,detail:{data:e}})}function C(){d.dispatch(this,c.CHANGE,{bubbles:!1,cancelable:!1})}function S(){var e=v.call(this);this[u.BUBBLE_VALUE]!==e&&(this[u.BUBBLE_VALUE]=e,d.dispatch(this,c.BUBBLE_INPUT,{bubbles:!1,cancelable:!1,detail:{data:e}}))}t.init=function(e){var t=e;return t.setAttribute("contenteditable","true"),t.setAttribute("spellcheck","false"),d.onLocal(t,m),d.onLocal(t,g),t.options("selection")&&(d.onLocal(t,b),p.init(t)),d.on(t,_),t.fireChange=h.throttle(C,t),t.fireEdit=h.throttle(y,t),t.fireInput=h.throttle(S,t),t.fireBeforeRemove=function(e){d.dispatch(this,c.BEFORE_REMOVE,{bubbles:!1,cancelable:!1,detail:{data:e}})}.bind(t),{canAddBubble:function(){return s.canAddBubble(this)}.bind(t),addBubble:function(e,t){var o=i.create(this,e,t);if(!this.canAddBubble()||!o)return!1;if(l.text2bubble(this,o))return this.fireInput(),this.fireChange(),a.restore(this),!0;return!1}.bind(t),bubbling:function(){i.bubbling(this)}.bind(t),editBubble:function(e){if(this.contains(e))return i.edit(this,e);return!1}.bind(t),getItems:function(){return s.getBubbles(this)}.bind(t),inputValue:v.bind(t),removeBubble:function(e){if(this.contains(e))return s.removeBubbles(this,[e]),this.fireChange(),!0;return!1}.bind(t),setContent:function(e){var t=n.getSelection();t&&t.removeAllRanges();var o=f.get(this);o.length&&(s.removeBubbles(this,o),this.fireChange());for(;this.firstChild;)this.removeChild(this.firstChild);return e=l.html2text(e),this.appendChild(this.ownerDocument.createTextNode(e)),i.bubbling(this),a.restore(this),!0}.bind(t)}},t.destroy=function(e){var t=e;d.off(t,_),d.offLocal(t,m),d.offLocal(t,g),t.options("selection")&&(d.offLocal(t,b),p.destroy(t))}},function(e,t,o){var n=o(4),s=o(5);function i(e){return Array.prototype.slice.call(e.querySelectorAll("[bubble]"))}function a(e){return i(e).length}function r(e){return e.nodeType===Node.ELEMENT_NODE&&"x-bubbles"===e.getAttribute("is")}function c(e){var t=e.options("limit");return t?t-a(e):Number.POSITIVE_INFINITY}t.closestNodeBubble=function(e){for(;e;){if(n.isBubbleNode(e))return e;if(r(e))return;e=e.parentNode}},t.closestNodeSet=function(e){for(;e;){if(r(e))return e;e=e.parentNode}},t.findBubbleLeft=function(e){if(!e.focusNode||!e.anchorNode)return;var t=e.focusNode.previousSibling;e.anchorNode!==e.focusNode&&e.anchorNode.compareDocumentPosition(e.focusNode)&Node.DOCUMENT_POSITION_FOLLOWING&&(t=e.anchorNode.previousSibling);for(;t;){if(n.isBubbleNode(t))return t;if(t.nodeType===Node.TEXT_NODE&&s.textClean(t.nodeValue))return;t=t.previousSibling}},t.findBubbleRight=function(e){if(!e.focusNode||!e.anchorNode)return;var t=e.focusNode.nextSibling;e.anchorNode!==e.focusNode&&e.anchorNode.compareDocumentPosition(e.focusNode)&Node.DOCUMENT_POSITION_FOLLOWING&&(t=e.anchorNode.nextSibling);for(;t;){if(n.isBubbleNode(t))return t;if(t.nodeType===Node.TEXT_NODE&&s.textClean(t.nodeValue))return;t=t.nextSibling}},t.getBubbles=i,t.bubblesCount=a,t.hasBubbles=function(e){return Boolean(e.querySelector("[bubble]"))},t.headBubble=function(e){return e.querySelector("[bubble]:first-child")},t.lastBubble=function(e){return e.querySelector("[bubble]:last-child")},t.nextBubble=function(e){var t=e&&e.nextSibling;for(;t;){if(n.isBubbleNode(t))return t;t=t.nextSibling}},t.prevBubble=function(e){var t=e&&e.previousSibling;for(;t;){if(n.isBubbleNode(t))return t;t=t.previousSibling}},t.removeBubbles=function(e,t){e.fireBeforeRemove(t),t.forEach(function(t){return e.removeChild(t)})},t.moveBubbles=function(e,t,o){var n=c(t);if(n<=0)return;var s=o.slice(0,n);e.fireBeforeRemove(s),s.forEach(function(e){return t.appendChild(e)})},t.canAddBubble=function(e){var t=e.options("limit");return!t||a(e)<t},t.getRemainingCapacity=c},function(e,t,o){var n=o(1),s=o(5),i=o(3),a=o(6),r=a.escape,c=a.canUseDrag;function u(e){return!(!e||e.nodeType!==Node.ELEMENT_NODE)&&e.hasAttribute("bubble")}function l(e,t){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(t=s.textClean(t)){var n=e.options("bubbleFormation"),i=e.options("classBubble"),a=c&&e.options("draggable")&&e.options("selection"),u=e.ownerDocument.createElement("span");for(var l in u.innerText=t,o)o[l]&&u.setAttribute("data-".concat(l),r(o[l]));if(n(u),i)for(var d=String(i).trim().split(/\s+/),h=d.length;h--;)u.classList.add(d[h]);return u.setAttribute("bubble",""),u.setAttribute("contenteditable","false"),a&&u.setAttribute("draggable","true"),u}}function d(e){return e.trim()}function h(e){return Boolean(e)}t.isBubbleNode=u,t.bubbling=function(e){var t=e.options("begining"),o=e.options("ending"),a=e.options("separator"),r=e.options("tokenizer"),c=function(e){for(var t,o,s=[],i=e.childNodes,a=0;a<i.length;a++)u(o=i[a])?t&&(t.setEndBefore(o),s.push(t),t=void 0):t||(t=n.document.createRange()).setStartBefore(o);t&&(t.setEndAfter(o),s.push(t));return s}(e),p=[],f=i.getRemainingCapacity(e);c.forEach(function(i){var c=s.textClean(i.toString());if(c){var u=[c];if(r?u=r(c):(a&&(u=c.split(a).map(d).filter(h)),o?u=u.reduce(function(e,t){return e.concat(function(e,t){var o=[],n=0,s=999;for(t.lastIndex=0;null!==t.exec(e)&&s;)s--,o.push(e.substring(n,t.lastIndex)),n=t.lastIndex;return o}(t,o))},[]).map(d).filter(h):t&&(u=u.reduce(function(e,o){return e.concat(function(e,t){var o,n=[],s=0,i=999;for(t.lastIndex=0;null!==(o=t.exec(e))&&i;)i--,s!==o.index&&(n.push(e.substring(s,o.index)),s=o.index);return n.push(e.substring(s,e.length)),n}(o,t))},[]).map(d).filter(h))),Array.isArray(u)&&u.length){var m=n.document.createDocumentFragment();u.forEach(function(t){if(!(p.length>=f)){var o=l(e,t);o&&(m.appendChild(o),p.push(o))}}),i.deleteContents(),i.insertNode(m)}else i.deleteContents()}else i.deleteContents()}),e.fireInput(),p.length&&e.fireChange();return p},t.create=l,t.edit=function(e,t){if(t.hasAttribute("readonly"))return!1;var o=n.getSelection();if(!o)return!1;var i=e.options("bubbleDeformation")(t);if(!i){var a=s.textClean(t.innerText);i={text:a,startOffset:0,endOffset:a.length}}var r=s.createZws(),c=n.document.createTextNode(i.text);e.fireEdit(t),e.replaceChild(c,t),e.insertBefore(r,c);var u=n.document.createRange();return u.setStart(c,i.startOffset),u.setEnd(c,i.endOffset),o.removeAllRanges(),o.addRange(u),!0}},function(e,t,o){var n=o(1),s=o(3),i=o(6),a=i.getSelection,r=i.correctSelection,c=/[\0-\x1F\x7F-\x9F\xAD\u0378\u0379\u037F-\u0383\u038B\u038D\u03A2\u0528-\u0530\u0557\u0558\u0560\u0588\u058B-\u058E\u0590\u05C8-\u05CF\u05EB-\u05EF\u05F5-\u0605\u061C\u061D\u06DD\u070E\u070F\u074B\u074C\u07B2-\u07BF\u07FB-\u07FF\u082E\u082F\u083F\u085C\u085D\u085F-\u089F\u08A1\u08AD-\u08E3\u08FF\u0978\u0980\u0984\u098D\u098E\u0991\u0992\u09A9\u09B1\u09B3-\u09B5\u09BA\u09BB\u09C5\u09C6\u09C9\u09CA\u09CF-\u09D6\u09D8-\u09DB\u09DE\u09E4\u09E5\u09FC-\u0A00\u0A04\u0A0B-\u0A0E\u0A11\u0A12\u0A29\u0A31\u0A34\u0A37\u0A3A\u0A3B\u0A3D\u0A43-\u0A46\u0A49\u0A4A\u0A4E-\u0A50\u0A52-\u0A58\u0A5D\u0A5F-\u0A65\u0A76-\u0A80\u0A84\u0A8E\u0A92\u0AA9\u0AB1\u0AB4\u0ABA\u0ABB\u0AC6\u0ACA\u0ACE\u0ACF\u0AD1-\u0ADF\u0AE4\u0AE5\u0AF2-\u0B00\u0B04\u0B0D\u0B0E\u0B11\u0B12\u0B29\u0B31\u0B34\u0B3A\u0B3B\u0B45\u0B46\u0B49\u0B4A\u0B4E-\u0B55\u0B58-\u0B5B\u0B5E\u0B64\u0B65\u0B78-\u0B81\u0B84\u0B8B-\u0B8D\u0B91\u0B96-\u0B98\u0B9B\u0B9D\u0BA0-\u0BA2\u0BA5-\u0BA7\u0BAB-\u0BAD\u0BBA-\u0BBD\u0BC3-\u0BC5\u0BC9\u0BCE\u0BCF\u0BD1-\u0BD6\u0BD8-\u0BE5\u0BFB-\u0C00\u0C04\u0C0D\u0C11\u0C29\u0C34\u0C3A-\u0C3C\u0C45\u0C49\u0C4E-\u0C54\u0C57\u0C5A-\u0C5F\u0C64\u0C65\u0C70-\u0C77\u0C80\u0C81\u0C84\u0C8D\u0C91\u0CA9\u0CB4\u0CBA\u0CBB\u0CC5\u0CC9\u0CCE-\u0CD4\u0CD7-\u0CDD\u0CDF\u0CE4\u0CE5\u0CF0\u0CF3-\u0D01\u0D04\u0D0D\u0D11\u0D3B\u0D3C\u0D45\u0D49\u0D4F-\u0D56\u0D58-\u0D5F\u0D64\u0D65\u0D76-\u0D78\u0D80\u0D81\u0D84\u0D97-\u0D99\u0DB2\u0DBC\u0DBE\u0DBF\u0DC7-\u0DC9\u0DCB-\u0DCE\u0DD5\u0DD7\u0DE0-\u0DF1\u0DF5-\u0E00\u0E3B-\u0E3E\u0E5C-\u0E80\u0E83\u0E85\u0E86\u0E89\u0E8B\u0E8C\u0E8E-\u0E93\u0E98\u0EA0\u0EA4\u0EA6\u0EA8\u0EA9\u0EAC\u0EBA\u0EBE\u0EBF\u0EC5\u0EC7\u0ECE\u0ECF\u0EDA\u0EDB\u0EE0-\u0EFF\u0F48\u0F6D-\u0F70\u0F98\u0FBD\u0FCD\u0FDB-\u0FFF\u10C6\u10C8-\u10CC\u10CE\u10CF\u1249\u124E\u124F\u1257\u1259\u125E\u125F\u1289\u128E\u128F\u12B1\u12B6\u12B7\u12BF\u12C1\u12C6\u12C7\u12D7\u1311\u1316\u1317\u135B\u135C\u137D-\u137F\u139A-\u139F\u13F5-\u13FF\u169D-\u169F\u16F1-\u16FF\u170D\u1715-\u171F\u1737-\u173F\u1754-\u175F\u176D\u1771\u1774-\u177F\u17DE\u17DF\u17EA-\u17EF\u17FA-\u17FF\u180F\u181A-\u181F\u1878-\u187F\u18AB-\u18AF\u18F6-\u18FF\u191D-\u191F\u192C-\u192F\u193C-\u193F\u1941-\u1943\u196E\u196F\u1975-\u197F\u19AC-\u19AF\u19CA-\u19CF\u19DB-\u19DD\u1A1C\u1A1D\u1A5F\u1A7D\u1A7E\u1A8A-\u1A8F\u1A9A-\u1A9F\u1AAE-\u1AFF\u1B4C-\u1B4F\u1B7D-\u1B7F\u1BF4-\u1BFB\u1C38-\u1C3A\u1C4A-\u1C4C\u1C80-\u1CBF\u1CC8-\u1CCF\u1CF7-\u1CFF\u1DE7-\u1DFB\u1F16\u1F17\u1F1E\u1F1F\u1F46\u1F47\u1F4E\u1F4F\u1F58\u1F5A\u1F5C\u1F5E\u1F7E\u1F7F\u1FB5\u1FC5\u1FD4\u1FD5\u1FDC\u1FF0\u1FF1\u1FF5\u1FFF\u200B-\u200F\u202A-\u202E\u2060-\u206F\u2072\u2073\u208F\u209D-\u209F\u20BB-\u20CF\u20F1-\u20FF\u218A-\u218F\u23F4-\u23FF\u2427-\u243F\u244B-\u245F\u2700\u2B4D-\u2B4F\u2B5A-\u2BFF\u2C2F\u2C5F\u2CF4-\u2CF8\u2D26\u2D28-\u2D2C\u2D2E\u2D2F\u2D68-\u2D6E\u2D71-\u2D7E\u2D97-\u2D9F\u2DA7\u2DAF\u2DB7\u2DBF\u2DC7\u2DCF\u2DD7\u2DDF\u2E3C-\u2E7F\u2E9A\u2EF4-\u2EFF\u2FD6-\u2FEF\u2FFC-\u2FFF\u3040\u3097\u3098\u3100-\u3104\u312E-\u3130\u318F\u31BB-\u31BF\u31E4-\u31EF\u321F\u32FF\u4DB6-\u4DBF\u9FCD-\u9FFF\uA48D-\uA48F\uA4C7-\uA4CF\uA62C-\uA63F\uA698-\uA69E\uA6F8-\uA6FF\uA78F\uA794-\uA79F\uA7AB-\uA7F7\uA82C-\uA82F\uA83A-\uA83F\uA878-\uA87F\uA8C5-\uA8CD\uA8DA-\uA8DF\uA8FC-\uA8FF\uA954-\uA95E\uA97D-\uA97F\uA9CE\uA9DA-\uA9DD\uA9E0-\uA9FF\uAA37-\uAA3F\uAA4E\uAA4F\uAA5A\uAA5B\uAA7C-\uAA7F\uAAC3-\uAADA\uAAF7-\uAB00\uAB07\uAB08\uAB0F\uAB10\uAB17-\uAB1F\uAB27\uAB2F-\uABBF\uABEE\uABEF\uABFA-\uABFF\uD7A4-\uD7AF\uD7C7-\uD7CA\uD7FC-\uF8FF\uFA6E\uFA6F\uFADA-\uFAFF\uFB07-\uFB12\uFB18-\uFB1C\uFB37\uFB3D\uFB3F\uFB42\uFB45\uFBC2-\uFBD2\uFD40-\uFD4F\uFD90\uFD91\uFDC8-\uFDEF\uFDFE\uFDFF\uFE1A-\uFE1F\uFE27-\uFE2F\uFE53\uFE67\uFE6C-\uFE6F\uFE75\uFEFD-\uFF00\uFFBF-\uFFC1\uFFC8\uFFC9\uFFD0\uFFD1\uFFD8\uFFD9\uFFDD-\uFFDF\uFFE7\uFFEF-\uFFFB\uFFFE\uFFFF]/g,u=/\u200B/,l="​";function d(e,t){if(t=t||a(e)){var o=t.focusNode&&t.focusNode.nodeType===Node.TEXT_NODE?t.focusNode:t.anchorNode&&t.anchorNode.nodeType===Node.TEXT_NODE?t.anchorNode:void 0;if(o){for(var n=o,s=o,i=o;i&&i.nodeType===Node.TEXT_NODE;)n=i,i=i.previousSibling;for(i=o;i&&i.nodeType===Node.TEXT_NODE;)s=i,i=i.nextSibling;var r=e.ownerDocument.createRange();return r.setStartBefore(n),r.setEndAfter(s),r}}}function h(e,t){if(!e||!e.rangeCount)return!1;var o=n.document.createElement("span");if(e.getRangeAt(0).surroundContents(o),o.parentNode.replaceChild(t,o),e.removeAllRanges(),t.nodeType===Node.TEXT_NODE){var s=n.document.createRange();s.setStart(t,t.nodeValue.length),s.collapse(!1),e.addRange(s)}else e.collapse(t,0);return!0}function p(e,t){for(var o=e,n=null,s="begin"===t?"previousSibling":"nextSibling";o&&o.nodeType===Node.TEXT_NODE;)n=o,o=o[s];return n}function f(e,t,o,i){var a=s.hasBubbles(i),r=n.document.createRange();r.setStart(t.node,t.offset),r.setEnd(o.node,o.offset);var c=b(r.toString());return!(!c&&(c||a))&&(c||r.collapse(),e.removeAllRanges(),e.addRange(r),!0)}function m(){return n.document.createTextNode(l)}function g(e){return u.test(e)}function b(e){return String(e||"").trim().replace(c,"")}t.isEmptyLeft=function(e){var t=r(e),o=t.startNode,n=t.startOffset,s=!0,i=o;for(;i&&i.nodeType===Node.TEXT_NODE;){var a=n>0?i.nodeValue.substring(0,n):i.nodeValue;if(b(a)){s=!1;break}n=0,i=i.previousSibling}return s},t.isEmptyRight=function(e){var t=r(e),o=t.endNode,n=t.endOffset,s=o;for(;s;){if(s.nodeType!==Node.TEXT_NODE)return!1;var i=n>-1&&n<s.nodeValue.length?s.nodeValue.substring(n):s.nodeValue;if(b(i))return!1;n=-1,s=s.nextSibling}return!0},t.arrowRight=function(e,t){if(!(e=e||n.getSelection())||!e.focusNode||e.focusNode.nodeType!==Node.TEXT_NODE)return!1;var o=r(e),s=o.startNode,i=o.endNode,a=o.startOffset,c=o.endOffset,u=o.revert;if(!e.isCollapsed&&!t)return e.collapse(i,c),!0;var l=u?s:i,d=u?a:c;for(;l;){if(l.nodeType!==Node.TEXT_NODE)return!1;var h=l.nodeValue.length;if(d+1>h)l=l.nextSibling,d=0;else{var p=l.nodeValue.substring(d,d+1);if(!g(p))break;d+=1}}if(!l)return!1;if(t){var f=Boolean(e.extend);if(f)e.extend(l,d+1);else{var m=n.document.createRange();u?(m.setStart(l,d+1),m.setEnd(i,c)):(m.setStart(s,a),m.setEnd(l,d+1)),e.removeAllRanges(),e.addRange(m)}}else e.collapse(l,d+1);return!0},t.arrowLeft=function(e,t){if(!(e=e||n.getSelection())||!e.anchorNode||e.anchorNode.nodeType!==Node.TEXT_NODE)return!1;var o=r(e),s=o.startNode,i=o.endNode,a=o.startOffset,c=o.endOffset,u=o.revert;if(!e.isCollapsed&&!t)return e.collapse(s,a),!0;var l=Boolean(e.extend),d=(u=l?u:!u)?s:i,h=u?a:c;for(;d;){if(d.nodeType!==Node.TEXT_NODE)return!1;if(null===h&&(h=d.nodeValue.length),h-1<0)d=d.previousSibling,h=null;else{var p=d.nodeValue.substring(h-1,h);if(!g(p))break;h-=1}}if(!d||null===h)return!1;if(t)if(l)e.extend(d,h-1);else{var f=n.document.createRange();u?(f.setStart(d,h-1),f.setEnd(i,c)):(f.setStart(s,a),f.setEnd(d,h-1)),e.removeAllRanges(),e.addRange(f)}else e.collapse(d,h-1);return!0},t.remove=function(e){return h(e,m())},t.html2text=function(e){if(!e)return"";var t=n.document.implementation.createHTMLDocument("").body;return t.innerText=e,t.innerText.replace(/^[\u0020\u00a0]+$/gm,"").replace(/\n/gm," ").trim()},t.currentTextRange=d,t.text2bubble=function(e,t){var o=a(e),n=o&&d(e,o);n?(o.removeAllRanges(),o.addRange(n),h(o,t)):e.appendChild(t);return!0},t.replaceString=function(e,t){if(!(e=b(e)))return!1;t=t||n.getSelection();var o=n.document.createTextNode(e);if(!h(t,o))return!1;return t.collapse(o,o.nodeValue.length),!0},t.findTextBorderNode=p,t.selectFromCursorToStrBegin=function(e,t){var o=(e=e||n.getSelection())&&e.anchorNode;if(!o||o.nodeType!==Node.TEXT_NODE)return!1;var s=e.anchorOffset,i=p(o,"begin");return f(e,{node:i,offset:0},{node:o,offset:s},t)},t.selectAll=function(e,t){var o=(e=e||n.getSelection())&&e.anchorNode;if(!o||o.nodeType!==Node.TEXT_NODE)return!1;var s=p(o,"begin"),i=p(o,"end");return f(e,{node:s,offset:0},{node:i,offset:i.nodeValue?i.nodeValue.length:0},t)},t.textClean=b,t.checkZws=g,t.createZws=m,t.hasNear=function(e){var t=(e=e||n.getSelection())&&e.anchorNode;if(!t||t.nodeType!==Node.TEXT_NODE)return!1;var o=p(t,"begin"),s=p(t,"end"),i=n.document.createRange();i.setStart(o,0),i.setEnd(s,s.nodeValue?s.nodeValue.length:0);var a=b(i.toString());return Boolean(a)}},function(e,t,o){var n=o(7),s=o(1),i=o(10).dispatch,a=o(12).EV,r={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","`":"&#96;"},c={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&#96;":"`"},u=/&(?:amp|lt|gt|quot|#39|#96);/g,l=/[&<>"'`]/g,d=RegExp(u.source),h=RegExp(l.source),p=/Trident|Edge/,f=/IEMobile/;function m(e){return c[e]}function g(e){return r[e]}t.getSelection=function(e){var t=s.getSelection();if(t&&t.anchorNode&&e.compareDocumentPosition(t.anchorNode)&Node.DOCUMENT_POSITION_CONTAINED_BY)return t},t.correctSelection=function(e){var t=e.focusNode,o=e.focusOffset,n=e.anchorNode,s=e.anchorOffset,i=!1;n===t?(s=Math.min(e.anchorOffset,e.focusOffset),o=Math.max(e.anchorOffset,e.focusOffset),i=e.anchorOffset>e.focusOffset):e.anchorNode.compareDocumentPosition(e.focusNode)&Node.DOCUMENT_POSITION_PRECEDING&&(n=e.focusNode,s=e.focusOffset,t=e.anchorNode,o=e.anchorOffset,i=!0);return{startNode:n,endNode:t,startOffset:s,endOffset:o,revert:i}},t.throttle=function(e,t){var o=0,s=function(){o=0};return function(){o||(o=n(s),e.apply(t||this,arguments))}},t.escape=function(e){return(e=String(e))&&h.test(e)?e.replace(l,g):e},t.unescape=function(e){return(e=String(e))&&d.test(e)?e.replace(u,m):e},t.canUseDrag=!p.test(s.navigator.userAgent),t.isIE=p.test(s.navigator.userAgent),t.isMobileIE=f.test(s.navigator.userAgent),t.ready=function(){var e=[],t=!1,o=!1;function r(){n(function(){s.setTimeout(function(){e.length&&i(s,a.READY,{detail:{data:e.splice(0)}}),t=!0})})}return"complete"===s.document.readyState?r():"interactive"!==s.document.readyState||s.attachEvent||s.HTMLImports&&!s.HTMLImports.ready?s.addEventListener(s.HTMLImports&&!s.HTMLImports.ready?"HTMLImportsLoaded":"DOMContentLoaded",r):r(),function(r){e.push(r),t&&!o&&(o=!0,n(function(){i(s,a.READY,{detail:{data:e.splice(0)}}),o=!1}))}}()},function(e,t,o){(function(t){for(var n=o(8),s="undefined"==typeof window?t:window,i=["moz","webkit"],a="AnimationFrame",r=s["request"+a],c=s["cancel"+a]||s["cancelRequest"+a],u=0;!r&&u<i.length;u++)r=s[i[u]+"Request"+a],c=s[i[u]+"Cancel"+a]||s[i[u]+"CancelRequest"+a];if(!r||!c){var l=0,d=0,h=[];r=function(e){if(0===h.length){var t=n(),o=Math.max(0,1e3/60-(t-l));l=o+t,setTimeout(function(){var e=h.slice(0);h.length=0;for(var t=0;t<e.length;t++)if(!e[t].cancelled)try{e[t].callback(l)}catch(e){setTimeout(function(){throw e},0)}},Math.round(o))}return h.push({handle:++d,callback:e,cancelled:!1}),d},c=function(e){for(var t=0;t<h.length;t++)h[t].handle===e&&(h[t].cancelled=!0)}}e.exports=function(e){return r.call(s,e)},e.exports.cancel=function(){c.apply(s,arguments)},e.exports.polyfill=function(){s.requestAnimationFrame=r,s.cancelAnimationFrame=c}}).call(t,function(){return this}())},function(e,t,o){(function(t){(function(){var o,n,s;"undefined"!=typeof performance&&null!==performance&&performance.now?e.exports=function(){return performance.now()}:void 0!==t&&null!==t&&t.hrtime?(e.exports=function(){return(o()-s)/1e6},n=t.hrtime,s=(o=function(){var e;return 1e9*(e=n())[0]+e[1]})()):Date.now?(e.exports=function(){return Date.now()-s},s=Date.now()):(e.exports=function(){return(new Date).getTime()-s},s=(new Date).getTime())}).call(this)}).call(t,o(9))},function(e,t){var o,n,s=e.exports={};function i(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function r(e){if(o===setTimeout)return setTimeout(e,0);if((o===i||!o)&&setTimeout)return o=setTimeout,setTimeout(e,0);try{return o(e,0)}catch(t){try{return o.call(null,e,0)}catch(t){return o.call(this,e,0)}}}!function(){try{o="function"==typeof setTimeout?setTimeout:i}catch(e){o=i}try{n="function"==typeof clearTimeout?clearTimeout:a}catch(e){n=a}}();var c,u=[],l=!1,d=-1;function h(){l&&c&&(l=!1,c.length?u=c.concat(u):d=-1,u.length&&p())}function p(){if(!l){var e=r(h);l=!0;for(var t=u.length;t;){for(c=u,u=[];++d<t;)c&&c[d].run();d=-1,t=u.length}c=null,l=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===a||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function f(e,t){this.fun=e,this.array=t}function m(){}s.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var o=1;o<arguments.length;o++)t[o-1]=arguments[o];u.push(new f(e,t)),1!==u.length||l||r(p)},f.prototype.run=function(){this.fun.apply(null,this.array)},s.title="browser",s.browser=!0,s.env={},s.argv=[],s.version="",s.versions={},s.on=m,s.addListener=m,s.once=m,s.off=m,s.removeListener=m,s.removeAllListeners=m,s.emit=m,s.prependListener=m,s.prependOnceListener=m,s.listeners=function(e){return[]},s.binding=function(e){throw new Error("process.binding is not supported")},s.cwd=function(){return"/"},s.chdir=function(e){throw new Error("process.chdir is not supported")},s.umask=function(){return 0}},function(e,t,o){var n=o(1),s=o(11),i=o(12).PROPS;function a(){var e=n.document.documentElement,t=n.document.body;return(e&&e.scrollLeft||t&&t.scrollLeft||0)-(e.clientLeft||0)}function r(){var e=n.document.documentElement,t=n.document.body;return(e&&e.scrollTop||t&&t.scrollTop||0)-(e.clientTop||0)}t.scrollX=a,t.scrollY=r,t.dispatch=function(e,t){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};e.dispatchEvent(new c(t,o))},t.keyCode=function(e){return e.charCode||e.keyCode},t.metaKey=function(e){return e.ctrlKey||e.metaKey},t.pageX=function(e){return null===e.pageX&&null!==e.clientX?e.clientX+a():e.pageX},t.pageY=function(e){return null===e.pageY&&null!==e.clientY?e.clientY+r():e.pageY},t.one=function(e,t,o){d(e,t,o,!0,!1,!0)},t.on=function(e,t,o){d(e,t,o)},t.off=function(e,t,o){d(e,t,o,!1)},t.oneLocal=function(e,t,o){d(e,t,o,!0,!0,!0)},t.onLocal=function(e,t,o){d(e,t,o,!0,!0)},t.offLocal=function(e,t,o){d(e,t,o,!1,!0)},t.prevent=function(e){return e.cancelBubble=!0,e.returnValue=!1,e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),!1},t.proxyLocal=function(e){!function(e,t){for(var o=e[i.LOCAL_EVENTS]&&e[i.LOCAL_EVENTS][t.type]||[],n={},s=0;s<o.length&&!t.immediatePropagationStopped;s++)o[s](t,n)}(e.currentTarget,e)};var c="function"==typeof n.CustomEvent?n.CustomEvent:s;function u(e,t,o){return function n(s){e.removeEventListener(t,n),o(s)}}var l={addLocalEventListener:function(e,t,o){(function(e,t){return e[i.LOCAL_EVENTS]||(e[i.LOCAL_EVENTS]={}),e[i.LOCAL_EVENTS][t]||(e[i.LOCAL_EVENTS][t]=[]),e[i.LOCAL_EVENTS][t]})(e,t).push(o)},removeLocalEventListener:function(e,t,o){for(var n=e[i.LOCAL_EVENTS]&&e[i.LOCAL_EVENTS][t]||[],s=0;s<n.length;)n[s]===o?n.splice(s,1):s++},addEventListener:function(e,t,o){e.addEventListener(t,o)},removeEventListener:function(e,t,o){e.removeEventListener(t,o)}};function d(e,t,o){var n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],i=arguments.length>5&&void 0!==arguments[5]&&arguments[5],a=o?function(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}({},t,o):t,r="".concat(n?"add":"remove").concat(s?"Local":"","EventListener");for(var c in a){var d=i?u(e,c,a[c]):a[c];l[r](e,c,d)}}},function(e,t,o){var n=o(1),s=n.document,i=n.Event.prototype,a=!1;try{a=Boolean(s.createEvent("CustomEvent"))}catch(e){}var r=i.stopImmediatePropagation;i.stopImmediatePropagation=function(){this.immediatePropagationStopped=!0,r?r.call(this):this.stopPropagation()};var c=a?function(e,t){t=t||{};var o=Boolean(t.bubbles),n=Boolean(t.cancelable),i=s.createEvent("CustomEvent");return i.initCustomEvent(e,o,n,t.detail),i}:function(e,t){t=t||{};var o=Boolean(t.bubbles),n=Boolean(t.cancelable),i=s.createEvent("Event");return i.initEvent(e,o,n),i.detail=t.detail,i};c.prototype=i,e.exports=c},function(e,t){t.KEY={a:65,Backspace:8,Bottom:40,c:67,Cmd:91,Comma:44,Delete:46,Enter:13,Esc:27,Home:36,Left:37,Right:39,Semicolon:59,Space:32,Tab:9,Top:38,x:88},t.CLS={DRAGSTART:"drag",DROPZONE:"dropzone"},t.EV={BEFORE_REMOVE:"before-remove",BUBBLE_EDIT:"bubble-edit",BUBBLE_INPUT:"bubble-input",CHANGE:"change",DRAGEND:"dragend",DRAGENTER:"dragenter",DRAGLEAVE:"dragleave",DRAGSTART:"dragstart",DROP:"drop",READY:"x-bubbles-ready"},t.PROPS={BUBBLE_VALUE:"__bubble_value__",CLICK_TIME:"__click_time__",LOCAL_EVENTS:"__events__",LOCK_COPY:"__lock_copy__",OPTIONS:"__options__"}},function(e,t,o){var n=o(1),s=o(5),i=o(14),a=o(6),r=o(15);function c(e){var t=s.createZws();if(e.hasChildNodes()){var o=e.childNodes[e.childNodes.length-1];o.isEqualNode(t)?t=o:e.appendChild(t)}else e.appendChild(t);return t}t.restore=function(e){if(!a.isMobileIE){if(r.init(e),!e.canAddBubble())return void i.setLast(e);i.clear(e);var t=c(e),o=n.getSelection();o.removeAllRanges(),o.collapse(t,1)}},t.restoreBasis=c},function(e,t,o){var n=o(1),s=o(6),i=o(4),a=o(3),r=Array.prototype.slice,c="[bubble][selected]",u="[bubble]:not([selected])";function l(e){var t=d(e);return t[t.length-1]}function d(e){return r.call(e.querySelectorAll(c))}function h(e){d(e).forEach(function(e){return e.removeAttribute("selected")})}function p(e){if(m(e)){var t=a.closestNodeSet(e);return t.startRangeSelect=e,i.bubbling(t),!0}return!1}function f(e){if(!i.isBubbleNode(e))return!1;var t=a.closestNodeSet(e),o=n.getSelection();return o&&o.removeAllRanges(),h(t),p(e)}function m(e){return!!i.isBubbleNode(e)&&(e.setAttribute("selected",""),!0)}t.all=function(e){r.call(e.querySelectorAll(u)).forEach(function(e){return m(e)}),e.startRangeSelect=e.querySelector(c),i.bubbling(e);var t=n.getSelection();t&&t.removeAllRanges()},t.allLeft=function(e){var t=l(e);if(!t)return;for(var o=a.prevBubble(t);o;o=a.prevBubble(o))m(o);e.startRangeSelect=e.querySelector(c),i.bubbling(e);var s=n.getSelection();s&&s.removeAllRanges()},t.add=p,t.clear=h,t.get=d,t.uniq=f,t.head=function(e){return d(e)[0]},t.last=l,t.has=function(e){return Boolean(e.querySelector(c))},t.range=function(e){if(!i.isBubbleNode(e))return;var t=e.parentNode,o=d(t);if(!o.length)return void f(e);h(t);var n,s,a=o[0],r=o[o.length-1];a!==r&&t.startRangeSelect||(t.startRangeSelect=a);e.compareDocumentPosition(t.startRangeSelect)&Node.DOCUMENT_POSITION_PRECEDING?(n=t.startRangeSelect,s=e):(n=e,s=t.startRangeSelect);if(n&&s){for(var c=n;c&&m(c)&&c!==s;)c=c.nextSibling;i.bubbling(t)}},t.toggleUniq=function(e){if(function(e){return i.isBubbleNode(e)&&e.hasAttribute("selected")||!1}(e)){var t=a.closestNodeSet(e);if(1===d(t).length)return function(e){if(i.isBubbleNode(e))return e.removeAttribute("selected"),!0;return!1}(e)}return f(e)},t.setLast=function(e){return f(a.lastBubble(e))},t.getEditable=function(e){if(!e.options("selection"))return!1;var t=s.getSelection(e);if(t&&t.rangeCount)return!1;var o=d(e);if(1!==o.length)return!1;return o[0]}},function(e,t,o){function n(e){return function(e){if(Array.isArray(e)){for(var t=0,o=new Array(e.length);t<e.length;t++)o[t]=e[t];return o}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var s=o(3),i=o(14),a=o(13),r=o(10);t.init=function(e){r.on(e,"mousedown",u),r.on(document,"handledragend",d)},t.destroy=function(e){r.off(e,"mousedown",u)},t.clean=function(){r.off(document,"mousemove",l)};var c={_onMouseMove:function(){},_onMouseUp:function(){}};function u(e){var t=s.closestNodeSet(e.target),o=e.target.parentNode.parentNode;t&&(o&&!o.hasAttribute("selected")&&(a.restore(t),r.dispatch(document,"deselectafterclick",{detail:{wasSelectedPreviously:!1}})),o&&o.hasAttribute("selected")||(t.focus(),c._onMouseMove=function(e){return l(e,t)},c._onMouseUp=function(e){return d(e,t)},r.on(document,"mousemove",c._onMouseMove),r.on(document,"mouseup",c._onMouseUp)))}function l(e,t){var o=s.closestNodeBubble(e.target);o&&t.contains(o)&&i.range(o)}function d(e,t){c._onMouseMove&&c._onMouseUp&&(r.off(document,"mousemove",c._onMouseMove),r.off(document,"mouseup",c._onMouseUp),t&&Boolean(n(t.children).map(function(e){return e.hasAttribute("selected")}).filter(Boolean).length)&&(r.dispatch(document,"deselectafterclick",{detail:{wasSelectedPreviously:!0}}),e.stopPropagation()))}},function(e,t,o){var n=o(17),s=o(20),i=o(6).canUseDrag;t.init=function(e){return i?n.init(e):s.init(e)},t.destroy=function(e){return i?n.destroy(e):s.destroy(e)}},function(e,t,o){var n=o(1),s=o(14),i=o(3),a=o(10),r=o(12).CLS,c=o(15).clean,u=o(18),l=u.getDragImage,d=u.onDropSuccess,h=u.DRAG_IMG,p={dragend:function(e){if(e.stopPropagation(),e.preventDefault(),!f)return;f.classList.remove(r.DRAGSTART);var t=i.closestNodeSet(e.target);t&&t!==f&&t.classList.remove(r.DROPZONE);f=null},dragenter:function(e){if(e.stopPropagation(),e.preventDefault(),!f)return;var t=i.closestNodeSet(e.target);t&&t!==f&&t.classList.add(r.DROPZONE)},dragleave:function(e){if(e.stopPropagation(),e.preventDefault(),a.dispatch(document,"handledragend",{}),!f)return;var t=i.closestNodeSet(e.target);t&&t!==f&&t.classList.remove(r.DROPZONE)},dragover:function(e){if(e.stopPropagation(),e.preventDefault(),!f)return;e.dataTransfer.dropEffect="move"},dragstart:function(e){e.stopPropagation(),c();var t=i.closestNodeSet(e.target),o=i.closestNodeBubble(e.target);if(!t||!o)return void e.preventDefault();var a=n.getSelection();a&&a.removeAllRanges(),f=t,t.classList.add(r.DRAGSTART),s.add(o),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",""),s.get(f).length>1&&e.dataTransfer.setDragImage(l(),h.w,h.h)},drop:function(e){if(e.stopPropagation(),e.preventDefault(),a.dispatch(document,"handledragend",{}),!f)return;var t=i.closestNodeSet(e.target);if(!t||t===f)return;var o=t.options("checkBubbleDrop"),r=s.get(f);r.length&&o(r)&&(i.moveBubbles(f,t,r),n.setTimeout(d,0,f,t))}},f=null;t.init=function(e){a.on(e,p)},t.destroy=function(e){a.off(e,p)}},function(e,t,o){var n=null;t.DRAG_IMG={w:16,h:16},t.getDragImage=function(){return n||((n=new Image).src=o(19)),n},t.onDropSuccess=function(e,t){e.fireChange(),t.focus(),t.fireChange()}},function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAE8AAAAVCAMAAAAw/0MlAAABblBMVEUAAABOXIZJWIKCkbeNnMKMmsJNW4VNW4VWZY57ibFHV4KVpMxRYImCkLh9jbpgcJ1fcJ1JWoaZqdNUZpaHmMaVpdJIWolTZJKHmMZEV4iXqNdkdqhjdal2iLx2ib2Knc6PodNJXpJJXpNOYpdpfLKCk8JPYpdofLNugblugrqUptdZdLdZd8Nfeb93js1+ksuGm9SGm9VHaLhJarxKZqxKbL9La7pNbr9Pb71Ucr1Wbag/XqU/X6pAVopffMdjf8ZphMpwicx2js9BW51CWZN/ldCBl9KCmNNFYKRFZbGJndWOodVKX5RKX5ZKYJdWdcNXbKJYdL1KYJtAVYpaeMVJXpJKbMBgebpjeLBjf8VLYp5kd65kgMlofLRog8log8tJYqBth8xugrpviMtNabBxi851jc8/X6t3i8BOaK56kdB9lNFOaa5Ob8FPY5qBl9NGXJODmNOEmdNQbrpRcsJUb7RGXJSTptmUptiUp9kfFguNAAAAK3RSTlMAJCQkJDw8P0JCRUVubpaWlpmZwMDAw8nJzMzV29vb7e3t7fDw+Pn5+fn8jndhZAAAAQhJREFUeF6tz2VXwgAYBtBnhBKKkgoGKPY2urvT7u7ujn/vtsM5fN/e+w8uJEaLa+HvR7Zfl8WILo293Qq8vykQaLXtGnRoPcH6i1L1oEcLidpde6BQc6shslXvaVSHIdD7S9c0Sv5+ACbfFRXftBoYuzijUry1AXPHJ1QK5349pvYOqeSPfCaM8Dkq/EFxHAMst0mDY3cL89Clkis0kqmd/CxgvUt8Ukg8rub4UYCZicTiT0rFY5HnNY4dBNC32GiGwtFt+aLhULOx9CWMdRAMbVXK6cyNfJl0ubL8IYytEDHe0/XX7IZ82e/9S3HsZSDpmSQZT/SiQ+UgGDtU6DKYnYrGTrMBon97+TS1J80efgAAAABJRU5ErkJggg=="},function(e,t,o){var n=o(1),s=o(10),i=o(6),a=o(14),r=o(3),c=o(21),u=o(12),l=u.CLS,d=u.EV,h=o(18),p=h.getDragImage,f=h.onDropSuccess,m=h.DRAG_IMG,g=null,b=null,_=null;function v(e){var t=r.closestNodeBubble(e.target);if(t){var o=r.closestNodeSet(e.target);if(o){e.preventDefault(),o.focus();var c=o.__drag__={nodeBubble:t,nodeOffsetX:e.offsetX,nodeOffsetY:e.offsetY,onMousemove:i.throttle(y.bind(this,o)),onMouseup:function(e,t){var o=e.__drag__;if(!o)return;s.off(document,"mousemove",o.onMousemove),s.off(document,"scroll",o.onScroll),delete e.__drag__,_&&(_.parentNode&&_.parentNode.removeChild(_),_=null);if(b){var i=b;b=null,i.classList.remove(l.DROPZONE),s.dispatch(i,d.DRAGLEAVE,{bubbles:!1,cancelable:!1})}if(g){var c=r.closestNodeSet(t.target);if(c&&c!==g){var u=a.get(g),h=c.options("checkBubbleDrop");u.length&&h(u)&&(r.moveBubbles(g,c,u),n.setTimeout(f,0,g,c))}var p=g;g=null,p.classList.remove(l.DRAGSTART),s.dispatch(p,d.DROP,{bubbles:!1,cancelable:!1}),s.dispatch(p,d.DRAGEND,{bubbles:!1,cancelable:!1,detail:{target:a.head(p)}})}}.bind(this,o),onScroll:i.throttle(C.bind(this,o)),x:0,y:0};g=null,b=null,_=null,s.one(document,"mouseup",c.onMouseup),s.on(document,"mousemove",c.onMousemove),s.on(document,"scroll",c.onScroll)}}}function y(e){var t=e.__drag__;if(t){if(!g){var o,i=n.getSelection();i&&i.removeAllRanges(),(g=e).classList.add(l.DRAGSTART),a.add(t.nodeBubble),1===a.get(g).length&&(o=t.nodeBubble.cloneNode(!0)),o||(o=p(),t.nodeOffsetX=m.w,t.nodeOffsetY=m.h),(_=document.body.appendChild(document.createElement("div"))).style.cssText="position:absolute;z-index:9999;pointer-events:none;top:0;left:0;",_.appendChild(o),s.dispatch(g,d.DRAGSTART,{bubbles:!1,cancelable:!1,detail:{target:a.head(g)}})}t.x=event.clientX,t.y=event.clientY,C(e);var c=r.closestNodeSet(event.target);if(c&&c!==g)b&&b!==c?(b.classList.remove(l.DROPZONE),c.classList.add(l.DROPZONE),b=c,s.dispatch(b,d.DRAGENTER,{bubbles:!1,cancelable:!1})):b||(c.classList.add(l.DROPZONE),b=c,s.dispatch(b,d.DRAGENTER,{bubbles:!1,cancelable:!1}));else if(b){var u=b;b=null,u.classList.remove(l.DROPZONE),s.dispatch(u,d.DRAGLEAVE,{bubbles:!1,cancelable:!1})}}}function C(e){var t=e.__drag__;if(t&&_){var o=t.x-t.nodeOffsetX+s.scrollX(),n=t.y-t.nodeOffsetY+s.scrollY();c.csstransforms3d?_.style.transform="translate3d(".concat(o,"px, ").concat(n,"px, 0px)"):c.csstransforms?_.style.transform="translate(".concat(o,"px, ").concat(n,"px)"):(_.style.top="".concat(n,"px"),_.style.left="".concat(o,"px"))}}t.init=function(e){s.on(e,"mousedown",v)},t.destroy=function(e){s.off(e,"mousedown",v)}},function(e,t){e.exports=window.Modernizr},function(e,t,o){var n=o(10),s=o(12).PROPS;e.exports=function(e){if(e.currentTarget[s.LOCK_COPY])return n.prevent(e)}},function(e,t,o){var n=o(10),s=o(3),i=o(12).PROPS;e.exports=function(e,t){var o=s.closestNodeSet(e.target);if(!o)return n.prevent(e);if(t.nodeEditor=o,t.nodeBubble=s.closestNodeBubble(e.target),t.isDblclick=!1,t.canAddBubble=o.canAddBubble(),t.nodeBubble){var a=Date.now();t.isDblclick=o[i.CLICK_TIME]&&a-o[i.CLICK_TIME]<200,o[i.CLICK_TIME]=a}}},function(e,t,o){var n=o(7),s=o(1),i=o(10),a=o(12).PROPS;e.exports=function(e){var t=e.currentTarget;if(t[a.LOCK_COPY])return i.prevent(e),delete t[a.LOCK_COPY],n(function(){var e=s.getSelection();e&&e.removeAllRanges()}),!1}},function(e,t,o){var n=o(6),s=o(10),i=o(12).KEY;e.exports=function(e,t){var o=s.keyCode(e);switch(t.nodeEditor=e.currentTarget,o){case i.Left:case i.Right:case i.Delete:case i.Backspace:e.preventDefault(),t.selection=n.getSelection(e.currentTarget)}}},function(e,t,o){var n=o(4);e.exports=function(e){n.bubbling(e.currentTarget)}},function(e,t,o){function n(e){return function(e){if(Array.isArray(e)){for(var t=0,o=new Array(e.length);t<e.length;t++)o[t]=e[t];return o}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var s=o(10),i=o(4),a=o(13),r=o(6),c=!1;s.on(document,"deselectafterclick",function(e){var t=e.detail,o=t.wasSelectedPreviously,n=t.sharedData;o!==c&&(n&&c&&a.restore(n.nodeEditor),setTimeout(function(){return c=Boolean(o)},50))}),e.exports=function(e,t){var o=t.nodeEditor,u=t.nodeBubble,l=t.isDblclick;if(u)l?e.shiftKey||s.metaKey(e)||i.edit(o,u):o.options("selection")||(i.bubbling(o),a.restore(o));else{var d=r.getSelection(o),h=Boolean(n(o.children).map(function(e){return e.hasAttribute("selected")}).filter(Boolean).length);d&&d.anchorNode.nodeType===Node.TEXT_NODE||h||c||a.restore(o),h&&(e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault()),c&&s.dispatch(document,"deselectafterclick",{detail:{wasSelectedPreviously:!1,sharedData:t}})}}},function(e,t,o){var n=o(3);e.exports=function(e){var t=n.closestNodeSet(e.target);t&&(n.closestNodeBubble(e.target)||t.canAddBubble()||(t.focus(),e.preventDefault()))}},function(e,t,o){function n(e){return function(e){if(Array.isArray(e)){for(var t=0,o=new Array(e.length);t<e.length;t++)o[t]=e[t];return o}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var s=o(7),i=o(10),a=o(13),r=o(1);e.exports=function(e){var t=e.currentTarget;if(t.canAddBubble()||s(function(){var e=r.getSelection();e&&e.removeAllRanges()}),Boolean(n(t.children).map(function(e){return e.hasAttribute("selected")}).filter(Boolean).length))return i.dispatch(document,"deselectafterclick",{detail:{wasSelectedPreviously:!1}});a.restore(t)}},function(e,t,o){var n=o(10),s=o(4),i=o(13),a=o(5),r=o(3),c=o(12).KEY;e.exports=function(e,t){var o=n.keyCode(e),u=n.metaKey(e);switch(o){case c.Esc:e.preventDefault(),s.bubbling(t.nodeEditor),i.restore(t.nodeEditor);break;case c.Backspace:!function(e,t){var o=t.selection;if(!o)return;var n=t.nodeEditor;if(!o.isCollapsed||a.arrowLeft(o,!0))a.remove(o),n.fireInput(),a.hasNear(o)||n.fireChange();else if(n.options("selection"))t.isEmptyLeft=!0;else{var s=r.findBubbleLeft(o);s&&(r.removeBubbles(n,[s]),n.fireChange())}}(0,t);break;case c.Delete:!function(e,t){var o=t.selection;if(!o)return;var n=t.nodeEditor;if(!o.isCollapsed||a.arrowRight(o,!0))a.remove(o),n.fireInput(),a.hasNear(o)||n.fireChange();else if(n.options("selection"))t.isEmptyRight=!0;else{var s=r.findBubbleRight(o);s&&(r.removeBubbles(n,[s]),n.fireChange())}}(0,t);break;case c.Left:!function(e,t){t.isEmptyLeft=!a.arrowLeft(t.selection,e.shiftKey)}(e,t);break;case c.Right:!function(e,t){t.isEmptyRight=!a.arrowRight(t.selection,e.shiftKey)}(e,t);break;case c.Home:e.shiftKey&&(e.preventDefault(),t.isTextSelectedFromBeginToCursor=a.selectFromCursorToStrBegin(null,t.nodeEditor));break;case c.a:u&&(e.preventDefault(),t.isTextSelectAll=a.selectAll(null,t.nodeEditor))}}},function(e,t,o){var n=o(10),s=o(4),i=o(13),a=o(14),r=o(12).KEY;e.exports=function(e,t){var o=n.keyCode(e),c=e.currentTarget;if(t.enterBubbling=!1,o===r.Enter)e.preventDefault(),c.options("disableControls")||a.getEditable(c)||(s.bubbling(c),i.restore(c),t.enterBubbling=!0);else if(c.canAddBubble()){var u=c.options("separator");if(u&&u.test(String.fromCharCode(o))){var l=c.options("separatorCond");l&&!l(c.inputValue)||(e.preventDefault(),s.bubbling(c),i.restore(c))}}else e.preventDefault()}},function(e,t,o){var n=o(10),s=o(12).KEY;e.exports=function(e){var t=e.currentTarget,o=n.keyCode(e);(e.key?1===e.key.length:(o>47||o===s.Space||o===s.Backspace)&&o!==s.Cmd)&&t.canAddBubble()&&t.fireInput()}},function(e,t,o){var n=o(7),s=o(1),i=o(4),a=o(13),r=o(5),c=o(6).isIE;function u(e,t){var o=e.options("checkBubblePaste"),i=e.options("lineBreakReplacer"),a=s.getSelection();t&&i&&(t=t.replace(/\n/g,i));var u=!(!t||!a.isCollapsed||e.inputValue)&&o(t);return!!r.replaceString(t,a)&&(u?c?n(function(){return l(e)}):l(e):e.fireInput(),!0)}function l(e){i.bubbling(e),e.focus(),n(function(){return a.restore(e)})}e.exports=function(e){e.preventDefault();var t=e.currentTarget;if(t.canAddBubble())if(s.clipboardData&&s.clipboardData.getData)u(t,s.clipboardData.getData("Text"));else if(e.clipboardData){var o=e.clipboardData,n=o.getData&&o.getData("text/plain");!u(t,n)&&o.items&&Array.prototype.slice.call(o.items).filter(function(e){return"string"===e.kind&&"text/plain"===e.type}).some(function(e){return e.getAsString(function(e){u(t,e)}),!0})}}},function(e,t,o){var n=o(14);e.exports=function(e){n.clear(e.currentTarget)}},function(e,t,o){function n(e){return function(e){if(Array.isArray(e)){for(var t=0,o=new Array(e.length);t<e.length;t++)o[t]=e[t];return o}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var s=o(10),i=o(14);e.exports=function(e,t){var o=t.nodeEditor,a=t.nodeBubble,r=t.isDblclick,c=t.canAddBubble,u=Boolean(n(o.children).map(function(e){return e.hasAttribute("selected")}).filter(Boolean).length);if(a)return s.metaKey(e)?void i.add(a):e.shiftKey?void(o.startRangeSelect?i.range(a):i.uniq(a)):r?void 0:void(c?i.toggleUniq(a):i.uniq(a));c&&!u&&i.clear(o)}},function(e,t,o){var n=o(7),s=o(10),i=o(6),a=o(4),r=o(14),c=o(3),u=o(13),l=o(12),d=l.KEY,h=l.PROPS;function p(e,t){var o=t.nodeEditor,s=t.selection;if(s){if(t.isEmptyRight){var i=c.findBubbleRight(s);i&&r.uniq(i)}}else f(o,!0)||(o.focus(),n(function(){return u.restore(o)}))}function f(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=r.get(e);if(!o.length)return!1;var s=o[0].previousSibling,i=o[o.length-1].nextSibling;if(t){var l=s;s=i,i=l}return c.removeBubbles(e,o),a.isBubbleNode(s)?r.uniq(s):a.isBubbleNode(i)?r.uniq(i):(e.focus(),n(function(){return u.restore(e)})),e.fireChange(),!0}function m(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};if(i.getSelection(e))return!1;var o=r.get(e);if(!o.length)return!1;var a=e.options("bubbleCopy")(o);if(!a)return!1;e[h.LOCK_COPY]=!0;var c=e.ownerDocument.createElement("input");return c.value=a,c.style.cssText="\n        position: absolute;\n        left: -9999px;\n        width: 1px;\n        height: 1px;\n        margin: 0;\n        padding: 0;\n        border: none;",e.parentNode.appendChild(c),s.one(c,{keyup:function(){return e.focus()},blur:function(){c&&c.parentNode&&c.parentNode.removeChild(c),n(t)}}),c.select(),!0}e.exports=function(e,t){var o=s.keyCode(e),i=s.metaKey(e);switch(o){case d.Backspace:!function(e,t){var o=t.nodeEditor,s=t.selection;if(s){if(t.isEmptyLeft){var i=c.findBubbleLeft(s);i&&r.uniq(i)}}else f(o)||(o.focus(),n(function(){return u.restore(o)}))}(0,t);break;case d.Delete:p(e,t);break;case d.Left:!function(e,t){var o=t.selection;if(o){if(t.isEmptyLeft){var n=c.findBubbleLeft(o);n&&r.uniq(n)}}else{var s=t.nodeEditor,i=r.get(s),a=i.length>1&&i[0]===s.startRangeSelect?i[i.length-1]:i[0],u=c.prevBubble(a);u&&(e.shiftKey?r.range(u):r.uniq(u))}}(e,t);break;case d.Right:!function(e,t){var o=t.selection;if(o){if(t.isEmptyRight){var n=c.findBubbleRight(o);n&&r.uniq(n)}}else{var s=t.nodeEditor,i=r.get(s),a=i.length>1&&i[i.length-1]===s.startRangeSelect?i[0]:i[i.length-1],l=c.nextBubble(a);l?e.shiftKey?r.range(l):r.uniq(l):u.restore(s)}}(e,t);break;case d.Top:e.preventDefault(),function(e,t){var o=t.nodeEditor;if(o.options("disableControls"))return;var n=c.headBubble(o);n&&r.uniq(n)}(0,t);break;case d.Bottom:e.preventDefault(),function(e,t){var o=t.nodeEditor;if(o.options("disableControls"))return;r.has(o)&&u.restore(o)}(0,t);break;case d.Home:e.shiftKey&&!t.isTextSelectedFromBeginToCursor&&r.has(t.nodeEditor)&&(e.preventDefault(),r.allLeft(t.nodeEditor));break;case d.a:i&&!t.isTextSelectAll&&(e.preventDefault(),r.all(t.nodeEditor));break;case d.c:i&&m(t.nodeEditor);break;case d.x:i&&m(t.nodeEditor,function(){return p(e,t)})}}},function(e,t,o){var n=o(10),s=o(4),i=o(14),a=o(12).KEY;function r(e){var t=i.getEditable(e);return!!t&&s.edit(e,t)}e.exports=function(e,t){var o=n.keyCode(e),s=e.currentTarget;o===a.Enter?(e.preventDefault(),s.options("disableControls")||t.enterBubbling||r(s)):o===a.Space&&r(s)&&e.preventDefault()}},function(e,t,o){function n(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var o=[],n=!0,s=!1,i=void 0;try{for(var a,r=e[Symbol.iterator]();!(n=(a=r.next()).done)&&(o.push(a.value),!t||o.length!==t);n=!0);}catch(e){s=!0,i=e}finally{try{n||null==r.return||r.return()}finally{if(s)throw i}}return o}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var i=o(1),a=o(12).PROPS,r=/\/(.+)\/([gimy]{0,3})/i,c={begining:["reg",null,"begining"],bubbleCopy:["func",function(e){return e.map(function(e){return e.innerHTML}).join(", ")},"bubble-copy"],bubbleDeformation:["func",function(){},"bubble-deformation"],bubbleFormation:["func",function(){},"bubble-formation"],checkBubblePaste:["func",function(){return!0},"check-bubble-paste"],checkBubbleDrop:["func",function(){return!0},"check-bubble-drop"],classBubble:["str","bubble","class-bubble"],disableControls:["bool",!1,"disable-controls"],draggable:["bool",!0,"draggable"],ending:["reg",null,"ending"],limit:["uint",0,"limit"],selection:["bool",!0,"selection"],separator:["reg",/[,;]/,"separator"],separatorCond:["func",null,"separator-cond"],tokenizer:["func",null,"tokenizer"]},u={func:function(e){switch(s(e)){case"string":return new Function("context","return context.".concat(e,";"))(i);case"function":return e}},bool:function(e){switch(s(e)){case"string":return"true"===e||"on"===e;case"boolean":return e}},noop:function(e){return e},reg:function(e){switch(s(e)){case"string":if(e){var t=e.match(r);if(t)return new RegExp(t[1],t[2])}return null;case"object":if(e instanceof i.RegExp||null===e)return e}},str:function(e){if(void 0!==e)return e?String(e):""},uint:function(e){if(e=Number(e),!isNaN(e)&&e>0)return e}};function l(e){var t=arguments.length<=1?void 0:arguments[1];if(t){if(e[a.OPTIONS]||d(e),"object"===s(t)&&null!==t){var o=t;return Object.keys(o).forEach(function(t){e[a.OPTIONS][t]=o[t]}),void h(e[a.OPTIONS])}var n=t,i=arguments.length<=2?void 0:arguments[2];if(void 0===i)return e[a.OPTIONS][n];e[a.OPTIONS][n]=i,h(e[a.OPTIONS])}else d(e)}function d(e){var t=e[a.OPTIONS]=e[a.OPTIONS]||{};for(var o in c){var n="data-".concat(c[o][2]);e.hasAttribute(n)&&(t[o]=e.getAttribute(n))}h(t)}function h(e){for(var t in c){var o=n(c[t],2),s=o[0],i=o[1];e[t]=u[s](e[t]),void 0===e[t]&&(e[t]=i)}}l.attributes=Object.keys(c).map(function(e){return"data-".concat(c[e][2])}),e.exports=l}])},367:function(e,t,o){"use strict";var n=o(394),s=o.n(n);o.d(t,"a",function(){return s.a})},397:function(e,t,o){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.useStores=void 0;var s=n(o(135)),i=o(342);t.useStores=function(){return s.default.useContext(i.MobXProviderContext)}},404:function(e,t,o){"use strict";o.d(t,"h",function(){return n}),o.d(t,"a",function(){return s}),o.d(t,"f",function(){return i}),o.d(t,"g",function(){return a}),o.d(t,"c",function(){return r}),o.d(t,"b",function(){return c}),o.d(t,"d",function(){return u}),o.d(t,"e",function(){return l});var n="blockquote",s="data-cke-role",i="placeholder",a="js-compose-Quote-Container",r="js-expand-quote",c="js-expand-all-quotes",u=10,l=1e4},450:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TOO_MANY_SUBSCRIBERS=t.VALIDATION_ERROR=t.SEND_RETRYABLE_FAILED=t.SEND_FAILED=t.REMOVE_DRAFT=t.LIMITED_RECIPIENTS=t.EMPTY_SUBJECT=t.DISK_RESOURCES=t.CONTACTS_SUGGEST=t.CONFIRM_REMOVE=t.CHECKBOX_CAPTCHA=t.CAPTCHA=t.ATTACHMENTS_ERROR=void 0,t.ATTACHMENTS_ERROR="AttachmentsError",t.CAPTCHA="Captcha",t.CHECKBOX_CAPTCHA="CheckboxCaptcha",t.CONFIRM_REMOVE="ConfirmRemove",t.CONTACTS_SUGGEST="ContactsSuggest",t.DISK_RESOURCES="DiskResources",t.EMPTY_SUBJECT="EmptySubject",t.LIMITED_RECIPIENTS="LimitedRecipients",t.REMOVE_DRAFT="RemoveDraft",t.SEND_FAILED="SendFailed",t.SEND_RETRYABLE_FAILED="SendRetryableFailed",t.VALIDATION_ERROR="ValidationError",t.TOO_MANY_SUBSCRIBERS="TooManySubscribers"},454:function(e,t,o){"use strict";t.a=function(e){return(e.innerText||"").replace(/[\n\r]/g,"")}},457:function(e,t,o){"use strict";o.d(t,"c",function(){return n}),o.d(t,"d",function(){return s}),o.d(t,"b",function(){return i}),o.d(t,"e",function(){return a}),o.d(t,"a",function(){return r});var n=40,s="dir",i=60,a=200,r=200},470:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NEXT_WEEK=t.WEEKEND=t.TOMORROW=t.TODAY=void 0,t.TODAY="today",t.TOMORROW="tomorrow",t.WEEKEND="weekend",t.NEXT_WEEK="next week"},479:function(e,t,o){"use strict";t.a=function(e){if("number"!=typeof e.size&&e.file){var t=e.file;e.size="number"==typeof t.size?t.size:t.fileSize}return Number(e.size)}},483:function(e,t,o){"use strict";o.d(t,"a",function(){return n}),o.d(t,"b",function(){return s});var n="/disk/",s="/mail/"},496:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SENT=t.DELETE=t.CLOSE=t.COLLAPSE=void 0,t.COLLAPSE="collapse",t.CLOSE="close",t.DELETE="delete",t.SENT="sent"},497:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MAX_SUGGEST_ITEMS_FOR_POPUP=void 0,t.MAX_SUGGEST_ITEMS_FOR_POPUP=3},499:function(e,t,o){"use strict";var n=o(673);o.d(t,"a",function(){return n})},522:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Modal=void 0;var n=o(340),s=o(141),i=o(403),a=o(440);t.Modal=n.compose(a.withPsTheme({source:i.DarkSource.Content}))(s.Modal)},523:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NONE=t.SMALL=t.NORMAL=void 0,t.NORMAL="normal",t.SMALL="small",t.NONE="none"},524:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.INSERT_REPLACEMENT_TEXT=t.INSERT_MULTIPLE=t.INSERT_TEXT=t.INSERT_LINE_BREAK=t.INSERT_FROM_PASTE=t.DELETE_CONTENT_BACKWARD=t.DELETE_BY_CUT=void 0,t.DELETE_BY_CUT="deleteByCut",t.DELETE_CONTENT_BACKWARD="deleteContentBackward",t.INSERT_FROM_PASTE="insertFromPaste",t.INSERT_LINE_BREAK="insertLineBreak",t.INSERT_TEXT="insertText",t.INSERT_MULTIPLE="insertMultiple",t.INSERT_REPLACEMENT_TEXT="insertReplacementText"},525:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NONE=t.NS_COMPOSE=t.AUTOCOMPLETE=void 0,t.AUTOCOMPLETE="Autocomplete",t.NS_COMPOSE="NsCompose",t.NONE="None"},526:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DRAFT_NOT_SAVED=t.DRAFT_REMOVED=t.DRAFT_SAVED=t.NO_CHANGES=void 0,t.NO_CHANGES="no changes",t.DRAFT_SAVED="draft saved",t.DRAFT_REMOVED="draft removed",t.DRAFT_NOT_SAVED="draft not saved"},527:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LOCK_DEFAULT_EMAIL=t.CAN_WRITE_LETTERS=t.TWO_SIZES_HEADER_PROMO=t.TIMELINE_EXPANDED=t.STORED_COMPOSE_STATES=t.SIZE_LAYOUT_LEFT=t.SIZE_LAYOUT=t.SIGNATURE_TOP=t.RECIPIENTS_DIFF_PROMO_CLOSED=t.NS_COMPOSE_PROMO_CLOSED=t.NUMBER_OF_AUTOSAVE_PROMO_SHOW=t.LAST_USED_COMPOSE_SIZE=t.FROM_NAME=t.DEFAULT_EMAIL=t.ENABLE_HOTKEYS=t.ENABLE_AUTOSAVE=t.EMPTY_SUBJECT_POPUP_DISABLED=t.DISABLE_AUTOCOMPLETE_REACT=t.SUGGEST_BEAUTIFUL_EMAIL_PROMO_CLOSED=t.BEAUTIFUL_EMAIL_PROMO_CLOSED=t.MUTE_AUTOSAVE_PROMO_UNTIL=void 0,t.MUTE_AUTOSAVE_PROMO_UNTIL="mute_autosave_promo_until",t.BEAUTIFUL_EMAIL_PROMO_CLOSED="beautiful_email_compose_promo",t.SUGGEST_BEAUTIFUL_EMAIL_PROMO_CLOSED="beautiful_email_compose_promo",t.DISABLE_AUTOCOMPLETE_REACT="disable_autocomplete_react",t.EMPTY_SUBJECT_POPUP_DISABLED="empty_subject_popup_disabled",t.ENABLE_AUTOSAVE="enable_autosave",t.ENABLE_HOTKEYS="enable_hotkeys",t.DEFAULT_EMAIL="default_email",t.FROM_NAME="from_name",t.LAST_USED_COMPOSE_SIZE="last_used_compose_size",t.NUMBER_OF_AUTOSAVE_PROMO_SHOW="number_of_autosave_promo_show",t.NS_COMPOSE_PROMO_CLOSED="ns_compose_promo_closed",t.RECIPIENTS_DIFF_PROMO_CLOSED="kukutz-promo-closed",t.SIGNATURE_TOP="signature_top",t.SIZE_LAYOUT="size-view-app",t.SIZE_LAYOUT_LEFT="size-layout-left",t.STORED_COMPOSE_STATES="storedComposeStates",t.TIMELINE_EXPANDED="timeline-is-open",t.TWO_SIZES_HEADER_PROMO="two_sizes_header_promo",t.CAN_WRITE_LETTERS="can_write_letters",t.LOCK_DEFAULT_EMAIL="lock_employees_default_mail_domain"},528:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.POPUP=t.INPUT=void 0,t.INPUT="line",t.POPUP="popup"},529:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QUERY=t.POPULAR=void 0,t.POPULAR="popular",t.QUERY="query"},530:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BACKGROUND=t.FOREGROUND=void 0,t.FOREGROUND="foreground",t.BACKGROUND="background"},531:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BanReason=void 0,function(e){e.RfcFail="RfcFail",e.UrlRbl="UrlRbl",e.BadKarma="BadKarma",e.MailLimits="MailLimits",e.PddAdminKarma="PddAdminKarma",e.Bounces="Bounces",e.SpamCompl="SpamCompl"}(t.BanReason||(t.BanReason={}))},532:function(e,t,o){"use strict";o.d(t,"b",function(){return s}),o.d(t,"a",function(){return i}),o.d(t,"c",function(){return r});var n=o(499),s=function(){return!Daria.isReactiveCompose()},i=function(){var e=a();return!ns.Model.get("settings").isSet(e)?Daria.isReactiveCompose()?n.a.REACT:n.a.NOSCRIPT:n.a.NONE},a=function(){return Daria.isReactiveCompose()?"disable_autocomplete_react":"disable_compose_autocomplete"},r=function(){var e=i();return Daria.isReactiveCompose()?e===n.a.REACT:Daria.isReactiveCompose()?null:e===n.a.NOSCRIPT}},537:function(e,t,o){"use strict";t.a=function(e,t){e&&e.parentNode&&t&&e.parentNode.replaceChild(t,e)}},570:function(e,t,o){"use strict";t.b=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],o=function(e,t){for(var o=!1,n=0;n<e.childNodes.length;n++){var s=e.childNodes[n],i=l(s);if(i&&(o=!o),!o&&!i){var a=c(s,t),r=a.isMatch,u=a.targetMatch;if(r)return{idx:n,targetMatch:u}}}return{idx:-1,targetMatch:null}}(e,t),n=o.idx,s=o.targetMatch;if(n<0)return null;for(var i={current:n,prev:n},a=!1,r=!1,h=n+1;h<e.childNodes.length;h++){var p=e.childNodes[h];if(u(p)){a=!0;break}if(l(p))break;if("#text"===p.nodeName)break;if((p.outerText||"").trim().startsWith("----------------"))break;(r=d(p))||(i.prev=i.current,i.current=h)}r&&i.prev++;s&&s.leadingLineBreaks>0&&function(e,t){for(;t--;)if(!(e=e.previousElementSibling)||!d(e))return!1;return!0}(e.childNodes[n],s.leadingLineBreaks)&&(n-=s.leadingLineBreaks);return{node:e,start:n,finish:a?i.prev:i.current,targetMatch:s}},t.c=function(e){for(;e.childNodes.length;){var t=e.childNodes[e.childNodes.length-1];if(!d(t))break;e.removeChild(t)}},t.a=function(e){for(var t=-1,o=-1,n=0;n<e.childNodes.length;n++){var s=e.childNodes[n];if(l(s)){if(-1===t){t=n;continue}o=n;break}}if(-1===t||-1===o)return null;return{node:e,start:t,finish:o}};var n=o(454),s=o(404),i="IMG",a=/^--------[^\-]+.*--------$/,r=/^--\s?$|^--\s/;function c(e,t){if(u(e))return{isMatch:!1,targetMatch:null};var o=Daria.Html2Text.html2text(e.innerHTML);o&&(o=o.replace(/^[\n\r]+/g,""));var n=!0,s=!1,i=void 0;try{for(var a,c=t[Symbol.iterator]();!(n=(a=c.next()).done);n=!0){var l=a.value;if(l.match&&new RegExp("^"+l.match).test(o))return{isMatch:!0,targetMatch:l}}}catch(e){s=!0,i=e}finally{try{n||null==c.return||c.return()}finally{if(s)throw i}}return r.test(o)?{isMatch:!0,targetMatch:null}:{isMatch:!1,targetMatch:null}}function u(e){return(e.tagName||"").toUpperCase()===s.h.toUpperCase()}function l(e){var t=Object(n.a)(e);return a.test(t)}function d(e){return!(Object(n.a)(e).trim()||(e.tagName||"").toUpperCase()===i||e.getElementsByTagName&&0!==e.getElementsByTagName(i).length)}},571:function(e,t,o){"use strict";t.a=function(e){if(!e)return 0;var t=Array.prototype.slice.call(e.getElementsByTagName(n.h)).map(function(e){return e.parentNode}),o=Object(s.uniq)(t).length;return e.tagName.toLowerCase()===n.h.toLowerCase()?o+1:o};var n=o(404),s=o(136);o.n(s)},585:function(e,t,o){"use strict";o.d(t,"a",function(){return c});var n=o(137);o.n(n);function s(e){return function(e){if(Array.isArray(e)){for(var t=0,o=new Array(e.length);t<e.length;t++)o[t]=e[t];return o}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function i(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),o.push.apply(o,n)}return o}function a(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function r(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var c=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,o){t&&r(e.prototype,t),o&&r(e,o)}(e,[{key:"getPageAfterSent",value:function(){return Daria.isReactiveCompose()&&Daria.IS_CORP||Daria.is3pane()?"prev":ns.Model.get("settings").getSetting("page_after_send")}},{key:"whereToGoAfterSend",value:function(){var e,t=ns.Model.get("folders");switch(this.getPageAfterSent()){case"sent_list":e=ns.router.generateUrl("messages",{current_folder:t.getFidBySymbol(n.WellKnownFolderSymbol.SENT)});break;case"current_list":e=ns.page.history.getPreviousPageUrl({match:"messages"});break;case"prev":e=ns.page.history.getPreviousPageUrl({mismatch:"compose2"})}e||(e=ns.router.generateUrl("messages",{current_folder:t.getFidBySymbol(n.WellKnownFolderSymbol.INBOX)}));return e}},{key:"showMessageSentNotification",value:function(e){var t=e.sentMid,o=e.wasSendCancelled,n=e.withUndo,s=e.isDelayed,i=e.sendTime;if(o)return!1;var a={};if(n){var r=Daria.SendMail.getUndoSendLogger(t);a.onClose=function(){r.logClose()},a.onCancel=function(){r.logCancel()}}return s?Daria.SendMail.showMessageSentDelayed(t,i,a):Daria.SendMail.showMessageSent(t,a),!0}},{key:"sendMetrika",value:function(){Jane.Metrika.counter&&Jane.Metrika.counter.reachGoal("SEND")}},{key:"leaveCompose",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=t.clearPageBlock,n=t.neverReturn;o&&ns.page.block.clear();var s=this.pageGoUrl||ns.page.history.getPreviousPageUrl({mismatch:"compose2"})||ns.page.HOME_HASH,i=ns.router(s);i.page===ns.R.REDIRECT&&(i=ns.router(i.redirect)),i.params=_.omit(i.params,"_cuid");var a=_.delay(function(){Jane.ErrorLog.send({event:"after_send_wait_10_sec"})},1e4),r=_.delay(function(){Jane.ErrorLog.send({event:"after_send_wait_20_sec"}),ns.page.go(ns.page.HOME_HASH)},2e4),c=ns.router.generateUrl(i.page,i.params);return ns.page.go(c,n?"replace":null).fail(function(t){return e.handleLeaveComposeFail(c,t)}).always(function(e){return window.clearTimeout(a),window.clearTimeout(r),e})}},{key:"handleLeaveComposeFail",value:function(e,t){var o=this,n=function(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?i(Object(o),!0).forEach(function(t){a(e,t,o[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):i(Object(o)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))})}return e}({},t,{event:"compose_leave_failed",loadingHash:e});return Jane.ErrorLog.send(n),this.handleTransitionFail(t,function(e,t){return ns.page.go(t).fail(o.handleTransitionFail)},[ns.page.HOME_HASH])}},{key:"handleTransitionFail",value:function(e,t,o){if(t=t||Vow.reject,o=Array.isArray(o)?o:[],"expired"!==(e&&e.error)){var n=t.apply(null,[e].concat(s(o)));return n instanceof Vow.Promise?n:Vow.reject(n)}return Vow.resolve(e)}}]),e}()},586:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),o.d(t,"UNKNOWN",function(){return n}),o.d(t,"FILE_LIMIT",function(){return s}),o.d(t,"TOTAL_LIMIT",function(){return i}),o.d(t,"YADISK_ERROR",function(){return a}),o.d(t,"VIRUS",function(){return r}),o.d(t,"DISK_FULL",function(){return c}),o.d(t,"STATUS_DISK_FULL",function(){return u}),o.d(t,"DISK_TRAFFIC_LIMIT",function(){return l}),o.d(t,"DISK_TECHNICAL_WORK",function(){return d});var n=0,s=1,i=2,a=6,r=106,c=85,u=507,l=311,d=312},587:function(e,t,o){"use strict";var n=o(136);o.n(n);t.a=function(e){return e.id||e.hid&&e.hid.replace(/\./g,"-")||Object(n.uniqueId)("attach-")}},589:function(e,t,o){"use strict";o.d(t,"d",function(){return n}),o.d(t,"a",function(){return s}),o.d(t,"i",function(){return i}),o.d(t,"h",function(){return a}),o.d(t,"f",function(){return r}),o.d(t,"g",function(){return c}),o.d(t,"e",function(){return u}),o.d(t,"b",function(){return l}),o.d(t,"c",function(){return d});var n="compose-have-opened",s="captcha-have-shown",i="SSItemsShow",a="SSItemClick",r="sending-has-been-triggered",c="sending-have-failed",u="delayed-sending-have-failed",l="changed-size-to-small",d="changed-size-to-large"},673:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),o.d(t,"NOSCRIPT",function(){return n}),o.d(t,"NONE",function(){return s}),o.d(t,"REACT",function(){return i});var n="noscript",s="none",i="react"},681:function(e,t,o){"use strict";t.a=function(e){e&&e.parentNode&&e.parentNode.removeChild(e)}},682:function(e,t,o){"use strict";t.a=function(e,t){if(!e)return null;var o=Array.prototype.slice.call(e.getElementsByTagName(n.h)).filter(function(t){var o=function(e){var t=e&&e.parentNode;for(;t;){if(t.tagName.toUpperCase()===n.h.toUpperCase())return t;t=t.parentNode}return null}(t);return!o||o===e}).map(function(e){return{quote:e,weight:function(e){var t=e.getAttribute(r);if(!t){var o=Object(a.a)(e),n=Object(s.a)(e).length;t=1e4*o+n,e.setAttribute(r,t)}return t}(e)}}).sort(function(e,t){return e.weight-t.weight}),c=null;o.length&&(c=o[o.length-1].quote,Object(i.a)(c,t));return c};var n=o(404),s=o(454),i=o(537),a=o(571),r="data-weight"},702:function(e,t,o){"use strict";var n=o(1060);o.d(t,"a",function(){return n.a});o(585);var s=o(779);o.d(t,"b",function(){return s.a});var i=o(780);o.d(t,"c",function(){return i.a})},703:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),o.d(t,"NEW",function(){return n}),o.d(t,"UPLOADING",function(){return s}),o.d(t,"COMPLETED",function(){return i}),o.d(t,"FAILED",function(){return a}),o.d(t,"VIRUS",function(){return r}),o.d(t,"ABORTED",function(){return c}),o.d(t,"RESTRICTED",function(){return u});var n=0,s=1,i=2,a=3,r=4,c=5,u=6},704:function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),o.d(t,"FILE",function(){return n}),o.d(t,"YADISK",function(){return s}),o.d(t,"FORWARDED_MAIL",function(){return i});var n="simple",s="narod",i="forwarded"},705:function(e,t,o){"use strict";t.a=function(e,t){var o=t.handlerName,n=t.isOk,s=t.errorCode;Daria.monitoring.workflow.attachToDisk({params:{size:e&&e.size,checkLimit:!0},handler:o,status:n?"success":"error",errorCode:s})}},706:function(e,t,o){"use strict";t.a=function(e,t){e.upload&&e.upload.addEventListener("progress",function(e,o){e&&e.lengthComputable&&(o=e.loaded/e.total*100),o=parseInt(o,10),o=isNaN(o)?-1:o,t(o)},!1)}},707:function(e,t,o){"use strict";function n(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),o.push.apply(o,n)}return o}function s(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}t.a=function(e){!function(e){if(!e.mid)return;var t=function(e){if(!e.mid||!e.from_template)return e;return function(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?n(Object(o),!0).forEach(function(t){s(e,t,o[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):n(Object(o)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))})}return e}({},e,{mid:e.template_mid,hid:e.template_hid})}(e);e.previewHref=Daria.url.attachment(t,e.mid,{no_disposition:!0}),e.previewSrc=Daria.url.attachment(t,e.mid,{no_disposition:!0,thumb:!0})}(e),function(e){if(!e.narodPreview)return;e.previewSrc=e.narodPreview,e.previewHref=e.narodUrl||e.narodPreview}(e)}},719:function(e,t,o){"use strict";var n=this&&this.__assign||function(){return(n=Object.assign||function(e){for(var t,o=1,n=arguments.length;o<n;o++)for(var s in t=arguments[o])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}).apply(this,arguments)},s=this&&this.__rest||function(e,t){var o={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(o[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(n=Object.getOwnPropertySymbols(e);s<n.length;s++)t.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(e,n[s])&&(o[n[s]]=e[n[s]])}return o},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Modal=void 0;var a=i(o(135)),r=i(o(339)),c=o(342),u=o(522),l=o(141),d=o(397);o(1120);var h={Block:"ComposeModal",Block_mobile:"ComposeModal_mobile",Block_tablet:"ComposeModal_tablet",Block_desktop:"ComposeModal_desktop",Block_fullscreen:"ComposeModal_fullscreen"};t.Modal=c.observer(function(e){var t,o=e.fullscreen,i=e.cls,c=e.className,p=s(e,["fullscreen","cls","className"]),f=d.useStores().services,m=r.default(i,c,h.Block,f.settings.isMobile?h.Block_mobile:h.Block_desktop,((t={})[h.Block_fullscreen]=o,t[h.Block_tablet]=null===f||void 0===f?void 0:f.settings.isTablet,t)),g=f.settings.isMobile?l.Modal:u.Modal;return a.default.createElement(g,n({className:m,theme:"normal"},p))}),t.default=t.Modal},779:function(e,t,o){"use strict";o.d(t,"a",function(){return i});var n=o(137);o.n(n);function s(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,o){t&&s(e.prototype,t),o&&s(e,o)}(e,[{key:"updateDraftAfterAction",value:function(e,t){if(t){var o=ns.Model.get("message",{ids:t});if(!e){ns.Model.traverse("messages",function(e){return e.remove(o)});var s=o.getThreadMessage();s&&s.hasRealData()&&s.updateThreadCount(-1)}var i=function(e){return e.isValid()&&e.params.ids===t};ns.Model.invalidate("message",i),ns.Model.invalidate("message-body",i),this.updateFolders(n.DraftLikeFoldersShort)}}},{key:"updateFolders",value:function(e){var t=Array.isArray(e)?e:[e],o=ns.Model.get("folders");return t.forEach(function(e){var t=o.getFidBySymbol(e);Daria.messages.clearCacheByFID(t)}),ns.forcedRequest(["folders","labels"]).then(function(){ns.router.buildFoldersUrls()})}},{key:"updateTemplateAfterAction",value:function(e){if(this.updateFolders(n.DraftTemplateLikeFoldersShort),e){var t=ns.Model.get("folders").getFidBySymbol(n.WellKnownFolderSymbol.TEMPLATE);ns.Model.get("message",{ids:e}).setIfChanged(".fid",t);var o=function(t){return t.isValid()&&t.params.ids===e};ns.Model.invalidate("message",o),ns.Model.invalidate("message-body",o)}}},{key:"updateMessageFlagsAfterSend",value:function(e,t){var o=t.isForward,n=t.isReply,s=t.replyMessageId;if(e&&e.length){var i=function(t){return e.forEach(function(e){return t(ns.Model.get("message",{ids:e}))})};o&&i(function(e){return e.markForwarded()}),n&&i(function(e){return e.markAnswered()}),ns.Model.invalidate("message-in-reply-to-ng",function(e){return e.params.message_id===s})}}},{key:"resetCheckedMessages",value:function(){"message"!==ns.page.current.page&&(ns.Model.get("messages-checked").resetChecked(),ns.events.trigger("daria:vToolbarButton:restruct",{force:!0}))}},{key:"updateOutboxAfterAction",value:function(){this.updateFolders([n.WellKnownFolderSymbol.OUTBOX])}}]),e}()},780:function(e,t,o){"use strict";t.a=function(e){return Boolean(e.inreplyto)?{initial_to:e.to,initial_cc:e.cc}:{}}},781:function(e,t,o){"use strict";t.a=function(e){return function(t){return e*(Math.sqrt(t)/(1+Math.sqrt(t)))}}},782:function(e,t,o){"use strict";var n=o(1446),s=o.n(n),i=o(703),a=o(586),r=o(704),c=o(136);o.n(c);function u(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),o.push.apply(o,n)}return o}function l(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?u(Object(o),!0).forEach(function(t){d(e,t,o[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):u(Object(o)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))})}return e}function d(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}t.a=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=t.status,n=t.previewSupported,u=e.id,d=e.name,h=e.folder,p=e.size,f=e.stid,m=e.message,g=e.type;if(g===r.FORWARDED_MAIL)return{id:u,name:d,icon:"eml",class:"mail"};var b=Daria.splitName(d),_={id:u,name:d,"name-uri-encoded":e["name-uri-encoded"],filename:b[0],fileext:b[1]?"."+b[1]:"",class:e.class,folder:h,"browser-supports":e["browser-supports"],length:p,status:o,errorCode:o===i.VIRUS?a.VIRUS:void 0,stid:f||void 0,icon:e.extension&&e.extension.icon||void 0,external_transformer:e.external_transformer,external_transformer_filetype:e.external_transformer?e.external_transformer_filetype:void 0,message:Boolean(m)||void 0,narod:g===r.YADISK||void 0},v=l({},Object(c.omit)(_,function(e){return void 0===e}),{},function(e){return function(e){var t=e.narodUrl,o=e.url;return t||o?{url:t||o}:null}(e)||function(e){var t=e.mid,o=e.hid,n=e.bid;return t&&o?{mid:t,hid:o,bid:n}:null}(e)||function(e){return e.from_template?{mid:e.template_mid,hid:e.template_hid}:null}(e)||{uploading:!0}}(e),{},function(e,t){return t?{"preview-supported":!0,"preview-src":e.previewSrc||!1,"preview-href":e.previewHref||!1}:{}}(e,n));return l({},v,{},function(e,t){if(function(e){return!!(e.external_transformer&&e.mid&&e.fileext)&&(s()(null,e.fileext.slice(1).toLowerCase())||s()(null,e.fileext.slice(1).toLowerCase(),!0))}(e))return{url:Daria.url.docviewer(e,e.mid)};if(e.narodUrl||e.url)return{url:e.narodUrl||e.url};if(t===i.COMPLETED)return{url:Daria.url.attachment(e,e.mid)};return{}}(v,o))}},783:function(e,t,o){"use strict";var n=o(136),s=(o.n(n),o(587)),i=o(357),a=o(707),r=o(1073);t.a=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};"mail"===e.class&&"eml"!==Daria.getExtension(Object(n.unescape)(e.name))&&(e.name+=".eml"),e.id=Object(s.a)(e),e.name=Object(n.unescape)(e.name||function(e){return Object(n.escape)(e?e.name||e.fileName:i18n("%Без_темы"))}(e.file)),e["name-uri-encoded"]=encodeURIComponent(e.name),e.extension=Daria.getExtensionInfo(e.name),e.class=e.class||e.extension.class;var t=Object(r.a)(e);return t&&Object(a.a)(e),{info:e,previewSupported:t,status:e.type?i.c.COMPLETED:i.c.NEW,progress:null}}},786:function(e,t){var o=/^(.*)<[^<>]*>$/,n={",":!0,";":!0," ":!0};function s(e,t,o){for(var n=!1,s=0;s<e.length;++s){var i=e[s];if(l(e,s)&&(n=!n),!n&&o[i]){var a=e.substring(0,s).trim();a&&t.push(a),e=r(e,0,s+1),s=-1}}return e&&(t.push(e.trim()),e=""),e}function i(e,t,n){for(var s=0,i=0;i<e.length;++i){var c=e.charAt(i);if("<"===c&&(s=i),">"===c){if(Daria.hasFeature("web-change-parse-contact"))if(!d(e.substring(s+1,i).trim()))continue;var u=e.substring(0,i+1).trim();if(u&&o.test(u)){var l=[];u=a(u,t,n),l.length&&t.push.apply(t,l),t.push(u),e=r(e,0,i+1),i=-1}}}return e.trim()}function a(e,t,o){for(var n=!1,s=0;s<e.length;++s){var i=e[s];if(l(e,s)&&(n=!n),!n&&o[i]){var a=e.substring(0,s).trim();a&&!c(a,i)||(a&&t.push(a),e=r(e,0,s+1),s=-1)}if(Daria.hasFeature("web-change-parse-contact")&&o[i]){var d=e.substring(0,s).trim();u(d,i,s,e)&&(d&&t.push(d),e=r(e,0,s+1),s=-1)}}return e.trim()}function r(e,t,o){return e.substr(0,t)+(o>0?e.substr(o):"")}function c(e,t){return(" "!==t||!function(e){return'"'===e[0]&&'"'===e[e.length-1]}(e))&&d(e)}function u(e,t,o,n){return">"!==n.charAt(o-1)&&" "!==t&&l(n,o+1)&&!l(n,0)&&!d(e)}function l(e,t){return'"'===e[t]&&(0===t||"\\"!==e[t-1])}function d(e){return Daria.hasFeature("web-change-parse-contact")?!!e&&Jane.FormValidation.checkEmail(e,!0):Jane.FormValidation.checkEmail(e)}e.exports=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:n;return function(t){return function(e,t){var o=999,n=1,a=[];for(;e&&o;)n>0?(e=i(e,a,t),n=-1):(e=s(e,a,t),n=1),o--;return a}(t,e)}},e.exports.SEPARATORS=n},791:function(e,t,o){"use strict";o.d(t,"b",function(){return a}),o.d(t,"a",function(){return d}),o.d(t,"c",function(){return h});var n=o(682),s=o(681),i=o(570),a=function(e){var t=e.messageBody,o=e.signatureMatches,n=void 0===o?[]:o,s=document.createElement("div");return s.innerHTML=t,{signature:r(s,n),forward:u(s),quotes:l(s)}},r=function(e,t){var o=Object(i.b)(e,t);return o?c(e,o):""},c=function(e,t){for(var o=t.start,n=t.finish,s=document.createElement("div"),i=n-o+1,a=0;a<i;a++)s.appendChild(e.childNodes[o]);return s.innerHTML},u=function(e){var t=Object(i.a)(e);return t?c(e,t):""},l=function(e){var t=document.createElement("div"),o=Object(n.a)(e,t);if(o){var s=document.createElement("div"),i=t.previousSibling;return i&&s.appendChild(i),s.appendChild(o),s.innerHTML}return""},d=function(e){var t=document.createElement("div");t.innerHTML=e;var o=document.createElement("div");if(Object(n.a)(t,o)){var i=o.previousSibling;Object(s.a)(i),Object(s.a)(o)}return Daria.Html2Text.html2text(t.innerHTML).trim().length},h=function(e){var t=e.messageBody,o=e.signatureMatches,n=void 0===o?[]:o,s=function(e){try{var t=new DOMParser,o=t.parseFromString(e,"text/html");return o.body}catch(t){var n=document.createElement("div");return n.innerHTML=e,n}}(t),a=Object(i.b)(s,n);return a?{beforeSignature:p(s,0,a.start-1),signature:p(s,a.start,a.finish),afterSignature:p(s,a.finish+1)}:{beforeSignature:s.innerHTML.trim(),signature:"",afterSignature:""}};function p(e,t){for(var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.children.length-1,n="",s=t;s<=o;)n+=e.children[s++].outerHTML;return n}}});